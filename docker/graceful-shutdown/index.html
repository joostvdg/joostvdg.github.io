



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://joostvdg.github.io/docker/graceful-shutdown/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>Graceful shutdown - Joostvdg's Software Engineering Page</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#fb8c00">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="orange" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../../#docker-graceful-shutdown" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://joostvdg.github.io" title="Joostvdg's Software Engineering Page" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Joostvdg's Software Engineering Page
              </span>
              <span class="md-header-nav__topic">
                Graceful shutdown
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/joostvdg/joostvdg.github.io/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      joostvdg/joostvdg.github.io
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://joostvdg.github.io" title="Joostvdg's Software Engineering Page" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Joostvdg's Software Engineering Page
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/joostvdg/joostvdg.github.io/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      joostvdg/joostvdg.github.io
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Java
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Java
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/" title="General" class="md-nav__link">
      General
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/spring/boot/" title="Spring Boot" class="md-nav__link">
      Spring Boot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/java9/" title="Java 9" class="md-nav__link">
      Java 9
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/ecosystem/" title="Java Ecosystem" class="md-nav__link">
      Java Ecosystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/networking/" title="Java Networking" class="md-nav__link">
      Java Networking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/streams/" title="Java Streams" class="md-nav__link">
      Java Streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/concurrency/" title="Java Concurrency" class="md-nav__link">
      Java Concurrency
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Docker
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Docker
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../multi-stage-builds/" title="Multi-Stage Builds" class="md-nav__link">
      Multi-Stage Builds
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Graceful shutdown
      </label>
    
    <a href="./" title="Graceful shutdown" class="md-nav__link md-nav__link--active">
      Graceful shutdown
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-case-for-graceful-shutdown" title="The case for graceful shutdown" class="md-nav__link">
    The case for graceful shutdown
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exec-form-vs-shell-form" title="Exec (form) vs Shell (form)" class="md-nav__link">
    Exec (form) vs Shell (form)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shell-form-example" title="Shell form example" class="md-nav__link">
    Shell form example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exec-form-example" title="Exec form example" class="md-nav__link">
    Exec form example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pid1" title="PID1" class="md-nav__link">
    PID1
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-docker-run-with-init" title="Example docker run with init" class="md-nav__link">
    Example docker run with init
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-dockerfile-with-tini" title="Example Dockerfile with tini" class="md-nav__link">
    Example Dockerfile with tini
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#signals" title="Signals" class="md-nav__link">
    Signals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" title="Examples" class="md-nav__link">
    Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#go" title="Go" class="md-nav__link">
    Go
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dockerfile" title="Dockerfile" class="md-nav__link">
    Dockerfile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#go-code-for-graceful-shutdown" title="Go code for graceful shutdown" class="md-nav__link">
    Go code for graceful shutdown
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java-plain-docker-swarm" title="Java plain (Docker Swarm)" class="md-nav__link">
    Java plain (Docker Swarm)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dockerfile_1" title="Dockerfile" class="md-nav__link">
    Dockerfile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-code" title="Handling code" class="md-nav__link">
    Handling code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java-plain-kubernetes" title="Java Plain (Kubernetes)" class="md-nav__link">
    Java Plain (Kubernetes)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#in-dockerfile" title="In Dockerfile" class="md-nav__link">
    In Dockerfile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-deployment" title="Kubernetes Deployment" class="md-nav__link">
    Kubernetes Deployment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java-spring-boot-1x" title="Java Spring Boot (1.x)" class="md-nav__link">
    Java Spring Boot (1.x)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execute-example" title="Execute example" class="md-nav__link">
    Execute example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dockerfile_2" title="Dockerfile" class="md-nav__link">
    Dockerfile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-compose-file" title="Docker compose file" class="md-nav__link">
    Docker compose file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java-handling-code" title="Java handling code" class="md-nav__link">
    Java handling code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-with-docker-swarm" title="Example with Docker Swarm" class="md-nav__link">
    Example with Docker Swarm
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docker-swarm-cluster" title="Docker swarm cluster" class="md-nav__link">
    Docker swarm cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-swarm-network-and-multicast" title="Docker swarm network and multicast" class="md-nav__link">
    Docker swarm network and multicast
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-stack" title="Docker stack" class="md-nav__link">
    Docker stack
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compose-file-docker-stackyml" title="Compose file (docker-stack.yml)" class="md-nav__link">
    Compose file (docker-stack.yml)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-stack" title="Create stack" class="md-nav__link">
    Create stack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-example_1" title="Execute example" class="md-nav__link">
    Execute example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" title="Further reading" class="md-nav__link">
    Further reading
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" title="References" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../swarm/" title="Swarm (mode)" class="md-nav__link">
      Swarm (mode)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../kubernetes/" title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Linux
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Linux
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../linux/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../linux/systemd/" title="SystemD" class="md-nav__link">
      SystemD
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../linux/networking/" title="Networking" class="md-nav__link">
      Networking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../linux/iptables/" title="iptables" class="md-nav__link">
      iptables
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Blogs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Blogs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/docker-graceful-shutdown/" title="Docker Graceful Shutdown" class="md-nav__link">
      Docker Graceful Shutdown
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/gitops-pipeline/" title="GitOps Pipeline" class="md-nav__link">
      GitOps Pipeline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/jenkins-pipeline-docker-alternatives/" title="Pipelines with Docker Alternatives" class="md-nav__link">
      Pipelines with Docker Alternatives
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/k8s-crd/" title="Create your own k8s resource" class="md-nav__link">
      Create your own k8s resource
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/k8s-controller/" title="Create your own k8s controller" class="md-nav__link">
      Create your own k8s controller
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/k8s-lets-encrypt/" title="Let's Encrypt for Kubernetes Apps" class="md-nav__link">
      Let's Encrypt for Kubernetes Apps
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/jenkins-pipeline-support-tool/" title="Jenkins Pipeline Support Tools" class="md-nav__link">
      Jenkins Pipeline Support Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/dockercon-eu-2018/" title="DockerCon EU 2018" class="md-nav__link">
      DockerCon EU 2018
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Kubernetes (K8S)
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Kubernetes (K8S)
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/cka-exam/" title="CKA Exam details" class="md-nav__link">
      CKA Exam details
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/cka-exam-prep/" title="CKA Exam prep" class="md-nav__link">
      CKA Exam prep
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      K8S CICD
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        K8S CICD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/cicd/cdp-jenkins-helm/" title="CD Pipeline Jenkins & Helm" class="md-nav__link">
      CD Pipeline Jenkins & Helm
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      K8S Distribution
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        K8S Distribution
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/distributions/install-gke/" title="GKE" class="md-nav__link">
      GKE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/distributions/aws-eks/" title="AWS EKS" class="md-nav__link">
      AWS EKS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      K8S Hard Way - GCE
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        K8S Hard Way - GCE
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/" title="Installer Preparation" class="md-nav__link">
      Installer Preparation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/terraform-compute/" title="Create GCE resources" class="md-nav__link">
      Create GCE resources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/certificates/" title="Prepare Certificates" class="md-nav__link">
      Prepare Certificates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/kubeconfigs/" title="Prepare Kubeconfigs" class="md-nav__link">
      Prepare Kubeconfigs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/encryption/" title="Encryption configuration" class="md-nav__link">
      Encryption configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/etcd/" title="ETCD configuration" class="md-nav__link">
      ETCD configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/controller/" title="Controller Config" class="md-nav__link">
      Controller Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/worker/" title="Worker Config" class="md-nav__link">
      Worker Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/remote-access/" title="Remote access" class="md-nav__link">
      Remote access
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/network/" title="Network config" class="md-nav__link">
      Network config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Software Engineering
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Software Engineering
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/naming/" title="Naming" class="md-nav__link">
      Naming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/ddd/" title="Domain Driven Design" class="md-nav__link">
      Domain Driven Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/microservices/" title="Microservices" class="md-nav__link">
      Microservices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/algorithms/" title="Algorithms" class="md-nav__link">
      Algorithms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/observability/" title="Observability" class="md-nav__link">
      Observability
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/others/" title="Others" class="md-nav__link">
      Others
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      Productivity
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        Productivity
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../productivity/" title="General" class="md-nav__link">
      General
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../productivity/tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../productivity/intellij/" title="Intelli J" class="md-nav__link">
      Intelli J
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../productivity/paradigms/" title="Paradigms" class="md-nav__link">
      Paradigms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../productivity/studies/" title="Studies" class="md-nav__link">
      Studies
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      Certificates
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        Certificates
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../certificates/lets-encrypt-k8s/" title="Let's Encrypt K8S" class="md-nav__link">
      Let's Encrypt K8S
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      Other
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        Other
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../other/mkdocs/" title="MKDocs (Static Website Generator)" class="md-nav__link">
      MKDocs (Static Website Generator)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../other/vim/" title="VIM" class="md-nav__link">
      VIM
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-14" type="checkbox" id="nav-14">
    
    <label class="md-nav__link" for="nav-14">
      CloudBees
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-14">
        CloudBees
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cloudbees/cbc-eks/" title="CloudBees Core on EKS" class="md-nav__link">
      CloudBees Core on EKS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cloudbees/cbc-post-install-tips/" title="CloudBees Core Post Install" class="md-nav__link">
      CloudBees Core Post Install
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../jenkins/" title="Jenkins" class="md-nav__link">
      Jenkins
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-16" type="checkbox" id="nav-16">
    
    <label class="md-nav__link" for="nav-16">
      Jenkins Job Management
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-16">
        Jenkins Job Management
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-jobs/jobdsl/" title="JobDSL" class="md-nav__link">
      JobDSL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-jobs/jenkins-jobs-builder/" title="JenkinsJobsBuilder" class="md-nav__link">
      JenkinsJobsBuilder
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-17" type="checkbox" id="nav-17">
    
    <label class="md-nav__link" for="nav-17">
      Jenkins Pipelines
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-17">
        Jenkins Pipelines
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/core-concepts/" title="Core Concepts" class="md-nav__link">
      Core Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/declarative-pipeline/" title="Pipeline (declarative)" class="md-nav__link">
      Pipeline (declarative)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/groovy-pipeline/" title="Groovy DSL Pipeline" class="md-nav__link">
      Groovy DSL Pipeline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/global-shared-library/" title="Pipeline Libraries" class="md-nav__link">
      Pipeline Libraries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/ide-integration-pipeline-dsl/" title="DSL IDE Integration" class="md-nav__link">
      DSL IDE Integration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/jenkins-parallel-pipeline/" title="Parallel" class="md-nav__link">
      Parallel
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/input/" title="Input" class="md-nav__link">
      Input
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-18" type="checkbox" id="nav-18">
    
    <label class="md-nav__link" for="nav-18">
      Jenkins Pipeline Examples
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-18">
        Jenkins Pipeline Examples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline-examples/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline-examples/docker-alternatives/" title="Docker Alternatives" class="md-nav__link">
      Docker Alternatives
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-18-3" type="checkbox" id="nav-18-3">
    
    <label class="md-nav__link" for="nav-18-3">
      Maven
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-18-3">
        Maven
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline-examples/maven-groovy-dsl/" title="Maven Groovy DSL" class="md-nav__link">
      Maven Groovy DSL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline-examples/maven-declarative/" title="Maven Declarative" class="md-nav__link">
      Maven Declarative
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline-examples/maven-shared-library/" title="Maven Shared Library" class="md-nav__link">
      Maven Shared Library
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-18-4" type="checkbox" id="nav-18-4">
    
    <label class="md-nav__link" for="nav-18-4">
      Other
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-18-4">
        Other
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline-examples/docker-declarative/" title="Docker Declarative" class="md-nav__link">
      Docker Declarative
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-case-for-graceful-shutdown" title="The case for graceful shutdown" class="md-nav__link">
    The case for graceful shutdown
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exec-form-vs-shell-form" title="Exec (form) vs Shell (form)" class="md-nav__link">
    Exec (form) vs Shell (form)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shell-form-example" title="Shell form example" class="md-nav__link">
    Shell form example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exec-form-example" title="Exec form example" class="md-nav__link">
    Exec form example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pid1" title="PID1" class="md-nav__link">
    PID1
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-docker-run-with-init" title="Example docker run with init" class="md-nav__link">
    Example docker run with init
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-dockerfile-with-tini" title="Example Dockerfile with tini" class="md-nav__link">
    Example Dockerfile with tini
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#signals" title="Signals" class="md-nav__link">
    Signals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" title="Examples" class="md-nav__link">
    Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#go" title="Go" class="md-nav__link">
    Go
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dockerfile" title="Dockerfile" class="md-nav__link">
    Dockerfile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#go-code-for-graceful-shutdown" title="Go code for graceful shutdown" class="md-nav__link">
    Go code for graceful shutdown
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java-plain-docker-swarm" title="Java plain (Docker Swarm)" class="md-nav__link">
    Java plain (Docker Swarm)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dockerfile_1" title="Dockerfile" class="md-nav__link">
    Dockerfile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-code" title="Handling code" class="md-nav__link">
    Handling code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java-plain-kubernetes" title="Java Plain (Kubernetes)" class="md-nav__link">
    Java Plain (Kubernetes)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#in-dockerfile" title="In Dockerfile" class="md-nav__link">
    In Dockerfile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-deployment" title="Kubernetes Deployment" class="md-nav__link">
    Kubernetes Deployment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java-spring-boot-1x" title="Java Spring Boot (1.x)" class="md-nav__link">
    Java Spring Boot (1.x)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execute-example" title="Execute example" class="md-nav__link">
    Execute example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dockerfile_2" title="Dockerfile" class="md-nav__link">
    Dockerfile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-compose-file" title="Docker compose file" class="md-nav__link">
    Docker compose file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java-handling-code" title="Java handling code" class="md-nav__link">
    Java handling code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-with-docker-swarm" title="Example with Docker Swarm" class="md-nav__link">
    Example with Docker Swarm
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docker-swarm-cluster" title="Docker swarm cluster" class="md-nav__link">
    Docker swarm cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-swarm-network-and-multicast" title="Docker swarm network and multicast" class="md-nav__link">
    Docker swarm network and multicast
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-stack" title="Docker stack" class="md-nav__link">
    Docker stack
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compose-file-docker-stackyml" title="Compose file (docker-stack.yml)" class="md-nav__link">
    Compose file (docker-stack.yml)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-stack" title="Create stack" class="md-nav__link">
    Create stack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-example_1" title="Execute example" class="md-nav__link">
    Execute example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" title="Further reading" class="md-nav__link">
    Further reading
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" title="References" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/joostvdg/joostvdg.github.io/edit/master/docs/docker/graceful-shutdown.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="docker-graceful-shutdown">Docker &amp; Graceful shutdown<a class="headerlink" href="#docker-graceful-shutdown" title="Permanent link">&para;</a></h1>
<h2 id="the-case-for-graceful-shutdown">The case for graceful shutdown<a class="headerlink" href="#the-case-for-graceful-shutdown" title="Permanent link">&para;</a></h2>
<blockquote>
<p>We can speak about the graceful shutdown of our application, when all of the resources it used and all of the traffic and/or data processing what it handled are closed and released properly.
  It means that no database connection remains open and no ongoing request fails because we stop our application. <sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup></p>
</blockquote>
<p>I thank <a href="https://blog.risingstack.com/graceful-shutdown-node-js-kubernetes/">Péter Márton</a> for the quote and giving a nice case for the graceful shutdown and docker.
Where his blog post goes into how to do this with/for Kubernetes, I will do this for Docker's Swarm (mode) orchestrator.</p>
<p>So, the case for graceful shutdown.
As the quote shows, what we mean with it, is that an application shuts down gracefully if it cleans up all its mess.</p>
<p>All things considered, I think most people would agree that cleaning up your mess - resources, connections or saying goodbye is preferred above just disappearing. </p>
<p>Shutting down nicely and leaving nothing behind will reduce the amount of potential (hard to debug) errors.
It also allows other applications or services to reliably know when you are there and when you're not there.
Not every application will have such dependencies (to it), but in today's cluster environments with many moving parts you'll never know.</p>
<p>So I would recommend to always do a graceful shutdown if you're able.
In the light of Docker, that might be a bit different than you're use to.</p>
<h2 id="exec-form-vs-shell-form">Exec (form) vs Shell (form)<a class="headerlink" href="#exec-form-vs-shell-form" title="Permanent link">&para;</a></h2>
<p>There are several ways to run a command in a <code>Dockerfile</code>.</p>
<p>These are are:</p>
<ul>
<li><strong>RUN</strong>: runs a command during the docker build phase</li>
<li><strong>CMD</strong>: runs a command when the container gets started</li>
<li><strong>ENTRYPOINT</strong>: provides the location from where commands get run when the container starts</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You need at least one ENTRYPOINT or CMD in a Dockerfile for it to be valid.
They can be used in collaboration but they can do similar things.</p>
</div>
<p>Al these commands can be put in both a shell form and a exec form <sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>. For more information on these commands you should check out <a href="http://www.johnzaccone.io/entrypoint-vs-cmd-back-to-basics/">John Zaccone's blog on Entrypoint vs CMD</a>.</p>
<p>In summary, the shell form will run the command as a shell command and spawn a process via <code>/bin/sh -c</code>.</p>
<p>Whereas the exec form will execute a child process that is still attached to PID1 <sup id="fnref:4"><a class="footnote-ref" href="#fn:4" rel="footnote">4</a></sup>.</p>
<p>This means that if you run the examples below, you will notice that you cannot <code>ctrl+c</code> out of the shell form, but you <strong>can</strong> out of the exec form.</p>
<p>Exec form is the recommended form to use and is a requirement for graceful shutdown.
Below you'll find some further reading on the CMD and ENTRYPOINT commands <sup id="fnref:5"><a class="footnote-ref" href="#fn:5" rel="footnote">5</a></sup><sup id="fnref:6"><a class="footnote-ref" href="#fn:6" rel="footnote">6</a></sup>.</p>
<h3 id="shell-form-example">Shell form example<a class="headerlink" href="#shell-form-example" title="Permanent link">&para;</a></h3>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> alpine  </span>
<span class="k">ENTRYPOINT</span><span class="s"> ping www.google.com  # &quot;shell&quot; format  </span>
</pre></div>
</td></tr></table>
<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup></p>
<h3 id="exec-form-example">Exec form example<a class="headerlink" href="#exec-form-example" title="Permanent link">&para;</a></h3>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> alpine  </span>
<span class="k">ENTRYPOINT</span><span class="s"> [&quot;ping&quot;, &quot;www.google.com&quot;]  # &quot;exec&quot; format  </span>
</pre></div>
</td></tr></table>
<sup id="fnref2:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup></p>
<h2 id="pid1">PID1<a class="headerlink" href="#pid1" title="Permanent link">&para;</a></h2>
<p>Now you run your commands nicely as PID1 and make sure it is your process that receives the <a href="http://man7.org/linux/man-pages/man7/signal.7.html">SIGNALS</a>.</p>
<p>Then all is good for a while, but at one point you will run into the problems of either having <a href="https://blog.phusion.nl/2015/01/20/docker-and-the-pid-1-zombie-reaping-problem">zombie child processes</a> or <a href="https://www.fpcomplete.com/blog/2016/10/docker-demons-pid1-orphans-zombies-signals">processes that aren't designed for running as PID1</a>.</p>
<p>This means you will have to do something about this, and luckily there's already some people who have done this for you.</p>
<p>There's <a href="https://github.com/krallin/tini">tini</a>: a tiny initialization system designed for Docker.</p>
<p>If used with the <em>exec</em> form it will run as PID1 and will manage your process and its child processes for you.</p>
<p>For what it adds exactly and why it was introduced, you can rever to <a href="https://github.com/krallin/tini/issues/8">this excellent explanation from its creator</a>.</p>
<p>In fact, tini was so successful, that <a href="https://github.com/krallin/tini/issues/81">docker included it in docker</a>!</p>
<p>While it works for <code>docker run</code> and <a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#init">docker compose</a> it doesn't yet work for Docker Swarm stacks.</p>
<h3 id="example-docker-run-with-init">Example docker run with init<a class="headerlink" href="#example-docker-run-with-init" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run <span class="se">\ </span>
    --rm <span class="se">\</span>
    -ti <span class="se">\</span>
<span class="hll">    --init<span class="se">\</span>
</span>    --name dui-test<span class="se">\</span>
     dui
</pre></div>
</td></tr></table>

<h3 id="example-dockerfile-with-tini">Example Dockerfile with tini<a class="headerlink" href="#example-dockerfile-with-tini" title="Permanent link">&para;</a></h3>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> debian:stable-slim</span>
<span class="k">ENV</span><span class="s"> TINI_VERSION v0.16.1</span>
<span class="k">ADD</span><span class="s"> https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini /tini</span>
<span class="k">RUN</span> chmod +x /tini
<span class="k">ENTRYPOINT</span><span class="s"> [&quot;/tini&quot;, &quot;-vv&quot;,&quot;-g&quot;, &quot;--&quot;, &quot;/usr/bin/dui&quot;]</span>
COPY --from<span class="o">=</span>build /usr/bin/dui-image/ /usr/bin/dui
</pre></div>
</td></tr></table>
Tini will be the entrypoint, executing our own user program (/usr/bin/dui).</p>
<p>This can also be achieved as follows:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">ENTRYPOINT</span><span class="s"> [&quot;/tini&quot;, &quot;-vv&quot;,&quot;-g&quot;, &quot;--&quot;]</span>
<span class="k">CMD</span><span class="s">[&quot;/usr/bin/dui&quot;]</span>
</pre></div>
</td></tr></table>

<ul>
<li><strong>-vv</strong>: debug log level 2 (-v =1, -vv=2, -vvv=3)</li>
<li><strong>-g</strong>: kill the entire group of processes when signal is received</li>
<li><strong>--</strong>: end of tini and start of your command </li>
</ul>
<h2 id="signals">Signals<a class="headerlink" href="#signals" title="Permanent link">&para;</a></h2>
<p>Now that we can correctly respond to signals we need to take care of which signals to listen to.</p>
<blockquote>
<p>There are essentially two commands: <code>docker stop</code> and <code>docker kill</code> that can be used to stop it. Behind the scenes, <code>docker stop</code> stops a running container by sending it SIGINT signal, let the main process process it, and after a grace period uses SIGKILL to terminate the application. <sup id="fnref:7"><a class="footnote-ref" href="#fn:7" rel="footnote">7</a></sup></p>
</blockquote>
<p>You can test it with the following image, which uses Java's shutdown hook to shutdown gracefully: this only happens when it is stopped.
Run the command below and press <code>ctrl+c</code>, and you will see that the application shuts down gracefully.</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run --rm -ti --name <span class="nb">test</span> caladreas/buming
</pre></div>
</td></tr></table>
Make sure you have two terminal windows open. In terminal one, run this command:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run -d --name <span class="nb">test</span> caladreas/buming
docker logs -f <span class="nb">test</span>
</pre></div>
</td></tr></table>

<p>In terminal two, run this command:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker rm -f <span class="nb">test</span>
</pre></div>
</td></tr></table>

<p>And now you will not see the graceful shutdown log, as the JVM was killed without being allowed to call shutdown hooks.</p>
<p>Docker allows you to specify which signal it should send via <code>--stop-signal</code> in the run command or <code>stop_signal:</code> in a compose file.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">&quot;3.5&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">yi</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dui</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
    <span class="l l-Scalar l-Scalar-Plain">stop_signal</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">SIGINT</span>
</pre></div>
</td></tr></table>

<h2 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">&para;</a></h2>
<p>How to actually listen to the signals and determine which one to use will depend on your programming language.</p>
<p>There's three examples I have worked out, one for Go (lang) and two for Java: pojo and Spring Boot.</p>
<h3 id="go">Go<a class="headerlink" href="#go" title="Permanent link">&para;</a></h3>
<h4 id="dockerfile">Dockerfile<a class="headerlink" href="#dockerfile" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># build stage</span>
FROM golang:latest AS build-env
RUN go get -v github.com/docker/docker/client/...
RUN go get -v github.com/docker/docker/api/...
ADD src/ <span class="nv">$GOPATH</span>/flow-proxy-service-lister
WORKDIR <span class="nv">$GOPATH</span>/flow-proxy-service-lister
RUN go build -o main -tags netgo main.go

<span class="c1"># final stage</span>
FROM alpine
ENTRYPOINT <span class="o">[</span><span class="s2">&quot;/app/main&quot;</span><span class="o">]</span>
COPY --from<span class="o">=</span>build-env /go/flow-proxy-service-lister/main /app/
RUN chmod +x /app/main
</pre></div>
</td></tr></table>

<h4 id="go-code-for-graceful-shutdown">Go code for graceful shutdown<a class="headerlink" href="#go-code-for-graceful-shutdown" title="Permanent link">&para;</a></h4>
<p>The following is a way for Go to shutdown a http server when receiving a termination signal.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="c1">// make channel for main &lt;--&gt; webserver communication</span>
    <span class="k">go</span> <span class="nx">webserver</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="s">&quot;7777&quot;</span><span class="p">,</span> <span class="nx">webserverData</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="c1">// ignore the missing data</span>

    <span class="nx">stop</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// make a channel that listens to is signals</span>
    <span class="nx">signal</span><span class="p">.</span><span class="nx">Notify</span><span class="p">(</span><span class="nx">stop</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGINT</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">)</span> <span class="c1">// we listen to some specific syscall signals</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span> <span class="c1">// this is still infinite</span>
        <span class="nx">t</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">NewTicker</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span> <span class="c1">// set a timer for the polling</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">stop</span><span class="p">:</span> <span class="c1">// this means we got a os signal on our channel</span>
            <span class="k">break</span> <span class="c1">// so we can stop</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">t</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
            <span class="c1">// our timer expired, refresh our data</span>
            <span class="k">continue</span> <span class="c1">// and continue with the loop</span>
        <span class="p">}</span>
        <span class="k">break</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Shutting down webserver&quot;</span><span class="p">)</span> <span class="c1">// if we got here, we have to inform the webserver to close shop</span>
    <span class="nx">c</span> <span class="o">&lt;-</span> <span class="kc">true</span> <span class="c1">// we do this by sending a message on the channel</span>
    <span class="k">if</span> <span class="nx">b</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">;</span> <span class="nx">b</span> <span class="p">{</span> <span class="c1">// when we get true back, that means the webserver is doing with a graceful shutdown</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Webserver shut down&quot;</span><span class="p">)</span> <span class="c1">// webserver is done</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Shut down app&quot;</span><span class="p">)</span> <span class="c1">// we can close shop ourselves now</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="java-plain-docker-swarm">Java plain (Docker Swarm)<a class="headerlink" href="#java-plain-docker-swarm" title="Permanent link">&para;</a></h3>
<p>This application is a Java 9 modular application, which can be found on github, <a href="https://github.com/joostvdg/buming">github.com/joostvdg</a>.</p>
<h4 id="dockerfile_1">Dockerfile<a class="headerlink" href="#dockerfile_1" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> openjdk:9-jdk AS build</span>

<span class="k">RUN</span> mkdir -p /usr/src/mods/jars
<span class="k">RUN</span> mkdir -p /usr/src/mods/compiled

COPY . /usr/src
<span class="k">WORKDIR</span><span class="s"> /usr/src</span>

<span class="k">RUN</span> javac -Xlint:unchecked -d /usr/src/mods/compiled --module-source-path /usr/src/src <span class="k">$(</span>find src -name <span class="s2">&quot;*.java&quot;</span><span class="k">)</span>
<span class="k">RUN</span> jar --create --file /usr/src/mods/jars/joostvdg.dui.logging.jar --module-version <span class="m">1</span>.0 -C /usr/src/mods/compiled/joostvdg.dui.logging .
<span class="k">RUN</span> jar --create --file /usr/src/mods/jars/joostvdg.dui.api.jar --module-version <span class="m">1</span>.0 -C /usr/src/mods/compiled/joostvdg.dui.api .
<span class="k">RUN</span> jar --create --file /usr/src/mods/jars/joostvdg.dui.client.jar --module-version <span class="m">1</span>.0 -C /usr/src/mods/compiled/joostvdg.dui.client .
<span class="k">RUN</span> jar --create --file /usr/src/mods/jars/joostvdg.dui.server.jar --module-version <span class="m">1</span>.0  -e com.github.joostvdg.dui.server.cli.DockerApp<span class="se">\</span>
    -C /usr/src/mods/compiled/joostvdg.dui.server .

<span class="k">RUN</span> rm -rf /usr/bin/dui-image
<span class="k">RUN</span> jlink --module-path /usr/src/mods/jars/:/<span class="si">${</span><span class="nv">JAVA_HOME</span><span class="si">}</span>/jmods <span class="se">\</span>
    --add-modules joostvdg.dui.api <span class="se">\</span>
    --add-modules joostvdg.dui.logging <span class="se">\</span>
    --add-modules joostvdg.dui.server <span class="se">\</span>
    --add-modules joostvdg.dui.client <span class="se">\</span>
    --launcher <span class="nv">dui</span><span class="o">=</span>joostvdg.dui.server <span class="se">\</span>
    --output /usr/bin/dui-image

<span class="k">RUN</span> ls -lath /usr/bin/dui-image
<span class="k">RUN</span> ls -lath /usr/bin/dui-image
<span class="k">RUN</span> /usr/bin/dui-image/bin/java --list-modules

<span class="k">FROM</span><span class="s"> debian:stable-slim</span>
LABEL <span class="nv">authors</span><span class="o">=</span><span class="s2">&quot;Joost van der Griendt &lt;joostvdg@gmail.com&gt;&quot;</span>
LABEL <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;0.1.0&quot;</span>
LABEL <span class="nv">description</span><span class="o">=</span><span class="s2">&quot;Docker image for playing with java applications in a concurrent, parallel and distributed manor.&quot;</span>
<span class="c"># Add Tini - it is already included: https://docs.docker.com/engine/reference/commandline/run/</span>
<span class="k">ENV</span><span class="s"> TINI_VERSION v0.16.1</span>
<span class="k">ADD</span><span class="s"> https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini /tini</span>
<span class="k">RUN</span> chmod +x /tini
<span class="k">ENTRYPOINT</span><span class="s"> [&quot;/tini&quot;, &quot;-vv&quot;,&quot;-g&quot;, &quot;--&quot;, &quot;/usr/bin/dui/bin/dui&quot;]</span>
<span class="k">ENV</span><span class="s"> DATE_CHANGED=&quot;20180120-1525&quot;</span>
COPY --from<span class="o">=</span>build /usr/bin/dui-image/ /usr/bin/dui
<span class="k">RUN</span> /usr/bin/dui/bin/java --list-modules
</pre></div>
</td></tr></table>

<h4 id="handling-code">Handling code<a class="headerlink" href="#handling-code" title="Permanent link">&para;</a></h4>
<p>The code first initializes the server which and when started, creates the <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/lang/hook-design.html">Shutdown Hook</a>.</p>
<p>Java handles certain signals in specific ways, as can be found <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/signals006.html#CIHBHCFE">in this table</a> for linux.
For more information, you can read the <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/signals.html">docs from Oracle</a>. </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DockerApp</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ServiceLoader</span><span class="o">&lt;</span><span class="n">Logger</span><span class="o">&gt;</span> <span class="n">loggers</span> <span class="o">=</span> <span class="n">ServiceLoader</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">Logger</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">loggers</span><span class="o">.</span><span class="na">findFirst</span><span class="o">().</span><span class="na">isPresent</span><span class="o">()</span> <span class="o">?</span> <span class="n">loggers</span><span class="o">.</span><span class="na">findFirst</span><span class="o">().</span><span class="na">get</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">logger</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Did not find any loggers, quiting&quot;</span><span class="o">);</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">);</span>

                <span class="kt">int</span> <span class="n">pseudoRandom</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">ProtocolConstants</span><span class="o">.</span><span class="na">POTENTIAL_SERVER_NAMES</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">serverName</span> <span class="o">=</span> <span class="n">ProtocolConstants</span><span class="o">.</span><span class="na">POTENTIAL_SERVER_NAMES</span><span class="o">[</span><span class="n">pseudoRandom</span><span class="o">];</span>
                <span class="kt">int</span> <span class="n">listenPort</span> <span class="o">=</span> <span class="n">ProtocolConstants</span><span class="o">.</span><span class="na">EXTERNAL_COMMUNICATION_PORT_A</span><span class="o">;</span>
                <span class="n">String</span> <span class="n">multicastGroup</span> <span class="o">=</span> <span class="n">ProtocolConstants</span><span class="o">.</span><span class="na">MULTICAST_GROUP</span><span class="o">;</span>

                <span class="n">DuiServer</span> <span class="n">distributedServer</span> <span class="o">=</span> <span class="n">DuiServerFactory</span><span class="o">.</span><span class="na">newDistributedServer</span><span class="o">(</span><span class="n">listenPort</span><span class="o">,</span><span class="n">multicastGroup</span> <span class="o">,</span> <span class="n">serverName</span><span class="o">,</span> <span class="n">logger</span><span class="o">);</span>

                <span class="n">distributedServer</span><span class="o">.</span><span class="na">logMembership</span><span class="o">();</span>

                <span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">distributedServer</span><span class="o">::</span><span class="n">startServer</span><span class="o">);</span>

                <span class="kt">long</span> <span class="n">threadId</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">();</span>

                <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">addShutdownHook</span><span class="o">(</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Shutdown hook called!&quot;</span><span class="o">);</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="na">WARN</span><span class="o">,</span> <span class="s">&quot;App&quot;</span><span class="o">,</span> <span class="s">&quot;ShotdownHook&quot;</span><span class="o">,</span> <span class="n">threadId</span><span class="o">,</span> <span class="s">&quot;Shutting down at request of Docker&quot;</span><span class="o">);</span>
                    <span class="n">distributedServer</span><span class="o">.</span><span class="na">stopServer</span><span class="o">();</span>
                    <span class="n">distributedServer</span><span class="o">.</span><span class="na">closeServer</span><span class="o">();</span>
                    <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdownNow</span><span class="o">();</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}));</span>        
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<h3 id="java-plain-kubernetes">Java Plain (Kubernetes)<a class="headerlink" href="#java-plain-kubernetes" title="Permanent link">&para;</a></h3>
<p>So far we've utilized the utilities from Docker itself in conjunction with it's native Docker Swarm orchestrator.</p>
<p>Unfortunately, when it comes to popularity <a href="https://platform9.com/blog/kubernetes-docker-swarm-compared/">Kubernetes beats Swarm hands down</a>.</p>
<p>So this isn't complete if it doesn't also do graceful shutdown in Kubernetes. </p>
<h4 id="in-dockerfile">In Dockerfile<a class="headerlink" href="#in-dockerfile" title="Permanent link">&para;</a></h4>
<p>Our original file had to be changed, as Debian's Slim image doesn't actually contain the kill package.
And we need a kill package, as we cannot instruct Kubernetes to issue a specific SIGNAL.
Instead, we can issue a <a href="https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/">PreStop exec command</a>, which we can utilise to execute a <a href="https://packages.debian.org/wheezy/psmisc">killall</a> java <a href="https://www.tecmint.com/how-to-kill-a-process-in-linux/">-INT</a>.</p>
<p>The command will be specified in the Kubernetes deployment definition below.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> openjdk:9-jdk AS build</span>

<span class="k">RUN</span> mkdir -p /usr/src/mods/jars
<span class="k">RUN</span> mkdir -p /usr/src/mods/compiled

COPY . /usr/src
<span class="k">WORKDIR</span><span class="s"> /usr/src</span>

<span class="k">RUN</span> javac -Xlint:unchecked -d /usr/src/mods/compiled --module-source-path /usr/src/src <span class="k">$(</span>find src -name <span class="s2">&quot;*.java&quot;</span><span class="k">)</span>
<span class="k">RUN</span> jar --create --file /usr/src/mods/jars/joostvdg.dui.logging.jar --module-version <span class="m">1</span>.0 -C /usr/src/mods/compiled/joostvdg.dui.logging .
<span class="k">RUN</span> jar --create --file /usr/src/mods/jars/joostvdg.dui.api.jar --module-version <span class="m">1</span>.0 -C /usr/src/mods/compiled/joostvdg.dui.api .
<span class="k">RUN</span> jar --create --file /usr/src/mods/jars/joostvdg.dui.client.jar --module-version <span class="m">1</span>.0 -C /usr/src/mods/compiled/joostvdg.dui.client .
<span class="k">RUN</span> jar --create --file /usr/src/mods/jars/joostvdg.dui.server.jar --module-version <span class="m">1</span>.0  -e com.github.joostvdg.dui.server.cli.DockerApp<span class="se">\</span>
    -C /usr/src/mods/compiled/joostvdg.dui.server .

<span class="k">RUN</span> rm -rf /usr/bin/dui-image
<span class="k">RUN</span> jlink --module-path /usr/src/mods/jars/:/<span class="si">${</span><span class="nv">JAVA_HOME</span><span class="si">}</span>/jmods <span class="se">\</span>
    --add-modules joostvdg.dui.api <span class="se">\</span>
    --add-modules joostvdg.dui.logging <span class="se">\</span>
    --add-modules joostvdg.dui.server <span class="se">\</span>
    --add-modules joostvdg.dui.client <span class="se">\</span>
    --launcher <span class="nv">dui</span><span class="o">=</span>joostvdg.dui.server <span class="se">\</span>
    --output /usr/bin/dui-image

<span class="k">RUN</span> ls -lath /usr/bin/dui-image
<span class="k">RUN</span> ls -lath /usr/bin/dui-image
<span class="k">RUN</span> /usr/bin/dui-image/bin/java --list-modules

<span class="k">FROM</span><span class="s"> debian:stable-slim</span>
LABEL <span class="nv">authors</span><span class="o">=</span><span class="s2">&quot;Joost van der Griendt &lt;joostvdg@gmail.com&gt;&quot;</span>
LABEL <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;0.1.0&quot;</span>
LABEL <span class="nv">description</span><span class="o">=</span><span class="s2">&quot;Docker image for playing with java applications in a concurrent, parallel and distributed manor.&quot;</span>
<span class="c"># Add Tini - it is already included: https://docs.docker.com/engine/reference/commandline/run/</span>
<span class="k">ENV</span><span class="s"> TINI_VERSION v0.16.1</span>
<span class="k">ADD</span><span class="s"> https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini /tini</span>
<span class="k">RUN</span> chmod +x /tini
<span class="k">ENTRYPOINT</span><span class="s"> [&quot;/tini&quot;, &quot;-vv&quot;,&quot;-g&quot;, &quot;--&quot;, &quot;/usr/bin/dui/bin/dui&quot;]</span>
<span class="k">ENV</span><span class="s"> DATE_CHANGED=&quot;20180120-1525&quot;</span>
<span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install --no-install-recommends -y <span class="nv">psmisc</span><span class="o">=</span><span class="m">22</span>.* <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*
COPY --from<span class="o">=</span>build /usr/bin/dui-image/ /usr/bin/dui
<span class="k">RUN</span> /usr/bin/dui/bin/java --list-modules
</pre></div>
</td></tr></table>

<h4 id="kubernetes-deployment">Kubernetes Deployment<a class="headerlink" href="#kubernetes-deployment" title="Permanent link">&para;</a></h4>
<p>So here we have the image's K8s <a href="">Deployment</a> descriptor.</p>
<p>Including the Pod's <a href="">lifecycle</a> <code>preStop</code> with a exec style command. You should know by now <a href="http://www.johnzaccone.io/entrypoint-vs-cmd-back-to-basics/">why we prefer that</a>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dui-deployment</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">k8s-app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dui</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">k8s-app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dui</span>
    <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
          <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">caladreas/buming</span>
          <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
              <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">7777</span>
          <span class="l l-Scalar l-Scalar-Plain">lifecycle</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">preStop</span><span class="p p-Indicator">:</span>
              <span class="l l-Scalar l-Scalar-Plain">exec</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;killall&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;java&quot;</span> <span class="p p-Indicator">,</span> <span class="s">&quot;-INT&quot;</span><span class="p p-Indicator">]</span>
      <span class="l l-Scalar l-Scalar-Plain">terminationGracePeriodSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>
</pre></div>
</td></tr></table>

<h3 id="java-spring-boot-1x">Java Spring Boot (1.x)<a class="headerlink" href="#java-spring-boot-1x" title="Permanent link">&para;</a></h3>
<p>This example is for Spring Boot 1.x, in time we will have an example for 2.x.</p>
<p>This example is for the scenario of a Fat Jar with Tomcat as container <sup id="fnref:8"><a class="footnote-ref" href="#fn:8" rel="footnote">8</a></sup>.</p>
<h4 id="execute-example">Execute example<a class="headerlink" href="#execute-example" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker-compose build
</pre></div>
</td></tr></table>

<p>Execute the following command:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run --rm -ti --name <span class="nb">test</span> spring-boot-graceful
</pre></div>
</td></tr></table>

<p>Exit the application/container via <code>ctrl+c</code> and you should see the application shutting down gracefully.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="m">2018</span>-01-30 <span class="m">13</span>:35:46.327  INFO <span class="m">7</span> --- <span class="o">[</span>       Thread-3<span class="o">]</span> ationConfigEmbeddedWebApplicationContext : Closing org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@6e5e91e4: startup date <span class="o">[</span>Tue Jan <span class="m">30</span> <span class="m">13</span>:35:42 GMT <span class="m">2018</span><span class="o">]</span><span class="p">;</span> root of context hierarchy
<span class="m">2018</span>-01-30 <span class="m">13</span>:35:46.405  INFO <span class="m">7</span> --- <span class="o">[</span>       Thread-3<span class="o">]</span> BootGracefulApplication<span class="nv">$GracefulShutdown</span> : Tomcat was shutdown gracefully within the allotted time.
<span class="m">2018</span>-01-30 <span class="m">13</span>:35:46.408  INFO <span class="m">7</span> --- <span class="o">[</span>       Thread-3<span class="o">]</span> o.s.j.e.a.AnnotationMBeanExporter        : Unregistering JMX-exposed beans on shutdown
</pre></div>
</td></tr></table>

<h4 id="dockerfile_2">Dockerfile<a class="headerlink" href="#dockerfile_2" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> maven:3-jdk-8 AS build</span>
<span class="k">ENV</span><span class="s"> MAVEN_OPTS=-Dmaven.repo.local=/usr/share/maven/repository</span>
<span class="k">ENV</span><span class="s"> WORKDIR=/usr/src/graceful</span>
<span class="k">RUN</span> mkdir <span class="nv">$WORKDIR</span>
<span class="k">WORKDIR</span><span class="s"> $WORKDIR</span>
COPY pom.xml <span class="nv">$WORKDIR</span>
<span class="k">RUN</span> mvn -B -e org.apache.maven.plugins:maven-dependency-plugin:3.0.2:go-offline
COPY . <span class="nv">$WORKSPACE</span>
<span class="k">RUN</span> mvn -B -e clean verify

<span class="k">FROM</span><span class="s"> anapsix/alpine-java:8_jdk_unlimited</span>
LABEL <span class="nv">authors</span><span class="o">=</span><span class="s2">&quot;Joost van der Griendt &lt;joostvdg@gmail.com&gt;&quot;</span>
<span class="k">ENV</span><span class="s"> TINI_VERSION v0.16.1</span>
<span class="k">ADD</span><span class="s"> https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini /tini</span>
<span class="k">RUN</span> chmod +x /tini
<span class="k">ENTRYPOINT</span><span class="s"> [&quot;/tini&quot;, &quot;-vv&quot;,&quot;-g&quot;, &quot;--&quot;]</span>
<span class="k">ENV</span><span class="s"> DATE_CHANGED=&quot;20180120-1525&quot;</span>
COPY --from<span class="o">=</span>build /usr/src/graceful/target/spring-boot-graceful.jar /app.jar
<span class="k">CMD</span><span class="s"> [&quot;java&quot;, &quot;-Xms256M&quot;,&quot;-Xmx480M&quot;, &quot;-Djava.security.egd=file:/dev/./urandom&quot;, &quot;-jar&quot;, &quot;/app.jar&quot;]</span>
</pre></div>
</td></tr></table>

<h4 id="docker-compose-file">Docker compose file<a class="headerlink" href="#docker-compose-file" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">&quot;3.5&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">web</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">spring-boot-graceful</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
    <span class="l l-Scalar l-Scalar-Plain">stop_signal</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">SIGINT</span>
</pre></div>
</td></tr></table>

<h4 id="java-handling-code">Java handling code<a class="headerlink" href="#java-handling-code" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">com.github.joostvdg.demo.springbootgraceful</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.catalina.connector.Connector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.tomcat.util.threads.ThreadPoolExecutor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.context.embedded.ConfigurableEmbeddedServletContainer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.context.embedded.EmbeddedServletContainerCustomizer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.context.embedded.tomcat.TomcatConnectorCustomizer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.event.ContextClosedEvent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.Executor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringBootGracefulApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">SpringBootGracefulApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">GracefulShutdown</span> <span class="nf">gracefulShutdown</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">GracefulShutdown</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">EmbeddedServletContainerCustomizer</span> <span class="nf">tomcatCustomizer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">EmbeddedServletContainerCustomizer</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">customize</span><span class="o">(</span><span class="n">ConfigurableEmbeddedServletContainer</span> <span class="n">container</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">container</span> <span class="k">instanceof</span> <span class="n">TomcatEmbeddedServletContainerFactory</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">((</span><span class="n">TomcatEmbeddedServletContainerFactory</span><span class="o">)</span> <span class="n">container</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">addConnectorCustomizers</span><span class="o">(</span><span class="n">gracefulShutdown</span><span class="o">());</span>
                <span class="o">}</span>

            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">GracefulShutdown</span> <span class="kd">implements</span> <span class="n">TomcatConnectorCustomizer</span><span class="o">,</span>
            <span class="n">ApplicationListener</span><span class="o">&lt;</span><span class="n">ContextClosedEvent</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">GracefulShutdown</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">Connector</span> <span class="n">connector</span><span class="o">;</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">customize</span><span class="o">(</span><span class="n">Connector</span> <span class="n">connector</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">connector</span> <span class="o">=</span> <span class="n">connector</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="n">ContextClosedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">connector</span><span class="o">.</span><span class="na">pause</span><span class="o">();</span>
            <span class="n">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">connector</span><span class="o">.</span><span class="na">getProtocolHandler</span><span class="o">().</span><span class="na">getExecutor</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">executor</span> <span class="k">instanceof</span> <span class="n">ThreadPoolExecutor</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">ThreadPoolExecutor</span> <span class="n">threadPoolExecutor</span> <span class="o">=</span> <span class="o">(</span><span class="n">ThreadPoolExecutor</span><span class="o">)</span> <span class="n">executor</span><span class="o">;</span>
                    <span class="n">threadPoolExecutor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">threadPoolExecutor</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;Tomcat thread pool did not shut down gracefully within &quot;</span>
                                <span class="o">+</span> <span class="s">&quot;30 seconds. Proceeding with forceful shutdown&quot;</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Tomcat was shutdown gracefully within the allotted time.&quot;</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<h2 id="example-with-docker-swarm">Example with Docker Swarm<a class="headerlink" href="#example-with-docker-swarm" title="Permanent link">&para;</a></h2>
<p>For now there's only an example with <a href="https://docs.docker.com/engine/swarm/">docker swarm</a>, in time there will also be a <a href="https://kubernetes.io/">Kubernetes</a> example.</p>
<p>Now that you can create Java applications packaged neatly in Docker images that support graceful shutdown, it would be nice to utilize.</p>
<p>A good scenario would be a microservices architecture where services can come and go, but are registered in a <a href="https://spring.io/guides/gs/service-registration-and-discovery/">service registry such as Eureka</a>.</p>
<p>Or a membership based protocol where members interact with each other and perhaps shard data.</p>
<p>In these cases, of course the interactions are designed to be fault tolerant and discover faulty nodes on their own.
But wouldn't it be better that if you knew you're going to quit, you inform the rest?</p>
<p>We can reuse the <code>caladreas/buming</code> image and make it a docker swarm stack and run the service on every node.
This way, we can easily see members coming and going and reduce the time to detect failure by notifying our peers of our impeding end.  </p>
<h3 id="docker-swarm-cluster">Docker swarm cluster<a class="headerlink" href="#docker-swarm-cluster" title="Permanent link">&para;</a></h3>
<p>Setting up a docker swarm cluster is easy, but has some requirements:</p>
<ul>
<li>virtual box 4.x+</li>
<li>docker-machine 1.12+</li>
<li>docker 17.06+</li>
</ul>
<div class="admonition warn">
<p class="admonition-title">Warn</p>
<p>Make sure this is the first and only virtualbox docker-machine VM being created/running, so that the ip range starts with 192.168.99.100</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker-machine create --driver virtualbox dui-1
docker-machine create --driver virtualbox dui-2
docker-machine create --driver virtualbox dui-3

<span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>docker-machine env dui-1<span class="k">)</span><span class="s2">&quot;</span>
<span class="nv">IP</span><span class="o">=</span><span class="m">192</span>.168.99.100
docker swarm init --advertise-addr <span class="nv">$IP</span>
<span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>docker swarm join-token -q worker<span class="k">)</span>

<span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>docker-machine env dui-2<span class="k">)</span><span class="s2">&quot;</span>
docker swarm join --token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span> <span class="si">${</span><span class="nv">IP</span><span class="si">}</span>:2377

<span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>docker-machine env dui-3<span class="k">)</span><span class="s2">&quot;</span>
docker swarm join --token <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span> <span class="si">${</span><span class="nv">IP</span><span class="si">}</span>:2377

<span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>docker-machine env dui-1<span class="k">)</span><span class="s2">&quot;</span>
docker node ls
</pre></div>
</td></tr></table>

<h3 id="docker-swarm-network-and-multicast">Docker swarm network and multicast<a class="headerlink" href="#docker-swarm-network-and-multicast" title="Permanent link">&para;</a></h3>
<p>Unfortunately, docker swarm's swarm mode network <a href="http://blog.nigelpoulton.com/demystifying-docker-overlay-networking/">overlay</a> does not support multicast <sup id="fnref:9"><a class="footnote-ref" href="#fn:9" rel="footnote">9</a></sup><sup id="fnref:10"><a class="footnote-ref" href="#fn:10" rel="footnote">10</a></sup>.</p>
<p>Why is this a problem? Well, the application I use to test the graceful shutdown requires this, sorry.</p>
<p>Luckily there is a very easy solution for this, its by using <a href="https://www.weave.works/blog/weave-net-2-released">Weavenet</a>'s docker network plugin.</p>
<p>Don't want to know about it or how you install it? Don't worry, just execute the script below.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="nb">echo</span> <span class="s2">&quot;=&gt; Prepare dui-2&quot;</span>
<span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>docker-machine env dui-2<span class="k">)</span><span class="s2">&quot;</span>
docker plugin install weaveworks/net-plugin:2.1.3 --grant-all-permissions
docker plugin disable weaveworks/net-plugin:2.1.3
docker plugin <span class="nb">set</span> weaveworks/net-plugin:2.1.3 <span class="nv">WEAVE_MULTICAST</span><span class="o">=</span><span class="m">1</span>
docker plugin <span class="nb">enable</span> weaveworks/net-plugin:2.1.3

<span class="nb">echo</span> <span class="s2">&quot;=&gt; Prepare dui-3&quot;</span>
<span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>docker-machine env dui-3<span class="k">)</span><span class="s2">&quot;</span>
docker plugin install weaveworks/net-plugin:2.1.3 --grant-all-permissions
docker plugin disable weaveworks/net-plugin:2.1.3
docker plugin <span class="nb">set</span> weaveworks/net-plugin:2.1.3 <span class="nv">WEAVE_MULTICAST</span><span class="o">=</span><span class="m">1</span>
docker plugin <span class="nb">enable</span> weaveworks/net-plugin:2.1.3

<span class="nb">echo</span> <span class="s2">&quot;=&gt; Prepare dui-1&quot;</span>
<span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>docker-machine env dui-1<span class="k">)</span><span class="s2">&quot;</span>
docker plugin install weaveworks/net-plugin:2.1.3 --grant-all-permissions
docker plugin disable weaveworks/net-plugin:2.1.3
docker plugin <span class="nb">set</span> weaveworks/net-plugin:2.1.3 <span class="nv">WEAVE_MULTICAST</span><span class="o">=</span><span class="m">1</span>
docker plugin <span class="nb">enable</span> weaveworks/net-plugin:2.1.3
docker network create --driver<span class="o">=</span>weaveworks/net-plugin:2.1.3 --opt works.weave.multicast<span class="o">=</span><span class="nb">true</span> --attachable dui
</pre></div>
</td></tr></table>

<h3 id="docker-stack">Docker stack<a class="headerlink" href="#docker-stack" title="Permanent link">&para;</a></h3>
<p>Now to create a service that runs on every node it is the easiest to create a <a href="https://docs.docker.com/get-started/part5/">docker stack</a>.</p>
<h4 id="compose-file-docker-stackyml">Compose file (docker-stack.yml)<a class="headerlink" href="#compose-file-docker-stackyml" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">&quot;3.5&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">dui</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">caladreas/buming</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
    <span class="l l-Scalar l-Scalar-Plain">stop_signal</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">SIGINT</span>
    <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">dui</span>
    <span class="l l-Scalar l-Scalar-Plain">deploy</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">global</span>
<span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">dui</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">external</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</td></tr></table>

<h4 id="create-stack">Create stack<a class="headerlink" href="#create-stack" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker stack deploy --compose-file docker-stack.yml buming
</pre></div>
</td></tr></table>

<h3 id="execute-example_1">Execute example<a class="headerlink" href="#execute-example_1" title="Permanent link">&para;</a></h3>
<p>Now that we have a docker swarm cluster and a stack - which has a service running on every node - we can showcase the power of graceful shutdown in a cluster of dependent services.</p>
<p>Confirm the service is running correctly on every node, first lets check our nodes.</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>docker-machine env dui-1<span class="k">)</span><span class="s2">&quot;</span>
docker node ls
</pre></div>
</td></tr></table>
Which should look like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS
f21ilm4thxegn5xbentmss5ur *   dui-1               Ready               Active              Leader
y7475bo5uplt2b58d050b4wfd     dui-2               Ready               Active              
6ssxola6y1i6h9p8256pi7bfv     dui-3               Ready               Active                            
</pre></div>
</td></tr></table>

<p>Then check the service.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker service ps buming_dui
</pre></div>
</td></tr></table>

<p>Which should look like this.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ID                  NAME                                   IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
3mrpr0jg31x1        buming_dui.6ssxola6y1i6h9p8256pi7bfv   dui:latest          dui-3               Running             Running <span class="m">17</span> seconds ago                       
pfubtiy4j7vo        buming_dui.f21ilm4thxegn5xbentmss5ur   dui:latest          dui-1               Running             Running <span class="m">17</span> seconds ago                       
f4gjnmhoe3y4        buming_dui.y7475bo5uplt2b58d050b4wfd   dui:latest          dui-2               Running             Running <span class="m">17</span> seconds ago                       
</pre></div>
</td></tr></table>

<p>Now open a second terminal window.
In window one, follow the service logs:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>docker-machine env dui-1<span class="k">)</span><span class="s2">&quot;</span>
docker service logs -f buming_dui
</pre></div>
</td></tr></table>

<p>In window two, go to a different node and stop the container.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">eval</span> <span class="s2">&quot;</span><span class="k">$(</span>docker-machine env dui-2<span class="k">)</span><span class="s2">&quot;</span>
docker ps
docker stop buming_dui.y7475bo5uplt2b58d050b4wfd.pnoui2x6elrz0tvkjz51njz94
</pre></div>
</td></tr></table>

<p>In this case, you will see the other nodes receiving a leave notice and then the node stopping.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>buming_dui.0.ryd8szexxku3@dui-3    <span class="p">|</span> <span class="o">[</span>Server-John D. Carmack<span class="o">]</span>           <span class="o">[</span>WARN<span class="o">]</span>  <span class="o">[</span><span class="m">14</span>:19:02.604011<span class="o">]</span>   <span class="o">[</span><span class="m">16</span><span class="o">]</span>    <span class="o">[</span>Main<span class="o">]</span>              Received membership leave notice from MessageOrigin<span class="o">{</span><span class="nv">host</span><span class="o">=</span><span class="s1">&#39;83918f6ad817&#39;</span>, <span class="nv">ip</span><span class="o">=</span><span class="s1">&#39;10.0.0.7&#39;</span>, <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;Ken Thompson&#39;</span><span class="o">}</span>
buming_dui.0.so5m14sz8ksh@dui-1    <span class="p">|</span> <span class="o">[</span>Server-Alan Kay<span class="o">]</span>                  <span class="o">[</span>WARN<span class="o">]</span>  <span class="o">[</span><span class="m">14</span>:19:02.602082<span class="o">]</span>   <span class="o">[</span><span class="m">16</span><span class="o">]</span>    <span class="o">[</span>Main<span class="o">]</span>              Received membership leave notice from MessageOrigin<span class="o">{</span><span class="nv">host</span><span class="o">=</span><span class="s1">&#39;83918f6ad817&#39;</span>, <span class="nv">ip</span><span class="o">=</span><span class="s1">&#39;10.0.0.7&#39;</span>, <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;Ken Thompson&#39;</span><span class="o">}</span>
buming_dui.0.pnoui2x6elrz@dui-2    <span class="p">|</span> Shutdown hook called!
buming_dui.0.pnoui2x6elrz@dui-2    <span class="p">|</span> <span class="o">[</span>App<span class="o">]</span>                              <span class="o">[</span>WARN<span class="o">]</span>  <span class="o">[</span><span class="m">14</span>:19:02.598759<span class="o">]</span>   <span class="o">[</span><span class="m">1</span><span class="o">]</span> <span class="o">[</span>ShotdownHook<span class="o">]</span>      Shutting down at request of Docker
buming_dui.0.pnoui2x6elrz@dui-2    <span class="p">|</span> <span class="o">[</span>Server-Ken Thompson<span class="o">]</span>              <span class="o">[</span>INFO<span class="o">]</span>  <span class="o">[</span><span class="m">14</span>:19:02.598858<span class="o">]</span>   <span class="o">[</span><span class="m">12</span><span class="o">]</span>    <span class="o">[</span>Main<span class="o">]</span>               Stopping
buming_dui.0.pnoui2x6elrz@dui-2    <span class="p">|</span> <span class="o">[</span>Server-Ken Thompson<span class="o">]</span>              <span class="o">[</span>INFO<span class="o">]</span>  <span class="o">[</span><span class="m">14</span>:19:02.601008<span class="o">]</span>   <span class="o">[</span><span class="m">12</span><span class="o">]</span>    <span class="o">[</span>Main<span class="o">]</span>               Closing
</pre></div>
</td></tr></table>

<h2 id="further-reading">Further reading<a class="headerlink" href="#further-reading" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Reboot_(computing)">Wikipedia page on reboots</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms738547(v=vs.85).aspx">Microsoft about graceful shutdown</a></li>
<li><a href="https://www.ctl.io/developers/blog/post/gracefully-stopping-docker-containers/">Gracefully stopping docker containers</a></li>
<li><a href="https://dzone.com/articles/know-jvm-series-2-shutdown">What to know about Java and shutdown hooks</a></li>
<li><a href="https://www.weave.works/blog/docker-container-networking-multicast-fast/">https://www.weave.works/blog/docker-container-networking-multicast-fast/</a></li>
<li><a href="https://www.weave.works/docs/net/latest/install/plugin/plugin-how-it-works/">https://www.weave.works/docs/net/latest/install/plugin/plugin-how-it-works/</a></li>
<li><a href="https://www.weave.works/docs/net/latest/install/plugin/plugin-v2/">https://www.weave.works/docs/net/latest/install/plugin/plugin-v2/</a></li>
<li><a href="https://www.auzias.net/en/docker-network-multihost/">https://www.auzias.net/en/docker-network-multihost/</a></li>
<li><a href="https://forums.docker.com/t/cannot-get-zookeeper-to-work-running-in-docker-using-swarm-mode/27109">https://forums.docker.com/t/cannot-get-zookeeper-to-work-running-in-docker-using-swarm-mode/27109</a></li>
<li><a href="https://github.com/docker/libnetwork/issues/740">https://github.com/docker/libnetwork/issues/740</a></li>
</ul>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://blog.risingstack.com/graceful-shutdown-node-js-kubernetes/">Péter Márton(@slashdotpeter) Gracefule Shutdown NodeJS Kubernetes</a>&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p><a href="https://docs.docker.com/engine/reference/builder/">Docker docs on building</a>&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p><a href="http://www.johnzaccone.io/entrypoint-vs-cmd-back-to-basics/">John Zaccone on Entrypoint vs CMD</a>&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a><a class="footnote-backref" href="#fnref2:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p><a href="https://www.lifewire.com/exec-linux-command-unix-command-4097150">Linux Exec command</a>&#160;<a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p><a href="https://stackoverflow.com/questions/21553353/what-is-the-difference-between-cmd-and-entrypoint-in-a-dockerfile">Stackoverflow thread on CMD vs Entrypoint</a>&#160;<a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p><a href="https://blog.codeship.com/understanding-dockers-cmd-and-entrypoint-instructions/">Codeship blog on CMD and Entrypoint details</a>&#160;<a class="footnote-backref" href="#fnref:6" rev="footnote" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:7">
<p><a href="https://medium.com/@gchudnov/trapping-signals-in-docker-containers-7a57fdda7d86">Grigorii Chudnov blog on Trapping Docker Signals</a>&#160;<a class="footnote-backref" href="#fnref:7" rev="footnote" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn:8">
<p><a href="https://github.com/spring-projects/spring-boot/issues/4657#issuecomment-161354811">Andy Wilkinson (from pivotal) explaining Spring Boot shutdown hook for Tomcat</a>&#160;<a class="footnote-backref" href="#fnref:8" rev="footnote" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
<li id="fn:9">
<p><a href="https://github.com/docker/swarm/issues/1691">Docker Swarm issue with multicast</a>&#160;<a class="footnote-backref" href="#fnref:9" rev="footnote" title="Jump back to footnote 9 in the text">&#8617;</a></p>
</li>
<li id="fn:10">
<p><a href="https://github.com/docker/libnetwork/issues/552">Docker network library issue with multicast</a>&#160;<a class="footnote-backref" href="#fnref:10" rev="footnote" title="Jump back to footnote 10 in the text">&#8617;</a></p>
</li>
<li id="fn:11">
<p><a href="https://jaxenter.com/nobody-puts-java-container-139373.html">Excellent article on JVM details inside Containers</a>&#160;<a class="footnote-backref" href="#fnref:11" rev="footnote" title="Jump back to footnote 11 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../multi-stage-builds/" title="Multi-Stage Builds" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Multi-Stage Builds
              </span>
            </div>
          </a>
        
        
          <a href="../swarm/" title="Swarm (mode)" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Swarm (mode)
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 Joost van der Griendt
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/joostvdg" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/joost_vdg" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/in/joostvdg" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.583bbe55.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>