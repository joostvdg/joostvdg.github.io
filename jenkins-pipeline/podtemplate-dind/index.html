<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Jenkins on Kubernetes building with Docker in Docker via PodTemplate"><link href=https://joostvdg.github.io/jenkins-pipeline/podtemplate-dind/ rel=canonical><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.2"><title>Jenkins Docker-in-Docker With PodTemplate</title><link rel=stylesheet href=../../assets/stylesheets/application.30686662.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#fb8c00><script src=../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-145385967-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-primary=orange data-md-color-accent=red> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#docker-in-docker-with-podtemplates tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-header-nav__button md-logo"> <i class=md-icon>public</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> J's Software Development Pages </span> <span class=md-header-nav__topic> Jenkins Docker-in-Docker With PodTemplate </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../blogs/jenkins-pipeline-support-tool/ class=md-tabs__link> Blogs </a> </li> <li class=md-tabs__item> <a href=../../cloudbees/sso-azure-ad/ class=md-tabs__link> CICD </a> </li> <li class=md-tabs__item> <a href=../../kubernetes/ class=md-tabs__link> Containers </a> </li> <li class=md-tabs__item> <a href=../../cloud/automation-pulumi/ class=md-tabs__link> Cloud </a> </li> <li class=md-tabs__item> <a href=../../certificates/lets-encrypt-k8s/ class=md-tabs__link> SWE </a> </li> <li class=md-tabs__item> <a href=../../java/ class=md-tabs__link> Java </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-nav__button md-logo"> <i class=md-icon>public</i> </a> J's Software Development Pages </label> <div class=md-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> Home </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-1> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Me class=md-nav__link> Me </a> </li> <li class=md-nav__item> <a href=../../other/mkdocs/ title="MKDocs (This Static Website)" class=md-nav__link> MKDocs (This Static Website) </a> </li> <li class=md-nav__item> <a href=../../other/vim/ title=VIM class=md-nav__link> VIM </a> </li> <li class=md-nav__item> <a href=../../other/shell/ title=Shell class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Blogs </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Blogs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../blogs/jenkins-pipeline-support-tool/ title="Jenkins Pipeline Support Tools" class=md-nav__link> Jenkins Pipeline Support Tools </a> </li> <li class=md-nav__item> <a href=../../blogs/graceful-shutdown/ title="Docker Graceful Shutdown" class=md-nav__link> Docker Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../blogs/docker-alternatives/ title="Pipelines with Docker Alternatives" class=md-nav__link> Pipelines with Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../blogs/k8s-lets-encrypt/ title="Let's Encrypt for Kubernetes Apps" class=md-nav__link> Let's Encrypt for Kubernetes Apps </a> </li> <li class=md-nav__item> <a href=../../blogs/sso-azure-ad/ title="CloudBees SSO Azure AD" class=md-nav__link> CloudBees SSO Azure AD </a> </li> <li class=md-nav__item> <a href=../../blogs/teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../../blogs/kubernetes-sso-keycloak/ title="Kubernetes SSO Keycloak" class=md-nav__link> Kubernetes SSO Keycloak </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-8 type=checkbox id=nav-2-8> <label class=md-nav__link for=nav-2-8> Jenkins Monitoring Kubernetes </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-8> Jenkins Monitoring Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/introduction/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/prepare/ title="Prepare Environment" class=md-nav__link> Prepare Environment </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/install/ title="Install Tools" class=md-nav__link> Install Tools </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/metrics/ title=Metrics class=md-nav__link> Metrics </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/alerts/ title=Alerts class=md-nav__link> Alerts </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/pipeline/ title=Pipeline class=md-nav__link> Pipeline </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/dashboard/ title=Dashboard class=md-nav__link> Dashboard </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/cloudbees/ title=CloudBees class=md-nav__link> CloudBees </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../blogs/k8s-crd/ title="Create your own k8s resource" class=md-nav__link> Create your own k8s resource </a> </li> <li class=md-nav__item> <a href=../../blogs/dockercon-eu-2018/ title="DockerCon EU 2018" class=md-nav__link> DockerCon EU 2018 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3 checked> <label class=md-nav__link for=nav-3> CICD </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> CICD </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-1 type=checkbox id=nav-3-1> <label class=md-nav__link for=nav-3-1> CloudBees </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-1> CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloudbees/sso-azure-ad/ title="Single Sign On - AzureAD" class=md-nav__link> Single Sign On - AzureAD </a> </li> <li class=md-nav__item> <a href=../../cloudbees/teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-gke-helm/ title="CloudBees Core on GKE" class=md-nav__link> CloudBees Core on GKE </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-eks/ title="CloudBees Core on EKS" class=md-nav__link> CloudBees Core on EKS </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-team-namespace/ title="Team Master Namespace" class=md-nav__link> Team Master Namespace </a> </li> <li class=md-nav__item> <a href=../../cloudbees/multi-cluster/ title=Multi-Cluster class=md-nav__link> Multi-Cluster </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-2 type=checkbox id=nav-3-2> <label class=md-nav__link for=nav-3-2> Jenkins X </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-2> Jenkins X </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/build-packs/ title="Build Packs" class=md-nav__link> Build Packs </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jx-pipelines/ title="Jenkins X Pipelines" class=md-nav__link> Jenkins X Pipelines </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot/ title="JX Boot GKE" class=md-nav__link> JX Boot GKE </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot-aks/ title="JX Boot AKS" class=md-nav__link> JX Boot AKS </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/aks-boot-core/ title="JX Boot & CloudBees Core" class=md-nav__link> JX Boot & CloudBees Core </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hello-world/ title=HelloWorld class=md-nav__link> HelloWorld </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/maven/ title=Maven class=md-nav__link> Maven </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hybrid/ title=Hybrid class=md-nav__link> Hybrid </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/kubernetes-days/ title="Example For Console Reel" class=md-nav__link> Example For Console Reel </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-3 type=checkbox id=nav-3-3> <label class=md-nav__link for=nav-3-3> Jenkins </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-3> Jenkins </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins/ title=Intro class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jobdsl/ title=JobDSL class=md-nav__link> JobDSL </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jenkins-jobs-builder/ title=JenkinsJobsBuilder class=md-nav__link> JenkinsJobsBuilder </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4 checked> <label class=md-nav__link for=nav-3-4> Jenkins Pipelines </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-4> Jenkins Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../job-types/ title="Job Types" class=md-nav__link> Job Types </a> </li> <li class=md-nav__item> <a href=../kaniko-pipelines/ title="Build Docker Image Kaniko" class=md-nav__link> Build Docker Image Kaniko </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> PodTemplate With Docker-In-Docker </label> <a href=./ title="PodTemplate With Docker-In-Docker" class="md-nav__link md-nav__link--active"> PodTemplate With Docker-In-Docker </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#scenario-pipeline-framework-based-on-docker class=md-nav__link> Scenario: Pipeline Framework Based On Docker </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#goal class=md-nav__link> Goal </a> </li> <li class=md-nav__item> <a href=#docker-socket class=md-nav__link> Docker Socket </a> </li> <li class=md-nav__item> <a href=#docker-on-docker class=md-nav__link> Docker-On-Docker </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#jenkinsfile-example class=md-nav__link> Jenkinsfile Example </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#docker-in-docker class=md-nav__link> Docker-In-Docker </a> </li> <li class=md-nav__item> <a href=#pod-configuration class=md-nav__link> Pod Configuration </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#client-container class=md-nav__link> Client Container </a> </li> <li class=md-nav__item> <a href=#daemon-container class=md-nav__link> Daemon Container </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> References </a> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../jenkins-parallel-pipeline/ title="Parallel Pipelines" class=md-nav__link> Parallel Pipelines </a> </li> <li class=md-nav__item> <a href=../core-concepts/ title="Core Concepts" class=md-nav__link> Core Concepts </a> </li> <li class=md-nav__item> <a href=../artifactory-integration/ title="Artifactory Integration" class=md-nav__link> Artifactory Integration </a> </li> <li class=md-nav__item> <a href=../declarative-pipeline/ title="Pipeline (declarative)" class=md-nav__link> Pipeline (declarative) </a> </li> <li class=md-nav__item> <a href=../groovy-pipeline/ title="Groovy DSL Pipeline" class=md-nav__link> Groovy DSL Pipeline </a> </li> <li class=md-nav__item> <a href=../global-shared-library/ title="Pipeline Libraries" class=md-nav__link> Pipeline Libraries </a> </li> <li class=md-nav__item> <a href=../ide-integration-pipeline-dsl/ title="DSL IDE Integration" class=md-nav__link> DSL IDE Integration </a> </li> <li class=md-nav__item> <a href=../input/ title=Input class=md-nav__link> Input </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-5 type=checkbox id=nav-3-5> <label class=md-nav__link for=nav-3-5> Jenkins Pipeline Examples </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-5> Jenkins Pipeline Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/ title=Index class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-alternatives/ title="Docker Alternatives" class=md-nav__link> Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/maven-declarative/ title="Maven Declarative" class=md-nav__link> Maven Declarative </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-declarative/ title="Docker Declarative" class=md-nav__link> Docker Declarative </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Containers </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Containers </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-1 type=checkbox id=nav-4-1> <label class=md-nav__link for=nav-4-1> Kubernetes (K8S) </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-1> Kubernetes (K8S) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../kubernetes/cka-exam-prep/ title="CKA Exam prep" class=md-nav__link> CKA Exam prep </a> </li> <li class=md-nav__item> <a href=../../kubernetes/tools/ title=Tools class=md-nav__link> Tools </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-2 type=checkbox id=nav-4-2> <label class=md-nav__link for=nav-4-2> K8S Public Services </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-2> K8S Public Services </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/distributions/install-gke/ title=GKE class=md-nav__link> GKE </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/gke-terraform/ title="GKE Terraform" class=md-nav__link> GKE Terraform </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/eks-eksctl/ title="AWS EKS" class=md-nav__link> AWS EKS </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-cli/ title="AKS CLI" class=md-nav__link> AKS CLI </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-terraform/ title="AKS Terraform" class=md-nav__link> AKS Terraform </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> K8S Hard Way - GCE </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-3> K8S Hard Way - GCE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/ title="Installer Preparation" class=md-nav__link> Installer Preparation </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/terraform-compute/ title="Create GCE resources" class=md-nav__link> Create GCE resources </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/certificates/ title="Prepare Certificates" class=md-nav__link> Prepare Certificates </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/kubeconfigs/ title="Prepare Kubeconfigs" class=md-nav__link> Prepare Kubeconfigs </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/encryption/ title="Encryption configuration" class=md-nav__link> Encryption configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/etcd/ title="ETCD configuration" class=md-nav__link> ETCD configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/controller/ title="Controller Config" class=md-nav__link> Controller Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/worker/ title="Worker Config" class=md-nav__link> Worker Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/remote-access/ title="Remote access" class=md-nav__link> Remote access </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/network/ title="Network config" class=md-nav__link> Network config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/debug/ title=Debug class=md-nav__link> Debug </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-4 type=checkbox id=nav-4-4> <label class=md-nav__link for=nav-4-4> Docker </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-4> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docker/graceful-shutdown/ title="Graceful Shutdown" class=md-nav__link> Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../docker/build-kit/ title=BuildKit class=md-nav__link> BuildKit </a> </li> <li class=md-nav__item> <a href=../../docker/multi-stage-builds/ title="Multi-Stage Builds(TBD)" class=md-nav__link> Multi-Stage Builds(TBD) </a> </li> <li class=md-nav__item> <a href=../../docker/swarm/ title="Swarm (mode) (TBD)" class=md-nav__link> Swarm (mode) (TBD) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-5 type=checkbox id=nav-4-5> <label class=md-nav__link for=nav-4-5> Linux </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-5> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../linux/systemd/ title=SystemD class=md-nav__link> SystemD </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Cloud </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloud/automation-pulumi/ title="Automation - Pulumi" class=md-nav__link> Automation - Pulumi </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> SWE </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-6> SWE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../certificates/lets-encrypt-k8s/ title="Let's Encrypt K8S" class=md-nav__link> Let's Encrypt K8S </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6-2 type=checkbox id=nav-6-2> <label class=md-nav__link for=nav-6-2> Software Engineering </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-6-2> Software Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../swe/important-concepts/ title="Important Concepts" class=md-nav__link> Important Concepts </a> </li> <li class=md-nav__item> <a href=../../swe/naming/ title=Naming class=md-nav__link> Naming </a> </li> <li class=md-nav__item> <a href=../../swe/distributed/ title="Distributed Computing" class=md-nav__link> Distributed Computing </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6-3 type=checkbox id=nav-6-3> <label class=md-nav__link for=nav-6-3> Productivity </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-6-3> Productivity </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../productivity/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../productivity/incidents/ title=Incidents class=md-nav__link> Incidents </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class=md-nav__link for=nav-7> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-7> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../java/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../keep-watching/ title="Spring Boot App" class=md-nav__link> Spring Boot App </a> </li> <li class=md-nav__item> <a href=../../java/networking/ title="Java Networking" class=md-nav__link> Java Networking </a> </li> <li class=md-nav__item> <a href=../../java/concurrency/ title="Java Concurrency" class=md-nav__link> Java Concurrency </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#scenario-pipeline-framework-based-on-docker class=md-nav__link> Scenario: Pipeline Framework Based On Docker </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#goal class=md-nav__link> Goal </a> </li> <li class=md-nav__item> <a href=#docker-socket class=md-nav__link> Docker Socket </a> </li> <li class=md-nav__item> <a href=#docker-on-docker class=md-nav__link> Docker-On-Docker </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#jenkinsfile-example class=md-nav__link> Jenkinsfile Example </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#docker-in-docker class=md-nav__link> Docker-In-Docker </a> </li> <li class=md-nav__item> <a href=#pod-configuration class=md-nav__link> Pod Configuration </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#client-container class=md-nav__link> Client Container </a> </li> <li class=md-nav__item> <a href=#daemon-container class=md-nav__link> Daemon Container </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> References </a> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/joostvdg/joostvdg.github.io/edit/master/docs/jenkins-pipeline/podtemplate-dind.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=docker-in-docker-with-podtemplates>Docker-in-Docker With PodTemplates<a class=headerlink href=#docker-in-docker-with-podtemplates title="Permanent link">&para;</a></h1> <p>First of all, doing Docker-In-Docker is a controversial practice to begin with<sup id=fnref:1><a class=footnote-ref href=#fn:1>1</a></sup>, creating just as many problems as it solves.</p> <p>Second, if you're in <a href=/blogs/docker-alternatives/ >Kubernetes, one should not use Docker directly</a>.</p> <p>Ok, all caveats aside, there can be legitimate reasons for wanting to run Docker containers directly even in Kubernetes.</p> <h2 id=scenario-pipeline-framework-based-on-docker>Scenario: Pipeline Framework Based On Docker<a class=headerlink href=#scenario-pipeline-framework-based-on-docker title="Permanent link">&para;</a></h2> <p>I created the solution in this article for a client. This client has created a internal framework around Jenkins Pipeline<sup id=fnref:3><a class=footnote-ref href=#fn:3>3</a></sup>.</p> <p>This pipeline processes the requirements off the pipeline run and spins up the appropriate containers in parallel. Running parallel container <a href=/jenkins-pipeline/jenkins-parallel-pipeline/ >can also be done with PodTemplates via the Kubernetes Plugin</a>, which was deemed the way forward.</p> <p>However, as one can expect, you do not rewrite a framework used by dozens of applications unless you're reasonably sure you can get everything to run as it should. In order to bridge this period of running the pipelines as is, while evaluating Jenkins on Kubernetes, we got to work on achieving Docker-in-Docker with Jenkins Kubernetes Plugin<sup id=fnref:4><a class=footnote-ref href=#fn:4>4</a></sup>.</p> <h3 id=goal>Goal<a class=headerlink href=#goal title="Permanent link">&para;</a></h3> <p>The goal of the exercise, is to prove we can do a single git clone, and spin up multiple containers re-using the original namespace.</p> <h3 id=docker-socket>Docker Socket<a class=headerlink href=#docker-socket title="Permanent link">&para;</a></h3> <p>There's many ways to spin up Docker containers, and I would say the most common one is know as <strong><em>Docker-in-Docker</em></strong> or <code class=codehilite><span class=n>dind</span></code>.</p> <p>I find this misleading, because most of the time the second container doesn't run inside the original container, but parallel to it. This is often achieved by mounting the docker socket as a volume - <code class=codehilite><span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=n>run</span><span class=o>/</span><span class=n>docker</span><span class=p>.</span><span class=n>sock</span></code> . I call this: <code class=codehilite><span class=n>Docker</span><span class=o>-</span><span class=k>On</span><span class=o>-</span><span class=n>Docker</span></code>. Because I want to stay close to the term Docker-in-Docker, but also signify it is different.</p> <p>What Docker-In-Docker should be, is that we host a docker daemon in a docker container, which then hosts the new containers in itself.</p> <p>Before we go into the differences, let's discuss why it matters. Remember, the goal is to be able to re-use the git clone in the original container. The default container with Jenkins Kubernetes Plugin is the <strong><em>jnpl</em></strong>, which acts as an ephemeral agent. It mounts a <code class=codehilite><span class=n>emptyDir</span><span class=err>{}</span></code> as temporary volume as its workspace, which means this folder only exists within the Pod (practically speaking).</p> <h3 id=docker-on-docker>Docker-On-Docker<a class=headerlink href=#docker-on-docker title="Permanent link">&para;</a></h3> <p>Classic Docker-On-Docker, we have a VM which has a Docker Daemon. We have a Docker client container which mounts the docker socket. The docker client now pretends to talk to a local Docker Daemon, but this redirects to the VM's daemon instead.</p> <p>When we do a <code class=codehilite><span class=n>docker</span> <span class=n>run</span></code>, the daemon will spawn a new container <em>next</em> to us. While this is nice, and stays clear from virtulization inception, this new container - let's say, a <code class=codehilite><span class=n>maven</span></code>container - cannot access our workspace. Any volume flag we give to our container with <code class=codehilite><span class=err>-</span>v <span class=p>{</span>origin<span class=p>}:{</span>target<span class=p>}</span></code> maps a Host directory to our new container, but not the workspace volume (purple) in our Pod.</p> <p>This is because the new container cannot access any volume inside the Pod. For this, we need true Docker-In-Docker.</p> <p><img alt=docker-on-docker src=../../images/docker-on-docker.png></p> <h4 id=jenkinsfile-example>Jenkinsfile Example<a class=headerlink href=#jenkinsfile-example title="Permanent link">&para;</a></h4> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>podTemplate</span><span class=o>(</span><span class=nl>yaml:</span> <span class=s2>&quot;&quot;&quot;</span>
<span class=s2>apiVersion: v1</span>
<span class=s2>kind: Pod</span>
<span class=s2>spec:</span>
<span class=s2>  containers:</span>
<span class=s2>  - name: docker</span>
<span class=s2>    image: docker:1.11</span>
<span class=s2>    command: [&#39;cat&#39;]</span>
<span class=s2>    tty: true</span>
<span class=s2>    volumeMounts:</span>
<span class=s2>    - name: dockersock</span>
<span class=s2>      mountPath: /var/run/docker.sock</span>
<span class=s2>  volumes:</span>
<span class=s2>  - name: dockersock</span>
<span class=s2>    hostPath:</span>
<span class=s2>      path: /var/run/docker.sock</span>
<span class=s2>&quot;&quot;&quot;</span>
  <span class=o>)</span> <span class=o>{</span>

  <span class=kt>def</span> <span class=n>image</span> <span class=o>=</span> <span class=s2>&quot;jenkins/jnlp-slave&quot;</span>
  <span class=n>node</span><span class=o>(</span><span class=n>POD_LABEL</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Build Docker image&#39;</span><span class=o>)</span> <span class=o>{</span>
      <span class=n>git</span> <span class=s1>&#39;https://github.com/jenkinsci/docker-jnlp-slave.git&#39;</span>
      <span class=n>container</span><span class=o>(</span><span class=s1>&#39;docker&#39;</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>sh</span> <span class=s2>&quot;docker build -t ${image} .&quot;</span>
      <span class=o>}</span>
    <span class=o>}</span>
  <span class=o>}</span>
<span class=o>}</span>
</pre></div> </td></tr></table> <h3 id=docker-in-docker>Docker-In-Docker<a class=headerlink href=#docker-in-docker title="Permanent link">&para;</a></h3> <p>True Docker-In-Docker means spinning up another container inside an existing container - as illustrated below.</p> <p>This has a big benefit. The container now has access to all the volumes inside the Pod. We can now do a git clone and use docker build on this workspace. In addition, we can also spin up a new container and give it the workspace as a volume and have it build with it.</p> <p><img alt=docker-in-docker src=../../images/docker-in-docker.png></p> <h3 id=pod-configuration>Pod Configuration<a class=headerlink href=#pod-configuration title="Permanent link">&para;</a></h3> <p>The examples below contain some specific configuration elements required to make the magic happen. So let's explore each configuration item to see what it does and why we set it.</p> <h4 id=client-container>Client Container<a class=headerlink href=#client-container title="Permanent link">&para;</a></h4> <p>The Docker Client has to know where the Docker Daemon is.</p> <p>We do this by setting the environment variable <code class=codehilite><span class=n>DOCKER_HOST</span></code><sup id=fnref:2><a class=footnote-ref href=#fn:2>2</a></sup> to <code class=codehilite><span class=n>tcp</span><span class=p>:</span><span class=o>//</span><span class=n>localhost</span><span class=p>:</span><span class=mi>2375</span></code>. If we put the Daemon container within the same Pod, we can use <code class=codehilite><span class=n>localhost</span></code> and then the default port of the daemon, being <code class=codehilite><span class=mi>2375</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>env</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">DOCKER_HOST</span>
    <span class=nt>value</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">tcp://localhost:2375</span>
</pre></div> </td></tr></table> <p>The client container will directly terminate unless we give it something to do. If we put it to sleep for a significant amount of time, it should be there to execute our every command!</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>command</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&#39;sleep&#39;</span><span class="p p-Indicator">,</span> <span class=s>&#39;99d&#39;</span><span class="p p-Indicator">]</span>
</pre></div> </td></tr></table> <h4 id=daemon-container>Daemon Container<a class=headerlink href=#daemon-container title="Permanent link">&para;</a></h4> <p>As of Docker 18.09 the Docker Daemon container can use TLS, as of 19.03 it is configured by default.<sup id=fnref2:2><a class=footnote-ref href=#fn:2>2</a></sup> So either you work around this or get the certificates sorted.</p> <p>The easiest way around it, is to set the environment variable <code class=codehilite><span class=n>DOCKER_TLS_CERTDIR</span></code> to <code class=codehilite><span class=ss>&quot;&quot;</span></code>, which will disable TLS.</p> <div class="admonition caution"> <p class=admonition-title>Caution</p> <p>Disabling TLS is at your OWN risk. Read the docs carefully for what this means<sup id=fnref3:2><a class=footnote-ref href=#fn:2>2</a></sup>.</p> </div> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>env</span><span class=p>:</span>
   <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">DOCKER_TLS_CERTDIR</span>
     <span class=nt>value</span><span class=p>:</span> <span class=s>&quot;&quot;</span>
</pre></div> </td></tr></table> <p>In order for the Docker Daemon to create containers, it needs the <code class=codehilite><span class=n>privileged</span></code> flag set to true. This should be another warning to you, to be careful of what you do with it!</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>securityContext</span><span class=p>:</span>
  <span class=nt>privileged</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div> </td></tr></table> <p>Last but not least, we would not want to store all the Docker Daemon data in the pods. We might as well leverage local storage or a some specific volume.</p> <p>The <code class=codehilite><span class=n>volume</span></code> and <code class=codehilite><span class=n>volumeMounts</span></code> configuration of the Daemon container ensures we can leverage the Docker build and image caches.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span>  <span class=nt>volumeMounts</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cache</span>
      <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/var/lib/docker</span>
<span class=nt>volumes</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cache</span>
    <span class=nt>hostPath</span><span class=p>:</span>
      <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp</span>
      <span class=nt>type</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Directory</span>
</pre></div> </td></tr></table> <details class=example><summary>Docker Build</summary><p>Now that we can directly use Docker to build, we can also leverage <code class=codehilite><span class=n>buildkit</span></code><sup id=fnref:7><a class=footnote-ref href=#fn:7>7</a></sup>.</p> <p>Because we have the workspace available to us, we can directly start our docker build.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>pipeline</span> <span class=o>{</span>
    <span class=n>options</span> <span class=o>{</span>
        <span class=n>disableConcurrentBuilds</span><span class=o>()</span>
    <span class=o>}</span>
    <span class=n>agent</span> <span class=o>{</span>
        <span class=n>kubernetes</span> <span class=o>{</span>
            <span class=n>label</span> <span class=s1>&#39;docker-in-docker-maven&#39;</span>
            <span class=n>yaml</span> <span class=s2>&quot;&quot;&quot;</span>
<span class=s2>apiVersion: v1</span>
<span class=s2>kind: Pod</span>
<span class=s2>spec:</span>
<span class=s2>containers:</span>
<span class=s2>- name: docker-client</span>
<span class=s2>  image: docker:19.03.1</span>
<span class=s2>  command: [&#39;sleep&#39;, &#39;99d&#39;]</span>
<span class=s2>  env:</span>
<span class=s2>    - name: DOCKER_HOST</span>
<span class=s2>      value: tcp://localhost:2375</span>
<span class=s2>- name: docker-daemon</span>
<span class=s2>  image: docker:19.03.1-dind</span>
<span class=s2>  env:</span>
<span class=s2>    - name: DOCKER_TLS_CERTDIR</span>
<span class=s2>      value: &quot;&quot;</span>
<span class=s2>  securityContext:</span>
<span class=s2>    privileged: true</span>
<span class=s2>  volumeMounts:</span>
<span class=s2>      - name: cache</span>
<span class=s2>        mountPath: /var/lib/docker</span>
<span class=s2>volumes:</span>
<span class=s2>  - name: cache</span>
<span class=s2>    hostPath:</span>
<span class=s2>      path: /tmp</span>
<span class=s2>      type: Directory</span>
<span class=s2>&quot;&quot;&quot;</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=n>stages</span> <span class=o>{</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Checkout&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>steps</span> <span class=o>{</span>
                <span class=n>git</span> <span class=s1>&#39;https://github.com/jenkinsci/docker-jnlp-slave.git&#39;</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Docker Build&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>steps</span> <span class=o>{</span>
                <span class=n>container</span><span class=o>(</span><span class=s1>&#39;docker-client&#39;</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>sh</span> <span class=s1>&#39;docker version &amp;&amp; DOCKER_BUILDKIT=1 docker build --progress plain -t testing .&#39;</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div> </td></tr></table> </details> <details class=example><summary>Docker Run With Workspace</summary><p>In this example we're going to spin up another container to run our build with maven.</p> <p>This means it needs our workspace - see below - but it will also download a lot of Maven depencencies. We want to make sure we can leverage a local Maven Repository in order to speed up builds.</p> <p>We can do so by mounting a volume - or a <code class=codehilite><span class=n>hostPath</span></code> to our Docker Client container.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>volumeMounts</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cache</span>
  <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/repository</span>
</pre></div> </td></tr></table> <p>We can then mount this into our new container via the Docker volume flag (<code class=codehilite><span class=o>-</span><span class=n>v</span></code>).</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=o>-</span><span class=n>v</span> <span class=o>/</span><span class=n>tmp</span><span class=o>/</span><span class=n>repository</span><span class=p>:</span><span class=o>/</span><span class=n>root</span><span class=o>/</span><span class=p>.</span><span class=n>m2</span><span class=o>/</span><span class=n>repository</span>
</pre></div> </td></tr></table> <p>Here we mount the workspace from our Jenkins Build. Notice the double quotes - in the pipeline below - this means we interpolate our Jenkins Environment variables.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>-v <span class=cp>${</span><span class=n>WORKSPACE</span><span class=cp>}</span>:/usr/src/mymaven 
</pre></div> </td></tr></table> <p>The <code class=codehilite><span class=o>-</span><span class=n>w</span></code> flag means <strong><em>work directory</em></strong>, it makes sure our container works in the directory container our workspace.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=o>-</span><span class=n>w</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>mymaven</span>
</pre></div> </td></tr></table> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>pipeline</span> <span class=o>{</span>
    <span class=n>options</span> <span class=o>{</span>
        <span class=n>disableConcurrentBuilds</span><span class=o>()</span>
    <span class=o>}</span>
    <span class=n>agent</span> <span class=o>{</span>
        <span class=n>kubernetes</span> <span class=o>{</span>
            <span class=n>label</span> <span class=s1>&#39;docker-in-docker-maven&#39;</span>
            <span class=n>yaml</span> <span class=s2>&quot;&quot;&quot;</span>
<span class=s2>apiVersion: v1</span>
<span class=s2>kind: Pod</span>
<span class=s2>spec:</span>
<span class=s2>containers:</span>
<span class=s2>- name: docker-client</span>
<span class=s2>  image: docker:19.03.1</span>
<span class=s2>  command: [&#39;sleep&#39;, &#39;99d&#39;]</span>
<span class=s2>  env:</span>
<span class=s2>    - name: DOCKER_HOST</span>
<span class=s2>      value: tcp://localhost:2375</span>
<span class=s2>  volumeMounts:</span>
<span class=s2>    - name: cache</span>
<span class=s2>      mountPath: /tmp/repository</span>
<span class=s2>- name: docker-daemon</span>
<span class=s2>  image: docker:19.03.1-dind</span>
<span class=s2>  env:</span>
<span class=s2>    - name: DOCKER_TLS_CERTDIR</span>
<span class=s2>      value: &quot;&quot;</span>
<span class=s2>  securityContext:</span>
<span class=s2>    privileged: true</span>
<span class=s2>  volumeMounts:</span>
<span class=s2>    - name: cache</span>
<span class=s2>      mountPath: /var/lib/docker</span>
<span class=s2>volumes:</span>
<span class=s2>  - name: cache</span>
<span class=s2>    hostPath:</span>
<span class=s2>      path: /tmp</span>
<span class=s2>      type: Directory</span>
<span class=s2>&quot;&quot;&quot;</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=n>stages</span> <span class=o>{</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Checkout&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>steps</span> <span class=o>{</span>
                <span class=n>git</span> <span class=s1>&#39;https://github.com/joostvdg/jx-maven-lib.git&#39;</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Build&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>steps</span> <span class=o>{</span>
                <span class=n>container</span><span class=o>(</span><span class=s1>&#39;docker-client&#39;</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>sh</span> <span class=s2>&quot;docker run -v ${WORKSPACE}:/usr/src/mymaven -v /tmp/repository:/root/.m2/repository -w /usr/src/mymaven maven:3-jdk-11-slim mvn clean verify&quot;</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div> </td></tr></table> </details> <h2 id=references>References<a class=headerlink href=#references title="Permanent link">&para;</a></h2> <div class=footnote> <hr> <ol> <li id=fn:1> <p><a href=https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/ >Using Docker-in-Docker - Jerome Petazzo</a>&#160;<a class=footnote-backref href=#fnref:1 title="Jump back to footnote 1 in the text">&#8617;</a></p> </li> <li id=fn:2> <p><a href="https://hub.docker.com/_/docker?tab=description">Docker images on Dockerhub</a>&#160;<a class=footnote-backref href=#fnref:2 title="Jump back to footnote 2 in the text">&#8617;</a><a class=footnote-backref href=#fnref2:2 title="Jump back to footnote 2 in the text">&#8617;</a><a class=footnote-backref href=#fnref3:2 title="Jump back to footnote 2 in the text">&#8617;</a></p> </li> <li id=fn:3> <p><a href=https://jenkins.io/doc/book/pipeline/ >Jenkins Pipeline</a>&#160;<a class=footnote-backref href=#fnref:3 title="Jump back to footnote 3 in the text">&#8617;</a></p> </li> <li id=fn:4> <p><a href=https://github.com/jenkinsci/kubernetes-plugin>Jenkins Kubernetes Plugin</a>&#160;<a class=footnote-backref href=#fnref:4 title="Jump back to footnote 4 in the text">&#8617;</a></p> </li> <li id=fn:5> <p><a href=https://github.com/jenkinsci/kubernetes-plugin/blob/master/examples/dind.groovy>Jenkins Kubernetes Plugin - Docker In Docker Example</a>&#160;<a class=footnote-backref href=#fnref:5 title="Jump back to footnote 5 in the text">&#8617;</a></p> </li> <li id=fn:6> <p><a href=https://github.com/jenkinsci/kubernetes-plugin/blob/master/examples/dood.groovy>Jenkins Kubernetes Plugin - Docker On Docker Example</a>&#160;<a class=footnote-backref href=#fnref:6 title="Jump back to footnote 6 in the text">&#8617;</a></p> </li> <li id=fn:7> <p><a href=https://docs.docker.com/develop/develop-images/build_enhancements/ >Docker Build Enchancements - Buildkit</a>&#160;<a class=footnote-backref href=#fnref:7 title="Jump back to footnote 7 in the text">&#8617;</a></p> </li> </ol> </div> <h2 id=__comments>Comments</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://joostvdg.github.io/jenkins-pipeline/podtemplate-dind/";
      this.page.identifier =
        "/jenkins-pipeline/podtemplate-dind/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//joostvdg-github-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../kaniko-pipelines/ title="Build Docker Image Kaniko" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> Build Docker Image Kaniko </span> </div> </a> <a href=../jenkins-parallel-pipeline/ title="Parallel Pipelines" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Parallel Pipelines </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2019 Joost van der Griendt </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <a href=https://github.com/joostvdg class="md-footer-social__link fa fa-github"></a> <a href=https://twitter.com/joost_vdg class="md-footer-social__link fa fa-twitter"></a> <a href=https://linkedin.com/in/joostvdg class="md-footer-social__link fa fa-linkedin"></a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.c648116f.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> </body> </html>