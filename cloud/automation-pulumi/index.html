<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Create And Manage Kubernetes And Workloads With Pulumi"><link href=https://joostvdg.github.io/cloud/automation-pulumi/ rel=canonical><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.0"><title>Cloud Automation With Pulumi</title><link rel=stylesheet href=../../assets/stylesheets/application.0284f74d.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.01803549.css><meta name=theme-color content=#fb8c00><script src=../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-145385967-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-primary=orange data-md-color-accent=red> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#pulumi tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-header-nav__button md-logo"> <i class=md-icon>public</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> J's Software Development Pages </span> <span class=md-header-nav__topic> Cloud Automation With Pulumi </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. title=Home class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../docker/graceful-shutdown/ title=Blogs class=md-tabs__link> Blogs </a> </li> <li class=md-tabs__item> <a href=../../cloudbees/sso-azure-ad/ title=CICD class=md-tabs__link> CICD </a> </li> <li class=md-tabs__item> <a href=../../kubernetes/ title=Containers class=md-tabs__link> Containers </a> </li> <li class=md-tabs__item> <a href=./ title=Cloud class="md-tabs__link md-tabs__link--active"> Cloud </a> </li> <li class=md-tabs__item> <a href=../../certificates/lets-encrypt-k8s/ title=SWE class=md-tabs__link> SWE </a> </li> <li class=md-tabs__item> <a href=../../java/ title=Java class=md-tabs__link> Java </a> </li> </ul> </div> </nav> <main class=md-main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-nav__button md-logo"> <i class=md-icon>public</i> </a> J's Software Development Pages </label> <div class=md-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> Home </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-1> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Me class=md-nav__link> Me </a> </li> <li class=md-nav__item> <a href=../../other/mkdocs/ title="MKDocs (This Static Website)" class=md-nav__link> MKDocs (This Static Website) </a> </li> <li class=md-nav__item> <a href=../../other/vim/ title=VIM class=md-nav__link> VIM </a> </li> <li class=md-nav__item> <a href=../../other/shell/ title=Shell class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Blogs </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Blogs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docker/graceful-shutdown/ title="Docker Graceful Shutdown" class=md-nav__link> Docker Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-alternatives/ title="Pipelines with Docker Alternatives" class=md-nav__link> Pipelines with Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../blogs/k8s-lets-encrypt/ title="Let's Encrypt for Kubernetes Apps" class=md-nav__link> Let's Encrypt for Kubernetes Apps </a> </li> <li class=md-nav__item> <a href=../../cloudbees/sso-azure-ad/ title="CloudBees SSO Azure AD" class=md-nav__link> CloudBees SSO Azure AD </a> </li> <li class=md-nav__item> <a href=../../cloudbees/teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../../blogs/jenkins-pipeline-support-tool/ title="Jenkins Pipeline Support Tools" class=md-nav__link> Jenkins Pipeline Support Tools </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-7 type=checkbox id=nav-2-7> <label class=md-nav__link for=nav-2-7> Jenkins Monitoring Kubernetes </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-7> Jenkins Monitoring Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/introduction/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/prepare/ title="Prepare Environment" class=md-nav__link> Prepare Environment </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/install/ title="Install Tools" class=md-nav__link> Install Tools </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/metrics/ title=Metrics class=md-nav__link> Metrics </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/alerts/ title=Alerts class=md-nav__link> Alerts </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/pipeline/ title=Pipeline class=md-nav__link> Pipeline </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/dashboard/ title=Dashboard class=md-nav__link> Dashboard </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/cloudbees/ title=CloudBees class=md-nav__link> CloudBees </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../blogs/k8s-crd/ title="Create your own k8s resource" class=md-nav__link> Create your own k8s resource </a> </li> <li class=md-nav__item> <a href=../../blogs/dockercon-eu-2018/ title="DockerCon EU 2018" class=md-nav__link> DockerCon EU 2018 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> CICD </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> CICD </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-1 type=checkbox id=nav-3-1> <label class=md-nav__link for=nav-3-1> CloudBees </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-1> CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloudbees/sso-azure-ad/ title="Single Sign On - AzureAD" class=md-nav__link> Single Sign On - AzureAD </a> </li> <li class=md-nav__item> <a href=../../cloudbees/teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-gke-helm/ title="CloudBees Core on GKE" class=md-nav__link> CloudBees Core on GKE </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-eks/ title="CloudBees Core on EKS" class=md-nav__link> CloudBees Core on EKS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-2 type=checkbox id=nav-3-2> <label class=md-nav__link for=nav-3-2> Jenkins X </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-2> Jenkins X </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/hello-world/ title=HelloWorld class=md-nav__link> HelloWorld </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/buildpack/ title=BuildPack class=md-nav__link> BuildPack </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/maven/ title=Maven class=md-nav__link> Maven </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hybrid/ title=Hybrid class=md-nav__link> Hybrid </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-3 type=checkbox id=nav-3-3> <label class=md-nav__link for=nav-3-3> Jenkins </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-3> Jenkins </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins/ title=Intro class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jobdsl/ title=JobDSL class=md-nav__link> JobDSL </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jenkins-jobs-builder/ title=JenkinsJobsBuilder class=md-nav__link> JenkinsJobsBuilder </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4> <label class=md-nav__link for=nav-3-4> Jenkins Pipelines </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-4> Jenkins Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline/artifactory-integration/ title="Artifactory Integration" class=md-nav__link> Artifactory Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/job-types/ title="Job Types" class=md-nav__link> Job Types </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/core-concepts/ title="Core Concepts" class=md-nav__link> Core Concepts </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/declarative-pipeline/ title="Pipeline (declarative)" class=md-nav__link> Pipeline (declarative) </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/groovy-pipeline/ title="Groovy DSL Pipeline" class=md-nav__link> Groovy DSL Pipeline </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/global-shared-library/ title="Pipeline Libraries" class=md-nav__link> Pipeline Libraries </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/ide-integration-pipeline-dsl/ title="DSL IDE Integration" class=md-nav__link> DSL IDE Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/jenkins-parallel-pipeline/ title=Parallel class=md-nav__link> Parallel </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/input/ title=Input class=md-nav__link> Input </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-5 type=checkbox id=nav-3-5> <label class=md-nav__link for=nav-3-5> Jenkins Pipeline Examples </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-5> Jenkins Pipeline Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/ title=Index class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-alternatives/ title="Docker Alternatives" class=md-nav__link> Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/maven-declarative/ title="Maven Declarative" class=md-nav__link> Maven Declarative </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-declarative/ title="Docker Declarative" class=md-nav__link> Docker Declarative </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Containers </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Containers </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-1 type=checkbox id=nav-4-1> <label class=md-nav__link for=nav-4-1> Kubernetes (K8S) </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-1> Kubernetes (K8S) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../kubernetes/cka-exam-prep/ title="CKA Exam prep" class=md-nav__link> CKA Exam prep </a> </li> <li class=md-nav__item> <a href=../../kubernetes/tools/ title=Tools class=md-nav__link> Tools </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-2 type=checkbox id=nav-4-2> <label class=md-nav__link for=nav-4-2> K8S Public Services </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-2> K8S Public Services </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/distributions/install-gke/ title=GKE class=md-nav__link> GKE </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/eks-eksctl/ title="AWS EKS" class=md-nav__link> AWS EKS </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-cli/ title="AKS CLI" class=md-nav__link> AKS CLI </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-terraform/ title="AKS Terraform" class=md-nav__link> AKS Terraform </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> K8S Hard Way - GCE </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-3> K8S Hard Way - GCE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/ title="Installer Preparation" class=md-nav__link> Installer Preparation </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/terraform-compute/ title="Create GCE resources" class=md-nav__link> Create GCE resources </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/certificates/ title="Prepare Certificates" class=md-nav__link> Prepare Certificates </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/kubeconfigs/ title="Prepare Kubeconfigs" class=md-nav__link> Prepare Kubeconfigs </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/encryption/ title="Encryption configuration" class=md-nav__link> Encryption configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/etcd/ title="ETCD configuration" class=md-nav__link> ETCD configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/controller/ title="Controller Config" class=md-nav__link> Controller Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/worker/ title="Worker Config" class=md-nav__link> Worker Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/remote-access/ title="Remote access" class=md-nav__link> Remote access </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/network/ title="Network config" class=md-nav__link> Network config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/debug/ title=Debug class=md-nav__link> Debug </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-4 type=checkbox id=nav-4-4> <label class=md-nav__link for=nav-4-4> Docker </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-4> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docker/graceful-shutdown/ title="Graceful Shutdown" class=md-nav__link> Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../docker/build-kit/ title=BuildKit class=md-nav__link> BuildKit </a> </li> <li class=md-nav__item> <a href=../../docker/multi-stage-builds/ title="Multi-Stage Builds(TBD)" class=md-nav__link> Multi-Stage Builds(TBD) </a> </li> <li class=md-nav__item> <a href=../../docker/swarm/ title="Swarm (mode) (TBD)" class=md-nav__link> Swarm (mode) (TBD) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-5 type=checkbox id=nav-4-5> <label class=md-nav__link for=nav-4-5> Linux </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-5> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../linux/systemd/ title=SystemD class=md-nav__link> SystemD </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5 checked> <label class=md-nav__link for=nav-5> Cloud </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Automation - Pulumi </label> <a href=./ title="Automation - Pulumi" class="md-nav__link md-nav__link--active"> Automation - Pulumi </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#steps-taken title="Steps taken" class=md-nav__link> Steps taken </a> </li> <li class=md-nav__item> <a href=#artifactory-via-helm title="Artifactory via Helm" class=md-nav__link> Artifactory via Helm </a> </li> <li class=md-nav__item> <a href=#gke-cluster title="GKE Cluster" class=md-nav__link> GKE Cluster </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#gke-config title="GKE Config" class=md-nav__link> GKE Config </a> </li> <li class=md-nav__item> <a href=#kubeconfig title=Kubeconfig class=md-nav__link> Kubeconfig </a> </li> <li class=md-nav__item> <a href=#pulumi-gcp-config title="Pulumi GCP Config" class=md-nav__link> Pulumi GCP Config </a> </li> <li class=md-nav__item> <a href=#post-cluster-creation title="Post Cluster Creation" class=md-nav__link> Post Cluster Creation </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#install-failed title="Install failed" class=md-nav__link> Install failed </a> </li> <li class=md-nav__item> <a href=#helm-charts title="Helm Charts" class=md-nav__link> Helm Charts </a> </li> <li class=md-nav__item> <a href=#deployment-service title="Deployment & Service" class=md-nav__link> Deployment &amp; Service </a> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> SWE </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-6> SWE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../certificates/lets-encrypt-k8s/ title="Let's Encrypt K8S" class=md-nav__link> Let's Encrypt K8S </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6-2 type=checkbox id=nav-6-2> <label class=md-nav__link for=nav-6-2> Software Engineering </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-6-2> Software Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../swe/important-concepts/ title="Important Concepts" class=md-nav__link> Important Concepts </a> </li> <li class=md-nav__item> <a href=../../swe/naming/ title=Naming class=md-nav__link> Naming </a> </li> <li class=md-nav__item> <a href=../../swe/distributed/ title="Distributed Computing" class=md-nav__link> Distributed Computing </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6-3 type=checkbox id=nav-6-3> <label class=md-nav__link for=nav-6-3> Productivity </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-6-3> Productivity </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../productivity/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../productivity/incidents/ title=Incidents class=md-nav__link> Incidents </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class=md-nav__link for=nav-7> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-7> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../java/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../keep-watching/ title="Spring Boot App" class=md-nav__link> Spring Boot App </a> </li> <li class=md-nav__item> <a href=../../java/networking/ title="Java Networking" class=md-nav__link> Java Networking </a> </li> <li class=md-nav__item> <a href=../../java/concurrency/ title="Java Concurrency" class=md-nav__link> Java Concurrency </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#steps-taken title="Steps taken" class=md-nav__link> Steps taken </a> </li> <li class=md-nav__item> <a href=#artifactory-via-helm title="Artifactory via Helm" class=md-nav__link> Artifactory via Helm </a> </li> <li class=md-nav__item> <a href=#gke-cluster title="GKE Cluster" class=md-nav__link> GKE Cluster </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#gke-config title="GKE Config" class=md-nav__link> GKE Config </a> </li> <li class=md-nav__item> <a href=#kubeconfig title=Kubeconfig class=md-nav__link> Kubeconfig </a> </li> <li class=md-nav__item> <a href=#pulumi-gcp-config title="Pulumi GCP Config" class=md-nav__link> Pulumi GCP Config </a> </li> <li class=md-nav__item> <a href=#post-cluster-creation title="Post Cluster Creation" class=md-nav__link> Post Cluster Creation </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#install-failed title="Install failed" class=md-nav__link> Install failed </a> </li> <li class=md-nav__item> <a href=#helm-charts title="Helm Charts" class=md-nav__link> Helm Charts </a> </li> <li class=md-nav__item> <a href=#deployment-service title="Deployment & Service" class=md-nav__link> Deployment &amp; Service </a> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/joostvdg/joostvdg.github.io/edit/master/docs/cloud/automation-pulumi.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=pulumi>Pulumi<a class=headerlink href=#pulumi title="Permanent link">&para;</a></h1> <p>Just pointing to the documentation and GitHub repository is a bit boring and most of all, lazy. So I've gone through the trouble to create a demo project that shows what Pulumi can do.</p> <p>One of the things to keep in mind is that Pulumi keeps its state in a remote location by default - Pulumi's SaaS service. Much like using an S3 bucket to store your Terraform state.</p> <p>The goal of the demo is to show what you can do with Pulumi. My personal opinion is that Pulumi is excellent for managing entire systems as code. From public cloud infrastructure to public open source resources right down to your applications and their configurations.</p> <p>The system that I've written with Pulumi is a CI/CD system running in a GKE cluster. The system contains Jenkins, Artifactory and a custom LDAP server.</p> <p>To make it interesting, we'll use different aspects of Pulumi to create the system. We will create the GKE cluster via Pulumi's wrapper for the <code class=codehilite><span class=n>gcloud</span></code> cli - in a similar way as JenkinsX does -, install Jenkins and Artifactory via Helm and install the LDAP server via Pulumi's Kubernetes resource classes.</p> <h2 id=steps-taken>Steps taken<a class=headerlink href=#steps-taken title="Permanent link">&para;</a></h2> <ul> <li>For more info <a href=pulumi.io>Pulumi.io</a></li> <li>install: <code class=codehilite><span class=n>brew</span> <span class=n>install</span> <span class=n>pulumi</span></code></li> <li>clone demo: <code class=codehilite><span class=n>git</span> <span class=n>clone</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>github</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>demomon</span><span class=o>/</span><span class=n>pulumi</span><span class=o>-</span><span class=n>demo</span><span class=o>-</span><span class=mi>1</span></code></li> <li>init stack: <code class=codehilite><span class=n>pulumi</span> <span class=n>stack</span> <span class=n>init</span> <span class=n>demomon</span><span class=o>-</span><span class=n>pulumi</span><span class=o>-</span><span class=n>demo</span><span class=o>-</span><span class=mi>1</span></code><ul> <li>connect to GitHub</li> </ul> </li> <li>set kubernetes config <code class=codehilite><span class=n>pulumi</span> <span class=n>config</span> <span class=k>set</span> <span class=n>kubernetes</span><span class=p>:</span><span class=n>context</span> <span class=n>gke_ps</span><span class=o>-</span><span class=n>dev</span><span class=o>-</span><span class=mi>201405</span><span class=n>_europe</span><span class=o>-</span><span class=n>west4_joostvdg</span><span class=o>-</span><span class=n>reg</span><span class=o>-</span><span class=n>dec18</span><span class=o>-</span><span class=mi>1</span></code></li> <li><code class=codehilite><span class=n>pulumi</span> <span class=n>config</span> <span class=k>set</span> <span class=n>isMinikube</span> <span class=k>false</span></code></li> <li>install npm resources: <code class=codehilite><span class=n>npm</span> <span class=n>install</span></code> (I've used the TypeScript demo's)</li> <li><code class=codehilite><span class=n>pulumi</span> <span class=n>config</span> <span class=k>set</span> <span class=n>username</span> <span class=n>administrator</span></code></li> <li><code class=codehilite><span class=n>pulumi</span> <span class=n>config</span> <span class=k>set</span> <span class=n>password</span> <span class=mi>3</span><span class=n>OvlgaockdnTsYRU5JAcgM1o</span> <span class=c1>--secret</span></code></li> <li><code class=codehilite><span class=n>pulumi</span> <span class=n>preview</span></code></li> <li>incase pulumi loses your stack: <code class=codehilite><span class=n>pulumi</span> <span class=n>stack</span> <span class=k>select</span> <span class=n>demomon</span><span class=o>-</span><span class=n>pulumi</span><span class=o>-</span><span class=n>demo</span><span class=o>-</span><span class=mi>1</span></code></li> <li><code class=codehilite><span class=n>pulumi</span> <span class=k>destroy</span></code></li> </ul> <p>Based on the following demo's:</p> <ul> <li><a href=https://pulumi.io/quickstart/kubernetes/tutorial-exposed-deployment.html>https://pulumi.io/quickstart/kubernetes/tutorial-exposed-deployment.html</a></li> <li><a href=https://github.com/pulumi/examples/tree/master/kubernetes-ts-jenkins>https://github.com/pulumi/examples/tree/master/kubernetes-ts-jenkins</a></li> </ul> <h2 id=artifactory-via-helm>Artifactory via Helm<a class=headerlink href=#artifactory-via-helm title="Permanent link">&para;</a></h2> <p>To install the helm charts of Artifactory using Helm, we will first need to add JFrog's repository.</p> <ul> <li><code class=codehilite><span class=n>helm</span> <span class=n>repo</span> <span class=k>add</span> <span class=n>jfrog</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>charts</span><span class=p>.</span><span class=n>jfrog</span><span class=p>.</span><span class=n>io</span></code></li> <li><code class=codehilite><span class=n>helm</span> <span class=n>repo</span> <span class=k>update</span></code></li> </ul> <h2 id=gke-cluster>GKE Cluster<a class=headerlink href=#gke-cluster title="Permanent link">&para;</a></h2> <p>Below is the code for the cluster.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>gcp</span> <span class=nx>from</span> <span class=s2>&quot;@pulumi/gcp&quot;</span><span class=p>;</span>
<span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>k8s</span> <span class=nx>from</span> <span class=s2>&quot;@pulumi/kubernetes&quot;</span><span class=p>;</span>
<span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>pulumi</span> <span class=nx>from</span> <span class=s2>&quot;@pulumi/pulumi&quot;</span><span class=p>;</span>
<span class=kr>import</span> <span class=p>{</span> <span class=nx>nodeCount</span><span class=p>,</span> <span class=nx>nodeMachineType</span><span class=p>,</span> <span class=nx>password</span><span class=p>,</span> <span class=nx>username</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&quot;./gke-config&quot;</span><span class=p>;</span>

<span class=kr>export</span> <span class=kr>const</span> <span class=nx>k8sCluster</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>gcp</span><span class=p>.</span><span class=nx>container</span><span class=p>.</span><span class=nx>Cluster</span><span class=p>(</span><span class=s2>&quot;gke-cluster&quot;</span><span class=p>,</span> <span class=p>{</span>
    <span class=nx>name</span><span class=o>:</span> <span class=s2>&quot;joostvdg-dec-2018-pulumi&quot;</span><span class=p>,</span>
    <span class=nx>initialNodeCount</span>: <span class=kt>nodeCount</span><span class=p>,</span>
    <span class=nx>nodeVersion</span><span class=o>:</span> <span class=s2>&quot;latest&quot;</span><span class=p>,</span>
    <span class=nx>minMasterVersion</span><span class=o>:</span> <span class=s2>&quot;latest&quot;</span><span class=p>,</span>
    <span class=nx>nodeConfig</span><span class=o>:</span> <span class=p>{</span>
        <span class=nx>machineType</span>: <span class=kt>nodeMachineType</span><span class=p>,</span>
        <span class=nx>oauthScopes</span><span class=o>:</span> <span class=p>[</span>
            <span class=s2>&quot;https://www.googleapis.com/auth/compute&quot;</span><span class=p>,</span>
            <span class=s2>&quot;https://www.googleapis.com/auth/devstorage.read_only&quot;</span><span class=p>,</span>
            <span class=s2>&quot;https://www.googleapis.com/auth/logging.write&quot;</span><span class=p>,</span>
            <span class=s2>&quot;https://www.googleapis.com/auth/monitoring&quot;</span>
        <span class=p>],</span>
    <span class=p>},</span>
<span class=p>});</span>
</pre></div> </td></tr></table> <h3 id=gke-config>GKE Config<a class=headerlink href=#gke-config title="Permanent link">&para;</a></h3> <p>As you could see, we import variables from a configuration file <code class=codehilite><span class=n>gke</span><span class=o>-</span><span class=n>config</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Config</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&quot;@pulumi/pulumi&quot;</span><span class=p>;</span>
<span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Config</span><span class=p>();</span>
<span class=kr>export</span> <span class=kr>const</span> <span class=nx>nodeCount</span> <span class=o>=</span> <span class=nx>config</span><span class=p>.</span><span class=nx>getNumber</span><span class=p>(</span><span class=s2>&quot;nodeCount&quot;</span><span class=p>)</span> <span class=o>||</span> <span class=mi>3</span><span class=p>;</span>
<span class=kr>export</span> <span class=kr>const</span> <span class=nx>nodeMachineType</span> <span class=o>=</span> <span class=nx>config</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&quot;nodeMachineType&quot;</span><span class=p>)</span> <span class=o>||</span> <span class=s2>&quot;n1-standard-2&quot;</span><span class=p>;</span>
<span class=c1>// username is the admin username for the cluster.</span>
<span class=kr>export</span> <span class=kr>const</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>config</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&quot;username&quot;</span><span class=p>)</span> <span class=o>||</span> <span class=s2>&quot;admin&quot;</span><span class=p>;</span>
<span class=c1>// password is the password for the admin user in the cluster.</span>
<span class=kr>export</span> <span class=kr>const</span> <span class=nx>password</span> <span class=o>=</span> <span class=nx>config</span><span class=p>.</span><span class=nx>require</span><span class=p>(</span><span class=s2>&quot;password&quot;</span><span class=p>);</span>
</pre></div> </td></tr></table> <h3 id=kubeconfig>Kubeconfig<a class=headerlink href=#kubeconfig title="Permanent link">&para;</a></h3> <p>As you probably will want to install other things (Helm charts, services) inside this cluster, we need to make sure we get the <code class=codehilite><span class=n>kubeconfig</span></code> file of our cluster - which is yet to be created. Below is the code - courtesy of <a href=https://github.com/pulumi/examples/tree/master/gcp-ts-gke>Pulumi's GKE Example</a> - that generates and exports the Kubernetes Client Configuration.</p> <p>This client configuration can then be used by Helm charts or other Kubernetes services. Pulumi will then also understand it depends on the cluster and create/update it first before moving on to the others.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1>// Manufacture a GKE-style Kubeconfig. Note that this is slightly &quot;different&quot; because of the way GKE requires</span>
<span class=c1>// gcloud to be in the picture for cluster authentication (rather than using the client cert/key directly).</span>
<span class=kr>export</span> <span class=kr>const</span> <span class=nx>k8sConfig</span> <span class=o>=</span> <span class=nx>pulumi</span><span class=p>.</span>
    <span class=nx>all</span><span class=p>([</span> <span class=nx>k8sCluster</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>k8sCluster</span><span class=p>.</span><span class=nx>endpoint</span><span class=p>,</span> <span class=nx>k8sCluster</span><span class=p>.</span><span class=nx>masterAuth</span> <span class=p>]).</span>
    <span class=nx>apply</span><span class=p>(([</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>endpoint</span><span class=p>,</span> <span class=nx>auth</span> <span class=p>])</span> <span class=o>=&gt;</span> <span class=p>{</span>
        <span class=kr>const</span> <span class=nx>context</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>gcp</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>project</span><span class=si>}</span><span class=sb>_</span><span class=si>${</span><span class=nx>gcp</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>zone</span><span class=si>}</span><span class=sb>_</span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
        <span class=k>return</span> <span class=sb>`apiVersion: v1</span>
<span class=sb>clusters:</span>
<span class=sb>- cluster:</span>
<span class=sb>    certificate-authority-data: </span><span class=si>${</span><span class=nx>auth</span><span class=p>.</span><span class=nx>clusterCaCertificate</span><span class=si>}</span><span class=sb></span>
<span class=sb>    server: https://</span><span class=si>${</span><span class=nx>endpoint</span><span class=si>}</span><span class=sb></span>
<span class=sb>  name: </span><span class=si>${</span><span class=nx>context</span><span class=si>}</span><span class=sb></span>
<span class=sb>contexts:</span>
<span class=sb>- context:</span>
<span class=sb>    cluster: </span><span class=si>${</span><span class=nx>context</span><span class=si>}</span><span class=sb></span>
<span class=sb>    user: </span><span class=si>${</span><span class=nx>context</span><span class=si>}</span><span class=sb></span>
<span class=sb>  name: </span><span class=si>${</span><span class=nx>context</span><span class=si>}</span><span class=sb></span>
<span class=sb>current-context: </span><span class=si>${</span><span class=nx>context</span><span class=si>}</span><span class=sb></span>
<span class=sb>kind: Config</span>
<span class=sb>preferences: {}</span>
<span class=sb>users:</span>
<span class=sb>- name: </span><span class=si>${</span><span class=nx>context</span><span class=si>}</span><span class=sb></span>
<span class=sb>  user:</span>
<span class=sb>    auth-provider:</span>
<span class=sb>      config:</span>
<span class=sb>        cmd-args: config config-helper --format=json</span>
<span class=sb>        cmd-path: gcloud</span>
<span class=sb>        expiry-key: &#39;{.credential.token_expiry}&#39;</span>
<span class=sb>        token-key: &#39;{.credential.access_token}&#39;</span>
<span class=sb>      name: gcp</span>
<span class=sb>`</span><span class=p>;</span>
    <span class=p>});</span>

<span class=c1>// Export a Kubernetes provider instance that uses our cluster from above.</span>
<span class=kr>export</span> <span class=kr>const</span> <span class=nx>k8sProvider</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>Provider</span><span class=p>(</span><span class=s2>&quot;gkeK8s&quot;</span><span class=p>,</span> <span class=p>{</span>
    <span class=nx>kubeconfig</span>: <span class=kt>k8sConfig</span><span class=p>,</span>
<span class=p>});</span>
</pre></div> </td></tr></table> <h3 id=pulumi-gcp-config>Pulumi GCP Config<a class=headerlink href=#pulumi-gcp-config title="Permanent link">&para;</a></h3> <ul> <li><a href=https://github.com/pulumi/examples/blob/master/gcp-ts-gke/README.md>https://github.com/pulumi/examples/blob/master/gcp-ts-gke/README.md</a></li> </ul> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nb>export</span> <span class=nv>GCP_PROJECT</span><span class=o>=</span>...
<span class=nb>export</span> <span class=nv>GCP_ZONE</span><span class=o>=</span>europe-west4-a
<span class=nb>export</span> <span class=nv>CLUSTER_PASSWORD</span><span class=o>=</span>...
<span class=nb>export</span> <span class=nv>GCP_SA_NAME</span><span class=o>=</span>...
</pre></div> </td></tr></table> <p>Make sure you have a Google SA (Service Account) by that name first, as you can <a href=https://pulumi.io/quickstart/gcp/index.html>read here</a>. For me it worked best to NOT set any environment variables mentioned. They invairably caused authentication or authorization issues. Just make sure the SA account and it's credential file (see below) are authorized and the <code class=codehilite><span class=n>gcloud</span></code> cli works.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span>gcloud iam service-accounts keys create gcp-credentials.json <span class=se>\</span>
    --iam-account <span class=si>${</span><span class=nv>GCP_SA_NAME</span><span class=si>}</span>@<span class=si>${</span><span class=nv>GCP_PROJECT</span><span class=si>}</span>.iam.gserviceaccount.com
gcloud auth activate-service-account --key-file gcp-credentials.json
gcloud auth application-default login
</pre></div> </td></tr></table> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span>pulumi config <span class=nb>set</span> gcp:project <span class=si>${</span><span class=nv>GCP_PROJECT</span><span class=si>}</span>
pulumi config <span class=nb>set</span> gcp:zone <span class=si>${</span><span class=nv>GCP_ZONE</span><span class=si>}</span>
pulumi config <span class=nb>set</span> password --secret <span class=si>${</span><span class=nv>CLUSTER_PASSWORD</span><span class=si>}</span>
</pre></div> </td></tr></table> <h3 id=post-cluster-creation>Post Cluster Creation<a class=headerlink href=#post-cluster-creation title="Permanent link">&para;</a></h3> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>gcloud container clusters get-credentials joostvdg-dec-2018-pulumi
kubectl create clusterrolebinding cluster-admin-binding  --clusterrole cluster-admin  --user <span class=k>$(</span>gcloud config get-value account<span class=k>)</span>
</pre></div> </td></tr></table> <h2 id=install-failed>Install failed<a class=headerlink href=#install-failed title="Permanent link">&para;</a></h2> <p>Failed to install <code class=codehilite><span class=n>kubernetes</span><span class=o>:</span><span class=n>rbac</span><span class=o>.</span><span class=na>authorization</span><span class=o>.</span><span class=na>k8s</span><span class=o>.</span><span class=na>io</span><span class=o>:</span><span class=n>Role</span> <span class=n>artifactory</span><span class=o>-</span><span class=n>artifactory</span></code>.</p> <p>Probably due to missing rights, so probably have to execute the admin binding before the helm charts.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>error: Plan apply failed: roles.rbac.authorization.k8s.io <span class=s2>&quot;artifactory-artifactory&quot;</span> is forbidden: attempt to grant extra privileges: ...
</pre></div> </td></tr></table> <h2 id=helm-charts>Helm Charts<a class=headerlink href=#helm-charts title="Permanent link">&para;</a></h2> <p>Using Pulumi to install a Helm Chart feels a bit like adding layers of wrapping upon wrapping. The power of Pulumi becomes visible when using more than one related service on the same cluster - for example a SDLC Tool Chain.</p> <p>This example application installs two helm charts, Jenkins and Artifactory, on a GKE cluster that is also created and managed by Pulumi.</p> <p>Below is an example of installing a Helm chart of Jenkins, where we provide the Kubernetes config from the GKE cluster as Provider. This way, Pulumi knows it must install the helm chart in that GKE cluster and not in the current Kubeconfig.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>k8sProvider</span><span class=p>,</span> <span class=nx>k8sConfig</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&quot;./gke-cluster&quot;</span><span class=p>;</span>

<span class=kr>const</span> <span class=nx>jenkins</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>helm</span><span class=p>.</span><span class=nx>v2</span><span class=p>.</span><span class=nx>Chart</span><span class=p>(</span><span class=s2>&quot;jenkins&quot;</span><span class=p>,</span> <span class=p>{</span>
    <span class=nx>repo</span><span class=o>:</span> <span class=s2>&quot;stable&quot;</span><span class=p>,</span>
    <span class=nx>version</span><span class=o>:</span> <span class=s2>&quot;0.25.1&quot;</span><span class=p>,</span>
    <span class=nx>chart</span><span class=o>:</span> <span class=s2>&quot;jenkins&quot;</span><span class=p>,</span>
    <span class=p>},</span> <span class=p>{</span> 
        <span class=nx>providers</span><span class=o>:</span> <span class=p>{</span> <span class=nx>kubernetes</span>: <span class=kt>k8sProvider</span> <span class=p>}</span>
    <span class=p>}</span>
<span class=p>);</span>
</pre></div> </td></tr></table> <h2 id=deployment-service>Deployment &amp; Service<a class=headerlink href=#deployment-service title="Permanent link">&para;</a></h2> <p>First, make sure you have an interface for the configuration arguments.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>LdapArgs</span> <span class=p>{</span>
    <span class=nx>readonly</span> <span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span>
    <span class=nx>readonly</span> <span class=nx>imageName</span>: <span class=kt>string</span><span class=p>,</span>
    <span class=nx>readonly</span> <span class=nx>imageTag</span>: <span class=kt>string</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>Then, create a exportable Pulumi resource class that can be reused.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>LdapInstallation</span> <span class=kr>extends</span> <span class=nx>pulumi</span><span class=p>.</span><span class=nx>ComponentResource</span> <span class=p>{</span>
    <span class=kr>public</span> <span class=nx>readonly</span> <span class=nx>deployment</span>: <span class=kt>k8s.apps.v1.Deployment</span><span class=p>;</span>
    <span class=kr>public</span> <span class=nx>readonly</span> <span class=nx>service</span>: <span class=kt>k8s.core.v1.Service</span><span class=p>;</span>

    <span class=c1>// constructor</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>Inside the constructor placehold we will create a constructor method. It will do all the configuration we need to do for this resource, in this case a Kubernetes Service and Deployment.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kr>constructor</span><span class=p>(</span><span class=nx>args</span>: <span class=kt>LdapArgs</span><span class=p>)</span> <span class=p>{</span>
    <span class=kr>super</span><span class=p>(</span><span class=s2>&quot;k8stypes:service:LdapInstallation&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=p>{});</span>
    <span class=kr>const</span> <span class=nx>labels</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>app</span>: <span class=kt>args.name</span> <span class=p>};</span>
    <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>name</span>
<span class=p>}</span>
</pre></div> </td></tr></table> <p>First Kubernetes resource to create is a container specification for the Deployment.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kr>const</span> <span class=nx>container</span>: <span class=kt>k8stypes.core.v1.Container</span> <span class=o>=</span> <span class=p>{</span>
    <span class=nx>name</span><span class=p>,</span>
    <span class=nx>image</span>: <span class=kt>args.imageName</span> <span class=o>+</span> <span class=s2>&quot;:&quot;</span> <span class=o>+</span> <span class=nx>args</span><span class=p>.</span><span class=nx>imageTag</span><span class=p>,</span>
    <span class=nx>resources</span><span class=o>:</span> <span class=p>{</span>
        <span class=nx>requests</span><span class=o>:</span> <span class=p>{</span> <span class=nx>cpu</span><span class=o>:</span> <span class=s2>&quot;100m&quot;</span><span class=p>,</span> <span class=nx>memory</span><span class=o>:</span> <span class=s2>&quot;200Mi&quot;</span> <span class=p>},</span>
        <span class=nx>limits</span><span class=o>:</span> <span class=p>{</span> <span class=nx>cpu</span><span class=o>:</span> <span class=s2>&quot;100m&quot;</span><span class=p>,</span> <span class=nx>memory</span><span class=o>:</span> <span class=s2>&quot;200Mi&quot;</span> <span class=p>},</span>
    <span class=p>},</span>
    <span class=nx>ports</span><span class=o>:</span> <span class=p>[{</span>
            <span class=nx>name</span><span class=o>:</span> <span class=s2>&quot;ldap&quot;</span><span class=p>,</span><span class=nx>containerPort</span>: <span class=kt>1389</span><span class=p>,</span>
        <span class=p>},</span>
    <span class=p>]</span>
<span class=p>};</span>
</pre></div> </td></tr></table> <p>As the configuration arguments can be any TypeScript type, you can allow people to override entire segments (such as Resources). Which you would do as follows:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=nx>resources</span>: <span class=kt>args.resources</span> <span class=o>||</span> <span class=p>{</span>
        <span class=nx>requests</span><span class=o>:</span> <span class=p>{</span> <span class=nx>cpu</span><span class=o>:</span> <span class=s2>&quot;100m&quot;</span><span class=p>,</span> <span class=nx>memory</span><span class=o>:</span> <span class=s2>&quot;200Mi&quot;</span> <span class=p>},</span>
        <span class=nx>limits</span><span class=o>:</span> <span class=p>{</span> <span class=nx>cpu</span><span class=o>:</span> <span class=s2>&quot;100m&quot;</span><span class=p>,</span> <span class=nx>memory</span><span class=o>:</span> <span class=s2>&quot;200Mi&quot;</span> <span class=p>},</span>
    <span class=p>},</span>
</pre></div> </td></tr></table> <p>The Deployment and Service construction are quite similar.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>this</span><span class=p>.</span><span class=nx>deployment</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>apps</span><span class=p>.</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=p>{</span>
    <span class=nx>spec</span><span class=o>:</span> <span class=p>{</span>
        <span class=nx>selector</span><span class=o>:</span> <span class=p>{</span> <span class=nx>matchLabels</span>: <span class=kt>labels</span> <span class=p>},</span>
        <span class=nx>replicas</span>: <span class=kt>1</span><span class=p>,</span>
        <span class=nx>template</span><span class=o>:</span> <span class=p>{</span>
            <span class=nx>metadata</span><span class=o>:</span> <span class=p>{</span> <span class=nx>labels</span>: <span class=kt>labels</span> <span class=p>},</span>
            <span class=nx>spec</span><span class=o>:</span> <span class=p>{</span> <span class=nx>containers</span><span class=o>:</span> <span class=p>[</span> <span class=nx>container</span> <span class=p>]</span> <span class=p>},</span>
        <span class=p>},</span>
    <span class=p>},</span>
<span class=p>},{</span> <span class=nx>provider</span>: <span class=kt>cluster.k8sProvider</span> <span class=p>});</span>
</pre></div> </td></tr></table> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>this</span><span class=p>.</span><span class=nx>service</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>core</span><span class=p>.</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Service</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=p>{</span>
    <span class=nx>metadata</span><span class=o>:</span> <span class=p>{</span>
        <span class=nx>labels</span>: <span class=kt>this.deployment.metadata.apply</span><span class=p>(</span><span class=nx>meta</span> <span class=o>=&gt;</span> <span class=nx>meta</span><span class=p>.</span><span class=nx>labels</span><span class=p>),</span>
    <span class=p>},</span>
    <span class=nx>spec</span><span class=o>:</span> <span class=p>{</span>
        <span class=nx>ports</span><span class=o>:</span> <span class=p>[{</span>
                <span class=nx>name</span><span class=o>:</span> <span class=s2>&quot;ldap&quot;</span><span class=p>,</span> <span class=nx>port</span>: <span class=kt>389</span><span class=p>,</span> <span class=nx>targetPort</span><span class=o>:</span> <span class=s2>&quot;ldap&quot;</span> <span class=p>,</span> <span class=nx>protocol</span><span class=o>:</span> <span class=s2>&quot;TCP&quot;</span>
            <span class=p>},</span>
        <span class=p>],</span>
        <span class=nx>selector</span>: <span class=kt>this.deployment.spec.apply</span><span class=p>(</span><span class=nx>spec</span> <span class=o>=&gt;</span> <span class=nx>spec</span><span class=p>.</span><span class=nx>template</span><span class=p>.</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>labels</span><span class=p>),</span>
        <span class=nx>type</span><span class=o>:</span> <span class=s2>&quot;ClusterIP&quot;</span><span class=p>,</span>
    <span class=p>},</span>
<span class=p>},</span> <span class=p>{</span> <span class=nx>provider</span>: <span class=kt>cluster.k8sProvider</span> <span class=p>});</span>
</pre></div> </td></tr></table> <h2 id=__comments>Comments</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://joostvdg.github.io/cloud/automation-pulumi/";
      this.page.identifier =
        "/cloud/automation-pulumi/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//joostvdg-github-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../../linux/systemd/ title=SystemD class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> SystemD </span> </div> </a> <a href=../../certificates/lets-encrypt-k8s/ title="Let's Encrypt K8S" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Let's Encrypt K8S </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2019 Joost van der Griendt </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <a href=https://github.com/joostvdg class="md-footer-social__link fa fa-github"></a> <a href=https://twitter.com/joost_vdg class="md-footer-social__link fa fa-twitter"></a> <a href=https://linkedin.com/in/joostvdg class="md-footer-social__link fa fa-linkedin"></a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.245445c6.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> </body> </html>