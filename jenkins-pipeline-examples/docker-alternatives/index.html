



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://joostvdg.github.io/jenkins-pipeline-examples/docker-alternatives/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>Docker Alternatives - Joostvdg's Software Engineering Page</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#fb8c00">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="orange" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../../#pipelines-with-docker-alternatives" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://joostvdg.github.io" title="Joostvdg's Software Engineering Page" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Joostvdg's Software Engineering Page
              </span>
              <span class="md-header-nav__topic">
                Docker Alternatives
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/joostvdg/joostvdg.github.io/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      joostvdg/joostvdg.github.io
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://joostvdg.github.io" title="Joostvdg's Software Engineering Page" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Joostvdg's Software Engineering Page
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/joostvdg/joostvdg.github.io/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      joostvdg/joostvdg.github.io
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Java
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Java
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/" title="General" class="md-nav__link">
      General
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/spring/boot/" title="Spring Boot" class="md-nav__link">
      Spring Boot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/java9/" title="Java 9" class="md-nav__link">
      Java 9
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/ecosystem/" title="Java Ecosystem" class="md-nav__link">
      Java Ecosystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/networking/" title="Java Networking" class="md-nav__link">
      Java Networking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/streams/" title="Java Streams" class="md-nav__link">
      Java Streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../java/concurrency/" title="Java Concurrency" class="md-nav__link">
      Java Concurrency
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Docker
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Docker
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../docker/multi-stage-builds/" title="Multi-Stage Builds" class="md-nav__link">
      Multi-Stage Builds
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../docker/graceful-shutdown/" title="Graceful shutdown" class="md-nav__link">
      Graceful shutdown
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../docker/swarm/" title="Swarm (mode)" class="md-nav__link">
      Swarm (mode)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../docker/kubernetes/" title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Linux
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Linux
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../linux/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../linux/systemd/" title="SystemD" class="md-nav__link">
      SystemD
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../linux/networking/" title="Networking" class="md-nav__link">
      Networking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../linux/iptables/" title="iptables" class="md-nav__link">
      iptables
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Blogs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Blogs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/docker-graceful-shutdown/" title="Docker Graceful Shutdown" class="md-nav__link">
      Docker Graceful Shutdown
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/gitops-pipeline/" title="GitOps Pipeline" class="md-nav__link">
      GitOps Pipeline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/jenkins-pipeline-docker-alternatives/" title="Pipelines with Docker Alternatives" class="md-nav__link">
      Pipelines with Docker Alternatives
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/k8s-crd/" title="Create your own k8s resource" class="md-nav__link">
      Create your own k8s resource
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/k8s-controller/" title="Create your own k8s controller" class="md-nav__link">
      Create your own k8s controller
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/k8s-lets-encrypt/" title="Let's Encrypt for Kubernetes Apps" class="md-nav__link">
      Let's Encrypt for Kubernetes Apps
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/jenkins-pipeline-support-tool/" title="Jenkins Pipeline Support Tools" class="md-nav__link">
      Jenkins Pipeline Support Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blogs/dockercon-eu-2018/" title="DockerCon EU 2018" class="md-nav__link">
      DockerCon EU 2018
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Kubernetes (K8S)
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Kubernetes (K8S)
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/cka-exam/" title="CKA Exam details" class="md-nav__link">
      CKA Exam details
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/cka-exam-prep/" title="CKA Exam prep" class="md-nav__link">
      CKA Exam prep
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      K8S CICD
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        K8S CICD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/cicd/cdp-jenkins-helm/" title="CD Pipeline Jenkins & Helm" class="md-nav__link">
      CD Pipeline Jenkins & Helm
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      K8S Distribution
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        K8S Distribution
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/distributions/install-gke/" title="GKE" class="md-nav__link">
      GKE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/distributions/aws-eks/" title="AWS EKS" class="md-nav__link">
      AWS EKS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      K8S Hard Way - GCE
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        K8S Hard Way - GCE
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/" title="Installer Preparation" class="md-nav__link">
      Installer Preparation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/terraform-compute/" title="Create GCE resources" class="md-nav__link">
      Create GCE resources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/certificates/" title="Prepare Certificates" class="md-nav__link">
      Prepare Certificates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/kubeconfigs/" title="Prepare Kubeconfigs" class="md-nav__link">
      Prepare Kubeconfigs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/encryption/" title="Encryption configuration" class="md-nav__link">
      Encryption configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/etcd/" title="ETCD configuration" class="md-nav__link">
      ETCD configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/controller/" title="Controller Config" class="md-nav__link">
      Controller Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/worker/" title="Worker Config" class="md-nav__link">
      Worker Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/remote-access/" title="Remote access" class="md-nav__link">
      Remote access
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/network/" title="Network config" class="md-nav__link">
      Network config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kubernetes/khw-gce/debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Software Engineering
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Software Engineering
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/naming/" title="Naming" class="md-nav__link">
      Naming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/ddd/" title="Domain Driven Design" class="md-nav__link">
      Domain Driven Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/microservices/" title="Microservices" class="md-nav__link">
      Microservices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/algorithms/" title="Algorithms" class="md-nav__link">
      Algorithms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/observability/" title="Observability" class="md-nav__link">
      Observability
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../swe/others/" title="Others" class="md-nav__link">
      Others
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      Productivity
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        Productivity
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../productivity/" title="General" class="md-nav__link">
      General
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../productivity/tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../productivity/intellij/" title="Intelli J" class="md-nav__link">
      Intelli J
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../productivity/paradigms/" title="Paradigms" class="md-nav__link">
      Paradigms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../productivity/studies/" title="Studies" class="md-nav__link">
      Studies
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      Certificates
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        Certificates
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../certificates/lets-encrypt-k8s/" title="Let's Encrypt K8S" class="md-nav__link">
      Let's Encrypt K8S
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      Other
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        Other
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../other/mkdocs/" title="MKDocs (Static Website Generator)" class="md-nav__link">
      MKDocs (Static Website Generator)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../other/vim/" title="VIM" class="md-nav__link">
      VIM
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-14" type="checkbox" id="nav-14">
    
    <label class="md-nav__link" for="nav-14">
      CloudBees
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-14">
        CloudBees
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cloudbees/cbc-eks/" title="CloudBees Core on EKS" class="md-nav__link">
      CloudBees Core on EKS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cloudbees/cbc-post-install-tips/" title="CloudBees Core Post Install" class="md-nav__link">
      CloudBees Core Post Install
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../jenkins/" title="Jenkins" class="md-nav__link">
      Jenkins
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-16" type="checkbox" id="nav-16">
    
    <label class="md-nav__link" for="nav-16">
      Jenkins Job Management
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-16">
        Jenkins Job Management
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-jobs/jobdsl/" title="JobDSL" class="md-nav__link">
      JobDSL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-jobs/jenkins-jobs-builder/" title="JenkinsJobsBuilder" class="md-nav__link">
      JenkinsJobsBuilder
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-17" type="checkbox" id="nav-17">
    
    <label class="md-nav__link" for="nav-17">
      Jenkins Pipelines
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-17">
        Jenkins Pipelines
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/core-concepts/" title="Core Concepts" class="md-nav__link">
      Core Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/declarative-pipeline/" title="Pipeline (declarative)" class="md-nav__link">
      Pipeline (declarative)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/groovy-pipeline/" title="Groovy DSL Pipeline" class="md-nav__link">
      Groovy DSL Pipeline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/global-shared-library/" title="Pipeline Libraries" class="md-nav__link">
      Pipeline Libraries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/ide-integration-pipeline-dsl/" title="DSL IDE Integration" class="md-nav__link">
      DSL IDE Integration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/jenkins-parallel-pipeline/" title="Parallel" class="md-nav__link">
      Parallel
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../jenkins-pipeline/input/" title="Input" class="md-nav__link">
      Input
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-18" type="checkbox" id="nav-18" checked>
    
    <label class="md-nav__link" for="nav-18">
      Jenkins Pipeline Examples
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-18">
        Jenkins Pipeline Examples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Docker Alternatives
      </label>
    
    <a href="./" title="Docker Alternatives" class="md-nav__link md-nav__link--active">
      Docker Alternatives
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#potential-alternatives" title="Potential Alternatives" class="md-nav__link">
    Potential Alternatives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-pod-and-external-node" title="Kubernetes Pod and External Node" class="md-nav__link">
    Kubernetes Pod and External Node
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steps" title="Steps" class="md-nav__link">
    Steps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-ami-with-packer" title="Create AMI with Packer" class="md-nav__link">
    Create AMI with Packer
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-setup-for-packer" title="AWS setup for Packer" class="md-nav__link">
    AWS setup for Packer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-port-22" title="Enable port 22" class="md-nav__link">
    Enable port 22
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#packer-ami-definition" title="Packer AMI definition" class="md-nav__link">
    Packer AMI definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2-key-pair" title="EC2 Key Pair" class="md-nav__link">
    EC2 Key Pair
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2-cloud-configuration" title="EC2 Cloud Configuration" class="md-nav__link">
    EC2 Cloud Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline" title="Pipeline" class="md-nav__link">
    Pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maven-jib" title="Maven JIB" class="md-nav__link">
    Maven JIB
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites_1" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steps_1" title="Steps" class="md-nav__link">
    Steps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline_1" title="Pipeline" class="md-nav__link">
    Pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kaniko" title="Kaniko" class="md-nav__link">
    Kaniko
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites_2" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steps_2" title="Steps" class="md-nav__link">
    Steps
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-docker-registry-secret" title="Create docker registry secret" class="md-nav__link">
    Create docker registry secret
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-ppeline" title="Example Ppeline" class="md-nav__link">
    Example Ppeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#img" title="IMG" class="md-nav__link">
    IMG
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#not-working-for-me-yet" title="Not working (for me) yet" class="md-nav__link">
    Not working (for me) yet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline-example" title="Pipeline Example" class="md-nav__link">
    Pipeline Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-18-3" type="checkbox" id="nav-18-3">
    
    <label class="md-nav__link" for="nav-18-3">
      Maven
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-18-3">
        Maven
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../maven-groovy-dsl/" title="Maven Groovy DSL" class="md-nav__link">
      Maven Groovy DSL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../maven-declarative/" title="Maven Declarative" class="md-nav__link">
      Maven Declarative
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../maven-shared-library/" title="Maven Shared Library" class="md-nav__link">
      Maven Shared Library
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-18-4" type="checkbox" id="nav-18-4">
    
    <label class="md-nav__link" for="nav-18-4">
      Other
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-18-4">
        Other
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../docker-declarative/" title="Docker Declarative" class="md-nav__link">
      Docker Declarative
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#potential-alternatives" title="Potential Alternatives" class="md-nav__link">
    Potential Alternatives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-pod-and-external-node" title="Kubernetes Pod and External Node" class="md-nav__link">
    Kubernetes Pod and External Node
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steps" title="Steps" class="md-nav__link">
    Steps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-ami-with-packer" title="Create AMI with Packer" class="md-nav__link">
    Create AMI with Packer
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-setup-for-packer" title="AWS setup for Packer" class="md-nav__link">
    AWS setup for Packer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-port-22" title="Enable port 22" class="md-nav__link">
    Enable port 22
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#packer-ami-definition" title="Packer AMI definition" class="md-nav__link">
    Packer AMI definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2-key-pair" title="EC2 Key Pair" class="md-nav__link">
    EC2 Key Pair
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ec2-cloud-configuration" title="EC2 Cloud Configuration" class="md-nav__link">
    EC2 Cloud Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline" title="Pipeline" class="md-nav__link">
    Pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maven-jib" title="Maven JIB" class="md-nav__link">
    Maven JIB
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites_1" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steps_1" title="Steps" class="md-nav__link">
    Steps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline_1" title="Pipeline" class="md-nav__link">
    Pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kaniko" title="Kaniko" class="md-nav__link">
    Kaniko
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites_2" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steps_2" title="Steps" class="md-nav__link">
    Steps
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-docker-registry-secret" title="Create docker registry secret" class="md-nav__link">
    Create docker registry secret
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-ppeline" title="Example Ppeline" class="md-nav__link">
    Example Ppeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#img" title="IMG" class="md-nav__link">
    IMG
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#not-working-for-me-yet" title="Not working (for me) yet" class="md-nav__link">
    Not working (for me) yet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline-example" title="Pipeline Example" class="md-nav__link">
    Pipeline Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/joostvdg/joostvdg.github.io/edit/master/docs/jenkins-pipeline-examples/docker-alternatives.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="pipelines-with-docker-alternatives">Pipelines With Docker Alternatives<a class="headerlink" href="#pipelines-with-docker-alternatives" title="Permanent link">&para;</a></h1>
<p>Building pipelines with Jenkins on Docker has been common for a while.</p>
<p>But accessing the docker socket has always been a bit tricky.
The easiest solution is directly mounting the docker socket of the host into your build container.</p>
<p>However, this is a big security risk and something that is undesirable at best and, pretty dangerous at worst.</p>
<p>When you're using an orchestrator such as Kubernetes - which is where Jenkins is currently best put to work - the problem gets worse. Not only do you open up security holes, you also mess up the schedular's insight into available resources, and mess with it's ability to keep your cluster in a correct state.</p>
<p>In some sense, using docker directly in a Kubernetes cluster, is <a href="https://www.youtube.com/watch?v=ltrV-Qmh3oY">likened to running with scissors</a>.</p>
<h2 id="potential-alternatives">Potential Alternatives<a class="headerlink" href="#potential-alternatives" title="Permanent link">&para;</a></h2>
<p>So, directly running docker containers via a docker engine inside your cluster is out.
Let's look at some alternatives.</p>
<ul>
<li><strong>Kubernetes Pod and External Node</strong>: the simple way out, use a cloud (such as EC2 Cloud) to provision a classic VM with docker engine as an agent and build there</li>
<li><strong>JIB</strong>: tool from Google, only works for Java applications and is supported directly from Gradle and Maven - <a href="https://github.com/GoogleContainerTools/jib">Link</a></li>
<li><strong>Kaniko</strong>: tool from Google, works as 1-on-1 replacement for docker image build (except <em>Windows Containers</em>) - <a href="https://github.com/GoogleContainerTools/kaniko">Link</a></li>
<li><strong>IMG</strong>: tool from Jess Frazelle to avoid building docker images with a root user involved <a href="https://github.com/genuinetools/img">Link</a></li>
</ul>
<h2 id="kubernetes-pod-and-external-node">Kubernetes Pod and External Node<a class="headerlink" href="#kubernetes-pod-and-external-node" title="Permanent link">&para;</a></h2>
<p>One of the most used cloud environments is AWS, so I created this solution with AWS's <a href="https://wiki.jenkins.io/display/JENKINS/Amazon+EC2+Plugin">Amazon EC2 Plugin</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Unfortunately, you cannot combine the Kubernetes plugin with external nodes (none pod container nodes) in a <code>Declarative</code> pipeline. So you have to use <code>Scripted</code>.</p>
</div>
<p>This can be done with various different cloud providers such as Digital Ocean, Google, AWS or Azure.
This guide will use AWS, as it has the most mature <code>Jenkins Cloud</code> plugin.</p>
<h3 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h3>
<ul>
<li>AWS Account with rights to create AMI's and run EC2 instances</li>
<li><a href="https://www.packer.io/">Packer</a></li>
<li>Jenkins with <a href="https://wiki.jenkins.io/display/JENKINS/Amazon+EC2+Plugin">Amazon EC2 Plugin</a> installed</li>
</ul>
<h3 id="steps">Steps<a class="headerlink" href="#steps" title="Permanent link">&para;</a></h3>
<ul>
<li>create AMI with Packer</li>
<li>install and configure Amazon EC2 plugin</li>
<li>create a test pipeline</li>
</ul>
<h3 id="create-ami-with-packer">Create AMI with Packer<a class="headerlink" href="#create-ami-with-packer" title="Permanent link">&para;</a></h3>
<p>Packer needs to be able to access EC2 API's and be able to spin up an EC2 instance and create an AMI out of it.</p>
<h4 id="aws-setup-for-packer">AWS setup for Packer<a class="headerlink" href="#aws-setup-for-packer" title="Permanent link">&para;</a></h4>
<p>You need to configure two things:</p>
<ul>
<li>account details for Packer to use</li>
<li>security group where your EC2 instances will be running with<ul>
<li>this security group needs to open port <code>22</code></li>
<li>both Packer and Jenkins will use this for their connection</li>
</ul>
</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>eu-west-1
<span class="nb">export</span> <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>XXX
<span class="nb">export</span> <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>XXX
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>aws ec2 --profile myAwsProfile create-security-group <span class="se">\</span>
    --description <span class="s2">&quot;For building Docker images&quot;</span> <span class="se">\</span>
    --group-name docker

<span class="o">{</span>
    <span class="s2">&quot;GroupId&quot;</span>: <span class="s2">&quot;sg-08079f78cXXXXXXX&quot;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Export the security group ID.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">SG_ID</span><span class="o">=</span>sg-08079f78cXXXXXXX
<span class="nb">echo</span> <span class="nv">$SG_ID</span>
</pre></div>
</td></tr></table>

<h4 id="enable-port-22">Enable port 22<a class="headerlink" href="#enable-port-22" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>aws ec2 <span class="se">\</span>
    --profile myAwsProfile <span class="se">\</span>
    authorize-security-group-ingress <span class="se">\</span>
    --group-name docker <span class="se">\</span>
    --protocol tcp <span class="se">\</span>
    --port <span class="m">22</span> <span class="se">\</span>
    --cidr <span class="m">0</span>.0.0.0/0
</pre></div>
</td></tr></table>

<h4 id="packer-ami-definition">Packer AMI definition<a class="headerlink" href="#packer-ami-definition" title="Permanent link">&para;</a></h4>
<p>Here's an example definition for Packer for a Ubuntu 18.04 LTS base image with JDK 8 (required by Jenkins) and Docker.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;builders&quot;</span><span class="p">:</span> <span class="p">[{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;amazon-ebs&quot;</span><span class="p">,</span>
        <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;source_ami_filter&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;filters&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;virtualization-type&quot;</span><span class="p">:</span> <span class="s2">&quot;hvm&quot;</span><span class="p">,</span>
                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;*ubuntu-bionic-18.04-amd64-server-*&quot;</span><span class="p">,</span>
                <span class="nt">&quot;root-device-type&quot;</span><span class="p">:</span> <span class="s2">&quot;ebs&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;owners&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;679593333241&quot;</span><span class="p">],</span>
            <span class="nt">&quot;most_recent&quot;</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="nt">&quot;instance_type&quot;</span><span class="p">:</span> <span class="s2">&quot;t2.micro&quot;</span><span class="p">,</span>
        <span class="nt">&quot;ssh_username&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
        <span class="nt">&quot;ami_name&quot;</span><span class="p">:</span> <span class="s2">&quot;docker&quot;</span><span class="p">,</span>
        <span class="nt">&quot;force_deregister&quot;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}],</span>
    <span class="nt">&quot;provisioners&quot;</span><span class="p">:</span> <span class="p">[{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
        <span class="nt">&quot;inline&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;sleep 15&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sudo apt-get clean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sudo apt-get update&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sudo apt-get install -y apt-transport-https ca-certificates nfs-common&quot;</span><span class="p">,</span>
            <span class="s2">&quot;curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sudo add-apt-repository \&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sudo add-apt-repository -y ppa:openjdk-r/ppa&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sudo apt-get update&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sudo apt-get install -y docker-ce&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sudo usermod -aG docker ubuntu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sudo apt-get install -y openjdk-8-jdk&quot;</span><span class="p">,</span>
            <span class="s2">&quot;java -version&quot;</span><span class="p">,</span>
            <span class="s2">&quot;docker version&quot;</span>
        <span class="p">]</span>
    <span class="p">}]</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Build the new AMI with packer.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>packer build docker-ami.json
<span class="nb">export</span> <span class="nv">AMI</span><span class="o">=</span>ami-0212ab37f84e418f4
</pre></div>
</td></tr></table>

<h4 id="ec2-key-pair">EC2 Key Pair<a class="headerlink" href="#ec2-key-pair" title="Permanent link">&para;</a></h4>
<p>Create EC2 key pair, this will be used by Jenkins to connect to the instances via ssh.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>aws ec2 --profile myAwsProfile create-key-pair <span class="se">\</span>
    --key-name jenkinsec2 <span class="se">\</span>
    <span class="p">|</span> jq -r <span class="s1">&#39;.KeyMaterial&#39;</span> <span class="se">\</span>
    &gt;jenkins-ec2-proton.pem
</pre></div>
</td></tr></table>

<h3 id="ec2-cloud-configuration">EC2 Cloud Configuration<a class="headerlink" href="#ec2-cloud-configuration" title="Permanent link">&para;</a></h3>
<p>In a Jenkins' master main configuration, you add a new <code>cloud</code>.
In this case, we will use a <code>ec2-cloud</code> so we can instantiate our EC2 VM's with docker.</p>
<ul>
<li>use EC2 credentials for initial connection</li>
<li>use key (<code>.pem</code>) for VM connection (jenkins &lt;&gt; agent)</li>
<li>configure the following:<ul>
<li>AMI: ami-0212ab37f84e418f4</li>
<li>availability zone: eu-west-1a</li>
<li>VPC SubnetID: subnet-aa54XXXX</li>
<li>Remote user: ubuntu</li>
<li>labels: docker ubuntu linux</li>
<li>SecurityGroup Name: (the id) sg-08079f78cXXXXXXX</li>
<li>public ip = true</li>
<li>connect via public ip = true</li>
</ul>
</li>
</ul>
<h3 id="pipeline">Pipeline<a class="headerlink" href="#pipeline" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nd">@Library</span><span class="o">(</span><span class="s1">&#39;jenkins-pipeline-library@master&#39;</span><span class="o">)</span> <span class="n">_</span>

<span class="kt">def</span> <span class="n">scmVars</span>
<span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;jenkins-slave-${UUID.randomUUID().toString()}&quot;</span>

<span class="n">podTemplate</span><span class="o">(</span>
        <span class="nl">label:</span> <span class="n">label</span><span class="o">,</span>
        <span class="nl">yaml:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">apiVersion: v1</span>
<span class="s2">kind: Pod</span>
<span class="s2">spec:</span>
<span class="s2">  containers:</span>
<span class="s2">  - name: kubectl</span>
<span class="s2">    image: vfarcic/kubectl</span>
<span class="s2">    command: [&quot;cat&quot;]</span>
<span class="s2">    tty: true</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="o">)</span> <span class="o">{</span>
    <span class="n">node</span><span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">node</span><span class="o">(</span><span class="s2">&quot;docker&quot;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;SCM &amp; Prepare&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">scmVars</span> <span class="o">=</span> <span class="n">checkout</span> <span class="n">scm</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Lint&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">dockerfileLint</span><span class="o">()</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Build Docker&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;docker image build -t demo:rc-1 .&quot;</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Tag &amp; Push Docker&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">IMAGE</span> <span class="o">=</span> <span class="s2">&quot;${DOCKER_IMAGE_NAME}&quot;</span>
                <span class="n">TAG</span> <span class="o">=</span> <span class="s2">&quot;${DOCKER_IMAGE_TAG}&quot;</span>
                <span class="n">FULL_NAME</span> <span class="o">=</span> <span class="s2">&quot;${FULL_IMAGE_NAME}&quot;</span>

                <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s2">&quot;dockerhub&quot;</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s2">&quot;USER&quot;</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s2">&quot;PASS&quot;</span><span class="o">)])</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s2">&quot;docker login -u $USER -p $PASS&quot;</span>
                <span class="o">}</span>
                <span class="n">sh</span> <span class="s2">&quot;docker image tag ${IMAGE}:${TAG} ${FULL_NAME}&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;docker image push ${FULL_NAME}&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="c1">// end node docker</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Prepare Pod&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// have to checkout on our kubernetes pod aswell</span>
            <span class="n">checkout</span> <span class="n">scm</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Check version&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">container</span><span class="o">(</span><span class="s1">&#39;kubectl&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s1">&#39;kubectl version&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="c1">// end node random label</span>
<span class="o">}</span> <span class="c1">// end pod def</span>
</pre></div>
</td></tr></table>

<h2 id="maven-jib">Maven JIB<a class="headerlink" href="#maven-jib" title="Permanent link">&para;</a></h2>
<p>If you use Java with either <a href="https://gradle.org/">Gradle</a> or <a href="https://maven.apache.org/">Maven</a>, you can use <a href="https://github.com/GoogleContainerTools/jib">JIB</a> to create docker image without requiring a docker client or docker engine.</p>
<p>JIB will communicate with DockerHub and Google's container registry for sending image layers back and forth.
The last layer will be created by the JIB plugin itself, adding your self-executing Jar to the layer and a <code>Entrypoint</code> with the correct flags.</p>
<p>For more information about the runtime options, see either <a href="https://github.com/GoogleContainerTools/jib/blob/master/jib-maven-plugin">jib-maven-plugin documentation</a> or <a href="https://github.com/GoogleContainerTools/jib/blob/master/jib-gradle-plugin">jib-gradle-plugin</a>.</p>
<h3 id="prerequisites_1">Prerequisites<a class="headerlink" href="#prerequisites_1" title="Permanent link">&para;</a></h3>
<ul>
<li>Java project build with Gradle or Maven</li>
<li>Java project that can start it self, such as <a href="https://spring.io/projects/spring-boot">Spring Boot</a> or <a href="https://thorntail.io/">Thorntail</a> (previously Wildfly Swarm, from the JBoss family)</li>
<li>able to build either gradle or maven applications</li>
</ul>
<h3 id="steps_1">Steps<a class="headerlink" href="#steps_1" title="Permanent link">&para;</a></h3>
<ul>
<li>configure the plugin for either Gradle or Maven</li>
<li>build using an official docker image via the kubernetes pod template</li>
</ul>
<h3 id="pipeline_1">Pipeline<a class="headerlink" href="#pipeline_1" title="Permanent link">&para;</a></h3>
<p>Using a bit more elaborate pipeline example here.</p>
<p>Using SonarCloud for static code analysis and then JIB to create a docker image.
We could then use that image either directly in anything that runs docker or in the same cluster via a Helm Chart.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">def</span> <span class="n">scmVars</span>
<span class="kt">def</span> <span class="n">tag</span>

<span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">options</span> <span class="o">{</span>
        <span class="n">buildDiscarder</span> <span class="nf">logRotator</span><span class="o">(</span><span class="nl">artifactDaysToKeepStr:</span> <span class="s1">&#39;5&#39;</span><span class="o">,</span> <span class="nl">artifactNumToKeepStr:</span> <span class="s1">&#39;5&#39;</span><span class="o">,</span> <span class="nl">daysToKeepStr:</span> <span class="s1">&#39;5&#39;</span><span class="o">,</span> <span class="nl">numToKeepStr:</span> <span class="s1">&#39;5&#39;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">libraries</span> <span class="o">{</span>
        <span class="n">lib</span><span class="o">(</span><span class="s1">&#39;jenkins-pipeline-library@master&#39;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">agent</span> <span class="o">{</span>
        <span class="n">kubernetes</span> <span class="o">{</span>
            <span class="n">label</span> <span class="s1">&#39;mypod&#39;</span>
            <span class="n">defaultContainer</span> <span class="s1">&#39;jnlp&#39;</span>
            <span class="n">yaml</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">apiVersion: v1</span>
<span class="s2">kind: Pod</span>
<span class="s2">metadata:</span>
<span class="s2">  labels:</span>
<span class="s2">    some-label: some-label-value</span>
<span class="s2">spec:</span>
<span class="s2">  containers:</span>
<span class="s2">  - name: maven</span>
<span class="s2">    image: maven:3-jdk-11-slim</span>
<span class="s2">    command:</span>
<span class="s2">    - cat</span>
<span class="s2">    tty: true</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Test versions&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;uname -a&#39;</span>
                    <span class="n">sh</span> <span class="s1">&#39;mvn -version&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Checkout&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">script</span> <span class="o">{</span>
                    <span class="n">scmVars</span> <span class="o">=</span> <span class="n">checkout</span> <span class="n">scm</span>
                <span class="o">}</span>
                <span class="n">gitRemoteConfigByUrl</span><span class="o">(</span><span class="n">scmVars</span><span class="o">.</span><span class="na">GIT_URL</span><span class="o">,</span> <span class="s1">&#39;githubtoken&#39;</span><span class="o">)</span>
                <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                git config --global user.email &quot;jenkins@jenkins.io&quot;</span>
<span class="s1">                git config --global user.name &quot;Jenkins&quot;</span>
<span class="s1">                &#39;&#39;&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;mvn clean verify -B -e&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Version &amp; Analysis&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">parallel</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Version Bump&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">when</span> <span class="o">{</span> <span class="n">branch</span> <span class="s1">&#39;master&#39;</span> <span class="o">}</span>
                    <span class="n">environment</span> <span class="o">{</span>
                        <span class="n">NEW_VERSION</span> <span class="o">=</span> <span class="n">gitNextSemverTagMaven</span><span class="o">(</span><span class="s1">&#39;pom.xml&#39;</span><span class="o">)</span>
                    <span class="o">}</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">script</span> <span class="o">{</span>
                            <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;${NEW_VERSION}&quot;</span>
                        <span class="o">}</span>
                        <span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">sh</span> <span class="s1">&#39;mvn versions:set -DnewVersion=${NEW_VERSION}&#39;</span>
                        <span class="o">}</span>
                        <span class="n">gitTag</span><span class="o">(</span><span class="s2">&quot;v${NEW_VERSION}&quot;</span><span class="o">)</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Sonar Analysis&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">when</span> <span class="o">{</span><span class="n">branch</span> <span class="s1">&#39;master&#39;</span><span class="o">}</span>
                    <span class="n">environment</span> <span class="o">{</span>
                        <span class="n">SONAR_HOST</span><span class="o">=</span><span class="s1">&#39;https://sonarcloud.io&#39;</span>
                        <span class="n">KEY</span><span class="o">=</span><span class="s1">&#39;spring-maven-demo&#39;</span>
                        <span class="n">ORG</span><span class="o">=</span><span class="s1">&#39;demomon&#39;</span>
                        <span class="n">SONAR_TOKEN</span><span class="o">=</span><span class="n">credentials</span><span class="o">(</span><span class="s1">&#39;sonarcloud&#39;</span><span class="o">)</span>
                    <span class="o">}</span>
                    <span class="n">steps</span> <span class="o">{</span>
                        <span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;mvn sonar:sonar \</span>
<span class="s1">                                -Dsonar.projectKey=${KEY} \</span>
<span class="s1">                                -Dsonar.organization=${ORG} \</span>
<span class="s1">                                -Dsonar.host.url=${SONAR_HOST} \</span>
<span class="s1">                                -Dsonar.login=${SONAR_TOKEN}</span>
<span class="s1">                            &#39;&#39;&#39;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Publish Artifact&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span> <span class="n">branch</span> <span class="s1">&#39;master&#39;</span> <span class="o">}</span>
            <span class="n">environment</span> <span class="o">{</span>
                <span class="n">DHUB</span><span class="o">=</span><span class="n">credentials</span><span class="o">(</span><span class="s1">&#39;dockerhub&#39;</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// we should never come here if the tests have not run, as we run verify before</span>
                    <span class="n">sh</span> <span class="s1">&#39;mvn clean compile -B -e jib:build -Djib.to.auth.username=${DHUB_USR} -Djib.to.auth.password=${DHUB_PSW} -DskipTests&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">post</span> <span class="o">{</span>
        <span class="n">always</span> <span class="o">{</span>
            <span class="n">cleanWs</span><span class="o">()</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<h2 id="kaniko">Kaniko<a class="headerlink" href="#kaniko" title="Permanent link">&para;</a></h2>
<p>Google loves Kubernetes and Google prefers people building docker images in Kubernetes without Docker.</p>
<p>As JIB is only available for Java projects, there's needs to be an alternative for any other usecase/programming language.</p>
<p>The answer to that is <a href="https://github.com/GoogleContainerTools/kaniko">Kaniko</a>, a specialized Docker image to create Docker images.</p>
<p>Kaniko isn't the most secure way to create docker images, it barely beats mounting a Docker Socket, or might even be worse if you ask others (such as <a href="https://twitter.com/jessfraz/status/985947353981976576">Jess Frazelle</a>). </p>
<p>That said, it is gaining some traction being used by <a href="https://jenkins-x.io">JenkinsX</a> and having an example in <a href="https://github.com/jenkinsci/kubernetes-plugin/blob/master/examples/kaniko-declarative.groovy">Jenkins' Kubernetes Plugin</a>.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>When building more than one image inside the kaniko container, make sure to use the <code>--cleanup</code> flag.
So it cleans its temporary cache data before building the next image, as discussed in <a href="https://groups.google.com/forum/#!topic/kaniko-users/_7LivHdMdy0">this google group</a>.</p>
</div>
<h3 id="prerequisites_2">Prerequisites<a class="headerlink" href="#prerequisites_2" title="Permanent link">&para;</a></h3>
<h3 id="steps_2">Steps<a class="headerlink" href="#steps_2" title="Permanent link">&para;</a></h3>
<ul>
<li>Create docker registry secret</li>
<li>Configure pod container template</li>
<li>Configure stage</li>
</ul>
<h4 id="create-docker-registry-secret">Create docker registry secret<a class="headerlink" href="#create-docker-registry-secret" title="Permanent link">&para;</a></h4>
<p>This is an example for DockerHub inside the <code>build</code> namespace.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>kubectl create secret docker-registry -n build regcred <span class="se">\</span>
    --docker-server<span class="o">=</span>index.docker.io <span class="se">\</span>
    --docker-username<span class="o">=</span>myDockerHubAccount <span class="se">\</span>
    --docker-password<span class="o">=</span>myDockerHubPassword <span class="se">\</span>
    --docker-email<span class="o">=</span>myDockerHub@Email.com
</pre></div>
</td></tr></table>

<h5 id="example-ppeline">Example Ppeline<a class="headerlink" href="#example-ppeline" title="Permanent link">&para;</a></h5>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Although multi-stage <code>Dockerfile</code>'s are supported, it did fail in my case.
So I created a second Dockerfile which is only for running the application (<code>Dockerfile.run</code>).</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="o">{</span>
        <span class="n">kubernetes</span> <span class="o">{</span>
            <span class="c1">//cloud &#39;kubernetes&#39;</span>
            <span class="n">label</span> <span class="s1">&#39;kaniko&#39;</span>
            <span class="n">yaml</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">kind: Pod</span>
<span class="s2">metadata:</span>
<span class="s2">  name: kaniko</span>
<span class="s2">spec:</span>
<span class="s2">  containers:</span>
<span class="s2">  - name: golang</span>
<span class="s2">    image: golang:1.11</span>
<span class="s2">    command:</span>
<span class="s2">    - cat</span>
<span class="s2">    tty: true</span>
<span class="s2">  - name: kaniko</span>
<span class="s2">    image: gcr.io/kaniko-project/executor:debug</span>
<span class="s2">    imagePullPolicy: Always</span>
<span class="s2">    command:</span>
<span class="s2">    - /busybox/cat</span>
<span class="s2">    tty: true</span>
<span class="s2">    volumeMounts:</span>
<span class="s2">      - name: jenkins-docker-cfg</span>
<span class="s2">        mountPath: /root</span>
<span class="s2">      - name: go-build-cache</span>
<span class="s2">        mountPath: /root/.cache/go-build</span>
<span class="s2">      - name: img-build-cache</span>
<span class="s2">        mountPath: /root/.local</span>
<span class="s2">  volumes:</span>
<span class="s2">  - name: go-build-cache</span>
<span class="s2">    emptyDir: {}</span>
<span class="s2">  - name: img-build-cache</span>
<span class="s2">    emptyDir: {}</span>
<span class="s2">  - name: jenkins-docker-cfg</span>
<span class="s2">    projected:</span>
<span class="s2">      sources:</span>
<span class="s2">      - secret:</span>
<span class="s2">          name: regcred</span>
<span class="s2">          items:</span>
<span class="s2">            - key: .dockerconfigjson</span>
<span class="s2">              path: .docker/config.json</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Checkout&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">git</span> <span class="s1">&#39;https://github.com/joostvdg/cat.git&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;golang&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;./build-go-bin.sh&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Make Image&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">environment</span> <span class="o">{</span>
                <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;/busybox:$PATH&quot;</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">container</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">&#39;kaniko&#39;</span><span class="o">,</span> <span class="nl">shell:</span> <span class="s1">&#39;/busybox/sh&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;&#39;&#39;#!/busybox/sh</span>
<span class="s1">                    /kaniko/executor -f `pwd`/Dockerfile.run -c `pwd` --cache=true --destination=index.docker.io/caladreas/cat</span>
<span class="s1">                    &#39;&#39;&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<h2 id="img">IMG<a class="headerlink" href="#img" title="Permanent link">&para;</a></h2>
<p><code>img</code> is the brainchild of Jess Frazelle, a prominent figure in the container space.</p>
<p>The goal is to be the safest and best way to build OCI compliant images, as outlined in her blog <a href="https://blog.jessfraz.com/post/building-container-images-securely-on-kubernetes/">building container images securely on kubernetes</a>.</p>
<h3 id="not-working-for-me-yet">Not working (for me) yet<a class="headerlink" href="#not-working-for-me-yet" title="Permanent link">&para;</a></h3>
<p>It does not seem to work for me on AWS's EKS.
To many little details with relation to runc, file permissions and other configuration.</p>
<p>For those who want to give it a spin, here are some resources to take a look at.</p>
<ul>
<li><a href="https://blog.jessfraz.com/post/building-container-images-securely-on-kubernetes/">https://blog.jessfraz.com/post/building-container-images-securely-on-kubernetes/</a></li>
<li><a href="https://github.com/genuinetools/img">https://github.com/genuinetools/img</a></li>
<li><a href="https://github.com/opencontainers/runc">https://github.com/opencontainers/runc</a></li>
<li><a href="https://git.j3ss.co/genuinetools/img/+/d05b3e4e10cd0e3c074ffb03dc22d7bb6cde1e78">https://git.j3ss.co/genuinetools/img/+/d05b3e4e10cd0e3c074ffb03dc22d7bb6cde1e78</a></li>
</ul>
<h3 id="pipeline-example">Pipeline Example<a class="headerlink" href="#pipeline-example" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="o">{</span>
        <span class="n">kubernetes</span> <span class="o">{</span>
            <span class="n">label</span> <span class="s1">&#39;img&#39;</span>
            <span class="n">yaml</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">kind: Pod</span>
<span class="s2">metadata:</span>
<span class="s2">  name: img</span>
<span class="s2">  annotations:</span>
<span class="s2">    container.apparmor.security.beta.kubernetes.io/img: unconfined  </span>
<span class="s2">spec:</span>
<span class="s2">  containers:</span>
<span class="s2">  - name: golang</span>
<span class="s2">    image: golang:1.11</span>
<span class="s2">    command:</span>
<span class="s2">    - cat</span>
<span class="s2">    tty: true</span>
<span class="s2">  - name: img</span>
<span class="s2">    workingDir: /home/jenkins</span>
<span class="s2">    image: caladreas/img:0.5.1</span>
<span class="s2">    imagePullPolicy: Always</span>
<span class="s2">    securityContext:</span>
<span class="s2">        rawProc: true</span>
<span class="s2">        privileged: true</span>
<span class="s2">    command:</span>
<span class="s2">    - cat</span>
<span class="s2">    tty: true</span>
<span class="s2">    volumeMounts:</span>
<span class="s2">      - name: jenkins-docker-cfg</span>
<span class="s2">        mountPath: /root</span>
<span class="s2">  volumes:</span>
<span class="s2">  - name: temp</span>
<span class="s2">    emptyDir: {}</span>
<span class="s2">  - name: jenkins-docker-cfg</span>
<span class="s2">    projected:</span>
<span class="s2">      sources:</span>
<span class="s2">      - secret:</span>
<span class="s2">          name: regcred</span>
<span class="s2">          items:</span>
<span class="s2">            - key: .dockerconfigjson</span>
<span class="s2">              path: .docker/config.json</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Checkout&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">git</span> <span class="s1">&#39;https://github.com/joostvdg/cat.git&#39;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Build&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;golang&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;./build-go-bin.sh&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Make Image&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;img&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s1">&#39;mkdir cache&#39;</span>
                    <span class="n">sh</span> <span class="s1">&#39;img build -s ./cache -f Dockerfile.run -t caladreas/cat .&#39;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../" title="Index" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Index
              </span>
            </div>
          </a>
        
        
          <a href="../maven-groovy-dsl/" title="Maven Groovy DSL" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Maven Groovy DSL
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 Joost van der Griendt
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/joostvdg" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/joost_vdg" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/in/joostvdg" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.583bbe55.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>