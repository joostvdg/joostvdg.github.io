<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Have To Achieve Graceful Shutdown In Docker Containers"><link href=https://joostvdg.github.io/blogs/graceful-shutdown/ rel=canonical><link href=../jenkins-pipeline-support-tool/ rel=prev><link href=../docker-alternatives/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.4.7"><title>Docker Graceful Shutdown - J's Software Development Pages</title><link rel=stylesheet href=../../assets/stylesheets/main.4b4a2bd9.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.356b1318.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"JetBrains Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-353607268"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-353607268",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-353607268",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=orange data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#gracefully-shutting-down-applications-in-docker class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="J's Software Development Pages" class="md-header__button md-logo" aria-label="J's Software Development Pages" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M6.5 20q-2.28 0-3.89-1.57Q1 16.85 1 14.58q0-1.95 1.17-3.48 1.18-1.53 3.08-1.95.63-2.3 2.5-3.72Q9.63 4 12 4q2.93 0 4.96 2.04Q19 8.07 19 11q1.73.2 2.86 1.5 1.14 1.28 1.14 3 0 1.88-1.31 3.19T18.5 20Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> J's Software Development Pages </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Docker Graceful Shutdown </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=orange data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=deep-orange data-md-color-accent=teal aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/joostvdg/joostvdg.github.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../jenkins-pipeline-support-tool/ class=md-tabs__link> Blogs </a> </li> <li class=md-tabs__item> <a href=../../jenkins/jenkins-on-kubernetes/ class=md-tabs__link> Jenkins & CloudBees </a> </li> <li class=md-tabs__item> <a href=../../openshift/rhos311-gcp-minimal/ class=md-tabs__link> Kubernetes & Docker </a> </li> <li class=md-tabs__item> <a href=../../tanzu/ class=md-tabs__link> VMware Tanzu </a> </li> <li class=md-tabs__item> <a href=../../jenkinsx/build-packs/ class=md-tabs__link> Jenkins X </a> </li> <li class=md-tabs__item> <a href=../../cloud/automation-pulumi/ class=md-tabs__link> Software Eng. </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="J's Software Development Pages" class="md-nav__button md-logo" aria-label="J's Software Development Pages" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M6.5 20q-2.28 0-3.89-1.57Q1 16.85 1 14.58q0-1.95 1.17-3.48 1.18-1.53 3.08-1.95.63-2.3 2.5-3.72Q9.63 4 12 4q2.93 0 4.96 2.04Q19 8.07 19 11q1.73.2 2.86 1.5 1.14 1.28 1.14 3 0 1.88-1.31 3.19T18.5 20Z"/></svg> </a> J's Software Development Pages </label> <div class=md-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex> <span class=md-ellipsis> Home </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Me </span> </a> </li> <li class=md-nav__item> <a href=../../other/mkdocs/ class=md-nav__link> <span class=md-ellipsis> MKDocs (This Static Website) </span> </a> </li> <li class=md-nav__item> <a href=../../other/vim/ class=md-nav__link> <span class=md-ellipsis> VIM </span> </a> </li> <li class=md-nav__item> <a href=../../other/shell/ class=md-nav__link> <span class=md-ellipsis> Shell </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Blogs </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Blogs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../jenkins-pipeline-support-tool/ class=md-nav__link> <span class=md-ellipsis> Jenkins Pipeline Support Tools </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Docker Graceful Shutdown </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Docker Graceful Shutdown </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#the-case-for-graceful-shutdown class=md-nav__link> The case for graceful shutdown </a> </li> <li class=md-nav__item> <a href=#start-good-so-you-can-end-well class=md-nav__link> Start Good So You Can End Well </a> <nav class=md-nav aria-label="Start Good So You Can End Well"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-shell-form-example class=md-nav__link> Docker Shell form example </a> </li> <li class=md-nav__item> <a href=#docker-exec-form-example class=md-nav__link> Docker exec form example </a> </li> <li class=md-nav__item> <a href=#gotchas class=md-nav__link> Gotchas </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#make-sure-your-process-listens class=md-nav__link> Make Sure Your Process Listens </a> <nav class=md-nav aria-label="Make Sure Your Process Listens"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#let-docker-manage-it-for-us class=md-nav__link> Let Docker manage it for us </a> </li> <li class=md-nav__item> <a href=#depend-on-a-process-manager class=md-nav__link> Depend on a process manager </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#how-to-be-told-what-you-want-to-hear class=md-nav__link> How To Be Told What You Want To Hear </a> <nav class=md-nav aria-label="How To Be Told What You Want To Hear"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#handle-signals-as-they-come class=md-nav__link> Handle signals as they come </a> </li> <li class=md-nav__item> <a href=#state-the-signals-we-want class=md-nav__link> State the signals we want </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#how-to-be-told-when-you-want-to-hear-it class=md-nav__link> How To Be Told When You Want To Hear It </a> <nav class=md-nav aria-label="How To Be Told When You Want To Hear It"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker class=md-nav__link> Docker </a> </li> <li class=md-nav__item> <a href=#kubernetes_1 class=md-nav__link> Kubernetes </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#examples class=md-nav__link> Examples </a> <nav class=md-nav aria-label=Examples> <ul class=md-nav__list> <li class=md-nav__item> <a href=#go class=md-nav__link> Go </a> </li> <li class=md-nav__item> <a href=#java-plain-docker-swarm class=md-nav__link> Java plain (Docker Swarm) </a> </li> <li class=md-nav__item> <a href=#java-plain-kubernetes class=md-nav__link> Java Plain (Kubernetes) </a> </li> <li class=md-nav__item> <a href=#java-spring-boot-1x class=md-nav__link> Java Spring Boot (1.x) </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#example-with-docker-swarm class=md-nav__link> Example with Docker Swarm </a> <nav class=md-nav aria-label="Example with Docker Swarm"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-swarm-cluster class=md-nav__link> Docker swarm cluster </a> </li> <li class=md-nav__item> <a href=#docker-swarm-network-and-multicast class=md-nav__link> Docker swarm network and multicast </a> </li> <li class=md-nav__item> <a href=#docker-stack class=md-nav__link> Docker stack </a> </li> <li class=md-nav__item> <a href=#execute-example_1 class=md-nav__link> Execute example </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#further-reading class=md-nav__link> Further reading </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../docker-alternatives/ class=md-nav__link> <span class=md-ellipsis> Pipelines with Docker Alternatives </span> </a> </li> <li class=md-nav__item> <a href=../k8s-lets-encrypt/ class=md-nav__link> <span class=md-ellipsis> Let's Encrypt for Kubernetes Apps </span> </a> </li> <li class=md-nav__item> <a href=../sso-azure-ad/ class=md-nav__link> <span class=md-ellipsis> CloudBees SSO Azure AD </span> </a> </li> <li class=md-nav__item> <a href=../teams-automation/ class=md-nav__link> <span class=md-ellipsis> CloudBees Automate Teams </span> </a> </li> <li class=md-nav__item> <a href=../kubernetes-sso-keycloak/ class=md-nav__link> <span class=md-ellipsis> Kubernetes SSO Keycloak </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_8> <label class=md-nav__link for=__nav_2_8 id=__nav_2_8_label tabindex=0> <span class=md-ellipsis> Jenkins X Java Native Image Prod </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_8_label aria-expanded=false> <label class=md-nav__title for=__nav_2_8> <span class="md-nav__icon md-icon"></span> Jenkins X Java Native Image Prod </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/01-intro/ class=md-nav__link> <span class=md-ellipsis> Intro </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/02-cloud-sql/ class=md-nav__link> <span class=md-ellipsis> Cloud SQL </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/03-quarkus/ class=md-nav__link> <span class=md-ellipsis> Quarkus </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/04-jx-import/ class=md-nav__link> <span class=md-ellipsis> Import Into Jenkins X </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/05-jx-secrets/ class=md-nav__link> <span class=md-ellipsis> Database Connection And Secrets </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/06-native-image/ class=md-nav__link> <span class=md-ellipsis> Native Image </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/07-pipeline-improvements/ class=md-nav__link> <span class=md-ellipsis> Pipeline Improvements </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/08-preview-int-test/ class=md-nav__link> <span class=md-ellipsis> Previews & Integration Tests </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/09-production-improvements/ class=md-nav__link> <span class=md-ellipsis> Production Improvements </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/10-promote-prod/ class=md-nav__link> <span class=md-ellipsis> Promote To Production </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_9> <label class=md-nav__link for=__nav_2_9 id=__nav_2_9_label tabindex=0> <span class=md-ellipsis> Jenkins Monitoring Kubernetes </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_9_label aria-expanded=false> <label class=md-nav__title for=__nav_2_9> <span class="md-nav__icon md-icon"></span> Jenkins Monitoring Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/prepare/ class=md-nav__link> <span class=md-ellipsis> Prepare Environment </span> </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/install/ class=md-nav__link> <span class=md-ellipsis> Install Tools </span> </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/metrics/ class=md-nav__link> <span class=md-ellipsis> Metrics </span> </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/alerts/ class=md-nav__link> <span class=md-ellipsis> Alerts </span> </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/pipeline/ class=md-nav__link> <span class=md-ellipsis> Pipeline </span> </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/dashboard/ class=md-nav__link> <span class=md-ellipsis> Dashboard </span> </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/cloudbees/ class=md-nav__link> <span class=md-ellipsis> CloudBees </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../k8s-crd/ class=md-nav__link> <span class=md-ellipsis> Create your own k8s resource </span> </a> </li> <li class=md-nav__item> <a href=../dockercon-eu-2018/ class=md-nav__link> <span class=md-ellipsis> DockerCon EU 2018 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Jenkins & CloudBees </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Jenkins & CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins/jenkins-on-kubernetes/ class=md-nav__link> <span class=md-ellipsis> Jenkins On Kubernetes </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/jenkins-tap/ class=md-nav__link> <span class=md-ellipsis> TAP & Jenkins </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class=md-ellipsis> CloudBees </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloudbees/cbci-casc/ class=md-nav__link> <span class=md-ellipsis> CloudBees CasC </span> </a> </li> <li class=md-nav__item> <a href=../../cloudbees/sso-azure-ad/ class=md-nav__link> <span class=md-ellipsis> Single Sign On - AzureAD </span> </a> </li> <li class=md-nav__item> <a href=../../cloudbees/teams-automation/ class=md-nav__link> <span class=md-ellipsis> CloudBees Automate Teams </span> </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-gke-helm/ class=md-nav__link> <span class=md-ellipsis> CloudBees CI on GKE </span> </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-eks/ class=md-nav__link> <span class=md-ellipsis> CloudBees CI on EKS </span> </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-team-namespace/ class=md-nav__link> <span class=md-ellipsis> Team Master Namespace </span> </a> </li> <li class=md-nav__item> <a href=../../cloudbees/multi-cluster-gke/ class=md-nav__link> <span class=md-ellipsis> Multi-Cluster GKE </span> </a> </li> <li class=md-nav__item> <a href=../../cloudbees/multi-cluster-eks/ class=md-nav__link> <span class=md-ellipsis> Multi-Cluster EKS </span> </a> </li> <li class=md-nav__item> <a href=../../cloudbees/multi-cluster/ class=md-nav__link> <span class=md-ellipsis> Multi-Cluster (OLD/AKS) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex=0> <span class=md-ellipsis> Jenkins </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Jenkins </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins/ class=md-nav__link> <span class=md-ellipsis> Intro </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jobdsl/ class=md-nav__link> <span class=md-ellipsis> JobDSL </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jenkins-jobs-builder/ class=md-nav__link> <span class=md-ellipsis> JenkinsJobsBuilder </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5 id=__nav_3_5_label tabindex=0> <span class=md-ellipsis> Jenkins Pipelines </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> Jenkins Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline/job-types/ class=md-nav__link> <span class=md-ellipsis> Job Types </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/kaniko-pipelines/ class=md-nav__link> <span class=md-ellipsis> Build Docker Image Kaniko </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/podtemplate-dind/ class=md-nav__link> <span class=md-ellipsis> PodTemplate With Docker-In-Docker </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/jenkins-parallel-pipeline/ class=md-nav__link> <span class=md-ellipsis> Parallel Pipelines </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/core-concepts/ class=md-nav__link> <span class=md-ellipsis> Core Concepts </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/artifactory-integration/ class=md-nav__link> <span class=md-ellipsis> Artifactory Integration </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/declarative-pipeline/ class=md-nav__link> <span class=md-ellipsis> Pipeline (declarative) </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/groovy-pipeline/ class=md-nav__link> <span class=md-ellipsis> Groovy DSL Pipeline </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/global-shared-library/ class=md-nav__link> <span class=md-ellipsis> Pipeline Libraries </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/ide-integration-pipeline-dsl/ class=md-nav__link> <span class=md-ellipsis> DSL IDE Integration </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/input/ class=md-nav__link> <span class=md-ellipsis> Input </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_6> <label class=md-nav__link for=__nav_3_6 id=__nav_3_6_label tabindex=0> <span class=md-ellipsis> Jenkins Pipeline Examples </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_6_label aria-expanded=false> <label class=md-nav__title for=__nav_3_6> <span class="md-nav__icon md-icon"></span> Jenkins Pipeline Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/ class=md-nav__link> <span class=md-ellipsis> Index </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-alternatives/ class=md-nav__link> <span class=md-ellipsis> Docker Alternatives </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/maven-declarative/ class=md-nav__link> <span class=md-ellipsis> Maven Declarative </span> </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-declarative/ class=md-nav__link> <span class=md-ellipsis> Docker Declarative </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Kubernetes & Docker </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Kubernetes & Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex=0> <span class=md-ellipsis> OpenShift </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> OpenShift </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../openshift/rhos311-gcp-minimal/ class=md-nav__link> <span class=md-ellipsis> OpenShift 3.11 GCP(minimal) </span> </a> </li> <li class=md-nav__item> <a href=../../openshift/rhos311-gcp-medium/ class=md-nav__link> <span class=md-ellipsis> OpenShift 3.11 GCP(medium) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Kubernetes (K8S) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Kubernetes (K8S) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/cka-exam-prep/ class=md-nav__link> <span class=md-ellipsis> CKA Exam prep </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/tools/ class=md-nav__link> <span class=md-ellipsis> Tools </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class=md-ellipsis> Managed Kubernetes (cloud) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Managed Kubernetes (cloud) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/distributions/install-gke/ class=md-nav__link> <span class=md-ellipsis> GKE </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/gke-terraform/ class=md-nav__link> <span class=md-ellipsis> GKE Terraform </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/eks-eksctl/ class=md-nav__link> <span class=md-ellipsis> AWS EKS </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-cli/ class=md-nav__link> <span class=md-ellipsis> AKS CLI </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-terraform/ class=md-nav__link> <span class=md-ellipsis> AKS Terraform </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex=0> <span class=md-ellipsis> K8S Hard Way - GCE </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> K8S Hard Way - GCE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/ class=md-nav__link> <span class=md-ellipsis> Installer Preparation </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/terraform-compute/ class=md-nav__link> <span class=md-ellipsis> Create GCE resources </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/certificates/ class=md-nav__link> <span class=md-ellipsis> Prepare Certificates </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/kubeconfigs/ class=md-nav__link> <span class=md-ellipsis> Prepare Kubeconfigs </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/encryption/ class=md-nav__link> <span class=md-ellipsis> Encryption configuration </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/etcd/ class=md-nav__link> <span class=md-ellipsis> ETCD configuration </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/controller/ class=md-nav__link> <span class=md-ellipsis> Controller Config </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/worker/ class=md-nav__link> <span class=md-ellipsis> Worker Config </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/remote-access/ class=md-nav__link> <span class=md-ellipsis> Remote access </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/network/ class=md-nav__link> <span class=md-ellipsis> Network config </span> </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/debug/ class=md-nav__link> <span class=md-ellipsis> Debug </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5 id=__nav_4_5_label tabindex=0> <span class=md-ellipsis> Docker </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_5_label aria-expanded=false> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docker/graceful-shutdown/ class=md-nav__link> <span class=md-ellipsis> Graceful Shutdown </span> </a> </li> <li class=md-nav__item> <a href=../../docker/build-kit/ class=md-nav__link> <span class=md-ellipsis> BuildKit </span> </a> </li> <li class=md-nav__item> <a href=../../docker/multi-stage-builds/ class=md-nav__link> <span class=md-ellipsis> Multi-Stage Builds(TBD) </span> </a> </li> <li class=md-nav__item> <a href=../../docker/swarm/ class=md-nav__link> <span class=md-ellipsis> Swarm (mode) (TBD) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_6> <label class=md-nav__link for=__nav_4_6 id=__nav_4_6_label tabindex=0> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_6_label aria-expanded=false> <label class=md-nav__title for=__nav_4_6> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../linux/systemd/ class=md-nav__link> <span class=md-ellipsis> SystemD </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> VMware Tanzu </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> VMware Tanzu </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tanzu/ class=md-nav__link> <span class=md-ellipsis> Tanzu </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> <span class=md-ellipsis> TAP GitOps </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> TAP GitOps </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tanzu/tap-gitops/ class=md-nav__link> <span class=md-ellipsis> Intro </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap-gitops/services/ class=md-nav__link> <span class=md-ellipsis> Services </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap-gitops/tap-gitops-prep/ class=md-nav__link> <span class=md-ellipsis> TAP GitOps Prep </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap-gitops/tap-build/ class=md-nav__link> <span class=md-ellipsis> TAP Build </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap-gitops/tap-run/ class=md-nav__link> <span class=md-ellipsis> TAP Run </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap-gitops/tap-view/ class=md-nav__link> <span class=md-ellipsis> TAP View </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap-gitops/next-steps/ class=md-nav__link> <span class=md-ellipsis> Next Steps </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap-gitops/run-with-argocd/ class=md-nav__link> <span class=md-ellipsis> TAP Run With ArgoCD </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_3> <label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex=0> <span class=md-ellipsis> TAP Supply Chain Customization </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> TAP Supply Chain Customization </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tanzu/supplychain/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/supplychain/gitops-flow/ class=md-nav__link> <span class=md-ellipsis> GitOps Flow </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_4> <label class=md-nav__link for=__nav_5_4 id=__nav_5_4_label tabindex=0> <span class=md-ellipsis> TAP GUI/Portal </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_4_label aria-expanded=false> <label class=md-nav__title for=__nav_5_4> <span class="md-nav__icon md-icon"></span> TAP GUI/Portal </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tanzu/tap-gui/ class=md-nav__link> <span class=md-ellipsis> Intro </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap-gui/gitlab-integration/ class=md-nav__link> <span class=md-ellipsis> GitLab Integration </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap-gui/techdocs-minio/ class=md-nav__link> <span class=md-ellipsis> TechDocs with MinIO </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap-gui/tdp-plugins/ class=md-nav__link> <span class=md-ellipsis> Backstage Plugins </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_5> <label class=md-nav__link for=__nav_5_5 id=__nav_5_5_label tabindex=0> <span class=md-ellipsis> TAP on TKGs </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5_5> <span class="md-nav__icon md-icon"></span> TAP on TKGs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_5_1> <label class=md-nav__link for=__nav_5_5_1 id=__nav_5_5_1_label tabindex=0> <span class=md-ellipsis> TAP 1.3.x </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_5_5_1_label aria-expanded=false> <label class=md-nav__title for=__nav_5_5_1> <span class="md-nav__icon md-icon"></span> TAP 1.3.x </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tanzu/tkgs/tap13-overview/ class=md-nav__link> <span class=md-ellipsis> TAP on TKGs </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tkgs/tap13/build-basic/ class=md-nav__link> <span class=md-ellipsis> TAP Build Profile - Basic Supply Chain </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tkgs/tap13/build-scanning-testing/ class=md-nav__link> <span class=md-ellipsis> TAP Build Profile - Scanning & Testing Supply Chain </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tkgs/tap13/run/ class=md-nav__link> <span class=md-ellipsis> TAP Run Profile </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tkgs/tap13/view/ class=md-nav__link> <span class=md-ellipsis> TAP View Profile </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_6> <label class=md-nav__link for=__nav_5_6 id=__nav_5_6_label tabindex=0> <span class=md-ellipsis> TAP DevSecOps </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_6_label aria-expanded=false> <label class=md-nav__title for=__nav_5_6> <span class="md-nav__icon md-icon"></span> TAP DevSecOps </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tanzu/grype-airgapped/ class=md-nav__link> <span class=md-ellipsis> Use Grype In Restricted Environments </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_7> <label class=md-nav__link for=__nav_5_7 id=__nav_5_7_label tabindex=0> <span class=md-ellipsis> TAP Misc </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_7_label aria-expanded=false> <label class=md-nav__title for=__nav_5_7> <span class="md-nav__icon md-icon"></span> TAP Misc </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tanzu/tap/fluxcd-ssh/ class=md-nav__link> <span class=md-ellipsis> Git access with SSH </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap/gitea/ class=md-nav__link> <span class=md-ellipsis> Setup Gitea </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../tanzu/custom-ca/ class=md-nav__link> <span class=md-ellipsis> Setup Custom CA </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/harbor-ca/ class=md-nav__link> <span class=md-ellipsis> Harbor with custom CA </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/minio-ca/ class=md-nav__link> <span class=md-ellipsis> Minio with custom CA </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/tkg-grafana/ class=md-nav__link> <span class=md-ellipsis> TKG Grafana with LDAP </span> </a> </li> <li class=md-nav__item> <a href=../../tanzu/dependencies/ class=md-nav__link> <span class=md-ellipsis> Dependencies </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Jenkins X </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Jenkins X </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/build-packs/ class=md-nav__link> <span class=md-ellipsis> Build Packs </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jx-pipelines/ class=md-nav__link> <span class=md-ellipsis> Jenkins X Pipelines </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6_3> <label class=md-nav__link for=__nav_6_3 id=__nav_6_3_label tabindex=0> <span class=md-ellipsis> Java Native Image Prod </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_6_3_label aria-expanded=false> <label class=md-nav__title for=__nav_6_3> <span class="md-nav__icon md-icon"></span> Java Native Image Prod </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/01-intro/ class=md-nav__link> <span class=md-ellipsis> Intro </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/02-cloud-sql/ class=md-nav__link> <span class=md-ellipsis> Cloud SQL </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/03-quarkus/ class=md-nav__link> <span class=md-ellipsis> Quarkus </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/04-jx-import/ class=md-nav__link> <span class=md-ellipsis> Import Into Jenkins X </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/05-jx-secrets/ class=md-nav__link> <span class=md-ellipsis> Database Connection And Secrets </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/06-native-image/ class=md-nav__link> <span class=md-ellipsis> Native Image </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/07-pipeline-improvements/ class=md-nav__link> <span class=md-ellipsis> Pipeline Improvements </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/08-preview-int-test/ class=md-nav__link> <span class=md-ellipsis> Previews & Integration Tests </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/09-production-improvements/ class=md-nav__link> <span class=md-ellipsis> Production Improvements </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/10-promote-prod/ class=md-nav__link> <span class=md-ellipsis> Promote To Production </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../jenkinsx/builder-image/ class=md-nav__link> <span class=md-ellipsis> Create Builder Image </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot/ class=md-nav__link> <span class=md-ellipsis> JX Boot GKE </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot-aks/ class=md-nav__link> <span class=md-ellipsis> JX Boot AKS </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/aks-boot-core/ class=md-nav__link> <span class=md-ellipsis> JX Boot & CloudBees Core </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/rhos-311-minimal/ class=md-nav__link> <span class=md-ellipsis> OpenShift 3.11 </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/rhos-311-restricted/ class=md-nav__link> <span class=md-ellipsis> OpenShift 3.11 - Restricted </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/lighthouse-bitbucket/ class=md-nav__link> <span class=md-ellipsis> Lighthouse & Bitbucket </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hello-world/ class=md-nav__link> <span class=md-ellipsis> HelloWorld </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/maven/ class=md-nav__link> <span class=md-ellipsis> Maven </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hybrid/ class=md-nav__link> <span class=md-ellipsis> Hybrid </span> </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/kubernetes-days/ class=md-nav__link> <span class=md-ellipsis> Example For Console Reel </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex> <span class=md-ellipsis> Software Eng. </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Software Eng. </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_1> <label class=md-nav__link for=__nav_7_1 id=__nav_7_1_label tabindex=0> <span class=md-ellipsis> Automation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_1_label aria-expanded=false> <label class=md-nav__title for=__nav_7_1> <span class="md-nav__icon md-icon"></span> Automation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloud/automation-pulumi/ class=md-nav__link> <span class=md-ellipsis> Pulumi </span> </a> </li> <li class=md-nav__item> <a href=../../certificates/lets-encrypt-k8s/ class=md-nav__link> <span class=md-ellipsis> Let's Encrypt K8S </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_2> <label class=md-nav__link for=__nav_7_2 id=__nav_7_2_label tabindex=0> <span class=md-ellipsis> Software Engineering </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_2_label aria-expanded=false> <label class=md-nav__title for=__nav_7_2> <span class="md-nav__icon md-icon"></span> Software Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../swe/important-concepts/ class=md-nav__link> <span class=md-ellipsis> Important Concepts </span> </a> </li> <li class=md-nav__item> <a href=../../swe/naming/ class=md-nav__link> <span class=md-ellipsis> Naming </span> </a> </li> <li class=md-nav__item> <a href=../../swe/distributed/ class=md-nav__link> <span class=md-ellipsis> Distributed Computing </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_3> <label class=md-nav__link for=__nav_7_3 id=__nav_7_3_label tabindex=0> <span class=md-ellipsis> Productivity </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_3_label aria-expanded=false> <label class=md-nav__title for=__nav_7_3> <span class="md-nav__icon md-icon"></span> Productivity </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../productivity/ class=md-nav__link> <span class=md-ellipsis> General </span> </a> </li> <li class=md-nav__item> <a href=../../productivity/incidents/ class=md-nav__link> <span class=md-ellipsis> Incidents </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7_4> <label class=md-nav__link for=__nav_7_4 id=__nav_7_4_label tabindex=0> <span class=md-ellipsis> Java </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_4_label aria-expanded=false> <label class=md-nav__title for=__nav_7_4> <span class="md-nav__icon md-icon"></span> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../java/ class=md-nav__link> <span class=md-ellipsis> General </span> </a> </li> <li class=md-nav__item> <a href=../../keep-watching/ class=md-nav__link> <span class=md-ellipsis> Spring Boot App </span> </a> </li> <li class=md-nav__item> <a href=../../java/networking/ class=md-nav__link> <span class=md-ellipsis> Java Networking </span> </a> </li> <li class=md-nav__item> <a href=../../java/concurrency/ class=md-nav__link> <span class=md-ellipsis> Java Concurrency </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#the-case-for-graceful-shutdown class=md-nav__link> The case for graceful shutdown </a> </li> <li class=md-nav__item> <a href=#start-good-so-you-can-end-well class=md-nav__link> Start Good So You Can End Well </a> <nav class=md-nav aria-label="Start Good So You Can End Well"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-shell-form-example class=md-nav__link> Docker Shell form example </a> </li> <li class=md-nav__item> <a href=#docker-exec-form-example class=md-nav__link> Docker exec form example </a> </li> <li class=md-nav__item> <a href=#gotchas class=md-nav__link> Gotchas </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#make-sure-your-process-listens class=md-nav__link> Make Sure Your Process Listens </a> <nav class=md-nav aria-label="Make Sure Your Process Listens"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#let-docker-manage-it-for-us class=md-nav__link> Let Docker manage it for us </a> </li> <li class=md-nav__item> <a href=#depend-on-a-process-manager class=md-nav__link> Depend on a process manager </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#how-to-be-told-what-you-want-to-hear class=md-nav__link> How To Be Told What You Want To Hear </a> <nav class=md-nav aria-label="How To Be Told What You Want To Hear"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#handle-signals-as-they-come class=md-nav__link> Handle signals as they come </a> </li> <li class=md-nav__item> <a href=#state-the-signals-we-want class=md-nav__link> State the signals we want </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#how-to-be-told-when-you-want-to-hear-it class=md-nav__link> How To Be Told When You Want To Hear It </a> <nav class=md-nav aria-label="How To Be Told When You Want To Hear It"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker class=md-nav__link> Docker </a> </li> <li class=md-nav__item> <a href=#kubernetes_1 class=md-nav__link> Kubernetes </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#examples class=md-nav__link> Examples </a> <nav class=md-nav aria-label=Examples> <ul class=md-nav__list> <li class=md-nav__item> <a href=#go class=md-nav__link> Go </a> </li> <li class=md-nav__item> <a href=#java-plain-docker-swarm class=md-nav__link> Java plain (Docker Swarm) </a> </li> <li class=md-nav__item> <a href=#java-plain-kubernetes class=md-nav__link> Java Plain (Kubernetes) </a> </li> <li class=md-nav__item> <a href=#java-spring-boot-1x class=md-nav__link> Java Spring Boot (1.x) </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#example-with-docker-swarm class=md-nav__link> Example with Docker Swarm </a> <nav class=md-nav aria-label="Example with Docker Swarm"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-swarm-cluster class=md-nav__link> Docker swarm cluster </a> </li> <li class=md-nav__item> <a href=#docker-swarm-network-and-multicast class=md-nav__link> Docker swarm network and multicast </a> </li> <li class=md-nav__item> <a href=#docker-stack class=md-nav__link> Docker stack </a> </li> <li class=md-nav__item> <a href=#execute-example_1 class=md-nav__link> Execute example </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#further-reading class=md-nav__link> Further reading </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=gracefully-shutting-down-applications-in-docker>Gracefully Shutting Down Applications in Docker<a class=headerlink href=#gracefully-shutting-down-applications-in-docker title="Permanent link">&para;</a></h1> <p>I'm not sure about you, but I prefer it when my neighbors leave our shared spaces clean and don't take up parking spaces when they don't need them.</p> <p>Imagine you live in an apartment complex with the above-mentioned parking lot. Some tenants go away and never come back. If nothing is done to clean up after them - to reclaim their apartment and parking space - then after some time, more and more apartments are unavailable for no reason, and the parking lot fills with cars which belong to no one.</p> <p>Some tenants did not get a parking lot and are getting frustrated that none are becoming available. When they moved in, they were told that when others leave, they would be next in line. While they're waiting, they have to park outside the complex. Eventually, the entrance gets blocked and no one can enter or leave. The end result is a completely unlivable apartment block with trapped tenants - never to be seen or heard from again.</p> <p>If you agree with me that when a tenant leaves, they should clean the apartment and free the parking spot to make it ready for the next inhabitant; then please read on. We're going to dive into the equivalent of doing this with containers.</p> <p>We will explore running our containers with Docker (run, compose, swarm) and Kubernetes. Even if you use another way to run your containers, this article should provide you with enough insight to get you on your way.</p> <h2 id=the-case-for-graceful-shutdown>The case for graceful shutdown<a class=headerlink href=#the-case-for-graceful-shutdown title="Permanent link">&para;</a></h2> <p>We're in an age where many applications are running in Docker containers across a multitude of clusters. These applications are then confronted with new concerns to tackle such as more moving parts, networking between these parts, remote storage and others. One significant way we defend ourselves against the perils of this distributed nature is to make our applications more robust - able to survive errors.</p> <p>However, even then there is still no guarantee your application is always up and running. So another concern we should tackle is how it responds when it needs to shut down. Where we can differentiate between an unexpected shutdown - we crashed - or an expected shutdown. On top of that, failing instead of trying to recover when something bad happens also adheres to "fail fast" - as strongly advocated by Michael Nygard in ReleaseIt.</p> <p>Shutting down can happen for a variety of reasons, in this post we dive into how to deal with an expected shutdown such as it being told to stop by an orchestrator such as Kubernetes.</p> <p>Containers can be purposefully shut down for a variety of reasons, including but not limited too:</p> <ul> <li>your application's health check fails</li> <li>your application consumed more resources than allowed</li> <li>the application is scaling down</li> </ul> <p>Just as cleaning up when leaving makes you a better tenant, having your application clean up connections, resources Moreover, the more tenants behaving in a good way increases the quality of living for all tenants. In our case, it improves the reliability and consistency of our cluster.</p> <p>Graceful shutdown is not unique to Docker, as it has been part of Linux's best practices for quite some years before Docker's existence. However, applying them to Docker container adds extra dimensions.</p> <h2 id=start-good-so-you-can-end-well>Start Good So You Can End Well<a class=headerlink href=#start-good-so-you-can-end-well title="Permanent link">&para;</a></h2> <p>When you sign up for an apartment, you probably have to sign a contract detailing your rights and obligations. The more you state explicitly, the easier it is to deal with bad behaving neighbors. The same is true when running processes; we should make sure that we set the rules, obligations, and expectations from the start.</p> <p>As we say in Dutch: a good beginning is half the work. We will start with how you can run a process in a container with a process that shuts down gracefully.</p> <p>There are many ways to start a process in a container. In this article, we look at processes started by commands defined in a Dockerfile. There are two ways to specify this:</p> <ul> <li><strong>CMD</strong>: runs a command when the container gets started</li> <li><strong>ENTRYPOINT</strong>: provides the location (entrypoint) from where commands get run when the container starts</li> </ul> <p>You need at least one ENTRYPOINT or CMD in a Dockerfile for it to be valid. They can be used in collaboration but they can do similar things.</p> <p>For more information on the details of these commands, read<a href=https://docs.docker.com/engine/reference/builder/#exec-form-entrypoint-example>Docker's docs on Entrypoint vs. CMD</a>.</p> <h3 id=docker-shell-form-example>Docker Shell form example<a class=headerlink href=#docker-shell-form-example title="Permanent link">&para;</a></h3> <p>We start with the shell form and see if it can do what we want; begin in such a way, we can stop it nicely. Shell form means we define a shell command without any special format or keywords.</p> <p>Please create Dockerfile with the content that follows.</p> <div class="language-dockerfile highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>FROM</span><span class=w> </span><span class=s>ubuntu:18.04</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=k>ENTRYPOINT</span><span class=w> </span>top<span class=w> </span>-b
</span></code></pre></div> <p>Then build an image and run a container.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>docker<span class=w> </span>image<span class=w> </span>build<span class=w> </span>--tag<span class=w> </span>shell-form<span class=w> </span>.
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>docker<span class=w> </span>run<span class=w> </span>--name<span class=w> </span>shell-form<span class=w> </span>--rm<span class=w> </span>shell-form
</span></code></pre></div> <p>The above command yields the following output.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>top<span class=w> </span>-<span class=w> </span><span class=m>16</span>:34:56<span class=w> </span>up<span class=w> </span><span class=m>1</span><span class=w> </span>day,<span class=w>  </span><span class=m>5</span>:15,<span class=w>  </span><span class=m>0</span><span class=w> </span>users,<span class=w>  </span>load<span class=w> </span>average:<span class=w> </span><span class=m>0</span>.00,<span class=w> </span><span class=m>0</span>.00,<span class=w> </span><span class=m>0</span>.00
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>Tasks:<span class=w>   </span><span class=m>2</span><span class=w> </span>total,<span class=w>   </span><span class=m>1</span><span class=w> </span>running,<span class=w>   </span><span class=m>1</span><span class=w> </span>sleeping,<span class=w>   </span><span class=m>0</span><span class=w> </span>stopped,<span class=w>   </span><span class=m>0</span><span class=w> </span>zombie
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>%Cpu<span class=o>(</span>s<span class=o>)</span>:<span class=w>  </span><span class=m>0</span>.4<span class=w> </span>us,<span class=w>  </span><span class=m>0</span>.3<span class=w> </span>sy,<span class=w>  </span><span class=m>0</span>.0<span class=w> </span>ni,<span class=w> </span><span class=m>99</span>.2<span class=w> </span>id,<span class=w>  </span><span class=m>0</span>.1<span class=w> </span>wa,<span class=w>  </span><span class=m>0</span>.0<span class=w> </span>hi,<span class=w>  </span><span class=m>0</span>.0<span class=w> </span>si,<span class=w>  </span><span class=m>0</span>.0<span class=w> </span>st
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>KiB<span class=w> </span>Mem<span class=w> </span>:<span class=w>  </span><span class=m>2046932</span><span class=w> </span>total,<span class=w>   </span><span class=m>541984</span><span class=w> </span>free,<span class=w>   </span><span class=m>302668</span><span class=w> </span>used,<span class=w>  </span><span class=m>1202280</span><span class=w> </span>buff/cache
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>KiB<span class=w> </span>Swap:<span class=w>  </span><span class=m>1048572</span><span class=w> </span>total,<span class=w>  </span><span class=m>1042292</span><span class=w> </span>free,<span class=w>     </span><span class=m>6280</span><span class=w> </span>used.<span class=w>  </span><span class=m>1579380</span><span class=w> </span>avail<span class=w> </span>Mem
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>  </span>PID<span class=w> </span>USER<span class=w>      </span>PR<span class=w>  </span>NI<span class=w>    </span>VIRT<span class=w>    </span>RES<span class=w>    </span>SHR<span class=w> </span>S<span class=w>  </span>%CPU<span class=w> </span>%MEM<span class=w>     </span>TIME+<span class=w> </span>COMMAND
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>    </span><span class=m>1</span><span class=w> </span>root<span class=w>      </span><span class=m>20</span><span class=w>   </span><span class=m>0</span><span class=w>    </span><span class=m>4624</span><span class=w>    </span><span class=m>760</span><span class=w>    </span><span class=m>696</span><span class=w> </span>S<span class=w>   </span><span class=m>0</span>.0<span class=w>  </span><span class=m>0</span>.0<span class=w>   </span><span class=m>0</span>:00.05<span class=w> </span>sh
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>    </span><span class=m>6</span><span class=w> </span>root<span class=w>      </span><span class=m>20</span><span class=w>   </span><span class=m>0</span><span class=w>   </span><span class=m>36480</span><span class=w>   </span><span class=m>2928</span><span class=w>   </span><span class=m>2580</span><span class=w> </span>R<span class=w>   </span><span class=m>0</span>.0<span class=w>  </span><span class=m>0</span>.1<span class=w>   </span><span class=m>0</span>:00.01<span class=w> </span>top
</span></code></pre></div> <p>As you can see, two processes are running, <strong>sh</strong> and <strong>top</strong>. Meaning, that killing the process, with <em>ctrl+c</em> for example, terminates the <strong>sh</strong> process, but not<strong>top</strong>. This happens because the <em>sh</em> process forked the <em>top</em> process, but the termination will only be send to PID 1 - in this case <em>sh</em>. As <em>sh</em> will not stop the <em>top</em> process for us it will continue running and leave the container alive.</p> <p>To kill this container, open a second terminal and execute the following command.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>docker<span class=w> </span>rm<span class=w> </span>-f<span class=w> </span>shell-form
</span></code></pre></div> <p>Shell form doesn't do what we need. Starting a process with shell form will only lead us to the disaster of parking lots filling up unless there's a someone actively cleaning up.</p> <h3 id=docker-exec-form-example>Docker exec form example<a class=headerlink href=#docker-exec-form-example title="Permanent link">&para;</a></h3> <p>This leads us to the exec form. Hopefully, this gets us somewhere.</p> <p>The exec form is written as an array of parameters:<code>ENTRYPOINT ["top", "-b"]</code></p> <p>To continue in the same line of examples, we will create a Dockerfile, build and run it.</p> <div class="language-dockerfile highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>FROM</span><span class=w> </span><span class=s>ubuntu:18.04</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=k>ENTRYPOINT</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;top&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;-b&quot;</span><span class=p>]</span>
</span></code></pre></div> <p>Then build and run it.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>docker<span class=w> </span>image<span class=w> </span>build<span class=w> </span>--tag<span class=w> </span>exec-form<span class=w> </span>.
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>docker<span class=w> </span>run<span class=w> </span>--name<span class=w> </span>exec-form<span class=w> </span>--rm<span class=w> </span>exec-form
</span></code></pre></div> <p>This yields the following output.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>top<span class=w> </span>-<span class=w> </span><span class=m>18</span>:12:30<span class=w> </span>up<span class=w> </span><span class=m>1</span><span class=w> </span>day,<span class=w>  </span><span class=m>6</span>:53,<span class=w>  </span><span class=m>0</span><span class=w> </span>users,<span class=w>  </span>load<span class=w> </span>average:<span class=w> </span><span class=m>0</span>.00,<span class=w> </span><span class=m>0</span>.00,<span class=w> </span><span class=m>0</span>.00
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>Tasks:<span class=w>   </span><span class=m>1</span><span class=w> </span>total,<span class=w>   </span><span class=m>1</span><span class=w> </span>running,<span class=w>   </span><span class=m>0</span><span class=w> </span>sleeping,<span class=w>   </span><span class=m>0</span><span class=w> </span>stopped,<span class=w>   </span><span class=m>0</span><span class=w> </span>zombie
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>%Cpu<span class=o>(</span>s<span class=o>)</span>:<span class=w>  </span><span class=m>0</span>.4<span class=w> </span>us,<span class=w>  </span><span class=m>0</span>.3<span class=w> </span>sy,<span class=w>  </span><span class=m>0</span>.0<span class=w> </span>ni,<span class=w> </span><span class=m>99</span>.2<span class=w> </span>id,<span class=w>  </span><span class=m>0</span>.1<span class=w> </span>wa,<span class=w>  </span><span class=m>0</span>.0<span class=w> </span>hi,<span class=w>  </span><span class=m>0</span>.0<span class=w> </span>si,<span class=w>  </span><span class=m>0</span>.0<span class=w> </span>st
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>KiB<span class=w> </span>Mem<span class=w> </span>:<span class=w>  </span><span class=m>2046932</span><span class=w> </span>total,<span class=w>   </span><span class=m>535896</span><span class=w> </span>free,<span class=w>   </span><span class=m>307196</span><span class=w> </span>used,<span class=w>  </span><span class=m>1203840</span><span class=w> </span>buff/cache
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>KiB<span class=w> </span>Swap:<span class=w>  </span><span class=m>1048572</span><span class=w> </span>total,<span class=w>  </span><span class=m>1042292</span><span class=w> </span>free,<span class=w>     </span><span class=m>6280</span><span class=w> </span>used.<span class=w>  </span><span class=m>1574880</span><span class=w> </span>avail<span class=w> </span>Mem
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>  </span>PID<span class=w> </span>USER<span class=w>      </span>PR<span class=w>  </span>NI<span class=w>    </span>VIRT<span class=w>    </span>RES<span class=w>    </span>SHR<span class=w> </span>S<span class=w>  </span>%CPU<span class=w> </span>%MEM<span class=w>     </span>TIME+<span class=w> </span>COMMAND
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>    </span><span class=m>1</span><span class=w> </span>root<span class=w>      </span><span class=m>20</span><span class=w>   </span><span class=m>0</span><span class=w>   </span><span class=m>36480</span><span class=w>   </span><span class=m>2940</span><span class=w>   </span><span class=m>2584</span><span class=w> </span>R<span class=w>   </span><span class=m>0</span>.0<span class=w>  </span><span class=m>0</span>.1<span class=w>   </span><span class=m>0</span>:00.03<span class=w> </span>top
</span></code></pre></div> <p>Now we got something we can work with. If something would tell this Container to stop, it will tell our only running process so it is sure to reach the correct one!</p> <h3 id=gotchas>Gotchas<a class=headerlink href=#gotchas title="Permanent link">&para;</a></h3> <p>Knowing we can use the exec form for our goal - gracefully shutting down our container - we can move on to the next part of our efforts. For the sake of imparting you with some hard learned lessons, we will explore two gotchas. They're optional, so you can also choose to skip to <em>Make Sure Your Process Listens</em>.</p> <h4 id=docker-exec-form-with-parameters>Docker exec form with parameters<a class=headerlink href=#docker-exec-form-with-parameters title="Permanent link">&para;</a></h4> <p>A caveat with the exec form is that it doesn't interpolate parameters.</p> <p>You can try the following:</p> <div class="language-dockerfile highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>FROM</span><span class=w> </span><span class=s>ubuntu:18.04</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=k>ENV</span><span class=w> </span><span class=nv>PARAM</span><span class=o>=</span><span class=s2>&quot;-b&quot;</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=k>ENTRYPOINT</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;top&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;${PARAM}&quot;</span><span class=p>]</span>
</span></code></pre></div> <p>Then build and run it:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>docker<span class=w> </span>image<span class=w> </span>build<span class=w> </span>--tag<span class=w> </span>exec-param<span class=w> </span>.
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>docker<span class=w> </span>run<span class=w> </span>--name<span class=w> </span>exec-form<span class=w> </span>--rm<span class=w> </span>exec-param
</span></code></pre></div> <p>This should yield the following:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>/bin/sh:<span class=w> </span><span class=m>1</span>:<span class=w> </span><span class=o>[</span>top:<span class=w> </span>not<span class=w> </span>found
</span></code></pre></div> <p>This is where Docker created a mix between the two styles. It allows you to create an <em>Entrypoint</em> with a shell command - performing interpolation - but executing it as an exec form. This can be done by prefixing the shell form, with, you guessed it, <em>exec</em>.</p> <div class="language-dockerfile highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=k>FROM</span><span class=w> </span><span class=s>ubuntu:18.04</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=k>ENV</span><span class=w> </span><span class=nv>PARAM</span><span class=o>=</span><span class=s2>&quot;-b&quot;</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=k>ENTRYPOINT</span><span class=w> </span><span class=nb>exec</span><span class=w> </span><span class=s2>&quot;top&quot;</span><span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PARAM</span><span class=si>}</span><span class=s2>&quot;</span>
</span></code></pre></div> <p>Then build and run it:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>docker<span class=w> </span>image<span class=w> </span>build<span class=w> </span>--tag<span class=w> </span>exec-param<span class=w> </span>.
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>docker<span class=w> </span>run<span class=w> </span>--name<span class=w> </span>exec-form<span class=w> </span>--rm<span class=w> </span>exec-param
</span></code></pre></div> <p>This will return the exact same as if we would've run <code>ENTRYPOINT ["top", "-b"]</code>.</p> <p>Now you can also override the param, by using the environment variable flag.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>docker<span class=w> </span>image<span class=w> </span>build<span class=w> </span>--tag<span class=w> </span>exec-param<span class=w> </span>.
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>docker<span class=w> </span>run<span class=w> </span>--name<span class=w> </span>exec-form<span class=w> </span>--rm<span class=w> </span>-e<span class=w> </span><span class=nv>PARAM</span><span class=o>=</span><span class=s2>&quot;help&quot;</span><span class=w> </span>exec-param
</span></code></pre></div> <p>Resulting in top's help string.</p> <h4 id=the-special-case-of-alpine>The special case of Alpine<a class=headerlink href=#the-special-case-of-alpine title="Permanent link">&para;</a></h4> <p>One of the main <a href=https://docs.docker.com/develop/develop-images/dockerfile_best-practices/ >best practices for Dockerfiles</a>, is to make them as small as possible. The easiest way to do this is to start with a minimal image. This is where <a href=https://hub.docker.com/_/alpine/ >Alpine Linux</a> comes in. We will revisit out shell form example, but replace ubuntu with alpine.</p> <p>Create the following Dockerfile.</p> <div class="language-dockerfile highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=k>FROM</span><span class=w> </span><span class=s>alpine:3.8</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=k>ENTRYPOINT</span><span class=w> </span>top<span class=w> </span>-b
</span></code></pre></div> <p>Then build and run it.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>docker<span class=w> </span>image<span class=w> </span>build<span class=w> </span>--tag<span class=w> </span>exec-param<span class=w> </span>.
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>docker<span class=w> </span>run<span class=w> </span>--name<span class=w> </span>exec-form<span class=w> </span>--rm<span class=w> </span>-e<span class=w> </span><span class=nv>PARAM</span><span class=o>=</span><span class=s2>&quot;help&quot;</span><span class=w> </span>exec-param
</span></code></pre></div> <p>This yields the following output.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>Mem:<span class=w> </span>1509068K<span class=w> </span>used,<span class=w> </span>537864K<span class=w> </span>free,<span class=w> </span>640K<span class=w> </span>shrd,<span class=w> </span>126756K<span class=w> </span>buff,<span class=w> </span>1012436K<span class=w> </span>cached
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>CPU:<span class=w>   </span><span class=m>0</span>%<span class=w> </span>usr<span class=w>   </span><span class=m>0</span>%<span class=w> </span>sys<span class=w>   </span><span class=m>0</span>%<span class=w> </span>nic<span class=w> </span><span class=m>100</span>%<span class=w> </span>idle<span class=w>   </span><span class=m>0</span>%<span class=w> </span>io<span class=w>   </span><span class=m>0</span>%<span class=w> </span>irq<span class=w>   </span><span class=m>0</span>%<span class=w> </span>sirq
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>Load<span class=w> </span>average:<span class=w> </span><span class=m>0</span>.00<span class=w> </span><span class=m>0</span>.00<span class=w> </span><span class=m>0</span>.00<span class=w> </span><span class=m>2</span>/404<span class=w> </span><span class=m>5</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>  </span>PID<span class=w>  </span>PPID<span class=w> </span>USER<span class=w>     </span>STAT<span class=w>   </span>VSZ<span class=w> </span>%VSZ<span class=w> </span>CPU<span class=w> </span>%CPU<span class=w> </span>COMMAND
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>    </span><span class=m>1</span><span class=w>     </span><span class=m>0</span><span class=w> </span>root<span class=w>     </span>R<span class=w>     </span><span class=m>1516</span><span class=w>   </span><span class=m>0</span>%<span class=w>   </span><span class=m>0</span><span class=w>   </span><span class=m>0</span>%<span class=w> </span>top<span class=w> </span>-b
</span></code></pre></div> <p>Aside from <strong>top</strong>'s output looking a bit different, there is only one command.</p> <p>Alpine Linux helps us avoid the problem of shell form altogether!</p> <h2 id=make-sure-your-process-listens>Make Sure Your Process Listens<a class=headerlink href=#make-sure-your-process-listens title="Permanent link">&para;</a></h2> <p>It is excellent if your tenants are all signed up, know their rights and obligations. But you can't contact them when something happens, how will they ever know when to act?</p> <p>Translating that into our process. It starts and can be told to shut down, but does it process listen? Can it interpret the message it gets from Docker or Kubernetes? And if it does, can it relay the message correctly to its Child Processes? In order for your process to gracefully shutdown, it should know when to do so. As such, it should listen not only for itself but also on behalf of its children - yours never do anything wrong though!</p> <p>Some processes do, but many aren't designed to <a href=https://www.fpcomplete.com/blog/2016/10/docker-demons-pid1-orphans-zombies-signals>listen</a> or tell <a href=https://blog.phusion.nl/2015/01/20/docker-and-the-pid-1-zombie-reaping-problem>their Children</a>. They expect someone else to listen for them and tell them and their children - process managers.</p> <p>In order to listen to these <strong>signals</strong>, we can call in the help of others. We will look at two options.</p> <ul> <li>we let Docker manage the process and its children</li> <li>we use a process manager</li> </ul> <h3 id=let-docker-manage-it-for-us>Let Docker manage it for us<a class=headerlink href=#let-docker-manage-it-for-us title="Permanent link">&para;</a></h3> <p>If you're not using Docker to run or manage your containers, you should skip to <em>Depend on a process manager</em>.</p> <p>Docker has a build in feature, that it uses a lightweight process manager to help you.</p> <p>So if you're running your images with Docker itself, either directly or via Compose or Swarm, you're fine. You can use the init flag in your run command or your compose file.</p> <p>Please, note that the below examples require a certain minimum version of Docker.</p> <ul> <li>run - 1.13+</li> <li><a href=https://docs.docker.com/compose/compose-file/compose-file-v2/#image>compose (v 2.2)</a> - 1.13.0+</li> <li><a href=https://docs.docker.com/compose/compose-file/#init>swarm (v 3.7)</a> - 18.06.0+</li> </ul> <h4 id=with-docker-run>With Docker Run<a class=headerlink href=#with-docker-run title="Permanent link">&para;</a></h4> <div class="language-bash highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>docker<span class=w> </span>run<span class=w> </span>--rm<span class=w> </span>-ti<span class=w> </span>--init<span class=w> </span>caladreas/dui
</span></code></pre></div> <h4 id=with-docker-compose>With Docker Compose<a class=headerlink href=#with-docker-compose title="Permanent link">&para;</a></h4> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&#39;2.2&#39;</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=nt>services</span><span class=p>:</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=w>    </span><span class=nt>web</span><span class=p>:</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">caladreas/java-docker-signal-demo:no-tini</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=w>        </span><span class=nt>init</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div> <h4 id=with-docker-swarm>With Docker Swarm<a class=headerlink href=#with-docker-swarm title="Permanent link">&para;</a></h4> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&#39;3.7&#39;</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=nt>services</span><span class=p>:</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=w>    </span><span class=nt>web</span><span class=p>:</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">caladreas/java-docker-signal-demo:no-tini</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=w>        </span><span class=nt>init</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div> <p>Relying on Docker does create a dependency on how your container runs. It only runs correctly in Docker-related technologies (run, compose, swarm) and only if the proper versions are available.</p> <p>Creating either a different experience for users running your application somewhere else or not able to meet the version requirements. So maybe another solution is to bake a process manager into your image and guarantee its behavior.</p> <h3 id=depend-on-a-process-manager>Depend on a process manager<a class=headerlink href=#depend-on-a-process-manager title="Permanent link">&para;</a></h3> <p>One of our goals for Docker images is to keep them small. We should look for a lightweight process manager. It does not have too many a whole machine worth or processes, just one and perhaps some children.</p> <p>Here we would like to introduce you to <a href=https://github.com/krallin/tini>Tini</a>, a lightweight process manager <a href=https://github.com/krallin/tini/issues/8>designed for this purpose</a>. It is a very successful and widely adopted process manager in the Docker world. So successful, that the before mentioned init flags from Docker are implemented by baking <a href=https://github.com/krallin/tini/issues/81>Tini into Docker</a>.</p> <h4 id=debian-example>Debian example<a class=headerlink href=#debian-example title="Permanent link">&para;</a></h4> <p>For brevity, the build process is excluded, and for image size, we use Debian slim instead of default Debian.</p> <div class="language-dockerfile highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=k>FROM</span><span class=w> </span><span class=s>debian:stable-slim</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=k>ENV</span><span class=w> </span>TINI_VERSION<span class=w> </span>v0.18.0
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=k>ADD</span><span class=w> </span>https://github.com/krallin/tini/releases/download/<span class=si>${</span><span class=nv>TINI_VERSION</span><span class=si>}</span>/tini<span class=w> </span>/tini
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=k>RUN</span><span class=w> </span>chmod<span class=w> </span>+x<span class=w> </span>/tini
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=k>ENTRYPOINT</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;/tini&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;-vv&quot;</span><span class=p>,</span><span class=s2>&quot;-g&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;--&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;/usr/bin/dui/bin/dui&quot;</span><span class=p>,</span><span class=s2>&quot;-XX:+UseCGroupMemoryLimitForHeap&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;-XX:+UnlockExperimentalVMOptions&quot;</span><span class=p>]</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=k>COPY</span><span class=w> </span>--from<span class=o>=</span>build<span class=w> </span>/usr/bin/dui-image/<span class=w> </span>/usr/bin/dui
</span></code></pre></div> <h4 id=alpine-example>Alpine example<a class=headerlink href=#alpine-example title="Permanent link">&para;</a></h4> <p>Alpine Linux works wonders for Docker images, so to improve our lives, you can very easily install it if you want.</p> <div class="language-dockerfile highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=k>FROM</span><span class=w> </span><span class=s>alpine</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=k>RUN</span><span class=w> </span>apk<span class=w> </span>add<span class=w> </span>--no-cache<span class=w> </span>tini
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=k>ENTRYPOINT</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;/sbin/tini&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;-vv&quot;</span><span class=p>,</span><span class=s2>&quot;-g&quot;</span><span class=p>,</span><span class=s2>&quot;-s&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;--&quot;</span><span class=p>]</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=k>CMD</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;top -b&quot;</span><span class=p>]</span>
</span></code></pre></div> <h2 id=how-to-be-told-what-you-want-to-hear>How To Be Told What You Want To Hear<a class=headerlink href=#how-to-be-told-what-you-want-to-hear title="Permanent link">&para;</a></h2> <p>You've made it this far; your tenets are reachable so you can inform them if they need to act. However, there's another problem lurking around the corner. Do they speak your language?</p> <p>Our process now starts knowing it can be talked to, it has someone who takes care of listening for it and its children. Now we need to make sure it can understand what it hears, it should be able to handle the incoming signals. We have two main ways of doing this.</p> <ul> <li><strong>Handle signals as they come</strong>: we should make sure our process deal with the signals as they come</li> <li><strong>State the signals we want</strong>: we can also tell up front, which signals we want to hear and put the burden of translation on our callers</li> </ul> <p>For more details on the subject of Signals and Docker, please read this excellent blog from <a href=https://medium.com/@gchudnov/trapping-signals-in-docker-containers-7a57fdda7d86>Grigorii Chudnov</a>.</p> <h3 id=handle-signals-as-they-come>Handle signals as they come<a class=headerlink href=#handle-signals-as-they-come title="Permanent link">&para;</a></h3> <p>Handling process signals depend on your application, programming language or framework.</p> <h3 id=state-the-signals-we-want>State the signals we want<a class=headerlink href=#state-the-signals-we-want title="Permanent link">&para;</a></h3> <p>Sometimes your language or framework of choice, doesn't handle signals all that well. It might be very rigid in what it does with specific signals, removing your ability to do the right thing. Of course, not all languages or frameworks are designed with Docker container or Microservices in mind, are yet to catch up to this more dynamic environment.</p> <p>Luckily Docker and Kubernetes allow you to specify what signal too sent to your process.</p> <h4 id=docker-run>Docker run<a class=headerlink href=#docker-run title="Permanent link">&para;</a></h4> <div class="language-bash highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a>docker<span class=w> </span>run<span class=w> </span>--rm<span class=w> </span>-ti<span class=w> </span>--init<span class=w> </span>--stop-signal<span class=o>=</span>SIGINT<span class=w> </span><span class=se>\</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=w>   </span>caladreas/java-docker-signal-demo
</span></code></pre></div> <h4 id=docker-composeswarm>Docker compose/swarm<a class=headerlink href=#docker-composeswarm title="Permanent link">&para;</a></h4> <p>Docker's compose file format allows you to specify a <a href=https://docs.docker.com/compose/compose-file/compose-file-v2/#stop_signal>stop signal</a>. This is the signal sent when the container is stopped in a normal fashion. Normal in this case, meaning <code>docker stop</code> or when docker itself determines it should stop the container.</p> <p>If you forcefully remove the container, for example with <code>docker rm -f</code> it will directly kill the process, so don't do that.</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&#39;2.2&#39;</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=nt>services</span><span class=p>:</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=w>    </span><span class=nt>web</span><span class=p>:</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">caladreas/java-docker-signal-demo</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=w>        </span><span class=nt>stop_signal</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">SIGINT</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=w>        </span><span class=nt>stop_grace_period</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">15s</span>
</span></code></pre></div> <p>If you run this with <code>docker-compose up</code> and then in a second terminal, stop the container, you will see something like this.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>web_1<span class=w>  </span><span class=p>|</span><span class=w> </span>HelloWorld!
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>web_1<span class=w>  </span><span class=p>|</span><span class=w> </span>Shutdown<span class=w> </span>hook<span class=w> </span>called!
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a>web_1<span class=w>  </span><span class=p>|</span><span class=w> </span>We<span class=s1>&#39;re told to stop early...</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=s1>web_1  | java.lang.InterruptedException: sleep interrupted</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=s1>web_1  |    at java.base/java.lang.Thread.sleep(Native Method)</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=s1>web_1  |    at joostvdg.demo.signal@1.0/com.github.joostvdg.demo.signal.HelloWorld.printHelloWorld(Unknown Source)</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=s1>web_1  |    at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=s1>web_1  |    at java.base/java.util.concurrent.FutureTask.run(Unknown Source)</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=s1>web_1  |    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=s1>web_1  |    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=s1>web_1  |    at java.base/java.lang.Thread.run(Unknown Source)</span>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a><span class=s1>web_1  | [DEBUG tini (1)] Passing signal: &#39;</span>Interrupt<span class=s1>&#39;</span>
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a><span class=s1>web_1  | [DEBUG tini (1)] Received SIGCHLD</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a><span class=s1>web_1  | [DEBUG tini (1)] Reaped child with pid: &#39;</span><span class=m>7</span><span class=s1>&#39;</span>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a><span class=s1>web_1  | [INFO  tini (1)] Main child exited with signal (with signal &#39;</span>Interrupt<span class=err>&#39;</span><span class=o>)</span>
</span></code></pre></div> <h4 id=kubernetes>Kubernetes<a class=headerlink href=#kubernetes title="Permanent link">&para;</a></h4> <p>In Kubernetes we can make use of <a href=https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/ >Container Lifecycle Hooks</a> to manage how our container should be stopped. We could, for example, send a SIGINT (interrupt) to tell our application to stop.</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">java-signal-demo</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">java-signal-demo</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=w>            </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=w>                </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">java-signal-demo</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=w>        </span><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=w>            </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=w>              </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">caladreas/java-docker-signal-demo</span>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=w>              </span><span class=nt>lifecycle</span><span class=p>:</span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=w>                  </span><span class=nt>preStop</span><span class=p>:</span>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=w>                      </span><span class=nt>exec</span><span class=p>:</span>
</span><span id=__span-24-21><a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a><span class=w>                          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;killall&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;java&quot;</span><span class=w> </span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;-INT&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-24-22><a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a><span class=w>            </span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
</span></code></pre></div> <p>When you create this as deployment.yml, create and delete it -<code>kubectl apply -f deployment.yml</code>/ <code>kubectl delete -f deployment.yml</code> - you will see the same behavior.</p> <h2 id=how-to-be-told-when-you-want-to-hear-it>How To Be Told When You Want To Hear It<a class=headerlink href=#how-to-be-told-when-you-want-to-hear-it title="Permanent link">&para;</a></h2> <p>Our process now will now start knowing it will hear what it wants to hear. But we now have to make sure we hear it when we need to hear it. An intervention is excellent when you can still be saved, but it is a bit useless if you're already dead.</p> <h3 id=docker>Docker<a class=headerlink href=#docker title="Permanent link">&para;</a></h3> <p>You can either configure your health check in your <a href=https://docs.docker.com/engine/reference/builder/#healthcheck>Dockerfile</a> or configure it in your <a href=https://docs.docker.com/compose/compose-file/#healthcheck>docker-compose.yml</a> for either compose or swarm.</p> <p>Considering only Docker can use the health check in your Dockerfile, it is strongly recommended to have health checks in your application and document how they can be used.</p> <h3 id=kubernetes_1>Kubernetes<a class=headerlink href=#kubernetes_1 title="Permanent link">&para;</a></h3> <p>In Kubernetes we have the concept of <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes>Container Probes</a>. This allows you to configure whether your container is ready (readinessProbe) to be used and if it is still working as expected (livenessProbe).</p> <h2 id=examples>Examples<a class=headerlink href=#examples title="Permanent link">&para;</a></h2> <p>How to actually listen to the signals and determine which one to use will depend on your programming language.</p> <p>There's three examples I have worked out, one for Go (lang) and two for Java: pojo and Spring Boot.</p> <h3 id=go>Go<a class=headerlink href=#go title="Permanent link">&para;</a></h3> <h4 id=dockerfile>Dockerfile<a class=headerlink href=#dockerfile title="Permanent link">&para;</a></h4> <div class="language-bash highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=c1># build stage</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>FROM<span class=w> </span>golang:latest<span class=w> </span>AS<span class=w> </span>build-env
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a>RUN<span class=w> </span>go<span class=w> </span>get<span class=w> </span>-v<span class=w> </span>github.com/docker/docker/client/...
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a>RUN<span class=w> </span>go<span class=w> </span>get<span class=w> </span>-v<span class=w> </span>github.com/docker/docker/api/...
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a>ADD<span class=w> </span>src/<span class=w> </span><span class=nv>$GOPATH</span>/flow-proxy-service-lister
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a>WORKDIR<span class=w> </span><span class=nv>$GOPATH</span>/flow-proxy-service-lister
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a>RUN<span class=w> </span>go<span class=w> </span>build<span class=w> </span>-o<span class=w> </span>main<span class=w> </span>-tags<span class=w> </span>netgo<span class=w> </span>main.go
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=c1># final stage</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a>FROM<span class=w> </span>alpine
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a>ENTRYPOINT<span class=w> </span><span class=o>[</span><span class=s2>&quot;/app/main&quot;</span><span class=o>]</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a>COPY<span class=w> </span>--from<span class=o>=</span>build-env<span class=w> </span>/go/flow-proxy-service-lister/main<span class=w> </span>/app/
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a>RUN<span class=w> </span>chmod<span class=w> </span>+x<span class=w> </span>/app/main
</span></code></pre></div> <h4 id=go-code-for-graceful-shutdown>Go code for graceful shutdown<a class=headerlink href=#go-code-for-graceful-shutdown title="Permanent link">&para;</a></h4> <p>The following is a way for Go to shutdown a http server when receiving a termination signal.</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=kd>func</span><span class=w> </span><span class=nx>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=w>    </span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=c1>// make channel for main &lt;--&gt; webserver communication</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=w>    </span><span class=k>go</span><span class=w> </span><span class=nx>webserver</span><span class=p>.</span><span class=nx>Start</span><span class=p>(</span><span class=s>&quot;7777&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>webserverData</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>)</span><span class=w> </span><span class=c1>// ignore the missing data</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=w>    </span><span class=nx>stop</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=c1>// make a channel that listens to is signals</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=w>    </span><span class=nx>signal</span><span class=p>.</span><span class=nx>Notify</span><span class=p>(</span><span class=nx>stop</span><span class=p>,</span><span class=w> </span><span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span><span class=w> </span><span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span><span class=w> </span><span class=c1>// we listen to some specific syscall signals</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// this is still infinite</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=w>        </span><span class=nx>t</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>NewTicker</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>30</span><span class=p>)</span><span class=w> </span><span class=c1>// set a timer for the polling</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=w>        </span><span class=k>select</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>stop</span><span class=p>:</span><span class=w> </span><span class=c1>// this means we got a os signal on our channel</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=w>            </span><span class=k>break</span><span class=w> </span><span class=c1>// so we can stop</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>t</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=w>            </span><span class=c1>// our timer expired, refresh our data</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=w>            </span><span class=k>continue</span><span class=w> </span><span class=c1>// and continue with the loop</span>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=w>        </span><span class=k>break</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=s>&quot;Shutting down webserver&quot;</span><span class=p>)</span><span class=w> </span><span class=c1>// if we got here, we have to inform the webserver to close shop</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=w>    </span><span class=nx>c</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c1>// we do this by sending a message on the channel</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>b</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>c</span><span class=p>;</span><span class=w> </span><span class=nx>b</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// when we get true back, that means the webserver is doing with a graceful shutdown</span>
</span><span id=__span-26-22><a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a><span class=w>        </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=s>&quot;Webserver shut down&quot;</span><span class=p>)</span><span class=w> </span><span class=c1>// webserver is done</span>
</span><span id=__span-26-23><a id=__codelineno-26-23 name=__codelineno-26-23 href=#__codelineno-26-23></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-24><a id=__codelineno-26-24 name=__codelineno-26-24 href=#__codelineno-26-24></a><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=s>&quot;Shut down app&quot;</span><span class=p>)</span><span class=w> </span><span class=c1>// we can close shop ourselves now</span>
</span><span id=__span-26-25><a id=__codelineno-26-25 name=__codelineno-26-25 href=#__codelineno-26-25></a><span class=p>}</span>
</span></code></pre></div> <h3 id=java-plain-docker-swarm>Java plain (Docker Swarm)<a class=headerlink href=#java-plain-docker-swarm title="Permanent link">&para;</a></h3> <p>This application is a Java 9 modular application, which can be found on github, <a href=https://github.com/joostvdg/buming>github.com/joostvdg</a>.</p> <h4 id=dockerfile_1>Dockerfile<a class=headerlink href=#dockerfile_1 title="Permanent link">&para;</a></h4> <div class="language-dockerfile highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=k>FROM</span><span class=w> </span><span class=s>openjdk:9-jdk</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s>build</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=k>RUN</span><span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span>/usr/src/mods/jars
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=k>RUN</span><span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span>/usr/src/mods/compiled
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=k>COPY</span><span class=w> </span>.<span class=w> </span>/usr/src
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=k>WORKDIR</span><span class=w> </span><span class=s>/usr/src</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=k>RUN</span><span class=w> </span>javac<span class=w> </span>-Xlint:unchecked<span class=w> </span>-d<span class=w> </span>/usr/src/mods/compiled<span class=w> </span>--module-source-path<span class=w> </span>/usr/src/src<span class=w> </span><span class=k>$(</span>find<span class=w> </span>src<span class=w> </span>-name<span class=w> </span><span class=s2>&quot;*.java&quot;</span><span class=k>)</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=k>RUN</span><span class=w> </span>jar<span class=w> </span>--create<span class=w> </span>--file<span class=w> </span>/usr/src/mods/jars/joostvdg.dui.logging.jar<span class=w> </span>--module-version<span class=w> </span><span class=m>1</span>.0<span class=w> </span>-C<span class=w> </span>/usr/src/mods/compiled/joostvdg.dui.logging<span class=w> </span>.
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=k>RUN</span><span class=w> </span>jar<span class=w> </span>--create<span class=w> </span>--file<span class=w> </span>/usr/src/mods/jars/joostvdg.dui.api.jar<span class=w> </span>--module-version<span class=w> </span><span class=m>1</span>.0<span class=w> </span>-C<span class=w> </span>/usr/src/mods/compiled/joostvdg.dui.api<span class=w> </span>.
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=k>RUN</span><span class=w> </span>jar<span class=w> </span>--create<span class=w> </span>--file<span class=w> </span>/usr/src/mods/jars/joostvdg.dui.client.jar<span class=w> </span>--module-version<span class=w> </span><span class=m>1</span>.0<span class=w> </span>-C<span class=w> </span>/usr/src/mods/compiled/joostvdg.dui.client<span class=w> </span>.
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=k>RUN</span><span class=w> </span>jar<span class=w> </span>--create<span class=w> </span>--file<span class=w> </span>/usr/src/mods/jars/joostvdg.dui.server.jar<span class=w> </span>--module-version<span class=w> </span><span class=m>1</span>.0<span class=w>  </span>-e<span class=w> </span>com.github.joostvdg.dui.server.cli.DockerApp<span class=se>\</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=w>    </span>-C<span class=w> </span>/usr/src/mods/compiled/joostvdg.dui.server<span class=w> </span>.
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=k>RUN</span><span class=w> </span>rm<span class=w> </span>-rf<span class=w> </span>/usr/bin/dui-image
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=k>RUN</span><span class=w> </span>jlink<span class=w> </span>--module-path<span class=w> </span>/usr/src/mods/jars/:/<span class=si>${</span><span class=nv>JAVA_HOME</span><span class=si>}</span>/jmods<span class=w> </span><span class=se>\</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=w>    </span>--add-modules<span class=w> </span>joostvdg.dui.api<span class=w> </span><span class=se>\</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=w>    </span>--add-modules<span class=w> </span>joostvdg.dui.logging<span class=w> </span><span class=se>\</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=w>    </span>--add-modules<span class=w> </span>joostvdg.dui.server<span class=w> </span><span class=se>\</span>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=w>    </span>--add-modules<span class=w> </span>joostvdg.dui.client<span class=w> </span><span class=se>\</span>
</span><span id=__span-27-22><a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a><span class=w>    </span>--launcher<span class=w> </span><span class=nv>dui</span><span class=o>=</span>joostvdg.dui.server<span class=w> </span><span class=se>\</span>
</span><span id=__span-27-23><a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a><span class=w>    </span>--output<span class=w> </span>/usr/bin/dui-image
</span><span id=__span-27-24><a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a>
</span><span id=__span-27-25><a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a><span class=k>RUN</span><span class=w> </span>ls<span class=w> </span>-lath<span class=w> </span>/usr/bin/dui-image
</span><span id=__span-27-26><a id=__codelineno-27-26 name=__codelineno-27-26 href=#__codelineno-27-26></a><span class=k>RUN</span><span class=w> </span>ls<span class=w> </span>-lath<span class=w> </span>/usr/bin/dui-image
</span><span id=__span-27-27><a id=__codelineno-27-27 name=__codelineno-27-27 href=#__codelineno-27-27></a><span class=k>RUN</span><span class=w> </span>/usr/bin/dui-image/bin/java<span class=w> </span>--list-modules
</span><span id=__span-27-28><a id=__codelineno-27-28 name=__codelineno-27-28 href=#__codelineno-27-28></a>
</span><span id=__span-27-29><a id=__codelineno-27-29 name=__codelineno-27-29 href=#__codelineno-27-29></a><span class=k>FROM</span><span class=w> </span><span class=s>debian:stable-slim</span>
</span><span id=__span-27-30><a id=__codelineno-27-30 name=__codelineno-27-30 href=#__codelineno-27-30></a><span class=k>LABEL</span><span class=w> </span><span class=nv>authors</span><span class=o>=</span><span class=s2>&quot;Joost van der Griendt &lt;joostvdg@gmail.com&gt;&quot;</span>
</span><span id=__span-27-31><a id=__codelineno-27-31 name=__codelineno-27-31 href=#__codelineno-27-31></a><span class=k>LABEL</span><span class=w> </span><span class=nv>version</span><span class=o>=</span><span class=s2>&quot;0.1.0&quot;</span>
</span><span id=__span-27-32><a id=__codelineno-27-32 name=__codelineno-27-32 href=#__codelineno-27-32></a><span class=k>LABEL</span><span class=w> </span><span class=nv>description</span><span class=o>=</span><span class=s2>&quot;Docker image for playing with java applications in a concurrent, parallel and distributed manor.&quot;</span>
</span><span id=__span-27-33><a id=__codelineno-27-33 name=__codelineno-27-33 href=#__codelineno-27-33></a><span class=c># Add Tini - it is already included: https://docs.docker.com/engine/reference/commandline/run/</span>
</span><span id=__span-27-34><a id=__codelineno-27-34 name=__codelineno-27-34 href=#__codelineno-27-34></a><span class=k>ENV</span><span class=w> </span>TINI_VERSION<span class=w> </span>v0.16.1
</span><span id=__span-27-35><a id=__codelineno-27-35 name=__codelineno-27-35 href=#__codelineno-27-35></a><span class=k>ADD</span><span class=w> </span>https://github.com/krallin/tini/releases/download/<span class=si>${</span><span class=nv>TINI_VERSION</span><span class=si>}</span>/tini<span class=w> </span>/tini
</span><span id=__span-27-36><a id=__codelineno-27-36 name=__codelineno-27-36 href=#__codelineno-27-36></a><span class=k>RUN</span><span class=w> </span>chmod<span class=w> </span>+x<span class=w> </span>/tini
</span><span id=__span-27-37><a id=__codelineno-27-37 name=__codelineno-27-37 href=#__codelineno-27-37></a><span class=k>ENTRYPOINT</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;/tini&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;-vv&quot;</span><span class=p>,</span><span class=s2>&quot;-g&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;--&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;/usr/bin/dui/bin/dui&quot;</span><span class=p>]</span>
</span><span id=__span-27-38><a id=__codelineno-27-38 name=__codelineno-27-38 href=#__codelineno-27-38></a><span class=k>ENV</span><span class=w> </span><span class=nv>DATE_CHANGED</span><span class=o>=</span><span class=s2>&quot;20180120-1525&quot;</span>
</span><span id=__span-27-39><a id=__codelineno-27-39 name=__codelineno-27-39 href=#__codelineno-27-39></a><span class=k>COPY</span><span class=w> </span>--from<span class=o>=</span>build<span class=w> </span>/usr/bin/dui-image/<span class=w> </span>/usr/bin/dui
</span><span id=__span-27-40><a id=__codelineno-27-40 name=__codelineno-27-40 href=#__codelineno-27-40></a><span class=k>RUN</span><span class=w> </span>/usr/bin/dui/bin/java<span class=w> </span>--list-modules
</span></code></pre></div> <h4 id=handling-code>Handling code<a class=headerlink href=#handling-code title="Permanent link">&para;</a></h4> <p>The code first initializes the server which and when started, creates the <a href=https://docs.oracle.com/javase/7/docs/technotes/guides/lang/hook-design.html>Shutdown Hook</a>.</p> <p>Java handles certain signals in specific ways, as can be found <a href=https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/signals006.html#CIHBHCFE>in this table</a> for linux. For more information, you can read the <a href=https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/signals.html>docs from Oracle</a>. </p> <div class="language-java highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DockerApp</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=w>        </span><span class=n>ServiceLoader</span><span class=o>&lt;</span><span class=n>Logger</span><span class=o>&gt;</span><span class=w> </span><span class=n>loggers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ServiceLoader</span><span class=p>.</span><span class=na>load</span><span class=p>(</span><span class=n>Logger</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=w>                </span><span class=n>Logger</span><span class=w> </span><span class=n>logger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loggers</span><span class=p>.</span><span class=na>findFirst</span><span class=p>().</span><span class=na>isPresent</span><span class=p>()</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>loggers</span><span class=p>.</span><span class=na>findFirst</span><span class=p>().</span><span class=na>get</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Did not find any loggers, quiting&quot;</span><span class=p>);</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=w>                </span><span class=n>logger</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>LogLevel</span><span class=p>.</span><span class=na>INFO</span><span class=p>);</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>pseudoRandom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>ProtocolConstants</span><span class=p>.</span><span class=na>POTENTIAL_SERVER_NAMES</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>serverName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ProtocolConstants</span><span class=p>.</span><span class=na>POTENTIAL_SERVER_NAMES</span><span class=o>[</span><span class=n>pseudoRandom</span><span class=o>]</span><span class=p>;</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>listenPort</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ProtocolConstants</span><span class=p>.</span><span class=na>EXTERNAL_COMMUNICATION_PORT_A</span><span class=p>;</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>multicastGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ProtocolConstants</span><span class=p>.</span><span class=na>MULTICAST_GROUP</span><span class=p>;</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a><span class=w>                </span><span class=n>DuiServer</span><span class=w> </span><span class=n>distributedServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DuiServerFactory</span><span class=p>.</span><span class=na>newDistributedServer</span><span class=p>(</span><span class=n>listenPort</span><span class=p>,</span><span class=n>multicastGroup</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=n>serverName</span><span class=p>,</span><span class=w> </span><span class=n>logger</span><span class=p>);</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a><span class=w>                </span><span class=n>distributedServer</span><span class=p>.</span><span class=na>logMembership</span><span class=p>();</span>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19 href=#__codelineno-28-19></a>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20 href=#__codelineno-28-20></a><span class=w>                </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>executorService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-28-21><a id=__codelineno-28-21 name=__codelineno-28-21 href=#__codelineno-28-21></a><span class=w>                </span><span class=n>executorService</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=n>distributedServer</span><span class=p>::</span><span class=n>startServer</span><span class=p>);</span>
</span><span id=__span-28-22><a id=__codelineno-28-22 name=__codelineno-28-22 href=#__codelineno-28-22></a>
</span><span id=__span-28-23><a id=__codelineno-28-23 name=__codelineno-28-23 href=#__codelineno-28-23></a><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>threadId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getId</span><span class=p>();</span>
</span><span id=__span-28-24><a id=__codelineno-28-24 name=__codelineno-28-24 href=#__codelineno-28-24></a>
</span><span id=__span-28-25><a id=__codelineno-28-25 name=__codelineno-28-25 href=#__codelineno-28-25></a><span class=w>                </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>addShutdownHook</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-26><a id=__codelineno-28-26 name=__codelineno-28-26 href=#__codelineno-28-26></a><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Shutdown hook called!&quot;</span><span class=p>);</span>
</span><span id=__span-28-27><a id=__codelineno-28-27 name=__codelineno-28-27 href=#__codelineno-28-27></a><span class=w>                    </span><span class=n>logger</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>LogLevel</span><span class=p>.</span><span class=na>WARN</span><span class=p>,</span><span class=w> </span><span class=s>&quot;App&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;ShotdownHook&quot;</span><span class=p>,</span><span class=w> </span><span class=n>threadId</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Shutting down at request of Docker&quot;</span><span class=p>);</span>
</span><span id=__span-28-28><a id=__codelineno-28-28 name=__codelineno-28-28 href=#__codelineno-28-28></a><span class=w>                    </span><span class=n>distributedServer</span><span class=p>.</span><span class=na>stopServer</span><span class=p>();</span>
</span><span id=__span-28-29><a id=__codelineno-28-29 name=__codelineno-28-29 href=#__codelineno-28-29></a><span class=w>                    </span><span class=n>distributedServer</span><span class=p>.</span><span class=na>closeServer</span><span class=p>();</span>
</span><span id=__span-28-30><a id=__codelineno-28-30 name=__codelineno-28-30 href=#__codelineno-28-30></a><span class=w>                    </span><span class=n>executorService</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span>
</span><span id=__span-28-31><a id=__codelineno-28-31 name=__codelineno-28-31 href=#__codelineno-28-31></a><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-32><a id=__codelineno-28-32 name=__codelineno-28-32 href=#__codelineno-28-32></a><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
</span><span id=__span-28-33><a id=__codelineno-28-33 name=__codelineno-28-33 href=#__codelineno-28-33></a><span class=w>                        </span><span class=n>executorService</span><span class=p>.</span><span class=na>shutdownNow</span><span class=p>();</span>
</span><span id=__span-28-34><a id=__codelineno-28-34 name=__codelineno-28-34 href=#__codelineno-28-34></a><span class=w>                        </span><span class=n>logger</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span>
</span><span id=__span-28-35><a id=__codelineno-28-35 name=__codelineno-28-35 href=#__codelineno-28-35></a><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-36><a id=__codelineno-28-36 name=__codelineno-28-36 href=#__codelineno-28-36></a><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
</span><span id=__span-28-37><a id=__codelineno-28-37 name=__codelineno-28-37 href=#__codelineno-28-37></a><span class=w>                    </span><span class=p>}</span>
</span><span id=__span-28-38><a id=__codelineno-28-38 name=__codelineno-28-38 href=#__codelineno-28-38></a><span class=w>                </span><span class=p>}));</span><span class=w>        </span>
</span><span id=__span-28-39><a id=__codelineno-28-39 name=__codelineno-28-39 href=#__codelineno-28-39></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-40><a id=__codelineno-28-40 name=__codelineno-28-40 href=#__codelineno-28-40></a><span class=p>}</span>
</span></code></pre></div> <h3 id=java-plain-kubernetes>Java Plain (Kubernetes)<a class=headerlink href=#java-plain-kubernetes title="Permanent link">&para;</a></h3> <p>So far we've utilized the utilities from Docker itself in conjunction with it's native Docker Swarm orchestrator.</p> <p>Unfortunately, when it comes to popularity <a href=https://platform9.com/blog/kubernetes-docker-swarm-compared/ >Kubernetes beats Swarm hands down</a>.</p> <p>So this isn't complete if it doesn't also do graceful shutdown in Kubernetes. </p> <h4 id=in-dockerfile>In Dockerfile<a class=headerlink href=#in-dockerfile title="Permanent link">&para;</a></h4> <p>Our original file had to be changed, as Debian's Slim image doesn't actually contain the kill package. And we need a kill package, as we cannot instruct Kubernetes to issue a specific SIGNAL. Instead, we can issue a <a href=https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/ >PreStop exec command</a>, which we can utilise to execute a <a href=https://packages.debian.org/wheezy/psmisc>killall</a> java <a href=https://www.tecmint.com/how-to-kill-a-process-in-linux/ >-INT</a>.</p> <p>The command will be specified in the Kubernetes deployment definition below.</p> <div class="language-dockerfile highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=k>FROM</span><span class=w> </span><span class=s>openjdk:9-jdk</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s>build</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=k>RUN</span><span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span>/usr/src/mods/jars
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=k>RUN</span><span class=w> </span>mkdir<span class=w> </span>-p<span class=w> </span>/usr/src/mods/compiled
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=k>COPY</span><span class=w> </span>.<span class=w> </span>/usr/src
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=k>WORKDIR</span><span class=w> </span><span class=s>/usr/src</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=k>RUN</span><span class=w> </span>javac<span class=w> </span>-Xlint:unchecked<span class=w> </span>-d<span class=w> </span>/usr/src/mods/compiled<span class=w> </span>--module-source-path<span class=w> </span>/usr/src/src<span class=w> </span><span class=k>$(</span>find<span class=w> </span>src<span class=w> </span>-name<span class=w> </span><span class=s2>&quot;*.java&quot;</span><span class=k>)</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=k>RUN</span><span class=w> </span>jar<span class=w> </span>--create<span class=w> </span>--file<span class=w> </span>/usr/src/mods/jars/joostvdg.dui.logging.jar<span class=w> </span>--module-version<span class=w> </span><span class=m>1</span>.0<span class=w> </span>-C<span class=w> </span>/usr/src/mods/compiled/joostvdg.dui.logging<span class=w> </span>.
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=k>RUN</span><span class=w> </span>jar<span class=w> </span>--create<span class=w> </span>--file<span class=w> </span>/usr/src/mods/jars/joostvdg.dui.api.jar<span class=w> </span>--module-version<span class=w> </span><span class=m>1</span>.0<span class=w> </span>-C<span class=w> </span>/usr/src/mods/compiled/joostvdg.dui.api<span class=w> </span>.
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=k>RUN</span><span class=w> </span>jar<span class=w> </span>--create<span class=w> </span>--file<span class=w> </span>/usr/src/mods/jars/joostvdg.dui.client.jar<span class=w> </span>--module-version<span class=w> </span><span class=m>1</span>.0<span class=w> </span>-C<span class=w> </span>/usr/src/mods/compiled/joostvdg.dui.client<span class=w> </span>.
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=k>RUN</span><span class=w> </span>jar<span class=w> </span>--create<span class=w> </span>--file<span class=w> </span>/usr/src/mods/jars/joostvdg.dui.server.jar<span class=w> </span>--module-version<span class=w> </span><span class=m>1</span>.0<span class=w>  </span>-e<span class=w> </span>com.github.joostvdg.dui.server.cli.DockerApp<span class=se>\</span>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=w>    </span>-C<span class=w> </span>/usr/src/mods/compiled/joostvdg.dui.server<span class=w> </span>.
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=k>RUN</span><span class=w> </span>rm<span class=w> </span>-rf<span class=w> </span>/usr/bin/dui-image
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a><span class=k>RUN</span><span class=w> </span>jlink<span class=w> </span>--module-path<span class=w> </span>/usr/src/mods/jars/:/<span class=si>${</span><span class=nv>JAVA_HOME</span><span class=si>}</span>/jmods<span class=w> </span><span class=se>\</span>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a><span class=w>    </span>--add-modules<span class=w> </span>joostvdg.dui.api<span class=w> </span><span class=se>\</span>
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a><span class=w>    </span>--add-modules<span class=w> </span>joostvdg.dui.logging<span class=w> </span><span class=se>\</span>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a><span class=w>    </span>--add-modules<span class=w> </span>joostvdg.dui.server<span class=w> </span><span class=se>\</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a><span class=w>    </span>--add-modules<span class=w> </span>joostvdg.dui.client<span class=w> </span><span class=se>\</span>
</span><span id=__span-29-22><a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a><span class=w>    </span>--launcher<span class=w> </span><span class=nv>dui</span><span class=o>=</span>joostvdg.dui.server<span class=w> </span><span class=se>\</span>
</span><span id=__span-29-23><a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a><span class=w>    </span>--output<span class=w> </span>/usr/bin/dui-image
</span><span id=__span-29-24><a id=__codelineno-29-24 name=__codelineno-29-24 href=#__codelineno-29-24></a>
</span><span id=__span-29-25><a id=__codelineno-29-25 name=__codelineno-29-25 href=#__codelineno-29-25></a><span class=k>RUN</span><span class=w> </span>ls<span class=w> </span>-lath<span class=w> </span>/usr/bin/dui-image
</span><span id=__span-29-26><a id=__codelineno-29-26 name=__codelineno-29-26 href=#__codelineno-29-26></a><span class=k>RUN</span><span class=w> </span>ls<span class=w> </span>-lath<span class=w> </span>/usr/bin/dui-image
</span><span id=__span-29-27><a id=__codelineno-29-27 name=__codelineno-29-27 href=#__codelineno-29-27></a><span class=k>RUN</span><span class=w> </span>/usr/bin/dui-image/bin/java<span class=w> </span>--list-modules
</span><span id=__span-29-28><a id=__codelineno-29-28 name=__codelineno-29-28 href=#__codelineno-29-28></a>
</span><span id=__span-29-29><a id=__codelineno-29-29 name=__codelineno-29-29 href=#__codelineno-29-29></a><span class=k>FROM</span><span class=w> </span><span class=s>debian:stable-slim</span>
</span><span id=__span-29-30><a id=__codelineno-29-30 name=__codelineno-29-30 href=#__codelineno-29-30></a><span class=k>LABEL</span><span class=w> </span><span class=nv>authors</span><span class=o>=</span><span class=s2>&quot;Joost van der Griendt &lt;joostvdg@gmail.com&gt;&quot;</span>
</span><span id=__span-29-31><a id=__codelineno-29-31 name=__codelineno-29-31 href=#__codelineno-29-31></a><span class=k>LABEL</span><span class=w> </span><span class=nv>version</span><span class=o>=</span><span class=s2>&quot;0.1.0&quot;</span>
</span><span id=__span-29-32><a id=__codelineno-29-32 name=__codelineno-29-32 href=#__codelineno-29-32></a><span class=k>LABEL</span><span class=w> </span><span class=nv>description</span><span class=o>=</span><span class=s2>&quot;Docker image for playing with java applications in a concurrent, parallel and distributed manor.&quot;</span>
</span><span id=__span-29-33><a id=__codelineno-29-33 name=__codelineno-29-33 href=#__codelineno-29-33></a><span class=c># Add Tini - it is already included: https://docs.docker.com/engine/reference/commandline/run/</span>
</span><span id=__span-29-34><a id=__codelineno-29-34 name=__codelineno-29-34 href=#__codelineno-29-34></a><span class=k>ENV</span><span class=w> </span>TINI_VERSION<span class=w> </span>v0.16.1
</span><span id=__span-29-35><a id=__codelineno-29-35 name=__codelineno-29-35 href=#__codelineno-29-35></a><span class=k>ADD</span><span class=w> </span>https://github.com/krallin/tini/releases/download/<span class=si>${</span><span class=nv>TINI_VERSION</span><span class=si>}</span>/tini<span class=w> </span>/tini
</span><span id=__span-29-36><a id=__codelineno-29-36 name=__codelineno-29-36 href=#__codelineno-29-36></a><span class=k>RUN</span><span class=w> </span>chmod<span class=w> </span>+x<span class=w> </span>/tini
</span><span id=__span-29-37><a id=__codelineno-29-37 name=__codelineno-29-37 href=#__codelineno-29-37></a><span class=k>ENTRYPOINT</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;/tini&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;-vv&quot;</span><span class=p>,</span><span class=s2>&quot;-g&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;--&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;/usr/bin/dui/bin/dui&quot;</span><span class=p>]</span>
</span><span id=__span-29-38><a id=__codelineno-29-38 name=__codelineno-29-38 href=#__codelineno-29-38></a><span class=k>ENV</span><span class=w> </span><span class=nv>DATE_CHANGED</span><span class=o>=</span><span class=s2>&quot;20180120-1525&quot;</span>
</span><span id=__span-29-39><a id=__codelineno-29-39 name=__codelineno-29-39 href=#__codelineno-29-39></a><span class=k>RUN</span><span class=w> </span>apt-get<span class=w> </span>update<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>apt-get<span class=w> </span>install<span class=w> </span>--no-install-recommends<span class=w> </span>-y<span class=w> </span><span class=nv>psmisc</span><span class=o>=</span><span class=m>22</span>.*<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>rm<span class=w> </span>-rf<span class=w> </span>/var/lib/apt/lists/*
</span><span id=__span-29-40><a id=__codelineno-29-40 name=__codelineno-29-40 href=#__codelineno-29-40></a><span class=k>COPY</span><span class=w> </span>--from<span class=o>=</span>build<span class=w> </span>/usr/bin/dui-image/<span class=w> </span>/usr/bin/dui
</span><span id=__span-29-41><a id=__codelineno-29-41 name=__codelineno-29-41 href=#__codelineno-29-41></a><span class=k>RUN</span><span class=w> </span>/usr/bin/dui/bin/java<span class=w> </span>--list-modules
</span></code></pre></div> <h4 id=kubernetes-deployment>Kubernetes Deployment<a class=headerlink href=#kubernetes-deployment title="Permanent link">&para;</a></h4> <p>So here we have the image's K8s <a href>Deployment</a> descriptor.</p> <p>Including the Pod's <a href>lifecycle</a> <code>preStop</code> with a exec style command. You should know by now <a href=http://www.johnzaccone.io/entrypoint-vs-cmd-back-to-basics/ >why we prefer that</a>.</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dui-deployment</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dui</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=w>      </span><span class=nt>labels</span><span class=p>:</span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=w>        </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dui</span>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=w>      </span><span class=nt>containers</span><span class=p>:</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">master</span>
</span><span id=__span-30-17><a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">caladreas/buming</span>
</span><span id=__span-30-18><a id=__codelineno-30-18 name=__codelineno-30-18 href=#__codelineno-30-18></a><span class=w>          </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-30-19><a id=__codelineno-30-19 name=__codelineno-30-19 href=#__codelineno-30-19></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
</span><span id=__span-30-20><a id=__codelineno-30-20 name=__codelineno-30-20 href=#__codelineno-30-20></a><span class=w>              </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">7777</span>
</span><span id=__span-30-21><a id=__codelineno-30-21 name=__codelineno-30-21 href=#__codelineno-30-21></a><span class=w>          </span><span class=nt>lifecycle</span><span class=p>:</span>
</span><span id=__span-30-22><a id=__codelineno-30-22 name=__codelineno-30-22 href=#__codelineno-30-22></a><span class=w>            </span><span class=nt>preStop</span><span class=p>:</span>
</span><span id=__span-30-23><a id=__codelineno-30-23 name=__codelineno-30-23 href=#__codelineno-30-23></a><span class=w>              </span><span class=nt>exec</span><span class=p>:</span>
</span><span id=__span-30-24><a id=__codelineno-30-24 name=__codelineno-30-24 href=#__codelineno-30-24></a><span class=w>                </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;killall&quot;</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;java&quot;</span><span class=w> </span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>&quot;-INT&quot;</span><span class="p p-Indicator">]</span>
</span><span id=__span-30-25><a id=__codelineno-30-25 name=__codelineno-30-25 href=#__codelineno-30-25></a><span class=w>      </span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
</span></code></pre></div> <h3 id=java-spring-boot-1x>Java Spring Boot (1.x)<a class=headerlink href=#java-spring-boot-1x title="Permanent link">&para;</a></h3> <p>This example is for Spring Boot 1.x, in time we will have an example for 2.x.</p> <p>This example is for the scenario of a Fat Jar with Tomcat as container [^8].</p> <h4 id=execute-example>Execute example<a class=headerlink href=#execute-example title="Permanent link">&para;</a></h4> <div class="language-bash highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a>docker-compose<span class=w> </span>build
</span></code></pre></div> <p>Execute the following command:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a>docker<span class=w> </span>run<span class=w> </span>--rm<span class=w> </span>-ti<span class=w> </span>--name<span class=w> </span><span class=nb>test</span><span class=w> </span>spring-boot-graceful
</span></code></pre></div> <p>Exit the application/container via <code>ctrl+c</code> and you should see the application shutting down gracefully.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=m>2018</span>-01-30<span class=w> </span><span class=m>13</span>:35:46.327<span class=w>  </span>INFO<span class=w> </span><span class=m>7</span><span class=w> </span>---<span class=w> </span><span class=o>[</span><span class=w>       </span>Thread-3<span class=o>]</span><span class=w> </span>ationConfigEmbeddedWebApplicationContext<span class=w> </span>:<span class=w> </span>Closing<span class=w> </span>org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@6e5e91e4:<span class=w> </span>startup<span class=w> </span>date<span class=w> </span><span class=o>[</span>Tue<span class=w> </span>Jan<span class=w> </span><span class=m>30</span><span class=w> </span><span class=m>13</span>:35:42<span class=w> </span>GMT<span class=w> </span><span class=m>2018</span><span class=o>]</span><span class=p>;</span><span class=w> </span>root<span class=w> </span>of<span class=w> </span>context<span class=w> </span>hierarchy
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=m>2018</span>-01-30<span class=w> </span><span class=m>13</span>:35:46.405<span class=w>  </span>INFO<span class=w> </span><span class=m>7</span><span class=w> </span>---<span class=w> </span><span class=o>[</span><span class=w>       </span>Thread-3<span class=o>]</span><span class=w> </span>BootGracefulApplication<span class=nv>$GracefulShutdown</span><span class=w> </span>:<span class=w> </span>Tomcat<span class=w> </span>was<span class=w> </span>shutdown<span class=w> </span>gracefully<span class=w> </span>within<span class=w> </span>the<span class=w> </span>allotted<span class=w> </span>time.
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=m>2018</span>-01-30<span class=w> </span><span class=m>13</span>:35:46.408<span class=w>  </span>INFO<span class=w> </span><span class=m>7</span><span class=w> </span>---<span class=w> </span><span class=o>[</span><span class=w>       </span>Thread-3<span class=o>]</span><span class=w> </span>o.s.j.e.a.AnnotationMBeanExporter<span class=w>        </span>:<span class=w> </span>Unregistering<span class=w> </span>JMX-exposed<span class=w> </span>beans<span class=w> </span>on<span class=w> </span>shutdown
</span></code></pre></div> <h4 id=dockerfile_2>Dockerfile<a class=headerlink href=#dockerfile_2 title="Permanent link">&para;</a></h4> <div class="language-dockerfile highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=k>FROM</span><span class=w> </span><span class=s>maven:3-jdk-8</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s>build</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=k>ENV</span><span class=w> </span><span class=nv>MAVEN_OPTS</span><span class=o>=</span>-Dmaven.repo.local<span class=o>=</span>/usr/share/maven/repository
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=k>ENV</span><span class=w> </span><span class=nv>WORKDIR</span><span class=o>=</span>/usr/src/graceful
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=k>RUN</span><span class=w> </span>mkdir<span class=w> </span><span class=nv>$WORKDIR</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=k>WORKDIR</span><span class=w> </span><span class=s>$WORKDIR</span>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=k>COPY</span><span class=w> </span>pom.xml<span class=w> </span><span class=nv>$WORKDIR</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=k>RUN</span><span class=w> </span>mvn<span class=w> </span>-B<span class=w> </span>-e<span class=w> </span>org.apache.maven.plugins:maven-dependency-plugin:3.0.2:go-offline
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=k>COPY</span><span class=w> </span>.<span class=w> </span><span class=nv>$WORKSPACE</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=k>RUN</span><span class=w> </span>mvn<span class=w> </span>-B<span class=w> </span>-e<span class=w> </span>clean<span class=w> </span>verify
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=k>FROM</span><span class=w> </span><span class=s>anapsix/alpine-java:8_jdk_unlimited</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=k>LABEL</span><span class=w> </span><span class=nv>authors</span><span class=o>=</span><span class=s2>&quot;Joost van der Griendt &lt;joostvdg@gmail.com&gt;&quot;</span>
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=k>ENV</span><span class=w> </span>TINI_VERSION<span class=w> </span>v0.16.1
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=k>ADD</span><span class=w> </span>https://github.com/krallin/tini/releases/download/<span class=si>${</span><span class=nv>TINI_VERSION</span><span class=si>}</span>/tini<span class=w> </span>/tini
</span><span id=__span-34-15><a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a><span class=k>RUN</span><span class=w> </span>chmod<span class=w> </span>+x<span class=w> </span>/tini
</span><span id=__span-34-16><a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a><span class=k>ENTRYPOINT</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;/tini&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;-vv&quot;</span><span class=p>,</span><span class=s2>&quot;-g&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;--&quot;</span><span class=p>]</span>
</span><span id=__span-34-17><a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a><span class=k>ENV</span><span class=w> </span><span class=nv>DATE_CHANGED</span><span class=o>=</span><span class=s2>&quot;20180120-1525&quot;</span>
</span><span id=__span-34-18><a id=__codelineno-34-18 name=__codelineno-34-18 href=#__codelineno-34-18></a><span class=k>COPY</span><span class=w> </span>--from<span class=o>=</span>build<span class=w> </span>/usr/src/graceful/target/spring-boot-graceful.jar<span class=w> </span>/app.jar
</span><span id=__span-34-19><a id=__codelineno-34-19 name=__codelineno-34-19 href=#__codelineno-34-19></a><span class=k>CMD</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;java&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;-Xms256M&quot;</span><span class=p>,</span><span class=s2>&quot;-Xmx480M&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;-Djava.security.egd=file:/dev/./urandom&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;-jar&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;/app.jar&quot;</span><span class=p>]</span>
</span></code></pre></div> <h4 id=docker-compose-file>Docker compose file<a class=headerlink href=#docker-compose-file title="Permanent link">&para;</a></h4> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&quot;3.5&quot;</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=nt>services</span><span class=p>:</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=w>  </span><span class=nt>web</span><span class=p>:</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spring-boot-graceful</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=w>    </span><span class=nt>stop_signal</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">SIGINT</span>
</span></code></pre></div> <h4 id=java-handling-code>Java handling code<a class=headerlink href=#java-handling-code title="Permanent link">&para;</a></h4> <div class="language-java highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=kn>package</span><span class=w> </span><span class=nn>com.github.joostvdg.demo.springbootgraceful</span><span class=p>;</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.SpringApplication</span><span class=p>;</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.autoconfigure.SpringBootApplication</span><span class=p>;</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.catalina.connector.Connector</span><span class=p>;</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.tomcat.util.threads.ThreadPoolExecutor</span><span class=p>;</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=kn>import</span><span class=w> </span><span class=nn>org.slf4j.Logger</span><span class=p>;</span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=kn>import</span><span class=w> </span><span class=nn>org.slf4j.LoggerFactory</span><span class=p>;</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.context.embedded.ConfigurableEmbeddedServletContainer</span><span class=p>;</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.context.embedded.EmbeddedServletContainerCustomizer</span><span class=p>;</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.context.embedded.tomcat.TomcatConnectorCustomizer</span><span class=p>;</span>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainerFactory</span><span class=p>;</span>
</span><span id=__span-36-15><a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.ApplicationListener</span><span class=p>;</span>
</span><span id=__span-36-16><a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Bean</span><span class=p>;</span>
</span><span id=__span-36-17><a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.event.ContextClosedEvent</span><span class=p>;</span>
</span><span id=__span-36-18><a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a>
</span><span id=__span-36-19><a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.Executor</span><span class=p>;</span>
</span><span id=__span-36-20><a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.TimeUnit</span><span class=p>;</span>
</span><span id=__span-36-21><a id=__codelineno-36-21 name=__codelineno-36-21 href=#__codelineno-36-21></a>
</span><span id=__span-36-22><a id=__codelineno-36-22 name=__codelineno-36-22 href=#__codelineno-36-22></a><span class=nd>@SpringBootApplication</span>
</span><span id=__span-36-23><a id=__codelineno-36-23 name=__codelineno-36-23 href=#__codelineno-36-23></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SpringBootGracefulApplication</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-24><a id=__codelineno-36-24 name=__codelineno-36-24 href=#__codelineno-36-24></a>
</span><span id=__span-36-25><a id=__codelineno-36-25 name=__codelineno-36-25 href=#__codelineno-36-25></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-26><a id=__codelineno-36-26 name=__codelineno-36-26 href=#__codelineno-36-26></a><span class=w>        </span><span class=n>SpringApplication</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>SpringBootGracefulApplication</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span>
</span><span id=__span-36-27><a id=__codelineno-36-27 name=__codelineno-36-27 href=#__codelineno-36-27></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-28><a id=__codelineno-36-28 name=__codelineno-36-28 href=#__codelineno-36-28></a>
</span><span id=__span-36-29><a id=__codelineno-36-29 name=__codelineno-36-29 href=#__codelineno-36-29></a><span class=w>    </span><span class=nd>@Bean</span>
</span><span id=__span-36-30><a id=__codelineno-36-30 name=__codelineno-36-30 href=#__codelineno-36-30></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>GracefulShutdown</span><span class=w> </span><span class=nf>gracefulShutdown</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-31><a id=__codelineno-36-31 name=__codelineno-36-31 href=#__codelineno-36-31></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GracefulShutdown</span><span class=p>();</span>
</span><span id=__span-36-32><a id=__codelineno-36-32 name=__codelineno-36-32 href=#__codelineno-36-32></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-33><a id=__codelineno-36-33 name=__codelineno-36-33 href=#__codelineno-36-33></a>
</span><span id=__span-36-34><a id=__codelineno-36-34 name=__codelineno-36-34 href=#__codelineno-36-34></a><span class=w>    </span><span class=nd>@Bean</span>
</span><span id=__span-36-35><a id=__codelineno-36-35 name=__codelineno-36-35 href=#__codelineno-36-35></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>EmbeddedServletContainerCustomizer</span><span class=w> </span><span class=nf>tomcatCustomizer</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-36><a id=__codelineno-36-36 name=__codelineno-36-36 href=#__codelineno-36-36></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EmbeddedServletContainerCustomizer</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-37><a id=__codelineno-36-37 name=__codelineno-36-37 href=#__codelineno-36-37></a>
</span><span id=__span-36-38><a id=__codelineno-36-38 name=__codelineno-36-38 href=#__codelineno-36-38></a><span class=w>            </span><span class=nd>@Override</span>
</span><span id=__span-36-39><a id=__codelineno-36-39 name=__codelineno-36-39 href=#__codelineno-36-39></a><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>customize</span><span class=p>(</span><span class=n>ConfigurableEmbeddedServletContainer</span><span class=w> </span><span class=n>container</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-40><a id=__codelineno-36-40 name=__codelineno-36-40 href=#__codelineno-36-40></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>container</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>TomcatEmbeddedServletContainerFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-41><a id=__codelineno-36-41 name=__codelineno-36-41 href=#__codelineno-36-41></a><span class=w>                    </span><span class=p>((</span><span class=n>TomcatEmbeddedServletContainerFactory</span><span class=p>)</span><span class=w> </span><span class=n>container</span><span class=p>)</span>
</span><span id=__span-36-42><a id=__codelineno-36-42 name=__codelineno-36-42 href=#__codelineno-36-42></a><span class=w>                            </span><span class=p>.</span><span class=na>addConnectorCustomizers</span><span class=p>(</span><span class=n>gracefulShutdown</span><span class=p>());</span>
</span><span id=__span-36-43><a id=__codelineno-36-43 name=__codelineno-36-43 href=#__codelineno-36-43></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-36-44><a id=__codelineno-36-44 name=__codelineno-36-44 href=#__codelineno-36-44></a>
</span><span id=__span-36-45><a id=__codelineno-36-45 name=__codelineno-36-45 href=#__codelineno-36-45></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-36-46><a id=__codelineno-36-46 name=__codelineno-36-46 href=#__codelineno-36-46></a><span class=w>        </span><span class=p>};</span>
</span><span id=__span-36-47><a id=__codelineno-36-47 name=__codelineno-36-47 href=#__codelineno-36-47></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-48><a id=__codelineno-36-48 name=__codelineno-36-48 href=#__codelineno-36-48></a>
</span><span id=__span-36-49><a id=__codelineno-36-49 name=__codelineno-36-49 href=#__codelineno-36-49></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>GracefulShutdown</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>TomcatConnectorCustomizer</span><span class=p>,</span>
</span><span id=__span-36-50><a id=__codelineno-36-50 name=__codelineno-36-50 href=#__codelineno-36-50></a><span class=w>            </span><span class=n>ApplicationListener</span><span class=o>&lt;</span><span class=n>ContextClosedEvent</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-51><a id=__codelineno-36-51 name=__codelineno-36-51 href=#__codelineno-36-51></a>
</span><span id=__span-36-52><a id=__codelineno-36-52 name=__codelineno-36-52 href=#__codelineno-36-52></a><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>GracefulShutdown</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
</span><span id=__span-36-53><a id=__codelineno-36-53 name=__codelineno-36-53 href=#__codelineno-36-53></a>
</span><span id=__span-36-54><a id=__codelineno-36-54 name=__codelineno-36-54 href=#__codelineno-36-54></a><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Connector</span><span class=w> </span><span class=n>connector</span><span class=p>;</span>
</span><span id=__span-36-55><a id=__codelineno-36-55 name=__codelineno-36-55 href=#__codelineno-36-55></a>
</span><span id=__span-36-56><a id=__codelineno-36-56 name=__codelineno-36-56 href=#__codelineno-36-56></a><span class=w>        </span><span class=nd>@Override</span>
</span><span id=__span-36-57><a id=__codelineno-36-57 name=__codelineno-36-57 href=#__codelineno-36-57></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>customize</span><span class=p>(</span><span class=n>Connector</span><span class=w> </span><span class=n>connector</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-58><a id=__codelineno-36-58 name=__codelineno-36-58 href=#__codelineno-36-58></a><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>connector</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connector</span><span class=p>;</span>
</span><span id=__span-36-59><a id=__codelineno-36-59 name=__codelineno-36-59 href=#__codelineno-36-59></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-36-60><a id=__codelineno-36-60 name=__codelineno-36-60 href=#__codelineno-36-60></a>
</span><span id=__span-36-61><a id=__codelineno-36-61 name=__codelineno-36-61 href=#__codelineno-36-61></a><span class=w>        </span><span class=nd>@Override</span>
</span><span id=__span-36-62><a id=__codelineno-36-62 name=__codelineno-36-62 href=#__codelineno-36-62></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onApplicationEvent</span><span class=p>(</span><span class=n>ContextClosedEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-63><a id=__codelineno-36-63 name=__codelineno-36-63 href=#__codelineno-36-63></a><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>connector</span><span class=p>.</span><span class=na>pause</span><span class=p>();</span>
</span><span id=__span-36-64><a id=__codelineno-36-64 name=__codelineno-36-64 href=#__codelineno-36-64></a><span class=w>            </span><span class=n>Executor</span><span class=w> </span><span class=n>executor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>connector</span><span class=p>.</span><span class=na>getProtocolHandler</span><span class=p>().</span><span class=na>getExecutor</span><span class=p>();</span>
</span><span id=__span-36-65><a id=__codelineno-36-65 name=__codelineno-36-65 href=#__codelineno-36-65></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>executor</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-66><a id=__codelineno-36-66 name=__codelineno-36-66 href=#__codelineno-36-66></a><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-67><a id=__codelineno-36-67 name=__codelineno-36-67 href=#__codelineno-36-67></a><span class=w>                    </span><span class=n>ThreadPoolExecutor</span><span class=w> </span><span class=n>threadPoolExecutor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>)</span><span class=w> </span><span class=n>executor</span><span class=p>;</span>
</span><span id=__span-36-68><a id=__codelineno-36-68 name=__codelineno-36-68 href=#__codelineno-36-68></a><span class=w>                    </span><span class=n>threadPoolExecutor</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span>
</span><span id=__span-36-69><a id=__codelineno-36-69 name=__codelineno-36-69 href=#__codelineno-36-69></a><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>threadPoolExecutor</span><span class=p>.</span><span class=na>awaitTermination</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-70><a id=__codelineno-36-70 name=__codelineno-36-70 href=#__codelineno-36-70></a><span class=w>                        </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Tomcat thread pool did not shut down gracefully within &quot;</span>
</span><span id=__span-36-71><a id=__codelineno-36-71 name=__codelineno-36-71 href=#__codelineno-36-71></a><span class=w>                                </span><span class=o>+</span><span class=w> </span><span class=s>&quot;30 seconds. Proceeding with forceful shutdown&quot;</span><span class=p>);</span>
</span><span id=__span-36-72><a id=__codelineno-36-72 name=__codelineno-36-72 href=#__codelineno-36-72></a><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-73><a id=__codelineno-36-73 name=__codelineno-36-73 href=#__codelineno-36-73></a><span class=w>                        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&quot;Tomcat was shutdown gracefully within the allotted time.&quot;</span><span class=p>);</span>
</span><span id=__span-36-74><a id=__codelineno-36-74 name=__codelineno-36-74 href=#__codelineno-36-74></a><span class=w>                    </span><span class=p>}</span>
</span><span id=__span-36-75><a id=__codelineno-36-75 name=__codelineno-36-75 href=#__codelineno-36-75></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-36-76><a id=__codelineno-36-76 name=__codelineno-36-76 href=#__codelineno-36-76></a><span class=w>                </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-77><a id=__codelineno-36-77 name=__codelineno-36-77 href=#__codelineno-36-77></a><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span>
</span><span id=__span-36-78><a id=__codelineno-36-78 name=__codelineno-36-78 href=#__codelineno-36-78></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-36-79><a id=__codelineno-36-79 name=__codelineno-36-79 href=#__codelineno-36-79></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-36-80><a id=__codelineno-36-80 name=__codelineno-36-80 href=#__codelineno-36-80></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-36-81><a id=__codelineno-36-81 name=__codelineno-36-81 href=#__codelineno-36-81></a>
</span><span id=__span-36-82><a id=__codelineno-36-82 name=__codelineno-36-82 href=#__codelineno-36-82></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-83><a id=__codelineno-36-83 name=__codelineno-36-83 href=#__codelineno-36-83></a><span class=p>}</span>
</span></code></pre></div> <h2 id=example-with-docker-swarm>Example with Docker Swarm<a class=headerlink href=#example-with-docker-swarm title="Permanent link">&para;</a></h2> <p>For now there's only an example with <a href=https://docs.docker.com/engine/swarm/ >docker swarm</a>, in time there will also be a <a href=https://kubernetes.io/ >Kubernetes</a> example.</p> <p>Now that you can create Java applications packaged neatly in Docker images that support graceful shutdown, it would be nice to utilize.</p> <p>A good scenario would be a microservices architecture where services can come and go, but are registered in a <a href=https://spring.io/guides/gs/service-registration-and-discovery/ >service registry such as Eureka</a>.</p> <p>Or a membership based protocol where members interact with each other and perhaps shard data.</p> <p>In these cases, of course the interactions are designed to be fault tolerant and discover faulty nodes on their own. But wouldn't it be better that if you knew you're going to quit, you inform the rest?</p> <p>We can reuse the <code>caladreas/buming</code> image and make it a docker swarm stack and run the service on every node. This way, we can easily see members coming and going and reduce the time to detect failure by notifying our peers of our impeding end. </p> <h3 id=docker-swarm-cluster>Docker swarm cluster<a class=headerlink href=#docker-swarm-cluster title="Permanent link">&para;</a></h3> <p>Setting up a docker swarm cluster is easy, but has some requirements:</p> <ul> <li>virtual box 4.x+</li> <li>docker-machine 1.12+</li> <li>docker 17.06+</li> </ul> <div class="admonition warn"> <p class=admonition-title>Warn</p> <p>Make sure this is the first and only virtualbox docker-machine VM being created/running, so that the ip range starts with 192.168.99.100</p> </div> <div class="language-bash highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a>docker-machine<span class=w> </span>create<span class=w> </span>--driver<span class=w> </span>virtualbox<span class=w> </span>dui-1
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a>docker-machine<span class=w> </span>create<span class=w> </span>--driver<span class=w> </span>virtualbox<span class=w> </span>dui-2
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a>docker-machine<span class=w> </span>create<span class=w> </span>--driver<span class=w> </span>virtualbox<span class=w> </span>dui-3
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=nb>eval</span><span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>docker-machine<span class=w> </span>env<span class=w> </span>dui-1<span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=nv>IP</span><span class=o>=</span><span class=m>192</span>.168.99.100
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a>docker<span class=w> </span>swarm<span class=w> </span>init<span class=w> </span>--advertise-addr<span class=w> </span><span class=nv>$IP</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a><span class=nv>TOKEN</span><span class=o>=</span><span class=k>$(</span>docker<span class=w> </span>swarm<span class=w> </span>join-token<span class=w> </span>-q<span class=w> </span>worker<span class=k>)</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a><span class=nb>eval</span><span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>docker-machine<span class=w> </span>env<span class=w> </span>dui-2<span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a>docker<span class=w> </span>swarm<span class=w> </span>join<span class=w> </span>--token<span class=w> </span><span class=si>${</span><span class=nv>TOKEN</span><span class=si>}</span><span class=w> </span><span class=si>${</span><span class=nv>IP</span><span class=si>}</span>:2377
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13 href=#__codelineno-37-13></a><span class=nb>eval</span><span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>docker-machine<span class=w> </span>env<span class=w> </span>dui-3<span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14 href=#__codelineno-37-14></a>docker<span class=w> </span>swarm<span class=w> </span>join<span class=w> </span>--token<span class=w> </span><span class=si>${</span><span class=nv>TOKEN</span><span class=si>}</span><span class=w> </span><span class=si>${</span><span class=nv>IP</span><span class=si>}</span>:2377
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15 href=#__codelineno-37-15></a>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16 href=#__codelineno-37-16></a><span class=nb>eval</span><span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>docker-machine<span class=w> </span>env<span class=w> </span>dui-1<span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-37-17><a id=__codelineno-37-17 name=__codelineno-37-17 href=#__codelineno-37-17></a>docker<span class=w> </span>node<span class=w> </span>ls
</span></code></pre></div> <h3 id=docker-swarm-network-and-multicast>Docker swarm network and multicast<a class=headerlink href=#docker-swarm-network-and-multicast title="Permanent link">&para;</a></h3> <p>Unfortunately, docker swarm's swarm mode network <a href=http://blog.nigelpoulton.com/demystifying-docker-overlay-networking/ >overlay</a> does not support multicast [<sup>9][</sup>10].</p> <p>Why is this a problem? Well, the application I use to test the graceful shutdown requires this, sorry.</p> <p>Luckily there is a very easy solution for this, its by using <a href=https://www.weave.works/blog/weave-net-2-released>Weavenet</a>'s docker network plugin.</p> <p>Don't want to know about it or how you install it? Don't worry, just execute the script below.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=ch>#!/usr/bin/env bash</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;=&gt; Prepare dui-2&quot;</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=nb>eval</span><span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>docker-machine<span class=w> </span>env<span class=w> </span>dui-2<span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a>docker<span class=w> </span>plugin<span class=w> </span>install<span class=w> </span>weaveworks/net-plugin:2.1.3<span class=w> </span>--grant-all-permissions
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a>docker<span class=w> </span>plugin<span class=w> </span>disable<span class=w> </span>weaveworks/net-plugin:2.1.3
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a>docker<span class=w> </span>plugin<span class=w> </span><span class=nb>set</span><span class=w> </span>weaveworks/net-plugin:2.1.3<span class=w> </span><span class=nv>WEAVE_MULTICAST</span><span class=o>=</span><span class=m>1</span>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a>docker<span class=w> </span>plugin<span class=w> </span><span class=nb>enable</span><span class=w> </span>weaveworks/net-plugin:2.1.3
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;=&gt; Prepare dui-3&quot;</span>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=nb>eval</span><span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>docker-machine<span class=w> </span>env<span class=w> </span>dui-3<span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-38-11><a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a>docker<span class=w> </span>plugin<span class=w> </span>install<span class=w> </span>weaveworks/net-plugin:2.1.3<span class=w> </span>--grant-all-permissions
</span><span id=__span-38-12><a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a>docker<span class=w> </span>plugin<span class=w> </span>disable<span class=w> </span>weaveworks/net-plugin:2.1.3
</span><span id=__span-38-13><a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a>docker<span class=w> </span>plugin<span class=w> </span><span class=nb>set</span><span class=w> </span>weaveworks/net-plugin:2.1.3<span class=w> </span><span class=nv>WEAVE_MULTICAST</span><span class=o>=</span><span class=m>1</span>
</span><span id=__span-38-14><a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a>docker<span class=w> </span>plugin<span class=w> </span><span class=nb>enable</span><span class=w> </span>weaveworks/net-plugin:2.1.3
</span><span id=__span-38-15><a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a>
</span><span id=__span-38-16><a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a><span class=nb>echo</span><span class=w> </span><span class=s2>&quot;=&gt; Prepare dui-1&quot;</span>
</span><span id=__span-38-17><a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=nb>eval</span><span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>docker-machine<span class=w> </span>env<span class=w> </span>dui-1<span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-38-18><a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a>docker<span class=w> </span>plugin<span class=w> </span>install<span class=w> </span>weaveworks/net-plugin:2.1.3<span class=w> </span>--grant-all-permissions
</span><span id=__span-38-19><a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a>docker<span class=w> </span>plugin<span class=w> </span>disable<span class=w> </span>weaveworks/net-plugin:2.1.3
</span><span id=__span-38-20><a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a>docker<span class=w> </span>plugin<span class=w> </span><span class=nb>set</span><span class=w> </span>weaveworks/net-plugin:2.1.3<span class=w> </span><span class=nv>WEAVE_MULTICAST</span><span class=o>=</span><span class=m>1</span>
</span><span id=__span-38-21><a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a>docker<span class=w> </span>plugin<span class=w> </span><span class=nb>enable</span><span class=w> </span>weaveworks/net-plugin:2.1.3
</span><span id=__span-38-22><a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a>docker<span class=w> </span>network<span class=w> </span>create<span class=w> </span>--driver<span class=o>=</span>weaveworks/net-plugin:2.1.3<span class=w> </span>--opt<span class=w> </span>works.weave.multicast<span class=o>=</span><span class=nb>true</span><span class=w> </span>--attachable<span class=w> </span>dui
</span></code></pre></div> <h3 id=docker-stack>Docker stack<a class=headerlink href=#docker-stack title="Permanent link">&para;</a></h3> <p>Now to create a service that runs on every node it is the easiest to create a <a href=https://docs.docker.com/get-started/part5/ >docker stack</a>.</p> <h4 id=compose-file-docker-stackyml>Compose file (docker-stack.yml)<a class=headerlink href=#compose-file-docker-stackyml title="Permanent link">&para;</a></h4> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&quot;3.5&quot;</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=nt>services</span><span class=p>:</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=w>  </span><span class=nt>dui</span><span class=p>:</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">caladreas/buming</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a><span class=w>    </span><span class=nt>stop_signal</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">SIGINT</span>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a><span class=w>    </span><span class=nt>networks</span><span class=p>:</span>
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dui</span>
</span><span id=__span-39-10><a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a><span class=w>    </span><span class=nt>deploy</span><span class=p>:</span>
</span><span id=__span-39-11><a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a><span class=w>      </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">global</span>
</span><span id=__span-39-12><a id=__codelineno-39-12 name=__codelineno-39-12 href=#__codelineno-39-12></a><span class=nt>networks</span><span class=p>:</span>
</span><span id=__span-39-13><a id=__codelineno-39-13 name=__codelineno-39-13 href=#__codelineno-39-13></a><span class=w>  </span><span class=nt>dui</span><span class=p>:</span>
</span><span id=__span-39-14><a id=__codelineno-39-14 name=__codelineno-39-14 href=#__codelineno-39-14></a><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div> <h4 id=create-stack>Create stack<a class=headerlink href=#create-stack title="Permanent link">&para;</a></h4> <div class="language-bash highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>docker<span class=w> </span>stack<span class=w> </span>deploy<span class=w> </span>--compose-file<span class=w> </span>docker-stack.yml<span class=w> </span>buming
</span></code></pre></div> <h3 id=execute-example_1>Execute example<a class=headerlink href=#execute-example_1 title="Permanent link">&para;</a></h3> <p>Now that we have a docker swarm cluster and a stack - which has a service running on every node - we can showcase the power of graceful shutdown in a cluster of dependent services.</p> <p>Confirm the service is running correctly on every node, first lets check our nodes.</p> <p><div class="language-bash highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=nb>eval</span><span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>docker-machine<span class=w> </span>env<span class=w> </span>dui-1<span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a>docker<span class=w> </span>node<span class=w> </span>ls
</span></code></pre></div> Which should look like this:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a>ID<span class=w>                            </span>HOSTNAME<span class=w>            </span>STATUS<span class=w>              </span>AVAILABILITY<span class=w>        </span>MANAGER<span class=w> </span>STATUS
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a>f21ilm4thxegn5xbentmss5ur<span class=w> </span>*<span class=w>   </span>dui-1<span class=w>               </span>Ready<span class=w>               </span>Active<span class=w>              </span>Leader
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>y7475bo5uplt2b58d050b4wfd<span class=w>     </span>dui-2<span class=w>               </span>Ready<span class=w>               </span>Active<span class=w>              </span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a>6ssxola6y1i6h9p8256pi7bfv<span class=w>     </span>dui-3<span class=w>               </span>Ready<span class=w>               </span>Active<span class=w>                            </span>
</span></code></pre></div> <p>Then check the service.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a>docker<span class=w> </span>service<span class=w> </span>ps<span class=w> </span>buming_dui
</span></code></pre></div> <p>Which should look like this.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a>ID<span class=w>                  </span>NAME<span class=w>                                   </span>IMAGE<span class=w>               </span>NODE<span class=w>                </span>DESIRED<span class=w> </span>STATE<span class=w>       </span>CURRENT<span class=w> </span>STATE<span class=w>            </span>ERROR<span class=w>               </span>PORTS
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a>3mrpr0jg31x1<span class=w>        </span>buming_dui.6ssxola6y1i6h9p8256pi7bfv<span class=w>   </span>dui:latest<span class=w>          </span>dui-3<span class=w>               </span>Running<span class=w>             </span>Running<span class=w> </span><span class=m>17</span><span class=w> </span>seconds<span class=w> </span>ago<span class=w>                       </span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a>pfubtiy4j7vo<span class=w>        </span>buming_dui.f21ilm4thxegn5xbentmss5ur<span class=w>   </span>dui:latest<span class=w>          </span>dui-1<span class=w>               </span>Running<span class=w>             </span>Running<span class=w> </span><span class=m>17</span><span class=w> </span>seconds<span class=w> </span>ago<span class=w>                       </span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a>f4gjnmhoe3y4<span class=w>        </span>buming_dui.y7475bo5uplt2b58d050b4wfd<span class=w>   </span>dui:latest<span class=w>          </span>dui-2<span class=w>               </span>Running<span class=w>             </span>Running<span class=w> </span><span class=m>17</span><span class=w> </span>seconds<span class=w> </span>ago<span class=w>                       </span>
</span></code></pre></div> <p>Now open a second terminal window. In window one, follow the service logs:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=nb>eval</span><span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>docker-machine<span class=w> </span>env<span class=w> </span>dui-1<span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>docker<span class=w> </span>service<span class=w> </span>logs<span class=w> </span>-f<span class=w> </span>buming_dui
</span></code></pre></div> <p>In window two, go to a different node and stop the container.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=nb>eval</span><span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>docker-machine<span class=w> </span>env<span class=w> </span>dui-2<span class=k>)</span><span class=s2>&quot;</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a>docker<span class=w> </span>ps
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a>docker<span class=w> </span>stop<span class=w> </span>buming_dui.y7475bo5uplt2b58d050b4wfd.pnoui2x6elrz0tvkjz51njz94
</span></code></pre></div> <p>In this case, you will see the other nodes receiving a leave notice and then the node stopping.</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a>buming_dui.0.ryd8szexxku3@dui-3<span class=w>    </span><span class=p>|</span><span class=w> </span><span class=o>[</span>Server-John<span class=w> </span>D.<span class=w> </span>Carmack<span class=o>]</span><span class=w>           </span><span class=o>[</span>WARN<span class=o>]</span><span class=w>  </span><span class=o>[</span><span class=m>14</span>:19:02.604011<span class=o>]</span><span class=w>   </span><span class=o>[</span><span class=m>16</span><span class=o>]</span><span class=w>    </span><span class=o>[</span>Main<span class=o>]</span><span class=w>              </span>Received<span class=w> </span>membership<span class=w> </span>leave<span class=w> </span>notice<span class=w> </span>from<span class=w> </span>MessageOrigin<span class=o>{</span><span class=nv>host</span><span class=o>=</span><span class=s1>&#39;83918f6ad817&#39;</span>,<span class=w> </span><span class=nv>ip</span><span class=o>=</span><span class=s1>&#39;10.0.0.7&#39;</span>,<span class=w> </span><span class=nv>name</span><span class=o>=</span><span class=s1>&#39;Ken Thompson&#39;</span><span class=o>}</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a>buming_dui.0.so5m14sz8ksh@dui-1<span class=w>    </span><span class=p>|</span><span class=w> </span><span class=o>[</span>Server-Alan<span class=w> </span>Kay<span class=o>]</span><span class=w>                  </span><span class=o>[</span>WARN<span class=o>]</span><span class=w>  </span><span class=o>[</span><span class=m>14</span>:19:02.602082<span class=o>]</span><span class=w>   </span><span class=o>[</span><span class=m>16</span><span class=o>]</span><span class=w>    </span><span class=o>[</span>Main<span class=o>]</span><span class=w>              </span>Received<span class=w> </span>membership<span class=w> </span>leave<span class=w> </span>notice<span class=w> </span>from<span class=w> </span>MessageOrigin<span class=o>{</span><span class=nv>host</span><span class=o>=</span><span class=s1>&#39;83918f6ad817&#39;</span>,<span class=w> </span><span class=nv>ip</span><span class=o>=</span><span class=s1>&#39;10.0.0.7&#39;</span>,<span class=w> </span><span class=nv>name</span><span class=o>=</span><span class=s1>&#39;Ken Thompson&#39;</span><span class=o>}</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a>buming_dui.0.pnoui2x6elrz@dui-2<span class=w>    </span><span class=p>|</span><span class=w> </span>Shutdown<span class=w> </span>hook<span class=w> </span>called!
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a>buming_dui.0.pnoui2x6elrz@dui-2<span class=w>    </span><span class=p>|</span><span class=w> </span><span class=o>[</span>App<span class=o>]</span><span class=w>                              </span><span class=o>[</span>WARN<span class=o>]</span><span class=w>  </span><span class=o>[</span><span class=m>14</span>:19:02.598759<span class=o>]</span><span class=w>   </span><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>[</span>ShotdownHook<span class=o>]</span><span class=w>      </span>Shutting<span class=w> </span>down<span class=w> </span>at<span class=w> </span>request<span class=w> </span>of<span class=w> </span>Docker
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a>buming_dui.0.pnoui2x6elrz@dui-2<span class=w>    </span><span class=p>|</span><span class=w> </span><span class=o>[</span>Server-Ken<span class=w> </span>Thompson<span class=o>]</span><span class=w>              </span><span class=o>[</span>INFO<span class=o>]</span><span class=w>  </span><span class=o>[</span><span class=m>14</span>:19:02.598858<span class=o>]</span><span class=w>   </span><span class=o>[</span><span class=m>12</span><span class=o>]</span><span class=w>    </span><span class=o>[</span>Main<span class=o>]</span><span class=w>               </span>Stopping
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a>buming_dui.0.pnoui2x6elrz@dui-2<span class=w>    </span><span class=p>|</span><span class=w> </span><span class=o>[</span>Server-Ken<span class=w> </span>Thompson<span class=o>]</span><span class=w>              </span><span class=o>[</span>INFO<span class=o>]</span><span class=w>  </span><span class=o>[</span><span class=m>14</span>:19:02.601008<span class=o>]</span><span class=w>   </span><span class=o>[</span><span class=m>12</span><span class=o>]</span><span class=w>    </span><span class=o>[</span>Main<span class=o>]</span><span class=w>               </span>Closing
</span></code></pre></div> <h2 id=further-reading>Further reading<a class=headerlink href=#further-reading title="Permanent link">&para;</a></h2> <ul> <li><a href=https://en.wikipedia.org/wiki/Reboot_(computing)>Wikipedia page on reboots</a></li> <li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms738547(v=vs.85).aspx">Microsoft about graceful shutdown</a></li> <li><a href=https://www.ctl.io/developers/blog/post/gracefully-stopping-docker-containers/ >Gracefully stopping docker containers</a></li> <li><a href=https://dzone.com/articles/know-jvm-series-2-shutdown>What to know about Java and shutdown hooks</a></li> <li><a href=https://www.weave.works/blog/docker-container-networking-multicast-fast/ >https://www.weave.works/blog/docker-container-networking-multicast-fast/</a></li> <li><a href=https://www.weave.works/docs/net/latest/install/plugin/plugin-how-it-works/ >https://www.weave.works/docs/net/latest/install/plugin/plugin-how-it-works/</a></li> <li><a href=https://www.weave.works/docs/net/latest/install/plugin/plugin-v2/ >https://www.weave.works/docs/net/latest/install/plugin/plugin-v2/</a></li> <li><a href=https://www.auzias.net/en/docker-network-multihost/ >https://www.auzias.net/en/docker-network-multihost/</a></li> <li><a href=https://forums.docker.com/t/cannot-get-zookeeper-to-work-running-in-docker-using-swarm-mode/27109>https://forums.docker.com/t/cannot-get-zookeeper-to-work-running-in-docker-using-swarm-mode/27109</a></li> <li><a href=https://github.com/docker/libnetwork/issues/740>https://github.com/docker/libnetwork/issues/740</a></li> </ul> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime">2019-08-31 13:21:13</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 Joost van der Griendt </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/joostvdg target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> <a href=https://twitter.com/joost_vdg target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://linkedin.com/in/joostvdg target=_blank rel=noopener title=linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "navigation.instant", "navigation.tabs.sticky", "content.code.annotate", "content.code.copy", "toc.follow"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.aecac24b.min.js></script> </body> </html>