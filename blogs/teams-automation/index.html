<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Use GitOps to manage Team Master in CloudBees Core on Modern"><link href=https://joostvdg.github.io/blogs/teams-automation/ rel=canonical><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.2"><title>Core Modern Teams Automation</title><link rel=stylesheet href=../../assets/stylesheets/application.30686662.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#fb8c00><script src=../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-145385967-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-primary=orange data-md-color-accent=red> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#core-modern-teams-automation tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-header-nav__button md-logo"> <i class=md-icon>public</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> J's Software Development Pages </span> <span class=md-header-nav__topic> Core Modern Teams Automation </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <div class=md-hero data-md-component=hero> <div class="md-hero__inner md-grid"> GitOps for Team Masters </div> </div> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../jenkins-pipeline-support-tool/ class="md-tabs__link md-tabs__link--active"> Blogs </a> </li> <li class=md-tabs__item> <a href=../../cloudbees/sso-azure-ad/ class=md-tabs__link> CICD </a> </li> <li class=md-tabs__item> <a href=../../kubernetes/ class=md-tabs__link> Containers </a> </li> <li class=md-tabs__item> <a href=../../cloud/automation-pulumi/ class=md-tabs__link> Cloud </a> </li> <li class=md-tabs__item> <a href=../../certificates/lets-encrypt-k8s/ class=md-tabs__link> SWE </a> </li> <li class=md-tabs__item> <a href=../../java/ class=md-tabs__link> Java </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-nav__button md-logo"> <i class=md-icon>public</i> </a> J's Software Development Pages </label> <div class=md-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> Home </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-1> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Me class=md-nav__link> Me </a> </li> <li class=md-nav__item> <a href=../../other/mkdocs/ title="MKDocs (This Static Website)" class=md-nav__link> MKDocs (This Static Website) </a> </li> <li class=md-nav__item> <a href=../../other/vim/ title=VIM class=md-nav__link> VIM </a> </li> <li class=md-nav__item> <a href=../../other/shell/ title=Shell class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Blogs </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Blogs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../jenkins-pipeline-support-tool/ title="Jenkins Pipeline Support Tools" class=md-nav__link> Jenkins Pipeline Support Tools </a> </li> <li class=md-nav__item> <a href=../graceful-shutdown/ title="Docker Graceful Shutdown" class=md-nav__link> Docker Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../docker-alternatives/ title="Pipelines with Docker Alternatives" class=md-nav__link> Pipelines with Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../k8s-lets-encrypt/ title="Let's Encrypt for Kubernetes Apps" class=md-nav__link> Let's Encrypt for Kubernetes Apps </a> </li> <li class=md-nav__item> <a href=../sso-azure-ad/ title="CloudBees SSO Azure AD" class=md-nav__link> CloudBees SSO Azure AD </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> CloudBees Automate Teams </label> <a href=./ title="CloudBees Automate Teams" class="md-nav__link md-nav__link--active"> CloudBees Automate Teams </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#goals class=md-nav__link> Goals </a> </li> <li class=md-nav__item> <a href=#before-we-start class=md-nav__link> Before We Start </a> </li> <li class=md-nav__item> <a href=#bootstrapping class=md-nav__link> Bootstrapping </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-api-token class=md-nav__link> Create API Token </a> </li> <li class=md-nav__item> <a href=#get-configure-client-jar class=md-nav__link> Get &amp; Configure Client Jar </a> </li> <li class=md-nav__item> <a href=#create-alias-test class=md-nav__link> Create Alias &amp; Test </a> </li> <li class=md-nav__item> <a href=#create-team-ops class=md-nav__link> Create Team Ops </a> </li> <li class=md-nav__item> <a href=#update-create-kubernetes-namespaces class=md-nav__link> Update &amp; Create Kubernetes Namespaces </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-team-ops-namespace class=md-nav__link> Create Team Ops Namespace </a> </li> <li class=md-nav__item> <a href=#update-operation-center-serviceaccount class=md-nav__link> Update Operation Center ServiceAccount </a> </li> <li class=md-nav__item> <a href=#jenkins-agent-configmap class=md-nav__link> Jenkins Agent ConfigMap </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-initial-master class=md-nav__link> Create Initial Master </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-team-ops-master class=md-nav__link> Configure Team Ops Master </a> </li> <li class=md-nav__item> <a href=#create-gitops-pipeline class=md-nav__link> Create GitOps Pipeline </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-cli-image-pipeline class=md-nav__link> Create CLI Image Pipeline </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#kaniko-configuration class=md-nav__link> Kaniko Configuration </a> </li> <li class=md-nav__item> <a href=#pipeline class=md-nav__link> Pipeline </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#pr-pipeline class=md-nav__link> PR Pipeline </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tools-used class=md-nav__link> Tools Used </a> </li> <li class=md-nav__item> <a href=#repository-layout class=md-nav__link> Repository Layout </a> </li> <li class=md-nav__item> <a href=#kustomize-configuration class=md-nav__link> Kustomize Configuration </a> </li> <li class=md-nav__item> <a href=#pipeline_1 class=md-nav__link> Pipeline </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#main-pipeline class=md-nav__link> Main Pipeline </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#process class=md-nav__link> Process </a> </li> <li class=md-nav__item> <a href=#notable-statements class=md-nav__link> Notable Statements </a> </li> <li class=md-nav__item> <a href=#files class=md-nav__link> Files </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../kubernetes-sso-keycloak/ title="Kubernetes SSO Keycloak" class=md-nav__link> Kubernetes SSO Keycloak </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-8 type=checkbox id=nav-2-8> <label class=md-nav__link for=nav-2-8> Jenkins Monitoring Kubernetes </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-8> Jenkins Monitoring Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/introduction/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/prepare/ title="Prepare Environment" class=md-nav__link> Prepare Environment </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/install/ title="Install Tools" class=md-nav__link> Install Tools </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/metrics/ title=Metrics class=md-nav__link> Metrics </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/alerts/ title=Alerts class=md-nav__link> Alerts </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/pipeline/ title=Pipeline class=md-nav__link> Pipeline </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/dashboard/ title=Dashboard class=md-nav__link> Dashboard </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/cloudbees/ title=CloudBees class=md-nav__link> CloudBees </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../k8s-crd/ title="Create your own k8s resource" class=md-nav__link> Create your own k8s resource </a> </li> <li class=md-nav__item> <a href=../dockercon-eu-2018/ title="DockerCon EU 2018" class=md-nav__link> DockerCon EU 2018 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> CICD </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> CICD </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-1 type=checkbox id=nav-3-1> <label class=md-nav__link for=nav-3-1> CloudBees </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-1> CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloudbees/sso-azure-ad/ title="Single Sign On - AzureAD" class=md-nav__link> Single Sign On - AzureAD </a> </li> <li class=md-nav__item> <a href=../../cloudbees/teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-gke-helm/ title="CloudBees Core on GKE" class=md-nav__link> CloudBees Core on GKE </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-eks/ title="CloudBees Core on EKS" class=md-nav__link> CloudBees Core on EKS </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-team-namespace/ title="Team Master Namespace" class=md-nav__link> Team Master Namespace </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-2 type=checkbox id=nav-3-2> <label class=md-nav__link for=nav-3-2> Jenkins X </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-2> Jenkins X </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/build-packs/ title="Build Packs" class=md-nav__link> Build Packs </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jx-pipelines/ title="Jenkins X Pipelines" class=md-nav__link> Jenkins X Pipelines </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot/ title="JX Boot GKE" class=md-nav__link> JX Boot GKE </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot-aks/ title="JX Boot AKS" class=md-nav__link> JX Boot AKS </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/aks-boot-core/ title="JX Boot & CloudBees Core" class=md-nav__link> JX Boot & CloudBees Core </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hello-world/ title=HelloWorld class=md-nav__link> HelloWorld </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/maven/ title=Maven class=md-nav__link> Maven </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hybrid/ title=Hybrid class=md-nav__link> Hybrid </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/kubernetes-days/ title="Example For Console Reel" class=md-nav__link> Example For Console Reel </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-3 type=checkbox id=nav-3-3> <label class=md-nav__link for=nav-3-3> Jenkins </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-3> Jenkins </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins/ title=Intro class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jobdsl/ title=JobDSL class=md-nav__link> JobDSL </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jenkins-jobs-builder/ title=JenkinsJobsBuilder class=md-nav__link> JenkinsJobsBuilder </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4> <label class=md-nav__link for=nav-3-4> Jenkins Pipelines </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-4> Jenkins Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline/job-types/ title="Job Types" class=md-nav__link> Job Types </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/kaniko-pipelines/ title="Build Docker Image Kaniko" class=md-nav__link> Build Docker Image Kaniko </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/podtemplate-dind/ title="PodTemplate With Docker-In-Docker" class=md-nav__link> PodTemplate With Docker-In-Docker </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/jenkins-parallel-pipeline/ title="Parallel Pipelines" class=md-nav__link> Parallel Pipelines </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/core-concepts/ title="Core Concepts" class=md-nav__link> Core Concepts </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/artifactory-integration/ title="Artifactory Integration" class=md-nav__link> Artifactory Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/declarative-pipeline/ title="Pipeline (declarative)" class=md-nav__link> Pipeline (declarative) </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/groovy-pipeline/ title="Groovy DSL Pipeline" class=md-nav__link> Groovy DSL Pipeline </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/global-shared-library/ title="Pipeline Libraries" class=md-nav__link> Pipeline Libraries </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/ide-integration-pipeline-dsl/ title="DSL IDE Integration" class=md-nav__link> DSL IDE Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/input/ title=Input class=md-nav__link> Input </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-5 type=checkbox id=nav-3-5> <label class=md-nav__link for=nav-3-5> Jenkins Pipeline Examples </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-5> Jenkins Pipeline Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/ title=Index class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-alternatives/ title="Docker Alternatives" class=md-nav__link> Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/maven-declarative/ title="Maven Declarative" class=md-nav__link> Maven Declarative </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-declarative/ title="Docker Declarative" class=md-nav__link> Docker Declarative </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Containers </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Containers </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-1 type=checkbox id=nav-4-1> <label class=md-nav__link for=nav-4-1> Kubernetes (K8S) </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-1> Kubernetes (K8S) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../kubernetes/cka-exam-prep/ title="CKA Exam prep" class=md-nav__link> CKA Exam prep </a> </li> <li class=md-nav__item> <a href=../../kubernetes/tools/ title=Tools class=md-nav__link> Tools </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-2 type=checkbox id=nav-4-2> <label class=md-nav__link for=nav-4-2> K8S Public Services </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-2> K8S Public Services </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/distributions/install-gke/ title=GKE class=md-nav__link> GKE </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/gke-terraform/ title="GKE Terraform" class=md-nav__link> GKE Terraform </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/eks-eksctl/ title="AWS EKS" class=md-nav__link> AWS EKS </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-cli/ title="AKS CLI" class=md-nav__link> AKS CLI </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-terraform/ title="AKS Terraform" class=md-nav__link> AKS Terraform </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> K8S Hard Way - GCE </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-3> K8S Hard Way - GCE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/ title="Installer Preparation" class=md-nav__link> Installer Preparation </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/terraform-compute/ title="Create GCE resources" class=md-nav__link> Create GCE resources </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/certificates/ title="Prepare Certificates" class=md-nav__link> Prepare Certificates </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/kubeconfigs/ title="Prepare Kubeconfigs" class=md-nav__link> Prepare Kubeconfigs </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/encryption/ title="Encryption configuration" class=md-nav__link> Encryption configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/etcd/ title="ETCD configuration" class=md-nav__link> ETCD configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/controller/ title="Controller Config" class=md-nav__link> Controller Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/worker/ title="Worker Config" class=md-nav__link> Worker Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/remote-access/ title="Remote access" class=md-nav__link> Remote access </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/network/ title="Network config" class=md-nav__link> Network config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/debug/ title=Debug class=md-nav__link> Debug </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-4 type=checkbox id=nav-4-4> <label class=md-nav__link for=nav-4-4> Docker </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-4> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docker/graceful-shutdown/ title="Graceful Shutdown" class=md-nav__link> Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../docker/build-kit/ title=BuildKit class=md-nav__link> BuildKit </a> </li> <li class=md-nav__item> <a href=../../docker/multi-stage-builds/ title="Multi-Stage Builds(TBD)" class=md-nav__link> Multi-Stage Builds(TBD) </a> </li> <li class=md-nav__item> <a href=../../docker/swarm/ title="Swarm (mode) (TBD)" class=md-nav__link> Swarm (mode) (TBD) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-5 type=checkbox id=nav-4-5> <label class=md-nav__link for=nav-4-5> Linux </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-5> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../linux/systemd/ title=SystemD class=md-nav__link> SystemD </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Cloud </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloud/automation-pulumi/ title="Automation - Pulumi" class=md-nav__link> Automation - Pulumi </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> SWE </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-6> SWE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../certificates/lets-encrypt-k8s/ title="Let's Encrypt K8S" class=md-nav__link> Let's Encrypt K8S </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6-2 type=checkbox id=nav-6-2> <label class=md-nav__link for=nav-6-2> Software Engineering </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-6-2> Software Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../swe/important-concepts/ title="Important Concepts" class=md-nav__link> Important Concepts </a> </li> <li class=md-nav__item> <a href=../../swe/naming/ title=Naming class=md-nav__link> Naming </a> </li> <li class=md-nav__item> <a href=../../swe/distributed/ title="Distributed Computing" class=md-nav__link> Distributed Computing </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6-3 type=checkbox id=nav-6-3> <label class=md-nav__link for=nav-6-3> Productivity </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-6-3> Productivity </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../productivity/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../productivity/incidents/ title=Incidents class=md-nav__link> Incidents </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class=md-nav__link for=nav-7> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-7> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../java/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../keep-watching/ title="Spring Boot App" class=md-nav__link> Spring Boot App </a> </li> <li class=md-nav__item> <a href=../../java/networking/ title="Java Networking" class=md-nav__link> Java Networking </a> </li> <li class=md-nav__item> <a href=../../java/concurrency/ title="Java Concurrency" class=md-nav__link> Java Concurrency </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#goals class=md-nav__link> Goals </a> </li> <li class=md-nav__item> <a href=#before-we-start class=md-nav__link> Before We Start </a> </li> <li class=md-nav__item> <a href=#bootstrapping class=md-nav__link> Bootstrapping </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-api-token class=md-nav__link> Create API Token </a> </li> <li class=md-nav__item> <a href=#get-configure-client-jar class=md-nav__link> Get &amp; Configure Client Jar </a> </li> <li class=md-nav__item> <a href=#create-alias-test class=md-nav__link> Create Alias &amp; Test </a> </li> <li class=md-nav__item> <a href=#create-team-ops class=md-nav__link> Create Team Ops </a> </li> <li class=md-nav__item> <a href=#update-create-kubernetes-namespaces class=md-nav__link> Update &amp; Create Kubernetes Namespaces </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-team-ops-namespace class=md-nav__link> Create Team Ops Namespace </a> </li> <li class=md-nav__item> <a href=#update-operation-center-serviceaccount class=md-nav__link> Update Operation Center ServiceAccount </a> </li> <li class=md-nav__item> <a href=#jenkins-agent-configmap class=md-nav__link> Jenkins Agent ConfigMap </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-initial-master class=md-nav__link> Create Initial Master </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-team-ops-master class=md-nav__link> Configure Team Ops Master </a> </li> <li class=md-nav__item> <a href=#create-gitops-pipeline class=md-nav__link> Create GitOps Pipeline </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-cli-image-pipeline class=md-nav__link> Create CLI Image Pipeline </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#kaniko-configuration class=md-nav__link> Kaniko Configuration </a> </li> <li class=md-nav__item> <a href=#pipeline class=md-nav__link> Pipeline </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#pr-pipeline class=md-nav__link> PR Pipeline </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tools-used class=md-nav__link> Tools Used </a> </li> <li class=md-nav__item> <a href=#repository-layout class=md-nav__link> Repository Layout </a> </li> <li class=md-nav__item> <a href=#kustomize-configuration class=md-nav__link> Kustomize Configuration </a> </li> <li class=md-nav__item> <a href=#pipeline_1 class=md-nav__link> Pipeline </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#main-pipeline class=md-nav__link> Main Pipeline </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#process class=md-nav__link> Process </a> </li> <li class=md-nav__item> <a href=#notable-statements class=md-nav__link> Notable Statements </a> </li> <li class=md-nav__item> <a href=#files class=md-nav__link> Files </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/joostvdg/joostvdg.github.io/edit/master/docs/blogs/teams-automation.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=core-modern-teams-automation>Core Modern Teams Automation<a class=headerlink href=#core-modern-teams-automation title="Permanent link">&para;</a></h1> <p>CloudBees Core on Modern (meaning, on Kubernetes) has two main types of Jenkins Masters, a Managed Master, and a Team Master. In this article, we're going to automate the creation and management of the Team Masters.</p> <div class="admonition hint"> <p class=admonition-title>Hint</p> <p>If you do not want to read any of the code here, or just want to take a look at the end result - pipeline wise - you can find working examples on GitHub.</p> <ul> <li><a href=https://github.com/joostvdg/cb-team-gitops-template>Template Repository</a> - creates a new team template and a PR to the GitOps repository</li> <li><a href=https://github.com/joostvdg/cb-team-gitops>GitOps Repository</a> - applies GitOps principles to manage the CloudBees Core Team Masters</li> </ul> </div> <h2 id=goals>Goals<a class=headerlink href=#goals title="Permanent link">&para;</a></h2> <p>Just automating the creation of a Team Master is relatively easy, as this can be done via the <a href>Client Jar</a>. So we're going to set some additional goals to create a decent challenge.</p> <ul> <li><strong>GitOps</strong>: I want to be able to create and delete Team Masters by managing configuration in a Git repository </li> <li><strong>Configuration-as-Code</strong>: as much of the configuration as possible should be stored in the Git repository</li> <li><strong>Namespace</strong>: one of the major reasons for Team Masters to exist is to increase (Product) Team autonomy, which in Kubernetes should correspond to a <code class=codehilite><span class=n>namespace</span></code>. So I want each Team Master to be in its own Namespace!</li> <li><strong>Self-Service</strong>: the solution should cater to (semi-)autonomous teams and lower the workload of the team managing CloudBees Core. So requesting a Team Master should be doable by everyone</li> </ul> <h2 id=before-we-start>Before We Start<a class=headerlink href=#before-we-start title="Permanent link">&para;</a></h2> <p>Some assumptions need to be taken care off before we start.</p> <ul> <li>Kubernetes cluster in which you are <code class=codehilite><span class=n>ClusterAdmin</span></code><ul> <li>if you don't have one yet, <a href=/kubernetes/distributions/install-gke/ >there are guides on this elsewhere on the site</a></li> </ul> </li> <li>your cluster has enough capacity (at least two nodes of 4gb memory)</li> <li>your cluster has CloudBees Core Modern installed<ul> <li>if you don't have this yet <a href=/cloudbees/cbc-gke-helm/ >look at one of the guides on this site</a></li> <li>or look at the <a href=https://go.cloudbees.com/docs/cloudbees-core/cloud-install-guide/ >guides on CloudBees.com</a></li> </ul> </li> <li>have administrator access to CloudBees Core Cloud <strong>Operations Center</strong></li> </ul> <div class="admonition tip"> <p class=admonition-title>Code Examples</p> <p>The more extensive Code Examples, such as Kubernetes Yaml files, are collapsed by default. You can open them by clicking on them. On the right, the code snippet will have a <code class=codehilite><span class=p>[</span> <span class=p>]</span></code> copy icon. Below is an example.</p> </div> <details class=example><summary>Code Snippet Example</summary><p>Here's a code snippet.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>pipeline</span> <span class=o>{</span>
    <span class=n>agent</span> <span class=n>any</span>
    <span class=n>stages</span> <span class=o>{</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Hello&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>steps</span> <span class=o>{</span>
                <span class=n>echo</span> <span class=s1>&#39;Hello World!&#39;</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div> </td></tr></table> </details> <h2 id=bootstrapping>Bootstrapping<a class=headerlink href=#bootstrapping title="Permanent link">&para;</a></h2> <p>All right, so we want to use GitOps and to process the changes we need a Pipeline that can be triggered by a Webhook. I believe in <strong><em>everything as code</em></strong> - except Secrets and such - which includes the Pipeline.</p> <p>Unfortunately, <strong>Operations Center</strong> cannot run such pipelines. To get over this hurdle, we will create a special <code class=codehilite><span class=n>Ops</span></code> Team Master. This Master will be configured to be able to Manage the other Team Masters for us.</p> <p>Log into your Operations Center with a user that has administrative access.</p> <h3 id=create-api-token>Create API Token<a class=headerlink href=#create-api-token title="Permanent link">&para;</a></h3> <p>Create a new API Token for your administrator user by clicking on the user's name - top right corner. Select the <code class=codehilite><span class=n>Configuration</span></code> menu on the left and then you should see a section where you can <code class=codehilite><span class=k>Create</span> <span class=n>a</span> <span class=n>API</span> <span class=n>Token</span></code>. This Token will disappear, so write it down.</p> <h3 id=get-configure-client-jar>Get &amp; Configure Client Jar<a class=headerlink href=#get-configure-client-jar title="Permanent link">&para;</a></h3> <p>Replace the values marked by <code class=codehilite><span class=o>&lt;</span> <span class=p>...</span> <span class=o>&gt;</span></code>. The Operations Center URL should look like this: <code class=codehilite><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>cbcore</span><span class=p>.</span><span class=n>mydomain</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>cjoc</span></code>.</p> <p>Setup the connection variables.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nv>OC_URL</span><span class=o>=</span>&lt;your operations center url&gt;
</pre></div> </td></tr></table> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nv>USR</span><span class=o>=</span>&lt;your username&gt;
<span class=nv>TKN</span><span class=o>=</span>&lt;api token&gt;
</pre></div> </td></tr></table> <p>Download the Client Jar.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>curl <span class=si>${</span><span class=nv>OC_URL</span><span class=si>}</span>/jnlpJars/jenkins-cli.jar -o jenkins-cli.jar
</pre></div> </td></tr></table> <h3 id=create-alias-test>Create Alias &amp; Test<a class=headerlink href=#create-alias-test title="Permanent link">&para;</a></h3> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nb>alias</span> <span class=nv>cboc</span><span class=o>=</span><span class=s2>&quot;java -jar jenkins-cli.jar -noKeyAuth -auth </span><span class=si>${</span><span class=nv>USR</span><span class=si>}</span><span class=s2>:</span><span class=si>${</span><span class=nv>TKN</span><span class=si>}</span><span class=s2> -s </span><span class=si>${</span><span class=nv>OC_URL</span><span class=si>}</span><span class=s2>&quot;</span>
</pre></div> </td></tr></table> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>cboc version
</pre></div> </td></tr></table> <h3 id=create-team-ops>Create Team Ops<a class=headerlink href=#create-team-ops title="Permanent link">&para;</a></h3> <p>As the tasks of the Team Masters for managing Operations are quite specific and demand special rights, I'd recommend putting this in its own <code class=codehilite><span class=n>namespace</span></code>. To do so properly, we need to configure a few things.</p> <ul> <li>allows Operations Center access to this namespace (so it can create the Team Master)</li> <li>give the <code class=codehilite><span class=n>ServiceAccount</span></code> the permissions to create <code class=codehilite><span class=n>namespace</span></code>'s for the other Team Masters</li> <li>add config map for the Jenkins Agents</li> <li>temporarily change Operations Center's operating Namespace (where it will spawn resources in)</li> <li>use the CLI to create the <code class=codehilite><span class=n>team</span><span class=o>-</span><span class=n>ops</span></code> Team Master</li> <li>reset Operations Center's operating Namespace</li> </ul> <h3 id=update-create-kubernetes-namespaces>Update &amp; Create Kubernetes Namespaces<a class=headerlink href=#update-create-kubernetes-namespaces title="Permanent link">&para;</a></h3> <h4 id=create-team-ops-namespace>Create Team Ops Namespace<a class=headerlink href=#create-team-ops-namespace title="Permanent link">&para;</a></h4> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl apply -f team-ops-namespace.yaml
</pre></div> </td></tr></table> <details class=example><summary>team-ops-namespace.yaml</summary><p>This creates the <code class=codehilite><span class=n>team</span><span class=o>-</span><span class=n>ops</span></code> namespace including all the resources required such as <code class=codehilite><span class=n>ResourceQuota</span></code>, <code class=codehilite><span class=n>ServiceAccount</span></code> and so on.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">team-ops</span>

<span class=nn>---</span>

<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ResourceQuota</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">resource-quota</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">team-ops</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>hard</span><span class=p>:</span>
    <span class=nt>pods</span><span class=p>:</span> <span class=s>&quot;20&quot;</span>
    <span class=nt>requests.cpu</span><span class=p>:</span> <span class=s>&quot;4&quot;</span>
    <span class=nt>requests.memory</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">6Gi</span>
    <span class=nt>limits.cpu</span><span class=p>:</span> <span class=s>&quot;5&quot;</span>
    <span class=nt>limits.memory</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">10Gi</span>
    <span class=nt>services.loadbalancers</span><span class=p>:</span> <span class=s>&quot;0&quot;</span>
    <span class=nt>services.nodeports</span><span class=p>:</span> <span class=s>&quot;0&quot;</span>
    <span class=nt>persistentvolumeclaims</span><span class=p>:</span> <span class=s>&quot;10&quot;</span>

<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">team-ops</span>

<span class=nn>---</span>

<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Role</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1beta1</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">pods-all</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">team-ops</span>
<span class=nt>rules</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;pods&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;pods/exec&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;pods/log&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>

<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">RoleBinding</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">team-ops</span>
<span class=nt>roleRef</span><span class=p>:</span>
  <span class=nt>apiGroup</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
  <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Role</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">pods-all</span>
<span class=nt>subjects</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">team-ops</span>

<span class=nn>---</span>

<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">RoleBinding</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cjoc</span>
<span class=nt>roleRef</span><span class=p>:</span>
  <span class=nt>apiGroup</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
  <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Role</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">master-management</span>
<span class=nt>subjects</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">team-ops</span>

<span class=nn>---</span>

<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">create-namespaces</span>
<span class=nt>rules</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;*&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;serviceaccounts&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;rolebindings&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;roles&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;resourcequotas&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;namespaces&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;configmaps&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;rolebindings&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;roles&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;resourcequotas&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;namespaces&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;events&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;persistentvolumeclaims&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;pods&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;pods/exec&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;services&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;statefulsets&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;ingresses&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;extensions&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;pods/log&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;secrets&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;apps&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;statefulsets&quot;</span><span class="p p-Indicator">]</span> 
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;extensions&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;ingresses&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>

<span class=nn>---</span>

<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ops-namespace</span>
<span class=nt>roleRef</span><span class=p>:</span>
  <span class=nt>apiGroup</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
  <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">create-namespaces</span>
<span class=nt>subjects</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">team-ops</span>
</pre></div> </td></tr></table> </details> <h4 id=update-operation-center-serviceaccount>Update Operation Center ServiceAccount<a class=headerlink href=#update-operation-center-serviceaccount title="Permanent link">&para;</a></h4> <p>The <code class=codehilite><span class=n>ServiceAccount</span></code> under which Operation Center runs, only has rights in it's own <code class=codehilite><span class=n>namespace</span></code>. Which means it cannot create our Team Ops Master. Below is the <code class=codehilite><span class=na>.yaml</span></code> file for Kubernetes and the command to apply it.</p> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>I assume you're using the default <code class=codehilite><span class=n>cloudbees</span><span class=o>-</span><span class=n>core</span></code> as per Cloudbees' documentation. If this is not the case, change the last line, <code class=codehilite><span class=kd>namespace</span><span class=o>:</span> <span class=n>cloudbees</span><span class=o>-</span><span class=n>core</span></code> with the namespace your Operation Center runs in.</p> </div> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl apply -f patch-oc-serviceaccount.yaml -n team-ops
</pre></div> </td></tr></table> <details class=example><summary>patch-oc-serviceaccount.yaml</summary><p>This patches the existing Operation Center's ServiceAccount to also have the correct rights in the <code class=codehilite><span class=n>team</span><span class=o>-</span><span class=n>ops</span></code> namespace.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Role</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1beta1</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">master-management</span>
<span class=nt>rules</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;pods&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;pods/exec&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;pods/log&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;apps&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;statefulsets&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;services&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;persistentvolumeclaims&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;extensions&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;ingresses&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;create&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;update&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;secrets&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroups</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>resources</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;events&quot;</span><span class="p p-Indicator">]</span>
  <span class=nt>verbs</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;get&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;list&quot;</span><span class="p p-Indicator">,</span><span class=s>&quot;watch&quot;</span><span class="p p-Indicator">]</span>

<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">RoleBinding</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cjoc</span>
<span class=nt>roleRef</span><span class=p>:</span>
  <span class=nt>apiGroup</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
  <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Role</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">master-management</span>
<span class=nt>subjects</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cjoc</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cloudbees-core</span>
</pre></div> </td></tr></table> </details> <h4 id=jenkins-agent-configmap>Jenkins Agent ConfigMap<a class=headerlink href=#jenkins-agent-configmap title="Permanent link">&para;</a></h4> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl apply -f jenkins-agent-config-map.yaml -n team-ops
</pre></div> </td></tr></table> <details class=example><summary>jenkins-agent-config-map.yaml</summary><p>Creates the Jenkins Agent ConfigMap, which contains the information the Jenkins Agent - within a PodTemplate - uses to connect to the Jenkins Master.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins-agent</span>
<span class=nt>data</span><span class=p>:</span>
  <span class=nt>jenkins-agent</span><span class=p>:</span> <span class="p p-Indicator">|</span>
    <span class=no>#!/usr/bin/env sh</span>
    <span class=no># The MIT License</span>
    <span class=no>#</span>
    <span class=no>#  Copyright (c) 2015, CloudBees, Inc.</span>
    <span class=no>#</span>
    <span class=no>#  Permission is hereby granted, free of charge, to any person obtaining a copy</span>
    <span class=no>#  of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
    <span class=no>#  in the Software without restriction, including without limitation the rights</span>
    <span class=no>#  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
    <span class=no>#  copies of the Software, and to permit persons to whom the Software is</span>
    <span class=no>#  furnished to do so, subject to the following conditions:</span>
    <span class=no>#</span>
    <span class=no>#  The above copyright notice and this permission notice shall be included in</span>
    <span class=no>#  all copies or substantial portions of the Software.</span>
    <span class=no>#</span>
    <span class=no>#  THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
    <span class=no>#  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
    <span class=no>#  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
    <span class=no>#  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
    <span class=no>#  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
    <span class=no>#  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span>
    <span class=no>#  THE SOFTWARE.</span>
    <span class=no># Usage jenkins-slave.sh [options] -url http://jenkins [SECRET] [AGENT_NAME]</span>
    <span class=no># Optional environment variables :</span>
    <span class=no># * JENKINS_TUNNEL : HOST:PORT for a tunnel to route TCP traffic to jenkins host, when jenkins can&#39;t be directly accessed over network</span>
    <span class=no># * JENKINS_URL : alternate jenkins URL</span>
    <span class=no># * JENKINS_SECRET : agent secret, if not set as an argument</span>
    <span class=no># * JENKINS_AGENT_NAME : agent name, if not set as an argument</span>
    <span class=no>if [ $# -eq 1 ]; then</span>
        <span class=no># if `docker run` only has one arguments, we assume user is running alternate command like `bash` to inspect the image</span>
        <span class=no>exec &quot;$@&quot;</span>
    <span class=no>else</span>
        <span class=no># if -tunnel is not provided try env vars</span>
        <span class=no>case &quot;$@&quot; in</span>
            <span class=no>*&quot;-tunnel &quot;*) ;;</span>
            <span class=no>*)</span>
            <span class=no>if [ ! -z &quot;$JENKINS_TUNNEL&quot; ]; then</span>
                <span class=no>TUNNEL=&quot;-tunnel $JENKINS_TUNNEL&quot;</span>
            <span class=no>fi ;;</span>
        <span class=no>esac</span>
        <span class=no>if [ -n &quot;$JENKINS_URL&quot; ]; then</span>
            <span class=no>URL=&quot;-url $JENKINS_URL&quot;</span>
        <span class=no>fi</span>
        <span class=no>if [ -n &quot;$JENKINS_NAME&quot; ]; then</span>
            <span class=no>JENKINS_AGENT_NAME=&quot;$JENKINS_NAME&quot;</span>
        <span class=no>fi  </span>
        <span class=no>if [ -z &quot;$JNLP_PROTOCOL_OPTS&quot; ]; then</span>
            <span class=no>echo &quot;Warning: JnlpProtocol3 is disabled by default, use JNLP_PROTOCOL_OPTS to alter the behavior&quot;</span>
            <span class=no>JNLP_PROTOCOL_OPTS=&quot;-Dorg.jenkinsci.remoting.engine.JnlpProtocol3.disabled=true&quot;</span>
        <span class=no>fi</span>
        <span class=no># If both required options are defined, do not pass the parameters</span>
        <span class=no>OPT_JENKINS_SECRET=&quot;&quot;</span>
        <span class=no>if [ -n &quot;$JENKINS_SECRET&quot; ]; then</span>
            <span class=no>case &quot;$@&quot; in</span>
                <span class=no>*&quot;${JENKINS_SECRET}&quot;*) echo &quot;Warning: SECRET is defined twice in command-line arguments and the environment variable&quot; ;;</span>
                <span class=no>*)</span>
                <span class=no>OPT_JENKINS_SECRET=&quot;${JENKINS_SECRET}&quot; ;;</span>
            <span class=no>esac</span>
        <span class=no>fi</span>

        <span class=no>OPT_JENKINS_AGENT_NAME=&quot;&quot;</span>
        <span class=no>if [ -n &quot;$JENKINS_AGENT_NAME&quot; ]; then</span>
            <span class=no>case &quot;$@&quot; in</span>
                <span class=no>*&quot;${JENKINS_AGENT_NAME}&quot;*) echo &quot;Warning: AGENT_NAME is defined twice in command-line arguments and the environment variable&quot; ;;</span>
                <span class=no>*)</span>
                <span class=no>OPT_JENKINS_AGENT_NAME=&quot;${JENKINS_AGENT_NAME}&quot; ;;</span>
            <span class=no>esac</span>
        <span class=no>fi</span>
        <span class=no>SLAVE_JAR=/usr/share/jenkins/slave.jar</span>
        <span class=no>if [ ! -f &quot;$SLAVE_JAR&quot; ]; then</span>
            <span class=no>tmpfile=$(mktemp)</span>
            <span class=no>if hash wget &gt; /dev/null 2&gt;&amp;1; then</span>
                <span class=no>wget -O &quot;$tmpfile&quot; &quot;$JENKINS_URL/jnlpJars/slave.jar&quot;</span>
            <span class=no>elif hash curl &gt; /dev/null 2&gt;&amp;1; then</span>
                <span class=no>curl -o &quot;$tmpfile&quot; &quot;$JENKINS_URL/jnlpJars/slave.jar&quot;</span>
            <span class=no>else</span>
                <span class=no>echo &quot;Image does not include $SLAVE_JAR and could not find wget or curl to download it&quot;</span>
                <span class=no>return 1</span>
            <span class=no>fi</span>
            <span class=no>SLAVE_JAR=$tmpfile</span>
        <span class=no>fi</span>
        <span class=no>#TODO: Handle the case when the command-line and Environment variable contain different values.</span>
        <span class=no>#It is fine it blows up for now since it should lead to an error anyway.</span>
        <span class=no>exec java $JAVA_OPTS $JNLP_PROTOCOL_OPTS -cp $SLAVE_JAR hudson.remoting.jnlp.Main -headless $TUNNEL $URL $OPT_JENKINS_SECRET $OPT_JENKINS_AGENT_NAME &quot;$@&quot;</span>
    <span class=no>fi</span>
</pre></div> </td></tr></table> </details> <h3 id=create-initial-master>Create Initial Master<a class=headerlink href=#create-initial-master title="Permanent link">&para;</a></h3> <p>To make it easier to change the <code class=codehilite><span class=n>namespace</span></code> if needed, its extracted out from the command.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nv>OriginalNamespace</span><span class=o>=</span>cloudbees-core
</pre></div> </td></tr></table> <p>This script changes the Operations Center's operating <code class=codehilite><span class=n>namespace</span></code>, creates a Team Master with the name <code class=codehilite><span class=n>ops</span></code>, and then resets the namespace.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span>cboc <span class=nv>groovy</span> <span class=o>=</span> &lt; configure-oc-namespace.groovy team-ops
cboc teams ops --put &lt; team-ops.json
cboc <span class=nv>groovy</span> <span class=o>=</span> &lt; configure-oc-namespace.groovy <span class=nv>$OriginalNamespace</span>
</pre></div> </td></tr></table> <details class=example><summary>team-ops.json</summary><p>This <code class=codehilite><span class=n>json</span></code> file that describes a team. By default there are three roles defined on a team, <code class=codehilite><span class=n>TEAM_ADMIN</span></code>, <code class=codehilite><span class=n>TEAM_MEMBER</span></code>, and <code class=codehilite><span class=n>TEAM_GUEST</span></code>. Don't forget to change the <code class=codehilite><span class=n>id</span></code>'s to Group ID's from your Single-Sign-On solution.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class="p p-Indicator">{</span>
    <span class=s>&quot;version&quot;</span><span class=nt> </span><span class=p>:</span> <span class=s>&quot;1&quot;</span><span class="p p-Indicator">,</span>
    <span class=s>&quot;data&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{</span>
        <span class=s>&quot;name&quot;</span><span class="p p-Indicator">:</span> <span class=s>&quot;ops&quot;</span><span class="p p-Indicator">,</span>
        <span class=s>&quot;displayName&quot;</span><span class="p p-Indicator">:</span> <span class=s>&quot;Operations&quot;</span><span class="p p-Indicator">,</span>
        <span class=s>&quot;provisioningRecipe&quot;</span><span class="p p-Indicator">:</span> <span class=s>&quot;basic&quot;</span><span class="p p-Indicator">,</span>
        <span class=s>&quot;members&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[{</span>
            <span class=s>&quot;id&quot;</span><span class="p p-Indicator">:</span> <span class=s>&quot;Catmins&quot;</span><span class="p p-Indicator">,</span>
            <span class=s>&quot;roles&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class=s>&quot;TEAM_ADMIN&quot;</span><span class="p p-Indicator">]</span>
        <span class="p p-Indicator">},</span>
        <span class="p p-Indicator">{</span>
            <span class=s>&quot;id&quot;</span><span class="p p-Indicator">:</span> <span class=s>&quot;Pirates&quot;</span><span class="p p-Indicator">,</span>
            <span class=s>&quot;roles&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class=s>&quot;TEAM_MEMBER&quot;</span><span class="p p-Indicator">]</span>
        <span class="p p-Indicator">},</span>
        <span class="p p-Indicator">{</span>
            <span class=s>&quot;id&quot;</span><span class="p p-Indicator">:</span> <span class=s>&quot;Continental&quot;</span><span class="p p-Indicator">,</span>
            <span class=s>&quot;roles&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class=s>&quot;TEAM_GUEST&quot;</span><span class="p p-Indicator">]</span>
        <span class="p p-Indicator">}</span>
        <span class="p p-Indicator">],</span>
        <span class=s>&quot;icon&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{</span>
            <span class=s>&quot;name&quot;</span><span class="p p-Indicator">:</span> <span class=s>&quot;hexagons&quot;</span><span class="p p-Indicator">,</span>
            <span class=s>&quot;color&quot;</span><span class="p p-Indicator">:</span> <span class=s>&quot;#8d7ec1&quot;</span>
        <span class="p p-Indicator">}</span>
    <span class="p p-Indicator">}</span>
<span class="p p-Indicator">}</span>
</pre></div> </td></tr></table> </details> <details class=example><summary>configure-oc-namespace.groovy</summary><p>This is a Jenkins Configuration or System Groovy script. It will change the <code class=codehilite><span class=n>namespace</span></code> Operation Center uses to create resources. You can change this in the UI by going to <code class=codehilite><span class=n>Operations</span> <span class=n>Center</span></code> -&gt; <code class=codehilite><span class=n>Manage</span> <span class=n>Jenkins</span></code> -&gt; <code class=codehilite><span class=k>System</span> <span class=n>Configuration</span></code> -&gt; <code class=codehilite><span class=n>Master</span> <span class=n>Provisioning</span></code> -&gt; <code class=codehilite><span class=k>Namespace</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>import</span> <span class=nn>hudson.*</span>
<span class=kn>import</span> <span class=nn>hudson.util.Secret</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>hudson.util.Scrambler</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>hudson.util.FormValidation</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>jenkins.*</span>
<span class=kn>import</span> <span class=nn>jenkins.model.*</span>
<span class=kn>import</span> <span class=nn>hudson.security.*</span>

<span class=kn>import</span> <span class=nn>com.cloudbees.masterprovisioning.kubernetes.KubernetesMasterProvisioning</span>
<span class=kn>import</span> <span class=nn>com.cloudbees.masterprovisioning.kubernetes.KubernetesClusterEndpoint</span>

<span class=n>println</span> <span class=s2>&quot;=== KubernetesMasterProvisioning Configuration - start&quot;</span>

<span class=n>println</span> <span class=s2>&quot;== Retrieving main configuration&quot;</span>
<span class=kt>def</span> <span class=n>descriptor</span> <span class=o>=</span> <span class=n>Jenkins</span><span class=o>.</span><span class=na>getInstance</span><span class=o>().</span><span class=na>getInjector</span><span class=o>().</span><span class=na>getInstance</span><span class=o>(</span><span class=n>KubernetesMasterProvisioning</span><span class=o>.</span><span class=na>DescriptorImpl</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
<span class=kt>def</span> <span class=n>namespace</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>args</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span>

<span class=kt>def</span> <span class=n>currentKubernetesClusterEndpoint</span> <span class=o>=</span>  <span class=n>descriptor</span><span class=o>.</span><span class=na>getClusterEndpoints</span><span class=o>().</span><span class=na>get</span><span class=o>(</span><span class=mi>0</span><span class=o>)</span>
<span class=n>println</span> <span class=s2>&quot;= Found current endpoint&quot;</span>
<span class=n>println</span> <span class=s2>&quot;= &quot;</span> <span class=o>+</span> <span class=n>currentKubernetesClusterEndpoint</span><span class=o>.</span><span class=na>toString</span><span class=o>()</span>
<span class=kt>def</span> <span class=n>id</span> <span class=o>=</span> <span class=n>currentKubernetesClusterEndpoint</span><span class=o>.</span><span class=na>getId</span><span class=o>()</span>
<span class=kt>def</span> <span class=n>name</span> <span class=o>=</span> <span class=n>currentKubernetesClusterEndpoint</span><span class=o>.</span><span class=na>getName</span><span class=o>()</span>
<span class=kt>def</span> <span class=n>url</span> <span class=o>=</span> <span class=n>currentKubernetesClusterEndpoint</span><span class=o>.</span><span class=na>getUrl</span><span class=o>()</span>
<span class=kt>def</span> <span class=n>credentialsId</span> <span class=o>=</span> <span class=n>currentKubernetesClusterEndpoint</span><span class=o>.</span><span class=na>getCredentialsId</span><span class=o>()</span>

<span class=n>println</span> <span class=s2>&quot;== Setting Namspace to &quot;</span> <span class=o>+</span> <span class=n>namespace</span>
<span class=kt>def</span> <span class=n>updatedKubernetesClusterEndpoint</span> <span class=o>=</span> <span class=k>new</span> <span class=n>KubernetesClusterEndpoint</span><span class=o>(</span><span class=n>id</span><span class=o>,</span> <span class=n>name</span><span class=o>,</span> <span class=n>url</span><span class=o>,</span> <span class=n>credentialsId</span><span class=o>,</span> <span class=n>namespace</span><span class=o>)</span>
<span class=kt>def</span> <span class=n>clusterEndpoints</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>KubernetesClusterEndpoint</span><span class=o>&gt;()</span>
<span class=n>clusterEndpoints</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>updatedKubernetesClusterEndpoint</span><span class=o>)</span>
<span class=n>descriptor</span><span class=o>.</span><span class=na>setClusterEndpoints</span><span class=o>(</span><span class=n>clusterEndpoints</span><span class=o>)</span>

<span class=n>println</span> <span class=s2>&quot;== Saving Jenkins configuration&quot;</span>
<span class=n>descriptor</span><span class=o>.</span><span class=na>save</span><span class=o>()</span>

<span class=n>println</span> <span class=s2>&quot;=== KubernetesMasterProvisioning Configuration - finish&quot;</span>
</pre></div> </td></tr></table> </details> <h2 id=configure-team-ops-master>Configure Team Ops Master<a class=headerlink href=#configure-team-ops-master title="Permanent link">&para;</a></h2> <p>Now that we've created the Operations Team Master (Team Ops), we can configure it. </p> <p>The Pipelines we need will require credentials, we describe them below. </p> <ul> <li><strong>githubtoken_token</strong>: GitHub API Token only, credentials type <code class=codehilite><span class=n>Secret</span> <span class=nb>Text</span></code> (for the PR pipeline)</li> <li><strong>githubtoken</strong>: GitHub username and API Token</li> <li><strong>jenkins-api</strong>: Username and API Token for Operations Center. Just like the one we used for Client Jar.</li> </ul> <p>We also need to have a Global Pipeline Library defined by the name <code class=codehilite><span class=n>github</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>joostvdg</span><span class=o>/</span><span class=n>jpl</span><span class=o>-</span><span class=n>core</span></code>. This, as the name suggests, should point to <code class=codehilite><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>github</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>joostvdg</span><span class=o>/</span><span class=n>jpl</span><span class=o>-</span><span class=n>core</span><span class=p>.</span><span class=n>git</span></code>.</p> <h2 id=create-gitops-pipeline>Create GitOps Pipeline<a class=headerlink href=#create-gitops-pipeline title="Permanent link">&para;</a></h2> <p>In total, we need two repositories and two or three Pipelines. You can either use my CLI Docker Image or roll your own. I will proceed as if you will create your own.</p> <ul> <li><strong>CLI Image Pipeline</strong>: this will create a CLI Docker Image that is used to talk to Operations Center via the Client Jar (CLI)</li> <li><strong>PR Pipeline</strong>: I like the idea of Self-Service, but in order to keep things in check, you might want to provide that via a PullRequest (PR) rather than a direct write to the Master branch. This is also Repository One, as I prefer having each pipeline in their own Repository, but you don't need to.</li> <li><strong>Main Pipeline</strong>: will trigger on a commit to the Master branch and create the new team. I'll even throw in a free <strong><em>manage your Team Recipes</em></strong> for free as well.</li> </ul> <h3 id=create-cli-image-pipeline>Create CLI Image Pipeline<a class=headerlink href=#create-cli-image-pipeline title="Permanent link">&para;</a></h3> <p>In a Kubernetes cluster, you should not build with Docker directly, use an in-cluster builder such as <a href=https://github.com/GoogleContainerTools/kaniko>Kaniko</a> or <a href=https://buildah.io/ >Buildah</a>. </p> <p>You can read more about the why and how <a href=/blogs/jenkins-pipeline-docker-alternatives/ >elsewhere on this site</a>.</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>If you do not want to create your own, you can re-use my images.</p> <p>There should be one available for every recent version of CloudBees Core that will work with your Operations Center. The images are available in DockerHub at <a href=https://cloud.docker.com/u/caladreas/repository/docker/caladreas/cbcore-cli>caladreas/cbcore-cli</a></p> </div> <h4 id=kaniko-configuration>Kaniko Configuration<a class=headerlink href=#kaniko-configuration title="Permanent link">&para;</a></h4> <p>Kaniko uses a Docker Image to build your Docker Image in cluster. It does however need to directly communicate to your Docker Registry. This requires a Kubernetes <code class=codehilite><span class=n>Secret</span></code> of type <code class=codehilite><span class=n>docker</span><span class=o>-</span><span class=n>registry</span></code>.</p> <p>How you can do this and more, you <a href=https://go.cloudbees.com/docs/cloudbees-core/cloud-install-guide/kubernetes-using-kaniko/ >can read on the CloudBees Core Docs</a>.</p> <h4 id=pipeline>Pipeline<a class=headerlink href=#pipeline title="Permanent link">&para;</a></h4> <p>Now that you have Kaniko configured, you can use this Pipeline to create your own CLI Images.</p> <div class="admonition caution"> <p class=admonition-title>Caution</p> <p>Make sure you replace the environment variables with values that make sense to you.</p> <ul> <li><em>CJOC_URL</em> internal url in Kubernets, usually <code class=codehilite><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>cjoc</span><span class=p>.</span><span class=o>&lt;</span><span class=n>namespace</span><span class=o>&gt;/</span><span class=n>cjoc</span></code></li> <li><em>REGISTRY</em> : index.docker.io = DockerHub</li> <li><em>REPO</em>: docker repository name</li> <li><em>IMAGE</em>: docker image name</li> </ul> </div> <details class=example><summary>Jenkinsfile</summary><p>Jenkins Declarative Pipeline for the CLI Image geberation.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>pipeline</span> <span class=o>{</span>
    <span class=n>agent</span> <span class=o>{</span>
        <span class=n>kubernetes</span> <span class=o>{</span>
        <span class=c1>//cloud &#39;kubernetes&#39;</span>
        <span class=n>label</span> <span class=s1>&#39;test&#39;</span>
        <span class=n>yaml</span> <span class=s2>&quot;&quot;&quot;</span>
<span class=s2>kind: Pod</span>
<span class=s2>metadata:</span>
<span class=s2>  name: test</span>
<span class=s2>spec:</span>
<span class=s2>  containers:</span>
<span class=s2>  - name: curl</span>
<span class=s2>    image: byrnedo/alpine-curl</span>
<span class=s2>    command:</span>
<span class=s2>    - cat</span>
<span class=s2>    tty: true</span>
<span class=s2>    resources:</span>
<span class=s2>      requests:</span>
<span class=s2>        memory: &quot;50Mi&quot;</span>
<span class=s2>        cpu: &quot;100m&quot;</span>
<span class=s2>      limits:</span>
<span class=s2>        memory: &quot;50Mi&quot;</span>
<span class=s2>        cpu: &quot;100m&quot;</span>
<span class=s2>  - name: kaniko</span>
<span class=s2>    image: gcr.io/kaniko-project/executor:debug</span>
<span class=s2>    imagePullPolicy: Always</span>
<span class=s2>    command:</span>
<span class=s2>    - /busybox/cat</span>
<span class=s2>    tty: true</span>
<span class=s2>    resources:</span>
<span class=s2>      requests:</span>
<span class=s2>        memory: &quot;50Mi&quot;</span>
<span class=s2>        cpu: &quot;100m&quot;</span>
<span class=s2>      limits:</span>
<span class=s2>        memory: &quot;50Mi&quot;</span>
<span class=s2>        cpu: &quot;100m&quot;</span>
<span class=s2>    volumeMounts:</span>
<span class=s2>      - name: jenkins-docker-cfg</span>
<span class=s2>        mountPath: /root</span>
<span class=s2>  volumes:</span>
<span class=s2>  - name: jenkins-docker-cfg</span>
<span class=s2>    projected:</span>
<span class=s2>      sources:</span>
<span class=s2>      - secret:</span>
<span class=s2>          name: docker-credentials</span>
<span class=s2>          items:</span>
<span class=s2>            - key: .dockerconfigjson</span>
<span class=s2>              path: .docker/config.json</span>
<span class=s2>&quot;&quot;&quot;</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=n>environment</span> <span class=o>{</span>
        <span class=n>CJOC_URL</span>    <span class=o>=</span> <span class=s1>&#39;http://cjoc.cloudbees-core/cjoc&#39;</span>
        <span class=n>CLI_VERSION</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
        <span class=n>REGISTRY</span>    <span class=o>=</span> <span class=s1>&#39;index.docker.io&#39;</span>
        <span class=n>REPO</span>        <span class=o>=</span> <span class=s1>&#39;caladreas&#39;</span>
        <span class=n>IMAGE</span>       <span class=o>=</span> <span class=s1>&#39;cbcore-cli&#39;</span>
    <span class=o>}</span>
    <span class=n>stages</span> <span class=o>{</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Download CLI&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>steps</span> <span class=o>{</span>
                <span class=n>container</span><span class=o>(</span><span class=s1>&#39;curl&#39;</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>sh</span> <span class=s1>&#39;curl --version&#39;</span>
                    <span class=n>sh</span> <span class=s1>&#39;echo ${CJOC_URL}/jnlpJars/jenkins-cli.jar&#39;</span>
                    <span class=n>sh</span> <span class=s1>&#39;curl ${CJOC_URL}/jnlpJars/jenkins-cli.jar --output jenkins-cli.jar&#39;</span>
                    <span class=n>sh</span> <span class=s1>&#39;ls -lath&#39;</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Prepare&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>parallel</span> <span class=o>{</span>
                <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Verify CLI&#39;</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>environment</span> <span class=o>{</span>
                        <span class=n>CREDS</span>   <span class=o>=</span> <span class=n>credentials</span><span class=o>(</span><span class=s1>&#39;jenkins-api&#39;</span><span class=o>)</span>
                        <span class=n>CLI</span>     <span class=o>=</span> <span class=s2>&quot;java -jar jenkins-cli.jar -noKeyAuth -s ${CJOC_URL} -auth&quot;</span>
                    <span class=o>}</span>
                    <span class=n>steps</span> <span class=o>{</span>
                        <span class=n>sh</span> <span class=s1>&#39;echo ${CLI}&#39;</span>
                        <span class=n>script</span> <span class=o>{</span>
                            <span class=n>CLI_VERSION</span> <span class=o>=</span> <span class=n>sh</span> <span class=nl>returnStdout:</span> <span class=kc>true</span><span class=o>,</span> <span class=nl>script:</span> <span class=s1>&#39;${CLI} ${CREDS} version&#39;</span>
                        <span class=o>}</span>
                        <span class=n>sh</span> <span class=s1>&#39;echo ${CLI_VERSION}&#39;</span>
                    <span class=o>}</span>
                <span class=o>}</span>
                <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Prepare Dockerfile&#39;</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>steps</span> <span class=o>{</span>
                        <span class=n>writeFile</span> <span class=nl>encoding:</span> <span class=s1>&#39;UTF-8&#39;</span><span class=o>,</span> <span class=nl>file:</span> <span class=s1>&#39;Dockerfile&#39;</span><span class=o>,</span> <span class=nl>text:</span> <span class=s2>&quot;&quot;&quot;FROM mcr.microsoft.com/java/jre-headless:8u192-zulu-alpine</span>
<span class=s2>WORKDIR /usr/bin</span>
<span class=s2>ADD jenkins-cli.jar .</span>
<span class=s2>RUN pwd</span>
<span class=s2>RUN ls -lath</span>
<span class=s2>&quot;&quot;&quot;</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Build with Kaniko&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>environment</span> <span class=o>{</span> 
                <span class=n>PATH</span> <span class=o>=</span> <span class=s2>&quot;/busybox:/kaniko:$PATH&quot;</span>
                <span class=n>TAG</span>  <span class=o>=</span> <span class=s2>&quot;${CLI_VERSION}&quot;</span>
            <span class=o>}</span>
            <span class=n>steps</span> <span class=o>{</span>
                <span class=n>sh</span> <span class=s1>&#39;echo image fqn=${REGISTRY}/${REPO}/${IMAGE}:${TAG}&#39;</span>
                <span class=n>container</span><span class=o>(</span><span class=nl>name:</span> <span class=s1>&#39;kaniko&#39;</span><span class=o>,</span> <span class=nl>shell:</span> <span class=s1>&#39;/busybox/sh&#39;</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>sh</span> <span class=s1>&#39;&#39;&#39;#!/busybox/sh</span>
<span class=s1>                    /kaniko/executor -f `pwd`/Dockerfile -c `pwd` --cleanup --cache=true --destination=${REGISTRY}/${REPO}/${IMAGE}:${TAG}</span>
<span class=s1>                    /kaniko/executor -f `pwd`/Dockerfile -c `pwd` --cleanup --cache=true --destination=${REGISTRY}/${REPO}/${IMAGE}:latest</span>
<span class=s1>                    &#39;&#39;&#39;</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div> </td></tr></table> </details> <h3 id=pr-pipeline>PR Pipeline<a class=headerlink href=#pr-pipeline title="Permanent link">&para;</a></h3> <div class="admonition caution"> <p class=admonition-title>Caution</p> <p>The PR Pipeline example builds upon the GitHub API, if you're not using GItHub, you will have to figure out another way to make the PR.</p> </div> <h4 id=tools-used>Tools Used<a class=headerlink href=#tools-used title="Permanent link">&para;</a></h4> <ul> <li><a href=https://github.com/mikefarah/yq>yq</a>: commandline tool for processing Yaml files</li> <li><a href=https://stedolan.github.io/jq/ >jq</a> commandline tool for pressing Json files </li> <li><a href=https://kustomize.io>Kustomize</a> templating tool for Kubernetes Yaml, as of Kubernetes <code class=codehilite><span class=mi>1</span><span class=p>.</span><span class=mi>13</span></code>, this is part of the Client (note, your server can be older, don't worry!)</li> <li><a href=https://github.com/github/hub>Hub</a> commandline client for GitHub</li> </ul> <h4 id=repository-layout>Repository Layout<a class=headerlink href=#repository-layout title="Permanent link">&para;</a></h4> <ul> <li>folder: <code class=codehilite><span class=n>team</span><span class=o>-</span><span class=n>master</span><span class=o>-</span><span class=k>template</span></code><ul> <li>with file <code class=codehilite><span class=k>simple</span><span class=p>.</span><span class=n>json</span></code></li> </ul> </li> <li>folder: <code class=codehilite><span class=n>namespace</span><span class=o>-</span><span class=n>creation</span></code><ul> <li>with folder: <code class=codehilite><span class=n>kustomize</span></code> this contains the <a href=https://kustomize.io/ >Kustomize</a> configuration</li> </ul> </li> </ul> <details class=example><summary>Simple.json</summary><p>This is a template for the team JSON definition.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=p>{</span>
    <span class=nt>&quot;version&quot;</span> <span class=p>:</span> <span class=s2>&quot;1&quot;</span><span class=p>,</span>
    <span class=nt>&quot;data&quot;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;NAME&quot;</span><span class=p>,</span>
        <span class=nt>&quot;displayName&quot;</span><span class=p>:</span> <span class=s2>&quot;DISPLAY_NAME&quot;</span><span class=p>,</span>
        <span class=nt>&quot;provisioningRecipe&quot;</span><span class=p>:</span> <span class=s2>&quot;RECIPE&quot;</span><span class=p>,</span>
        <span class=nt>&quot;members&quot;</span><span class=p>:</span> <span class=p>[</span>
            <span class=p>{</span>
                <span class=nt>&quot;id&quot;</span><span class=p>:</span> <span class=s2>&quot;ADMINS&quot;</span><span class=p>,</span>
                <span class=nt>&quot;roles&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;TEAM_ADMIN&quot;</span><span class=p>]</span>
            <span class=p>},</span>
            <span class=p>{</span>
                <span class=nt>&quot;id&quot;</span><span class=p>:</span> <span class=s2>&quot;MEMBERS&quot;</span><span class=p>,</span>
                <span class=nt>&quot;roles&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;TEAM_MEMBER&quot;</span><span class=p>]</span>
            <span class=p>},</span>
            <span class=p>{</span>
                <span class=nt>&quot;id&quot;</span><span class=p>:</span> <span class=s2>&quot;GUESTS&quot;</span><span class=p>,</span>
                <span class=nt>&quot;roles&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;TEAM_GUEST&quot;</span><span class=p>]</span>
            <span class=p>}</span>
        <span class=p>],</span>
        <span class=nt>&quot;icon&quot;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;ICON&quot;</span><span class=p>,</span>
            <span class=nt>&quot;color&quot;</span><span class=p>:</span> <span class=s2>&quot;HEX_COLOR&quot;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre></div> </td></tr></table> </details> <h4 id=kustomize-configuration>Kustomize Configuration<a class=headerlink href=#kustomize-configuration title="Permanent link">&para;</a></h4> <p>Kustomize is a tool for template Kubernetes YAML definitions, which is what we need here. However, only for the <code class=codehilite><span class=n>namespace</span></code> creation &amp; configuration. So if you don't want to do that, you can skip this.</p> <p>The Kustomize configuration has two parts, a folder called <code class=codehilite><span class=n>team</span><span class=o>-</span><span class=n>example</span></code> with a <code class=codehilite><span class=n>kustomization</span><span class=p>.</span><span class=n>yaml</span></code>. This will be what we configure to generate a new yaml definition. The main template is in the folder <code class=codehilite><span class=n>base</span></code>, where the entrypoint will be again <code class=codehilite><span class=n>kustomization</span><span class=p>.</span><span class=n>yaml</span></code>. This time, the <code class=codehilite><span class=n>kustomization</span><span class=p>.</span><span class=n>yaml</span></code> will link to all the template files we need.</p> <p>As posting all these yaml files again is a bit much, I'll link to my example repo. Feel free to fork it instead: <a href=https://github.com/joostvdg/cb-team-gitops-template>cb-team-gitops-template</a></p> <ul> <li><a href=https://github.com/joostvdg/cb-team-gitops-template/blob/master/namespace-creation/kustomize/base/configmap.yaml>configmap.yaml</a>: the Jenkins Agent ConfigMap</li> <li><a href=https://github.com/joostvdg/cb-team-gitops-template/blob/master/namespace-creation/kustomize/base/namespace.yaml>namespace.yaml</a>: the new namespace</li> <li><a href=https://github.com/joostvdg/cb-team-gitops-template/blob/master/namespace-creation/kustomize/base/resource-quota.yaml>resource-quota.yaml</a>: resource quota's for the namespace</li> <li><a href=https://github.com/joostvdg/cb-team-gitops-template/blob/master/namespace-creation/kustomize/base/role-binding-cjoc.yaml>role-binding-cjoc.yaml</a>: a role binding for the CJOC ServiceAccount, so it create create the new Master in the new <code class=codehilite><span class=n>namespace</span></code></li> <li><a href=https://github.com/joostvdg/cb-team-gitops-template/blob/master/namespace-creation/kustomize/base/role-binding.yaml>role-binding.yaml</a>: the role binding for the <code class=codehilite><span class=n>jenkins</span></code> ServiceAccount, which allows the new Master to create and manage Pods (for PodTemplates)</li> <li><a href=https://github.com/joostvdg/cb-team-gitops-template/blob/master/namespace-creation/kustomize/base/role-cjoc.yaml>role-cjoc.yaml</a>: the role for CJOC for the ability to create a Master in the new Namspace</li> <li><a href=https://github.com/joostvdg/cb-team-gitops-template/blob/master/namespace-creation/kustomize/base/role.yaml>role.yaml</a>: the role for the <code class=codehilite><span class=n>jenkins</span></code> ServiceAccount for the new Master</li> <li><a href=https://github.com/joostvdg/cb-team-gitops-template/blob/master/namespace-creation/kustomize/base/service-account.yaml>service-account.yaml</a>: the ServiceAccount, <code class=codehilite><span class=n>jenkins</span></code>, used by the new Master</li> </ul> <h4 id=pipeline_1>Pipeline<a class=headerlink href=#pipeline_1 title="Permanent link">&para;</a></h4> <p>The Pipeline will do the following:</p> <ul> <li>capture input parameters to be used to customize the Team Master</li> <li>update the Kustomize template to make sure every resource is correct for the new namespace (<code class=codehilite><span class=n>teams</span><span class=o>-&lt;</span><span class=n>name</span> <span class=k>of</span> <span class=n>team</span><span class=o>&gt;</span></code>)</li> <li>execute Kustomize to generate a single <code class=codehilite><span class=n>yaml</span></code> file that defines the configuration for the new Team Masters' namespace</li> <li>process the <code class=codehilite><span class=k>simple</span><span class=p>.</span><span class=n>json</span></code> to generate a <code class=codehilite><span class=n>team</span><span class=p>.</span><span class=n>json</span></code> file for the new Team Master for use with the Jenkins CLI</li> <li>checkout your GIT_REPO that contains your team definitions</li> <li>create a new PR to your GIT_REPO for the new team</li> </ul> <details class=example><summary>Jenkinsfile</summary><p>Variables to update:</p> <ul> <li><strong>GIT_REPO</strong>: the GitHub repository in which the Team Definitions are stored</li> <li><strong>RESET_NAMESPACE</strong>: the namespace Operations Center should use as default</li> </ul> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218</pre></div></td><td class=code><div class=codehilite><pre><span></span>  <span class=n>pipeline</span> <span class=o>{</span>
      <span class=n>agent</span> <span class=o>{</span>
          <span class=n>kubernetes</span> <span class=o>{</span>
          <span class=n>label</span> <span class=s1>&#39;team-automation&#39;</span>
          <span class=n>yaml</span> <span class=s2>&quot;&quot;&quot;</span>
<span class=s2>  kind: Pod</span>
<span class=s2>  spec:</span>
<span class=s2>    containers:</span>
<span class=s2>    - name: hub</span>
<span class=s2>      image:  caladreas/hub</span>
<span class=s2>      command: [&quot;cat&quot;]</span>
<span class=s2>      tty: true</span>
<span class=s2>      resources:</span>
<span class=s2>        requests:</span>
<span class=s2>          memory: &quot;50Mi&quot;</span>
<span class=s2>          cpu: &quot;150m&quot;</span>
<span class=s2>        limits:</span>
<span class=s2>          memory: &quot;50Mi&quot;</span>
<span class=s2>          cpu: &quot;150m&quot;</span>
<span class=s2>    - name: kubectl</span>
<span class=s2>      image: bitnami/kubectl:latest</span>
<span class=s2>      command: [&quot;cat&quot;]</span>
<span class=s2>      tty: true</span>
<span class=s2>      securityContext:</span>
<span class=s2>        runAsUser: 1000</span>
<span class=s2>        fsGroup: 1000</span>
<span class=s2>      resources:</span>
<span class=s2>        requests:</span>
<span class=s2>          memory: &quot;50Mi&quot;</span>
<span class=s2>          cpu: &quot;100m&quot;</span>
<span class=s2>        limits:</span>
<span class=s2>          memory: &quot;150Mi&quot;</span>
<span class=s2>          cpu: &quot;200m&quot;</span>
<span class=s2>    - name: yq</span>
<span class=s2>      image: mikefarah/yq</span>
<span class=s2>      command: [&#39;cat&#39;]</span>
<span class=s2>      tty: true</span>
<span class=s2>      resources:</span>
<span class=s2>        requests:</span>
<span class=s2>          memory: &quot;50Mi&quot;</span>
<span class=s2>          cpu: &quot;100m&quot;</span>
<span class=s2>        limits:</span>
<span class=s2>          memory: &quot;50Mi&quot;</span>
<span class=s2>          cpu: &quot;100m&quot;</span>
<span class=s2>    - name: jq</span>
<span class=s2>      image: colstrom/jq</span>
<span class=s2>      command: [&#39;cat&#39;]</span>
<span class=s2>      tty: true</span>
<span class=s2>      resources:</span>
<span class=s2>        requests:</span>
<span class=s2>          memory: &quot;50Mi&quot;</span>
<span class=s2>          cpu: &quot;100m&quot;</span>
<span class=s2>        limits:</span>
<span class=s2>          memory: &quot;50Mi&quot;</span>
<span class=s2>          cpu: &quot;100m&quot;</span>

<span class=s2>  &quot;&quot;&quot;</span>
          <span class=o>}</span>
      <span class=o>}</span>
      <span class=n>libraries</span> <span class=o>{</span>
          <span class=n>lib</span><span class=o>(</span><span class=s1>&#39;github.com/joostvdg/jpl-core&#39;</span><span class=o>)</span>
      <span class=o>}</span>
      <span class=n>options</span> <span class=o>{</span>
          <span class=n>disableConcurrentBuilds</span><span class=o>()</span> <span class=c1>// we don&#39;t want more than one at a time</span>
          <span class=n>checkoutToSubdirectory</span> <span class=s1>&#39;templates&#39;</span> <span class=c1>// we need to do two checkouts</span>
          <span class=n>buildDiscarder</span> <span class=nf>logRotator</span><span class=o>(</span><span class=nl>artifactDaysToKeepStr:</span> <span class=s1>&#39;&#39;</span><span class=o>,</span> <span class=nl>artifactNumToKeepStr:</span> <span class=s1>&#39;&#39;</span><span class=o>,</span> <span class=nl>daysToKeepStr:</span> <span class=s1>&#39;5&#39;</span><span class=o>,</span> <span class=nl>numToKeepStr:</span> <span class=s1>&#39;5&#39;</span><span class=o>)</span> <span class=c1>// always clean up</span>
      <span class=o>}</span>
      <span class=n>environment</span> <span class=o>{</span>
          <span class=n>envGitInfo</span>          <span class=o>=</span> <span class=s1>&#39;&#39;</span>
          <span class=n>RESET_NAMESPACE</span>     <span class=o>=</span> <span class=s1>&#39;jx-production&#39;</span>
          <span class=n>TEAM_BASE_NAME</span>      <span class=o>=</span> <span class=s1>&#39;&#39;</span>
          <span class=n>NAMESPACE_TO_CREATE</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
          <span class=n>DISPLAY_NAME</span>        <span class=o>=</span> <span class=s1>&#39;&#39;</span>
          <span class=n>TEAM_RECIPE</span>         <span class=o>=</span> <span class=s1>&#39;&#39;</span>
          <span class=n>ICON</span>                <span class=o>=</span> <span class=s1>&#39;&#39;</span>
          <span class=n>ICON_COLOR_CODE</span>     <span class=o>=</span> <span class=s1>&#39;&#39;</span>
          <span class=n>ADMINS_ROLE</span>         <span class=o>=</span> <span class=s1>&#39;&#39;</span>
          <span class=n>MEMBERS_ROLE</span>        <span class=o>=</span> <span class=s1>&#39;&#39;</span>
          <span class=n>GUESTS_ROLE</span>         <span class=o>=</span> <span class=s1>&#39;&#39;</span>
          <span class=n>RECORD_LOC</span>          <span class=o>=</span> <span class=s1>&#39;&#39;</span>
          <span class=n>GIT_REPO</span>                 <span class=o>=</span> <span class=s1>&#39;&#39;</span>
      <span class=o>}</span>
      <span class=n>stages</span> <span class=o>{</span>
          <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Team Details&#39;</span><span class=o>)</span> <span class=o>{</span>
              <span class=n>input</span> <span class=o>{</span>
                  <span class=n>message</span> <span class=s2>&quot;Please enter the team details.&quot;</span>
                  <span class=n>ok</span> <span class=s2>&quot;Looks good, proceed&quot;</span>
                  <span class=n>parameters</span> <span class=o>{</span>
                      <span class=n>string</span><span class=o>(</span><span class=nl>name:</span> <span class=s1>&#39;Name&#39;</span><span class=o>,</span> <span class=nl>defaultValue:</span> <span class=s1>&#39;hex&#39;</span><span class=o>,</span> <span class=nl>description:</span> <span class=s1>&#39;Please specify a team name&#39;</span><span class=o>)</span>
                      <span class=n>string</span><span class=o>(</span><span class=nl>name:</span> <span class=s1>&#39;DisplayName&#39;</span><span class=o>,</span> <span class=nl>defaultValue:</span> <span class=s1>&#39;Hex&#39;</span><span class=o>,</span> <span class=nl>description:</span> <span class=s1>&#39;Please specify a team display name&#39;</span><span class=o>)</span>
                      <span class=n>choice</span> <span class=nl>choices:</span> <span class=o>[</span><span class=s1>&#39;joostvdg&#39;</span><span class=o>,</span> <span class=s1>&#39;basic&#39;</span><span class=o>,</span> <span class=s1>&#39;java-web&#39;</span><span class=o>],</span> <span class=nl>description:</span> <span class=s1>&#39;Please select a Team Recipe&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;TeamRecipe&#39;</span>
                      <span class=n>choice</span> <span class=nl>choices:</span> <span class=o>[</span><span class=s1>&#39;anchor&#39;</span><span class=o>,</span> <span class=s1>&#39;bear&#39;</span><span class=o>,</span> <span class=s1>&#39;bowler-hat&#39;</span><span class=o>,</span> <span class=s1>&#39;briefcase&#39;</span><span class=o>,</span> <span class=s1>&#39;bug&#39;</span><span class=o>,</span> <span class=s1>&#39;calculator&#39;</span><span class=o>,</span> <span class=s1>&#39;calculatorcart&#39;</span><span class=o>,</span> <span class=s1>&#39;clock&#39;</span><span class=o>,</span> <span class=s1>&#39;cloud&#39;</span><span class=o>,</span> <span class=s1>&#39;cloudbees&#39;</span><span class=o>,</span> <span class=s1>&#39;connect&#39;</span><span class=o>,</span> <span class=s1>&#39;dollar-bill&#39;</span><span class=o>,</span> <span class=s1>&#39;dollar-symbol&#39;</span><span class=o>,</span> <span class=s1>&#39;file&#39;</span><span class=o>,</span> <span class=s1>&#39;flag&#39;</span><span class=o>,</span> <span class=s1>&#39;flower-carnation&#39;</span><span class=o>,</span> <span class=s1>&#39;flower-daisy&#39;</span><span class=o>,</span> <span class=s1>&#39;help&#39;</span><span class=o>,</span> <span class=s1>&#39;hexagon&#39;</span><span class=o>,</span> <span class=s1>&#39;high-heels&#39;</span><span class=o>,</span> <span class=s1>&#39;jenkins&#39;</span><span class=o>,</span> <span class=s1>&#39;key&#39;</span><span class=o>,</span> <span class=s1>&#39;marker&#39;</span><span class=o>,</span> <span class=s1>&#39;monocle&#39;</span><span class=o>,</span> <span class=s1>&#39;mustache&#39;</span><span class=o>,</span> <span class=s1>&#39;office&#39;</span><span class=o>,</span> <span class=s1>&#39;panther&#39;</span><span class=o>,</span> <span class=s1>&#39;paw-print&#39;</span><span class=o>,</span> <span class=s1>&#39;teacup&#39;</span><span class=o>,</span> <span class=s1>&#39;tiger&#39;</span><span class=o>,</span> <span class=s1>&#39;truck&#39;</span><span class=o>],</span> <span class=nl>description:</span> <span class=s1>&#39;Please select an Icon&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;Icon&#39;</span>
                      <span class=n>string</span><span class=o>(</span><span class=nl>name:</span> <span class=s1>&#39;IconColorCode&#39;</span><span class=o>,</span> <span class=nl>defaultValue:</span> <span class=s1>&#39;#CCCCCC&#39;</span><span class=o>,</span> <span class=nl>description:</span> <span class=s1>&#39;Please specify a valid html hexcode for the color (https://htmlcolorcodes.com/)&#39;</span><span class=o>)</span>
                      <span class=n>string</span><span class=o>(</span><span class=nl>name:</span> <span class=s1>&#39;Admins&#39;</span><span class=o>,</span> <span class=nl>defaultValue:</span> <span class=s1>&#39;Catmins&#39;</span><span class=o>,</span> <span class=nl>description:</span> <span class=s1>&#39;Please specify a groupid or userid for the TEAM_ADMIN role&#39;</span><span class=o>)</span>
                      <span class=n>string</span><span class=o>(</span><span class=nl>name:</span> <span class=s1>&#39;Members&#39;</span><span class=o>,</span> <span class=nl>defaultValue:</span> <span class=s1>&#39;Pirates&#39;</span><span class=o>,</span> <span class=nl>description:</span> <span class=s1>&#39;Please specify a groupid or userid for the TEAM_MEMBER role&#39;</span><span class=o>)</span>
                      <span class=n>string</span><span class=o>(</span><span class=nl>name:</span> <span class=s1>&#39;Guests&#39;</span><span class=o>,</span> <span class=nl>defaultValue:</span> <span class=s1>&#39;Continental&#39;</span><span class=o>,</span> <span class=nl>description:</span> <span class=s1>&#39;Please specify a groupid or userid for the TEAM_GUEST role&#39;</span><span class=o>)</span>
                  <span class=o>}</span>
              <span class=o>}</span>
              <span class=n>steps</span> <span class=o>{</span>
                  <span class=n>println</span> <span class=s2>&quot;Name=${Name}&quot;</span>
                  <span class=n>println</span> <span class=s2>&quot;DisplayName=${DisplayName}&quot;</span>
                  <span class=n>println</span> <span class=s2>&quot;TeamRecipe=${TeamRecipe}&quot;</span>
                  <span class=n>println</span> <span class=s2>&quot;Icon=${Icon}&quot;</span>
                  <span class=n>println</span> <span class=s2>&quot;IconColorCode=${IconColorCode}&quot;</span>
                  <span class=n>println</span> <span class=s2>&quot;Admins=${Admins}&quot;</span>
                  <span class=n>println</span> <span class=s2>&quot;Members=${Members}&quot;</span>
                  <span class=n>println</span> <span class=s2>&quot;Guests=${Guests}&quot;</span>
                  <span class=n>script</span> <span class=o>{</span>
                      <span class=n>TEAM_BASE_NAME</span>      <span class=o>=</span> <span class=s2>&quot;${Name}&quot;</span>
                      <span class=n>NAMESPACE_TO_CREATE</span> <span class=o>=</span> <span class=s2>&quot;cb-teams-${Name}&quot;</span>
                      <span class=n>DISPLAY_NAME</span>        <span class=o>=</span> <span class=s2>&quot;${DisplayName}&quot;</span>
                      <span class=n>TEAM_RECIPE</span>         <span class=o>=</span> <span class=s2>&quot;${TeamRecipe}&quot;</span>
                      <span class=n>ICON</span>                <span class=o>=</span> <span class=s2>&quot;${Icon}&quot;</span>
                      <span class=n>ICON_COLOR_CODE</span>     <span class=o>=</span> <span class=s2>&quot;${IconColorCode}&quot;</span>
                      <span class=n>ADMINS_ROLE</span>         <span class=o>=</span> <span class=s2>&quot;${Admins}&quot;</span>
                      <span class=n>MEMBERS_ROLE</span>        <span class=o>=</span> <span class=s2>&quot;${Members}&quot;</span>
                      <span class=n>GUESTS_ROLE</span>         <span class=o>=</span> <span class=s2>&quot;${Guests}&quot;</span>
                      <span class=n>RECORD_LOC</span>          <span class=o>=</span> <span class=s2>&quot;templates/teams/${Name}&quot;</span>
                      <span class=n>sh</span> <span class=s2>&quot;mkdir -p ${RECORD_LOC}&quot;</span>
                  <span class=o>}</span>
              <span class=o>}</span>
          <span class=o>}</span>
          <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Create Team Config&#39;</span><span class=o>)</span> <span class=o>{</span>
              <span class=n>environment</span> <span class=o>{</span>
                  <span class=n>BASE</span>        <span class=o>=</span> <span class=s1>&#39;templates/namespace-creation/kustomize&#39;</span>
                  <span class=n>NAMESPACE</span>   <span class=o>=</span> <span class=s2>&quot;${NAMESPACE_TO_CREATE}&quot;</span>
                  <span class=n>RECORD_LOC</span>  <span class=o>=</span> <span class=s2>&quot;templates/teams/${TEAM_BASE_NAME}&quot;</span>
              <span class=o>}</span>
              <span class=n>parallel</span> <span class=o>{</span>
                  <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Namespace&#39;</span><span class=o>)</span> <span class=o>{</span>
                      <span class=n>steps</span> <span class=o>{</span>
                          <span class=n>container</span><span class=o>(</span><span class=s1>&#39;yq&#39;</span><span class=o>)</span> <span class=o>{</span>
                              <span class=n>sh</span> <span class=s1>&#39;yq w -i ${BASE}/base/role-binding.yaml subjects[0].namespace ${NAMESPACE}&#39;</span>
                              <span class=n>sh</span> <span class=s1>&#39;yq w -i ${BASE}/base/namespace.yaml metadata.name ${NAMESPACE}&#39;</span>
                              <span class=n>sh</span> <span class=s1>&#39;yq w -i ${BASE}/team-example/kustomization.yaml namespace ${NAMESPACE}&#39;</span>
                          <span class=o>}</span>
                          <span class=n>container</span><span class=o>(</span><span class=s1>&#39;kubectl&#39;</span><span class=o>)</span> <span class=o>{</span>
                              <span class=n>sh</span> <span class=s1>&#39;&#39;&#39;</span>
<span class=s1>                                  kubectl kustomize ${BASE}/team-example &gt; ${RECORD_LOC}/team.yaml</span>
<span class=s1>                                  cat ${RECORD_LOC}/team.yaml</span>
<span class=s1>                              &#39;&#39;&#39;</span>
                          <span class=o>}</span>
                      <span class=o>}</span>
                  <span class=o>}</span>
                  <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Team Master JSON&#39;</span><span class=o>)</span> <span class=o>{</span>
                      <span class=n>steps</span> <span class=o>{</span>
                          <span class=n>container</span><span class=o>(</span><span class=s1>&#39;jq&#39;</span><span class=o>)</span> <span class=o>{</span>
                              <span class=n>sh</span> <span class=s2>&quot;&quot;&quot;jq \</span>
<span class=s2>                              &#39;.data.name = &quot;${TEAM_BASE_NAME}&quot; |\</span>
<span class=s2>                              .data.displayName = &quot;${DISPLAY_NAME}&quot; |\</span>
<span class=s2>                              .data.provisioningRecipe = &quot;${TEAM_RECIPE}&quot; |\</span>
<span class=s2>                              .data.icon.name = &quot;${ICON}&quot; |\</span>
<span class=s2>                              .data.icon.color = &quot;${ICON_COLOR_CODE}&quot; |\</span>
<span class=s2>                              .data.members[0].id = &quot;${ADMINS_ROLE}&quot; |\</span>
<span class=s2>                              .data.members[1].id = &quot;${MEMBERS_ROLE}&quot; |\</span>
<span class=s2>                              .data.members[2].id = &quot;${GUESTS_ROLE}&quot;&#39;\</span>
<span class=s2>                              templates/team-master-template/simple.json &gt; ${RECORD_LOC}/team.json</span>
<span class=s2>                              &quot;&quot;&quot;</span>
                          <span class=o>}</span>
                          <span class=n>sh</span> <span class=s1>&#39;cat ${RECORD_LOC}/team.json&#39;</span>
                      <span class=o>}</span>
                  <span class=o>}</span>
              <span class=o>}</span>
          <span class=o>}</span>
          <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Create PR&#39;</span><span class=o>)</span> <span class=o>{</span>
              <span class=n>when</span> <span class=o>{</span> <span class=n>branch</span> <span class=s1>&#39;master&#39;</span><span class=o>}</span>
              <span class=n>environment</span> <span class=o>{</span>
                  <span class=n>RECORD_OLD_LOC</span>  <span class=o>=</span> <span class=s2>&quot;templates/teams/${TEAM_BASE_NAME}&quot;</span>
                  <span class=n>RECORD_LOC</span>      <span class=o>=</span> <span class=s2>&quot;teams/${TEAM_BASE_NAME}&quot;</span>
                  <span class=n>PR_CHANGE_NAME</span>  <span class=o>=</span> <span class=s2>&quot;add_team_${TEAM_BASE_NAME}&quot;</span>
              <span class=o>}</span>
              <span class=n>steps</span> <span class=o>{</span>
                  <span class=n>container</span><span class=o>(</span><span class=s1>&#39;hub&#39;</span><span class=o>)</span> <span class=o>{</span>
                      <span class=n>dir</span><span class=o>(</span><span class=s1>&#39;cb-team-gitops&#39;</span><span class=o>)</span> <span class=o>{</span>
                          <span class=n>script</span> <span class=o>{</span>
                              <span class=n>envGitInfo</span> <span class=o>=</span> <span class=n>git</span> <span class=s2>&quot;${GIT_REPO}&quot;</span>
                          <span class=o>}</span>
                          <span class=n>sh</span> <span class=s1>&#39;git checkout -b ${PR_CHANGE_NAME}&#39;</span>
                          <span class=n>sh</span> <span class=s1>&#39;ls -lath ../${RECORD_OLD_LOC}&#39;</span>
                          <span class=n>sh</span> <span class=s1>&#39;cp -R ../${RECORD_OLD_LOC} ./teams&#39;</span>
                          <span class=n>sh</span> <span class=s1>&#39;ls -lath&#39;</span>
                          <span class=n>sh</span> <span class=s1>&#39;ls -lath teams/&#39;</span>

                          <span class=n>gitRemoteConfigByUrl</span><span class=o>(</span><span class=n>envGitInfo</span><span class=o>.</span><span class=na>GIT_URL</span><span class=o>,</span> <span class=s1>&#39;githubtoken_token&#39;</span><span class=o>)</span> <span class=c1>// must be a API Token ONLY -&gt; secret text</span>
                          <span class=n>sh</span> <span class=s1>&#39;&#39;&#39;</span>
<span class=s1>                          git config --global user.email &quot;jenkins@jenkins.io&quot;</span>
<span class=s1>                          git config --global user.name &quot;Jenkins&quot;</span>
<span class=s1>                          git add ${RECORD_LOC}</span>
<span class=s1>                          git status</span>
<span class=s1>                          git commit -m &quot;add team ${TEAM_BASE_NAME}&quot;</span>
<span class=s1>                          git push origin ${PR_CHANGE_NAME}</span>
<span class=s1>                          &#39;&#39;&#39;</span>


                          <span class=c1>// has to be indented like that, else the indents will be in the pr description</span>
                          <span class=n>writeFile</span> <span class=nl>encoding:</span> <span class=s1>&#39;UTF-8&#39;</span><span class=o>,</span> <span class=nl>file:</span> <span class=s1>&#39;pr-info.md&#39;</span><span class=o>,</span> <span class=nl>text:</span> <span class=s2>&quot;&quot;&quot;Add ${TEAM_BASE_NAME}</span>
<span class=s2>  \n</span>
<span class=s2>  This pr is automatically generated via CloudBees.\\n</span>
<span class=s2>  \n</span>
<span class=s2>  The job: ${env.JOB_URL}</span>
<span class=s2>                      &quot;&quot;&quot;</span>

                          <span class=c1>// TODO: unfortunately, environment {}&#39;s credentials have fixed environment variable names</span>
                          <span class=c1>// TODO: in this case, they need to be EXACTLY GITHUB_PASSWORD and GITHUB_USER</span>
                          <span class=n>script</span> <span class=o>{</span>
                              <span class=n>withCredentials</span><span class=o>([</span><span class=n>usernamePassword</span><span class=o>(</span><span class=nl>credentialsId:</span> <span class=s1>&#39;githubtoken&#39;</span><span class=o>,</span> <span class=nl>passwordVariable:</span> <span class=s1>&#39;GITHUB_PASSWORD&#39;</span><span class=o>,</span> <span class=nl>usernameVariable:</span> <span class=s1>&#39;GITHUB_USER&#39;</span><span class=o>)])</span> <span class=o>{</span>
                                  <span class=n>sh</span> <span class=s2>&quot;&quot;&quot;</span>
<span class=s2>                                  set +x</span>
<span class=s2>                                  hub pull-request --force -F pr-info.md -l &#39;${TEAM_BASE_NAME}&#39; --no-edit</span>
<span class=s2>                                  &quot;&quot;&quot;</span>
                              <span class=o>}</span>
                          <span class=o>}</span>
                      <span class=o>}</span>
                  <span class=o>}</span>
              <span class=o>}</span>
          <span class=o>}</span>
      <span class=o>}</span>
  <span class=o>}</span>
</pre></div> </td></tr></table> </details> <h3 id=main-pipeline>Main Pipeline<a class=headerlink href=#main-pipeline title="Permanent link">&para;</a></h3> <p>The main Pipeline should be part of a repository. The Repository should look like this:</p> <ul> <li><code class=codehilite><span class=n>recipes</span></code> (folder)<ul> <li><code class=codehilite><span class=n>recipes</span><span class=p>.</span><span class=n>json</span></code> -&gt; current complete list of CloudBees Core Team Recipes definition</li> </ul> </li> <li><code class=codehilite><span class=n>teams</span></code> (folder)<ul> <li>folder per team<ul> <li><code class=codehilite><span class=n>team</span><span class=p>.</span><span class=n>json</span></code> -&gt; CloudBees Core Team definition</li> <li><code class=codehilite><span class=n>team</span><span class=p>.</span><span class=n>yaml</span></code> -&gt; Kubernetes YAML definition of the <code class=codehilite><span class=n>namespace</span></code> and all its resources</li> </ul> </li> </ul> </li> </ul> <h4 id=process>Process<a class=headerlink href=#process title="Permanent link">&para;</a></h4> <p>The pipeline can be a bit hard to grasp, so let me break it down into individual steps.</p> <p>We have the following stages:</p> <ul> <li><code class=codehilite><span class=k>Create</span> <span class=n>Team</span></code> - which is broken into sub-stages via the <a href=https://jenkins.io/blog/2018/07/02/whats-new-declarative-piepline-13x-sequential-stages/ >sequential stages feature</a>. * <code class=codehilite><span class=n>Parse</span> <span class=n>Changelog</span></code> * <code class=codehilite><span class=k>Create</span> <span class=n>Namespace</span></code> * <code class=codehilite><span class=n>Change</span> <span class=n>OC</span> <span class=n>Namespace</span></code> * <code class=codehilite><span class=k>Create</span> <span class=n>Team</span> <span class=n>Master</span></code></li> <li><code class=codehilite><span class=n>Test</span> <span class=n>CLI</span> <span class=k>Connection</span></code></li> <li><code class=codehilite><span class=k>Update</span> <span class=n>Team</span> <span class=n>Recipes</span></code></li> </ul> <h4 id=notable-statements>Notable Statements<a class=headerlink href=#notable-statements title="Permanent link">&para;</a></h4> <details class=example><summary>disableConcurrentBuilds</summary><p>We change the <code class=codehilite><span class=n>namespace</span></code> of Operation Center to a different value only for the duration of creating this master. This is something that should probably be part of the Team Master creation, but as it is a single configuration option for all that Operation Center does, we need to be careful. By ensuring we only run one build concurrently, we reduce the risk of this blowing up in our face.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>options</span> <span class=o>{</span>
    <span class=n>disableConcurrentBuilds</span><span class=o>()</span>
<span class=o>}</span>
</pre></div> </td></tr></table> </details> <details class=example><summary>when { }</summary><p>The <a href=https://jenkins.io/doc/book/pipeline/syntax/#when>When Directive</a> allows us to creating effective conditions for when a stage should be executed.</p> <p>The snippet below shows the use of a combination of both the <code class=codehilite><span class=n>branch</span></code> and <code class=codehilite><span class=n>changeset</span></code> built-in filters. <code class=codehilite><span class=n>changeset</span></code> looks at the commit being build and validates that there was a change in that file path.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=n>when</span> <span class=o>{</span> <span class=n>allOf</span> <span class=o>{</span> <span class=n>branch</span> <span class=s1>&#39;master&#39;</span><span class=o>;</span> <span class=n>changeset</span> <span class=s2>&quot;teams/**/team.*&quot;</span> <span class=o>}</span> <span class=o>}</span>
</pre></div> </td></tr></table> </details> <details class=example><summary>post { always { } }</summary><p>The <a href=https://jenkins.io/doc/book/pipeline/syntax/#post>Post Directive</a> allows us to run certain commands after the main pipeline has run depending on the outcome (compared or not to the previous outcome). In this case, we want to make sure we reset the <code class=codehilite><span class=n>namespace</span></code> used by Operations Center to the original value.</p> <p>By using <code class=codehilite><span class=n>post</span> <span class=err>{</span> <span class=n>always</span> <span class=err>{}</span> <span class=err>}</span></code>, it will ALWAYS run, regardless of the status of the pipeline. So we should be safe.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>post</span> <span class=o>{</span>
    <span class=n>always</span> <span class=o>{</span>
        <span class=n>container</span><span class=o>(</span><span class=s1>&#39;cli&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>sh</span> <span class=s1>&#39;${CLI} ${CREDS} groovy = &lt; resources/bootstrap/configure-oc-namespace.groovy ${RESET_NAMESPACE}&#39;</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</pre></div> </td></tr></table> </details> <details class=example><summary>stages { stage { parallel { stage() { stages { stage { </summary><p>Oke, you might've noticed this massive indenting depth and probably have some questions. </p> <p>By combining <a href=https://jenkins.io/blog/2018/07/02/whats-new-declarative-piepline-13x-sequential-stages/ >sequential stages</a> with <a href=https://jenkins.io/blog/2017/09/25/declarative-1/ >parallel stages</a> we can create a set of stages that will be executed in sequence but can be controlled by a single <code class=codehilite><span class=k>when</span> <span class=err>{}</span></code> statement whether or not they get executed. </p> <p>This prevents mistakes being made in the condition and accidentally running one or other but not all the required steps.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=n>stages</span> <span class=o>{</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Create Team&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>parallel</span> <span class=o>{</span>
                <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Main&#39;</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>stages</span> <span class=o>{</span>
                        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Parse Changelog&#39;</span><span class=o>)</span> <span class=o>{</span>
</pre></div> </td></tr></table> </details> <details class=example><summary>changetSetData &amp; container('jpb') {}</summary><p>Alright, so even if we know a team was added in <code class=codehilite><span class=o>/</span><span class=n>teams</span><span class=o>/&lt;</span><span class=n>team</span><span class=o>-</span><span class=n>name</span><span class=o>&gt;</span></code>, we still don't know the following two things: 1) what is the name of this team, 2) was this team changed or deleted?</p> <p>So we have to process the changelog to be able to answer these questions as well. There are different ways of getting the changelog and parsing it. I've written one you can do on ANY machine, regardless of Jenkins by leveraging <code class=codehilite><span class=n>Git</span></code> and my own custom binary (<code class=codehilite><span class=n>jpb</span></code> -&gt; Jenkins Pipeline Binary). The code for my binary is at GitHub: <a href=https://github.com/joostvdg/jpb>github.com/joostvdg/jpb</a>.</p> <p>An alternative approach is described by <a href=https://support.cloudbees.com/hc/en-us/articles/217630098-How-to-access-Changelogs-in-a-Pipeline-Job->CloudBees Support here</a>, which leverages Jenkins groovy powers.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>COMMIT_INFO</span> <span class=o>=</span> <span class=s2>&quot;${scmVars.GIT_COMMIT} ${scmVars.GIT_PREVIOUS_COMMIT}&quot;</span>
<span class=kt>def</span> <span class=n>changeSetData</span> <span class=o>=</span> <span class=n>sh</span> <span class=nl>returnStdout:</span> <span class=kc>true</span><span class=o>,</span> <span class=nl>script:</span> <span class=s2>&quot;git diff-tree --no-commit-id --name-only -r ${COMMIT_INFO}&quot;</span>
<span class=n>changeSetData</span> <span class=o>=</span> <span class=n>changeSetData</span><span class=o>.</span><span class=na>replace</span><span class=o>(</span><span class=s2>&quot;\n&quot;</span><span class=o>,</span> <span class=s2>&quot;\\n&quot;</span><span class=o>)</span>
<span class=n>container</span><span class=o>(</span><span class=s1>&#39;jpb&#39;</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>changeSetFolders</span> <span class=o>=</span> <span class=n>sh</span> <span class=nl>returnStdout:</span> <span class=kc>true</span><span class=o>,</span> <span class=nl>script:</span> <span class=s2>&quot;/usr/bin/jpb/bin/jpb GitChangeListToFolder &#39;${changeSetData}&#39; &#39;teams/&#39;&quot;</span>
    <span class=n>changeSetFolders</span> <span class=o>=</span> <span class=n>changeSetFolders</span><span class=o>.</span><span class=na>split</span><span class=o>(</span><span class=s1>&#39;,&#39;</span><span class=o>)</span>
<span class=o>}</span>
</pre></div> </td></tr></table> </details> <h4 id=files>Files<a class=headerlink href=#files title="Permanent link">&para;</a></h4> <details class=example><summary>recipes.json</summary><p>The default Team Recipes that ships with CloudBees Core Modern.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=p>{</span>
        <span class=nt>&quot;version&quot;</span><span class=p>:</span> <span class=s2>&quot;1&quot;</span><span class=p>,</span>
        <span class=nt>&quot;data&quot;</span><span class=p>:</span> <span class=p>[{</span>
            <span class=nt>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;basic&quot;</span><span class=p>,</span>
            <span class=nt>&quot;displayName&quot;</span><span class=p>:</span> <span class=s2>&quot;Basic&quot;</span><span class=p>,</span>
            <span class=nt>&quot;description&quot;</span><span class=p>:</span> <span class=s2>&quot;The minimalistic setup.&quot;</span><span class=p>,</span>
            <span class=nt>&quot;plugins&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;bluesteel-master&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-folders-plus&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-jsync-archiver&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-monitoring&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-nodes-plus&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-ssh-slaves&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-support&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-workflow-template&quot;</span><span class=p>,</span> <span class=s2>&quot;credentials-binding&quot;</span><span class=p>,</span> <span class=s2>&quot;email-ext&quot;</span><span class=p>,</span> <span class=s2>&quot;git&quot;</span><span class=p>,</span> <span class=s2>&quot;git-client&quot;</span><span class=p>,</span> <span class=s2>&quot;github-branch-source&quot;</span><span class=p>,</span> <span class=s2>&quot;github-organization-folder&quot;</span><span class=p>,</span> <span class=s2>&quot;infradna-backup&quot;</span><span class=p>,</span> <span class=s2>&quot;ldap&quot;</span><span class=p>,</span> <span class=s2>&quot;mailer&quot;</span><span class=p>,</span> <span class=s2>&quot;operations-center-analytics-reporter&quot;</span><span class=p>,</span> <span class=s2>&quot;operations-center-cloud&quot;</span><span class=p>,</span> <span class=s2>&quot;pipeline-model-definition&quot;</span><span class=p>,</span> <span class=s2>&quot;ssh-credentials&quot;</span><span class=p>,</span> <span class=s2>&quot;wikitext&quot;</span><span class=p>,</span> <span class=s2>&quot;workflow-aggregator&quot;</span><span class=p>,</span> <span class=s2>&quot;workflow-cps-checkpoint&quot;</span><span class=p>],</span>
            <span class=nt>&quot;default&quot;</span><span class=p>:</span> <span class=kc>true</span>
        <span class=p>},</span> <span class=p>{</span>
            <span class=nt>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;java-web&quot;</span><span class=p>,</span>
            <span class=nt>&quot;displayName&quot;</span><span class=p>:</span> <span class=s2>&quot;Java &amp; Web Development&quot;</span><span class=p>,</span>
            <span class=nt>&quot;description&quot;</span><span class=p>:</span> <span class=s2>&quot;The essential tools to build, release and deploy Java Web applications including integration with Maven, Gradle and Node JS.&quot;</span><span class=p>,</span>
            <span class=nt>&quot;plugins&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;bluesteel-master&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-folders-plus&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-jsync-archiver&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-monitoring&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-nodes-plus&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-ssh-slaves&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-support&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-workflow-template&quot;</span><span class=p>,</span> <span class=s2>&quot;credentials-binding&quot;</span><span class=p>,</span> <span class=s2>&quot;email-ext&quot;</span><span class=p>,</span> <span class=s2>&quot;git&quot;</span><span class=p>,</span> <span class=s2>&quot;git-client&quot;</span><span class=p>,</span> <span class=s2>&quot;github-branch-source&quot;</span><span class=p>,</span> <span class=s2>&quot;github-organization-folder&quot;</span><span class=p>,</span> <span class=s2>&quot;infradna-backup&quot;</span><span class=p>,</span> <span class=s2>&quot;ldap&quot;</span><span class=p>,</span> <span class=s2>&quot;mailer&quot;</span><span class=p>,</span> <span class=s2>&quot;operations-center-analytics-reporter&quot;</span><span class=p>,</span> <span class=s2>&quot;operations-center-cloud&quot;</span><span class=p>,</span> <span class=s2>&quot;pipeline-model-definition&quot;</span><span class=p>,</span> <span class=s2>&quot;ssh-credentials&quot;</span><span class=p>,</span> <span class=s2>&quot;wikitext&quot;</span><span class=p>,</span> <span class=s2>&quot;workflow-aggregator&quot;</span><span class=p>,</span> <span class=s2>&quot;workflow-cps-checkpoint&quot;</span><span class=p>,</span> <span class=s2>&quot;config-file-provider&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-aws-cli&quot;</span><span class=p>,</span> <span class=s2>&quot;cloudbees-cloudfoundry-cli&quot;</span><span class=p>,</span> <span class=s2>&quot;findbugs&quot;</span><span class=p>,</span> <span class=s2>&quot;gradle&quot;</span><span class=p>,</span> <span class=s2>&quot;jira&quot;</span><span class=p>,</span> <span class=s2>&quot;junit&quot;</span><span class=p>,</span> <span class=s2>&quot;nodejs&quot;</span><span class=p>,</span> <span class=s2>&quot;openshift-cli&quot;</span><span class=p>,</span> <span class=s2>&quot;pipeline-maven&quot;</span><span class=p>,</span> <span class=s2>&quot;tasks&quot;</span><span class=p>,</span> <span class=s2>&quot;warnings&quot;</span><span class=p>],</span>
            <span class=nt>&quot;default&quot;</span><span class=p>:</span> <span class=kc>false</span>
        <span class=p>}]</span>
    <span class=p>}</span>
</pre></div> </td></tr></table> </details> <details class=example><summary>Jenkinsfile</summary><p>This is the pipeline that will process the commit to the repository and, if it detects a new team is created will apply the changes.</p> <p>Variables to overwrite:</p> <ul> <li><strong>GIT_REPO</strong>: the https url to the Git Repository your GitOps code/configuration is stored</li> <li><strong>RESET_NAMESPACE</strong>: the <code class=codehilite><span class=n>namespace</span></code> your Operation Center normally operates in</li> <li><strong>CLI</strong>: this command depends on the namespace Operation Center is in (<code class=codehilite><span class=n>http</span><span class=p>:</span><span class=o>//&lt;</span><span class=n>service</span> <span class=n>name</span><span class=o>&gt;</span><span class=p>.</span><span class=o>&lt;</span><span class=n>namespace</span><span class=o>&gt;/</span><span class=n>cjoc</span></code>)</li> </ul> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>pipeline</span> <span class=o>{</span>
    <span class=n>agent</span> <span class=o>{</span>
        <span class=n>kubernetes</span> <span class=o>{</span>
            <span class=n>label</span> <span class=s1>&#39;jenkins-agent&#39;</span>
            <span class=n>yaml</span> <span class=s1>&#39;&#39;&#39;</span>
<span class=s1>apiVersion: v1</span>
<span class=s1>kind: Pod</span>
<span class=s1>spec:</span>
<span class=s1>  serviceAccountName: jenkins</span>
<span class=s1>  containers:</span>
<span class=s1>  - name: cli</span>
<span class=s1>    image: caladreas/cbcore-cli:2.176.2.3</span>
<span class=s1>    imagePullPolicy: Always</span>
<span class=s1>    command:</span>
<span class=s1>    - cat</span>
<span class=s1>    tty: true</span>
<span class=s1>    resources:</span>
<span class=s1>      requests:</span>
<span class=s1>        memory: &quot;50Mi&quot;</span>
<span class=s1>        cpu: &quot;150m&quot;</span>
<span class=s1>      limits:</span>
<span class=s1>        memory: &quot;50Mi&quot;</span>
<span class=s1>        cpu: &quot;150m&quot;</span>
<span class=s1>  - name: kubectl</span>
<span class=s1>    image: bitnami/kubectl:latest</span>
<span class=s1>    command: [&quot;cat&quot;]</span>
<span class=s1>    tty: true</span>
<span class=s1>    resources:</span>
<span class=s1>      requests:</span>
<span class=s1>        memory: &quot;50Mi&quot;</span>
<span class=s1>        cpu: &quot;100m&quot;</span>
<span class=s1>      limits:</span>
<span class=s1>        memory: &quot;150Mi&quot;</span>
<span class=s1>        cpu: &quot;200m&quot;</span>
<span class=s1>  - name: yq</span>
<span class=s1>    image: mikefarah/yq</span>
<span class=s1>    command: [&#39;cat&#39;]</span>
<span class=s1>    tty: true</span>
<span class=s1>    resources:</span>
<span class=s1>      requests:</span>
<span class=s1>        memory: &quot;50Mi&quot;</span>
<span class=s1>        cpu: &quot;100m&quot;</span>
<span class=s1>      limits:</span>
<span class=s1>        memory: &quot;50Mi&quot;</span>
<span class=s1>        cpu: &quot;100m&quot;</span>
<span class=s1>  - name: jpb</span>
<span class=s1>    image: caladreas/jpb</span>
<span class=s1>    command:</span>
<span class=s1>    - cat</span>
<span class=s1>    tty: true</span>
<span class=s1>    resources:</span>
<span class=s1>      requests:</span>
<span class=s1>        memory: &quot;50Mi&quot;</span>
<span class=s1>        cpu: &quot;100m&quot;</span>
<span class=s1>      limits:</span>
<span class=s1>        memory: &quot;50Mi&quot;</span>
<span class=s1>        cpu: &quot;100m&quot;</span>
<span class=s1>  securityContext:</span>
<span class=s1>    runAsUser: 1000</span>
<span class=s1>    fsGroup: 1000</span>
<span class=s1>&#39;&#39;&#39;</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=n>options</span> <span class=o>{</span>
        <span class=n>disableConcurrentBuilds</span><span class=o>()</span>
        <span class=n>buildDiscarder</span> <span class=nf>logRotator</span><span class=o>(</span><span class=nl>artifactDaysToKeepStr:</span> <span class=s1>&#39;&#39;</span><span class=o>,</span> <span class=nl>artifactNumToKeepStr:</span> <span class=s1>&#39;&#39;</span><span class=o>,</span> <span class=nl>daysToKeepStr:</span> <span class=s1>&#39;5&#39;</span><span class=o>,</span> <span class=nl>numToKeepStr:</span> <span class=s1>&#39;5&#39;</span><span class=o>)</span>
    <span class=o>}</span>
    <span class=n>environment</span> <span class=o>{</span>
        <span class=n>RESET_NAMESPACE</span>     <span class=o>=</span> <span class=s1>&#39;cloudbees-core&#39;</span>
        <span class=n>CREDS</span>               <span class=o>=</span> <span class=n>credentials</span><span class=o>(</span><span class=s1>&#39;jenkins-api&#39;</span><span class=o>)</span>
        <span class=n>CLI</span>                 <span class=o>=</span> <span class=s2>&quot;java -jar /usr/bin/jenkins-cli.jar -noKeyAuth -s http://cjoc.cloudbees-core/cjoc -auth&quot;</span>
        <span class=n>COMMIT_INFO</span>         <span class=o>=</span> <span class=s1>&#39;&#39;</span>
        <span class=n>TEAM</span>                <span class=o>=</span> <span class=s1>&#39;&#39;</span>
        <span class=n>GIT_REPO</span>            <span class=o>=</span> <span class=s1>&#39;&#39;</span>
    <span class=o>}</span>
    <span class=n>stages</span> <span class=o>{</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Create Team&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>when</span> <span class=o>{</span> <span class=n>allOf</span> <span class=o>{</span> <span class=n>branch</span> <span class=s1>&#39;master&#39;</span><span class=o>;</span> <span class=n>changeset</span> <span class=s2>&quot;teams/**/team.*&quot;</span> <span class=o>}</span> <span class=o>}</span>
            <span class=n>parallel</span> <span class=o>{</span>
                <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Main&#39;</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>stages</span> <span class=o>{</span>
                        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Parse Changelog&#39;</span><span class=o>)</span> <span class=o>{</span>
                            <span class=n>steps</span> <span class=o>{</span>
                                <span class=c1>// Alternative approach: https://support.cloudbees.com/hc/en-us/articles/217630098-How-to-access-Changelogs-in-a-Pipeline-Job-</span>
                                <span class=c1>// However, that runs on the master, JPB runs in an agent!</span>
                                <span class=n>script</span> <span class=o>{</span>
                                    <span class=n>scmVars</span> <span class=o>=</span> <span class=n>git</span> <span class=s2>&quot;${GIT_REPO}&quot;</span>
                                    <span class=n>COMMIT_INFO</span> <span class=o>=</span> <span class=s2>&quot;${scmVars.GIT_COMMIT} ${scmVars.GIT_PREVIOUS_COMMIT}&quot;</span>
                                    <span class=kt>def</span> <span class=n>changeSetData</span> <span class=o>=</span> <span class=n>sh</span> <span class=nl>returnStdout:</span> <span class=kc>true</span><span class=o>,</span> <span class=nl>script:</span> <span class=s2>&quot;git diff-tree --no-commit-id --name-only -r ${COMMIT_INFO}&quot;</span>
                                    <span class=n>changeSetData</span> <span class=o>=</span> <span class=n>changeSetData</span><span class=o>.</span><span class=na>replace</span><span class=o>(</span><span class=s2>&quot;\n&quot;</span><span class=o>,</span> <span class=s2>&quot;\\n&quot;</span><span class=o>)</span>
                                    <span class=n>container</span><span class=o>(</span><span class=s1>&#39;jpb&#39;</span><span class=o>)</span> <span class=o>{</span>
                                        <span class=n>changeSetFolders</span> <span class=o>=</span> <span class=n>sh</span> <span class=nl>returnStdout:</span> <span class=kc>true</span><span class=o>,</span> <span class=nl>script:</span> <span class=s2>&quot;/usr/bin/jpb/bin/jpb GitChangeListToFolder &#39;${changeSetData}&#39; &#39;teams/&#39;&quot;</span>
                                        <span class=n>changeSetFolders</span> <span class=o>=</span> <span class=n>changeSetFolders</span><span class=o>.</span><span class=na>split</span><span class=o>(</span><span class=s1>&#39;,&#39;</span><span class=o>)</span>
                                    <span class=o>}</span>
                                    <span class=k>if</span> <span class=o>(</span><span class=n>changeSetFolders</span><span class=o>.</span><span class=na>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
                                        <span class=n>TEAM</span> <span class=o>=</span> <span class=n>changeSetFolders</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span>
                                        <span class=n>TEAM</span> <span class=o>=</span> <span class=n>TEAM</span><span class=o>.</span><span class=na>trim</span><span class=o>()</span>
                                        <span class=c1>// to protect against a team being removed</span>
                                        <span class=kt>def</span> <span class=n>exists</span> <span class=o>=</span> <span class=n>fileExists</span> <span class=s2>&quot;teams/${TEAM}/team.yaml&quot;</span>
                                        <span class=k>if</span> <span class=o>(!</span><span class=n>exists</span><span class=o>)</span> <span class=o>{</span>
                                            <span class=n>TEAM</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
                                        <span class=o>}</span>
                                    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
                                        <span class=n>TEAM</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
                                    <span class=o>}</span>
                                    <span class=n>echo</span> <span class=s2>&quot;Team that changed: |${TEAM}|&quot;</span>
                                <span class=o>}</span>
                            <span class=o>}</span>
                        <span class=o>}</span>
                        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Create Namespace&#39;</span><span class=o>)</span> <span class=o>{</span>
                            <span class=n>when</span> <span class=o>{</span> <span class=n>expression</span> <span class=o>{</span> <span class=k>return</span> <span class=o>!</span><span class=n>TEAM</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s1>&#39;&#39;</span><span class=o>)</span> <span class=o>}</span> <span class=o>}</span>
                            <span class=n>environment</span> <span class=o>{</span>
                                <span class=n>NAMESPACE</span>   <span class=o>=</span> <span class=s2>&quot;cb-teams-${TEAM}&quot;</span>
                                <span class=n>RECORD_LOC</span>  <span class=o>=</span> <span class=s2>&quot;teams/${TEAM}&quot;</span>
                            <span class=o>}</span>
                            <span class=n>steps</span> <span class=o>{</span>
                                <span class=n>container</span><span class=o>(</span><span class=s1>&#39;kubectl&#39;</span><span class=o>)</span> <span class=o>{</span>
                                    <span class=n>sh</span> <span class=s1>&#39;&#39;&#39;</span>
<span class=s1>                                        cat ${RECORD_LOC}/team.yaml</span>
<span class=s1>                                        kubectl apply -f ${RECORD_LOC}/team.yaml</span>
<span class=s1>                                    &#39;&#39;&#39;</span>
                                <span class=o>}</span>
                            <span class=o>}</span>
                        <span class=o>}</span>
                        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Change OC Namespace&#39;</span><span class=o>)</span> <span class=o>{</span>
                            <span class=n>when</span> <span class=o>{</span> <span class=n>expression</span> <span class=o>{</span> <span class=k>return</span> <span class=o>!</span><span class=n>TEAM</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s1>&#39;&#39;</span><span class=o>)</span> <span class=o>}</span> <span class=o>}</span>
                            <span class=n>environment</span> <span class=o>{</span>
                                <span class=n>NAMESPACE</span>   <span class=o>=</span> <span class=s2>&quot;cb-teams-${TEAM}&quot;</span>
                            <span class=o>}</span>
                            <span class=n>steps</span> <span class=o>{</span>
                                <span class=n>container</span><span class=o>(</span><span class=s1>&#39;cli&#39;</span><span class=o>)</span> <span class=o>{</span>
                                    <span class=n>sh</span> <span class=s1>&#39;echo ${NAMESPACE}&#39;</span>
                                    <span class=n>script</span> <span class=o>{</span>
                                        <span class=kt>def</span> <span class=n>response</span> <span class=o>=</span> <span class=n>sh</span> <span class=nl>encoding:</span> <span class=s1>&#39;UTF-8&#39;</span><span class=o>,</span> <span class=nl>label:</span> <span class=s1>&#39;create team&#39;</span><span class=o>,</span> <span class=nl>returnStatus:</span> <span class=kc>true</span><span class=o>,</span> <span class=nl>script:</span> <span class=s1>&#39;${CLI} ${CREDS} groovy = &lt; resources/bootstrap/configure-oc-namespace.groovy ${NAMESPACE}&#39;</span>
                                        <span class=n>println</span> <span class=s2>&quot;Response: ${response}&quot;</span>
                                    <span class=o>}</span>
                                <span class=o>}</span>
                            <span class=o>}</span>
                        <span class=o>}</span>
                        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Create Team Master&#39;</span><span class=o>)</span> <span class=o>{</span>
                            <span class=n>when</span> <span class=o>{</span> <span class=n>expression</span> <span class=o>{</span> <span class=k>return</span> <span class=o>!</span><span class=n>TEAM</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s1>&#39;&#39;</span><span class=o>)</span> <span class=o>}</span> <span class=o>}</span>
                            <span class=n>environment</span> <span class=o>{</span>
                                <span class=n>TEAM_NAME</span> <span class=o>=</span> <span class=s2>&quot;${TEAM}&quot;</span>
                            <span class=o>}</span>
                            <span class=n>steps</span> <span class=o>{</span>
                                <span class=n>container</span><span class=o>(</span><span class=s1>&#39;cli&#39;</span><span class=o>)</span> <span class=o>{</span>
                                    <span class=n>println</span> <span class=s2>&quot;TEAM_NAME=${TEAM_NAME}&quot;</span>
                                    <span class=n>sh</span> <span class=s1>&#39;ls -lath&#39;</span>
                                    <span class=n>sh</span> <span class=s1>&#39;ls -lath teams/&#39;</span>
                                    <span class=n>script</span> <span class=o>{</span>
                                        <span class=kt>def</span> <span class=n>response</span> <span class=o>=</span> <span class=n>sh</span> <span class=nl>encoding:</span> <span class=s1>&#39;UTF-8&#39;</span><span class=o>,</span> <span class=nl>label:</span> <span class=s1>&#39;create team&#39;</span><span class=o>,</span> <span class=nl>returnStatus:</span> <span class=kc>true</span><span class=o>,</span> <span class=nl>script:</span> <span class=s1>&#39;${CLI} ${CREDS} teams ${TEAM_NAME} --put &lt; &quot;teams/${TEAM_NAME}/team.json&quot;&#39;</span>
                                        <span class=n>println</span> <span class=s2>&quot;Response: ${response}&quot;</span>
                                    <span class=o>}</span>
                                <span class=o>}</span>
                            <span class=o>}</span>
                        <span class=o>}</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Test CLI Connection&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>steps</span> <span class=o>{</span>
                <span class=n>container</span><span class=o>(</span><span class=s1>&#39;cli&#39;</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>script</span> <span class=o>{</span>
                        <span class=kt>def</span> <span class=n>response</span> <span class=o>=</span> <span class=n>sh</span> <span class=nl>encoding:</span> <span class=s1>&#39;UTF-8&#39;</span><span class=o>,</span> <span class=nl>label:</span> <span class=s1>&#39;retrieve version&#39;</span><span class=o>,</span> <span class=nl>returnStatus:</span> <span class=kc>true</span><span class=o>,</span> <span class=nl>script:</span> <span class=s1>&#39;${CLI} ${CREDS} version&#39;</span>
                        <span class=n>println</span> <span class=s2>&quot;Response: ${response}&quot;</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Update Team Recipes&#39;</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>when</span> <span class=o>{</span> <span class=n>allOf</span> <span class=o>{</span> <span class=n>branch</span> <span class=s1>&#39;master&#39;</span><span class=o>;</span> <span class=n>changeset</span> <span class=s2>&quot;recipes/recipes.json&quot;</span> <span class=o>}</span> <span class=o>}</span>
            <span class=n>steps</span> <span class=o>{</span>
                <span class=n>container</span><span class=o>(</span><span class=s1>&#39;cli&#39;</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>sh</span> <span class=s1>&#39;ls -lath&#39;</span>
                    <span class=n>sh</span> <span class=s1>&#39;ls -lath recipes/&#39;</span>
                    <span class=n>script</span> <span class=o>{</span>
                        <span class=kt>def</span> <span class=n>response</span> <span class=o>=</span> <span class=n>sh</span> <span class=nl>encoding:</span> <span class=s1>&#39;UTF-8&#39;</span><span class=o>,</span> <span class=nl>label:</span> <span class=s1>&#39;update team recipe&#39;</span><span class=o>,</span> <span class=nl>returnStatus:</span> <span class=kc>true</span><span class=o>,</span> <span class=nl>script:</span> <span class=s1>&#39;${CLI} ${CREDS} team-creation-recipes --put &lt; &quot;recipes/recipes.json&quot;&#39;</span>
                        <span class=n>println</span> <span class=s2>&quot;Response: ${response}&quot;</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=n>post</span> <span class=o>{</span>
        <span class=n>always</span> <span class=o>{</span>
            <span class=n>container</span><span class=o>(</span><span class=s1>&#39;cli&#39;</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>sh</span> <span class=s1>&#39;${CLI} ${CREDS} groovy = &lt; resources/bootstrap/configure-oc-namespace.groovy ${RESET_NAMESPACE}&#39;</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>        
</pre></div> </td></tr></table> </details> <h2 id=__comments>Comments</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://joostvdg.github.io/blogs/teams-automation/";
      this.page.identifier =
        "/blogs/teams-automation/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//joostvdg-github-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../sso-azure-ad/ title="CloudBees SSO Azure AD" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> CloudBees SSO Azure AD </span> </div> </a> <a href=../kubernetes-sso-keycloak/ title="Kubernetes SSO Keycloak" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Kubernetes SSO Keycloak </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2019 Joost van der Griendt </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <a href=https://github.com/joostvdg class="md-footer-social__link fa fa-github"></a> <a href=https://twitter.com/joost_vdg class="md-footer-social__link fa fa-twitter"></a> <a href=https://linkedin.com/in/joostvdg class="md-footer-social__link fa fa-linkedin"></a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.c648116f.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> </body> </html>