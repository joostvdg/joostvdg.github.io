<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link href=https://joostvdg.github.io/blogs/docker-graceful-shutdown/ rel=canonical><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.0"><title>Docker Graceful Shutdown - J's Software Development Pages</title><link rel=stylesheet href=../../assets/stylesheets/application.0284f74d.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.01803549.css><meta name=theme-color content=#fb8c00><script src=../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-145385967-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-primary=orange data-md-color-accent=red> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#gracefully-shutting-down-applications-in-docker tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-header-nav__button md-logo"> <i class=md-icon>public</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> J's Software Development Pages </span> <span class=md-header-nav__topic> Docker Graceful Shutdown </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. title=Home class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=./ title=Blogs class="md-tabs__link md-tabs__link--active"> Blogs </a> </li> <li class=md-tabs__item> <a href=../../cloudbees/sso-azure-ad/ title=CICD class=md-tabs__link> CICD </a> </li> <li class=md-tabs__item> <a href=../../kubernetes/ title=Containers class=md-tabs__link> Containers </a> </li> <li class=md-tabs__item> <a href=../../certificates/lets-encrypt-k8s/ title=SWE class=md-tabs__link> SWE </a> </li> <li class=md-tabs__item> <a href=../../java/ title=Java class=md-tabs__link> Java </a> </li> </ul> </div> </nav> <main class=md-main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-nav__button md-logo"> <i class=md-icon>public</i> </a> J's Software Development Pages </label> <div class=md-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> Home </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-1> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Me class=md-nav__link> Me </a> </li> <li class=md-nav__item> <a href=../../other/mkdocs/ title="MKDocs (This Static Website)" class=md-nav__link> MKDocs (This Static Website) </a> </li> <li class=md-nav__item> <a href=../../other/vim/ title=VIM class=md-nav__link> VIM </a> </li> <li class=md-nav__item> <a href=../../other/shell/ title=Shell class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Blogs </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Blogs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Docker Graceful Shutdown </label> <a href=./ title="Docker Graceful Shutdown" class="md-nav__link md-nav__link--active"> Docker Graceful Shutdown </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#the-case-for-graceful-shutdown title="The case for graceful shutdown" class=md-nav__link> The case for graceful shutdown </a> </li> <li class=md-nav__item> <a href=#start-good-so-you-can-end-well title="Start Good So You Can End Well" class=md-nav__link> Start Good So You Can End Well </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-shell-form-example title="Docker Shell form example" class=md-nav__link> Docker Shell form example </a> </li> <li class=md-nav__item> <a href=#docker-exec-form-example title="Docker exec form example" class=md-nav__link> Docker exec form example </a> </li> <li class=md-nav__item> <a href=#gotchas title=Gotchas class=md-nav__link> Gotchas </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-exec-form-with-parameters title="Docker exec form with parameters" class=md-nav__link> Docker exec form with parameters </a> </li> <li class=md-nav__item> <a href=#the-special-case-of-alpine title="The special case of Alpine" class=md-nav__link> The special case of Alpine </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#make-sure-your-process-listens title="Make Sure Your Process Listens" class=md-nav__link> Make Sure Your Process Listens </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#let-docker-manage-it-for-us title="Let Docker manage it for us" class=md-nav__link> Let Docker manage it for us </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#with-docker-run title="With Docker Run" class=md-nav__link> With Docker Run </a> </li> <li class=md-nav__item> <a href=#with-docker-compose title="With Docker Compose" class=md-nav__link> With Docker Compose </a> </li> <li class=md-nav__item> <a href=#with-docker-swarm title="With Docker Swarm" class=md-nav__link> With Docker Swarm </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#depend-on-a-process-manager title="Depend on a process manager" class=md-nav__link> Depend on a process manager </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#debian-example title="Debian example" class=md-nav__link> Debian example </a> </li> <li class=md-nav__item> <a href=#alpine-example title="Alpine example" class=md-nav__link> Alpine example </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#how-to-be-told-what-you-want-to-hear title="How To Be Told What You Want To Hear" class=md-nav__link> How To Be Told What You Want To Hear </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#handle-signals-as-they-come title="Handle signals as they come" class=md-nav__link> Handle signals as they come </a> </li> <li class=md-nav__item> <a href=#state-the-signals-we-want title="State the signals we want" class=md-nav__link> State the signals we want </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-run title="Docker run" class=md-nav__link> Docker run </a> </li> <li class=md-nav__item> <a href=#docker-composeswarm title="Docker compose/swarm" class=md-nav__link> Docker compose/swarm </a> </li> <li class=md-nav__item> <a href=#kubernetes title=Kubernetes class=md-nav__link> Kubernetes </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#how-to-be-told-when-you-want-to-hear-it title="How To Be Told When You Want To Hear It" class=md-nav__link> How To Be Told When You Want To Hear It </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker title=Docker class=md-nav__link> Docker </a> </li> <li class=md-nav__item> <a href=#kubernetes_1 title=Kubernetes class=md-nav__link> Kubernetes </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../jenkins-pipeline-docker-alternatives/ title="Pipelines with Docker Alternatives" class=md-nav__link> Pipelines with Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../k8s-lets-encrypt/ title="Let's Encrypt for Kubernetes Apps" class=md-nav__link> Let's Encrypt for Kubernetes Apps </a> </li> <li class=md-nav__item> <a href=../../cloudbees/sso-azure-ad/ title="CloudBees SSO Azure AD" class=md-nav__link> CloudBees SSO Azure AD </a> </li> <li class=md-nav__item> <a href=../../cloudbees/teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../jenkins-pipeline-support-tool/ title="Jenkins Pipeline Support Tools" class=md-nav__link> Jenkins Pipeline Support Tools </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-7 type=checkbox id=nav-2-7> <label class=md-nav__link for=nav-2-7> Jenkins Monitoring Kubernetes </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-7> Jenkins Monitoring Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/introduction/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/prepare/ title="Prepare Environment" class=md-nav__link> Prepare Environment </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/install/ title="Install Tools" class=md-nav__link> Install Tools </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/metrics/ title=Metrics class=md-nav__link> Metrics </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/alerts/ title=Alerts class=md-nav__link> Alerts </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/pipeline/ title=Pipeline class=md-nav__link> Pipeline </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/dashboard/ title=Dashboard class=md-nav__link> Dashboard </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/cloudbees/ title=CloudBees class=md-nav__link> CloudBees </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../k8s-crd/ title="Create your own k8s resource" class=md-nav__link> Create your own k8s resource </a> </li> <li class=md-nav__item> <a href=../dockercon-eu-2018/ title="DockerCon EU 2018" class=md-nav__link> DockerCon EU 2018 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> CICD </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> CICD </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-1 type=checkbox id=nav-3-1> <label class=md-nav__link for=nav-3-1> CloudBees </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-1> CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloudbees/sso-azure-ad/ title="Single Sign On - AzureAD" class=md-nav__link> Single Sign On - AzureAD </a> </li> <li class=md-nav__item> <a href=../../cloudbees/teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-gke-helm/ title="CloudBees Core on GKE" class=md-nav__link> CloudBees Core on GKE </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-eks/ title="CloudBees Core on EKS" class=md-nav__link> CloudBees Core on EKS </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-post-install-tips/ title="CloudBees Core Post Install" class=md-nav__link> CloudBees Core Post Install </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-2 type=checkbox id=nav-3-2> <label class=md-nav__link for=nav-3-2> Jenkins X </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-2> Jenkins X </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/intro/ title=Intro class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hello-world/ title=HelloWorld class=md-nav__link> HelloWorld </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/workshop/ title=Workshop class=md-nav__link> Workshop </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/buildpack/ title=BuildPack class=md-nav__link> BuildPack </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/maven/ title=Maven class=md-nav__link> Maven </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hybrid/ title=Hybrid class=md-nav__link> Hybrid </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-3 type=checkbox id=nav-3-3> <label class=md-nav__link for=nav-3-3> Jenkins </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-3> Jenkins </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins/ title=Intro class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jobdsl/ title=JobDSL class=md-nav__link> JobDSL </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jenkins-jobs-builder/ title=JenkinsJobsBuilder class=md-nav__link> JenkinsJobsBuilder </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4> <label class=md-nav__link for=nav-3-4> Jenkins Pipelines </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-4> Jenkins Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline/job-types/ title="Job Types" class=md-nav__link> Job Types </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/core-concepts/ title="Core Concepts" class=md-nav__link> Core Concepts </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/declarative-pipeline/ title="Pipeline (declarative)" class=md-nav__link> Pipeline (declarative) </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/groovy-pipeline/ title="Groovy DSL Pipeline" class=md-nav__link> Groovy DSL Pipeline </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/global-shared-library/ title="Pipeline Libraries" class=md-nav__link> Pipeline Libraries </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/ide-integration-pipeline-dsl/ title="DSL IDE Integration" class=md-nav__link> DSL IDE Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/jenkins-parallel-pipeline/ title=Parallel class=md-nav__link> Parallel </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/input/ title=Input class=md-nav__link> Input </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-5 type=checkbox id=nav-3-5> <label class=md-nav__link for=nav-3-5> Jenkins Pipeline Examples </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-5> Jenkins Pipeline Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/ title=Index class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-alternatives/ title="Docker Alternatives" class=md-nav__link> Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/maven-declarative/ title="Maven Declarative" class=md-nav__link> Maven Declarative </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/maven-shared-library/ title="Maven Shared Library" class=md-nav__link> Maven Shared Library </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-declarative/ title="Docker Declarative" class=md-nav__link> Docker Declarative </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Containers </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Containers </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-1 type=checkbox id=nav-4-1> <label class=md-nav__link for=nav-4-1> Kubernetes (K8S) </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-1> Kubernetes (K8S) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../kubernetes/cka-exam-prep/ title="CKA Exam prep" class=md-nav__link> CKA Exam prep </a> </li> <li class=md-nav__item> <a href=../../kubernetes/tools/ title=Tools class=md-nav__link> Tools </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-2 type=checkbox id=nav-4-2> <label class=md-nav__link for=nav-4-2> K8S CICD </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-2> K8S CICD </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/cicd/cdp-jenkins-helm/ title="CD Pipeline Jenkins & Helm" class=md-nav__link> CD Pipeline Jenkins & Helm </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> K8S Public Services </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-3> K8S Public Services </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/distributions/install-gke/ title=GKE class=md-nav__link> GKE </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/eks-eksctl/ title="AWS EKS" class=md-nav__link> AWS EKS </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-cli/ title="AKS CLI" class=md-nav__link> AKS CLI </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-terraform/ title="AKS Terraform" class=md-nav__link> AKS Terraform </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-4 type=checkbox id=nav-4-4> <label class=md-nav__link for=nav-4-4> K8S Hard Way - GCE </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-4> K8S Hard Way - GCE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/ title="Installer Preparation" class=md-nav__link> Installer Preparation </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/terraform-compute/ title="Create GCE resources" class=md-nav__link> Create GCE resources </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/certificates/ title="Prepare Certificates" class=md-nav__link> Prepare Certificates </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/kubeconfigs/ title="Prepare Kubeconfigs" class=md-nav__link> Prepare Kubeconfigs </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/encryption/ title="Encryption configuration" class=md-nav__link> Encryption configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/etcd/ title="ETCD configuration" class=md-nav__link> ETCD configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/controller/ title="Controller Config" class=md-nav__link> Controller Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/worker/ title="Worker Config" class=md-nav__link> Worker Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/remote-access/ title="Remote access" class=md-nav__link> Remote access </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/network/ title="Network config" class=md-nav__link> Network config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/debug/ title=Debug class=md-nav__link> Debug </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-5 type=checkbox id=nav-4-5> <label class=md-nav__link for=nav-4-5> Docker </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-5> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docker/multi-stage-builds/ title="Multi-Stage Builds(TBD)" class=md-nav__link> Multi-Stage Builds(TBD) </a> </li> <li class=md-nav__item> <a href=../../docker/swarm/ title="Swarm (mode) (TBD)" class=md-nav__link> Swarm (mode) (TBD) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-6 type=checkbox id=nav-4-6> <label class=md-nav__link for=nav-4-6> Linux </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-6> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../linux/systemd/ title=SystemD class=md-nav__link> SystemD </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> SWE </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> SWE </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Other </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Other </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../certificates/lets-encrypt-k8s/ title="Let's Encrypt K8S" class=md-nav__link> Let's Encrypt K8S </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Software Engineering </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Software Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../swe/naming/ title=Naming class=md-nav__link> Naming </a> </li> <li class=md-nav__item> <a href=../../swe/ddd/ title="Domain Driven Design" class=md-nav__link> Domain Driven Design </a> </li> <li class=md-nav__item> <a href=../../swe/microservices/ title=Microservices class=md-nav__link> Microservices </a> </li> <li class=md-nav__item> <a href=../../swe/algorithms/ title=Algorithms class=md-nav__link> Algorithms </a> </li> <li class=md-nav__item> <a href=../../swe/observability/ title=Observability class=md-nav__link> Observability </a> </li> <li class=md-nav__item> <a href=../../swe/others/ title=Others class=md-nav__link> Others </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> Productivity </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> Productivity </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../productivity/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../productivity/tools/ title=Tools class=md-nav__link> Tools </a> </li> <li class=md-nav__item> <a href=../../productivity/intellij/ title="Intelli J" class=md-nav__link> Intelli J </a> </li> <li class=md-nav__item> <a href=../../productivity/paradigms/ title=Paradigms class=md-nav__link> Paradigms </a> </li> <li class=md-nav__item> <a href=../../productivity/studies/ title=Studies class=md-nav__link> Studies </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-6> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../java/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../java/spring/boot/ title="Spring Boot" class=md-nav__link> Spring Boot </a> </li> <li class=md-nav__item> <a href=../../java/java9/ title="Java 9" class=md-nav__link> Java 9 </a> </li> <li class=md-nav__item> <a href=../../java/ecosystem/ title="Java Ecosystem" class=md-nav__link> Java Ecosystem </a> </li> <li class=md-nav__item> <a href=../../java/networking/ title="Java Networking" class=md-nav__link> Java Networking </a> </li> <li class=md-nav__item> <a href=../../java/streams/ title="Java Streams" class=md-nav__link> Java Streams </a> </li> <li class=md-nav__item> <a href=../../java/concurrency/ title="Java Concurrency" class=md-nav__link> Java Concurrency </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#the-case-for-graceful-shutdown title="The case for graceful shutdown" class=md-nav__link> The case for graceful shutdown </a> </li> <li class=md-nav__item> <a href=#start-good-so-you-can-end-well title="Start Good So You Can End Well" class=md-nav__link> Start Good So You Can End Well </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-shell-form-example title="Docker Shell form example" class=md-nav__link> Docker Shell form example </a> </li> <li class=md-nav__item> <a href=#docker-exec-form-example title="Docker exec form example" class=md-nav__link> Docker exec form example </a> </li> <li class=md-nav__item> <a href=#gotchas title=Gotchas class=md-nav__link> Gotchas </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-exec-form-with-parameters title="Docker exec form with parameters" class=md-nav__link> Docker exec form with parameters </a> </li> <li class=md-nav__item> <a href=#the-special-case-of-alpine title="The special case of Alpine" class=md-nav__link> The special case of Alpine </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#make-sure-your-process-listens title="Make Sure Your Process Listens" class=md-nav__link> Make Sure Your Process Listens </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#let-docker-manage-it-for-us title="Let Docker manage it for us" class=md-nav__link> Let Docker manage it for us </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#with-docker-run title="With Docker Run" class=md-nav__link> With Docker Run </a> </li> <li class=md-nav__item> <a href=#with-docker-compose title="With Docker Compose" class=md-nav__link> With Docker Compose </a> </li> <li class=md-nav__item> <a href=#with-docker-swarm title="With Docker Swarm" class=md-nav__link> With Docker Swarm </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#depend-on-a-process-manager title="Depend on a process manager" class=md-nav__link> Depend on a process manager </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#debian-example title="Debian example" class=md-nav__link> Debian example </a> </li> <li class=md-nav__item> <a href=#alpine-example title="Alpine example" class=md-nav__link> Alpine example </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#how-to-be-told-what-you-want-to-hear title="How To Be Told What You Want To Hear" class=md-nav__link> How To Be Told What You Want To Hear </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#handle-signals-as-they-come title="Handle signals as they come" class=md-nav__link> Handle signals as they come </a> </li> <li class=md-nav__item> <a href=#state-the-signals-we-want title="State the signals we want" class=md-nav__link> State the signals we want </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker-run title="Docker run" class=md-nav__link> Docker run </a> </li> <li class=md-nav__item> <a href=#docker-composeswarm title="Docker compose/swarm" class=md-nav__link> Docker compose/swarm </a> </li> <li class=md-nav__item> <a href=#kubernetes title=Kubernetes class=md-nav__link> Kubernetes </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#how-to-be-told-when-you-want-to-hear-it title="How To Be Told When You Want To Hear It" class=md-nav__link> How To Be Told When You Want To Hear It </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#docker title=Docker class=md-nav__link> Docker </a> </li> <li class=md-nav__item> <a href=#kubernetes_1 title=Kubernetes class=md-nav__link> Kubernetes </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/joostvdg/joostvdg.github.io/edit/master/docs/blogs/docker-graceful-shutdown.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=gracefully-shutting-down-applications-in-docker>Gracefully Shutting Down Applications in Docker<a class=headerlink href=#gracefully-shutting-down-applications-in-docker title="Permanent link">&para;</a></h1> <p>I'm not sure about you, but I prefer it when my neighbors leave our shared spaces clean and don't take up parking spaces when they don't need them.</p> <p>Imagine you live in an apartment complex with the above-mentioned parking lot. Some tenants go away and never come back. If nothing is done to clean up after them - to reclaim their apartment and parking space - then after some time, more and more apartments are unavailable for no reason, and the parking lot fills with cars which belong to no one.</p> <p>Some tenants did not get a parking lot and are getting frustrated that none are becoming available. When they moved in, they were told that when others leave, they would be next in line. While they're waiting, they have to park outside the complex. Eventually, the entrance gets blocked and no one can enter or leave. The end result is a completely unlivable apartment block with trapped tenants - never to be seen or heard from again.</p> <p>If you agree with me that when a tenant leaves, they should clean the apartment and free the parking spot to make it ready for the next inhabitant; then please read on. We're going to dive into the equivalent of doing this with containers.</p> <p>We will explore running our containers with Docker (run, compose, swarm) and Kubernetes. Even if you use another way to run your containers, this article should provide you with enough insight to get you on your way.</p> <h2 id=the-case-for-graceful-shutdown>The case for graceful shutdown<a class=headerlink href=#the-case-for-graceful-shutdown title="Permanent link">&para;</a></h2> <p>We're in an age where many applications are running in Docker containers across a multitude of clusters. These applications are then confronted with new concerns to tackle such as more moving parts, networking between these parts, remote storage and others. One significant way we defend ourselves against the perils of this distributed nature is to make our applications more robust - able to survive errors.</p> <p>However, even then there is still no guarantee your application is always up and running. So another concern we should tackle is how it responds when it needs to shut down. Where we can differentiate between an unexpected shutdown - we crashed - or an expected shutdown. On top of that, failing instead of trying to recover when something bad happens also adheres to "fail fast" - as strongly advocated by Michael Nygard in ReleaseIt.</p> <p>Shutting down can happen for a variety of reasons, in this post we dive into how to deal with an expected shutdown such as it being told to stop by an orchestrator such as Kubernetes.</p> <p>Containers can be purposefully shut down for a variety of reasons, including but not limited too:</p> <ul> <li>your application's health check fails</li> <li>your application consumed more resources than allowed</li> <li>the application is scaling down</li> </ul> <p>Just as cleaning up when leaving makes you a better tenant, having your application clean up connections, resources Moreover, the more tenants behaving in a good way increases the quality of living for all tenants. In our case, it improves the reliability and consistency of our cluster.</p> <p>Graceful shutdown is not unique to Docker, as it has been part of Linux's best practices for quite some years before Docker's existence. However, applying them to Docker container adds extra dimensions.</p> <h2 id=start-good-so-you-can-end-well>Start Good So You Can End Well<a class=headerlink href=#start-good-so-you-can-end-well title="Permanent link">&para;</a></h2> <p>When you sign up for an apartment, you probably have to sign a contract detailing your rights and obligations. The more you state explicitly, the easier it is to deal with bad behaving neighbors. The same is true when running processes; we should make sure that we set the rules, obligations, and expectations from the start.</p> <p>As we say in Dutch: a good beginning is half the work. We will start with how you can run a process in a container with a process that shuts down gracefully.</p> <p>There are many ways to start a process in a container. In this article, we look at processes started by commands defined in a Dockerfile. There are two ways to specify this:</p> <ul> <li><strong>CMD</strong>: runs a command when the container gets started</li> <li><strong>ENTRYPOINT</strong>: provides the location (entrypoint) from where commands get run when the container starts</li> </ul> <p>You need at least one ENTRYPOINT or CMD in a Dockerfile for it to be valid. They can be used in collaboration but they can do similar things.</p> <p>For more information on the details of these commands, read <a href=https://docs.docker.com/engine/reference/builder/#exec-form-entrypoint-example>Docker's docs on Entrypoint vs. CMD</a>.</p> <h3 id=docker-shell-form-example>Docker Shell form example<a class=headerlink href=#docker-shell-form-example title="Permanent link">&para;</a></h3> <p>We start with the shell form and see if it can do what we want; begin in such a way, we can stop it nicely. Shell form means we define a shell command without any special format or keywords.</p> <p>Please create Dockerfile with the content that follows.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>FROM</span><span class=s> ubuntu:18.04</span>
<span class=k>ENTRYPOINT</span> top -b
</pre></div> </td></tr></table> <p>Then build an image and run a container.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>docker image build --tag shell-form .
docker run --name shell-form --rm shell-form
</pre></div> </td></tr></table> <p>The above command yields the following output.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span>top - <span class=m>16</span>:34:56 up <span class=m>1</span> day,  <span class=m>5</span>:15,  <span class=m>0</span> users,  load average: <span class=m>0</span>.00, <span class=m>0</span>.00, <span class=m>0</span>.00
Tasks:   <span class=m>2</span> total,   <span class=m>1</span> running,   <span class=m>1</span> sleeping,   <span class=m>0</span> stopped,   <span class=m>0</span> zombie
%Cpu<span class=o>(</span>s<span class=o>)</span>:  <span class=m>0</span>.4 us,  <span class=m>0</span>.3 sy,  <span class=m>0</span>.0 ni, <span class=m>99</span>.2 id,  <span class=m>0</span>.1 wa,  <span class=m>0</span>.0 hi,  <span class=m>0</span>.0 si,  <span class=m>0</span>.0 st
KiB Mem :  <span class=m>2046932</span> total,   <span class=m>541984</span> free,   <span class=m>302668</span> used,  <span class=m>1202280</span> buff/cache
KiB Swap:  <span class=m>1048572</span> total,  <span class=m>1042292</span> free,     <span class=m>6280</span> used.  <span class=m>1579380</span> avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
    <span class=m>1</span> root      <span class=m>20</span>   <span class=m>0</span>    <span class=m>4624</span>    <span class=m>760</span>    <span class=m>696</span> S   <span class=m>0</span>.0  <span class=m>0</span>.0   <span class=m>0</span>:00.05 sh
    <span class=m>6</span> root      <span class=m>20</span>   <span class=m>0</span>   <span class=m>36480</span>   <span class=m>2928</span>   <span class=m>2580</span> R   <span class=m>0</span>.0  <span class=m>0</span>.1   <span class=m>0</span>:00.01 top
</pre></div> </td></tr></table> <p>As you can see, two processes are running, <strong>sh</strong> and <strong>top</strong>. Meaning, that killing the process, with <em>ctrl+c</em> for example, terminates the <strong>sh</strong> process, but not <strong>top</strong>. This happens because the <em>sh</em> process forked the <em>top</em> process, but the termination will only be send to PID 1 - in this case <em>sh</em>. As <em>sh</em> will not stop the <em>top</em> process for us it will continue running and leave the container alive.</p> <p>To kill this container, open a second terminal and execute the following command.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>docker rm -f shell-form
</pre></div> </td></tr></table> <p>Shell form doesn't do what we need. Starting a process with shell form will only lead us to the disaster of parking lots filling up unless there's a someone actively cleaning up.</p> <h3 id=docker-exec-form-example>Docker exec form example<a class=headerlink href=#docker-exec-form-example title="Permanent link">&para;</a></h3> <p>This leads us to the exec form. Hopefully, this gets us somewhere.</p> <p>The exec form is written as an array of parameters: <code class=codehilite><span class=n>ENTRYPOINT</span> <span class=p>[</span><span class=ss>&quot;top&quot;</span><span class=p>,</span> <span class=ss>&quot;-b&quot;</span><span class=p>]</span></code></p> <p>To continue in the same line of examples, we will create a Dockerfile, build and run it.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>FROM</span><span class=s> ubuntu:18.04</span>
<span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&quot;top&quot;</span><span class=p>,</span> <span class=s2>&quot;-b&quot;</span><span class=p>]</span>
</pre></div> </td></tr></table> <p>Then build and run it.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>docker image build --tag exec-form .
docker run --name exec-form --rm exec-form
</pre></div> </td></tr></table> <p>This yields the following output.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span>top - <span class=m>18</span>:12:30 up <span class=m>1</span> day,  <span class=m>6</span>:53,  <span class=m>0</span> users,  load average: <span class=m>0</span>.00, <span class=m>0</span>.00, <span class=m>0</span>.00
Tasks:   <span class=m>1</span> total,   <span class=m>1</span> running,   <span class=m>0</span> sleeping,   <span class=m>0</span> stopped,   <span class=m>0</span> zombie
%Cpu<span class=o>(</span>s<span class=o>)</span>:  <span class=m>0</span>.4 us,  <span class=m>0</span>.3 sy,  <span class=m>0</span>.0 ni, <span class=m>99</span>.2 id,  <span class=m>0</span>.1 wa,  <span class=m>0</span>.0 hi,  <span class=m>0</span>.0 si,  <span class=m>0</span>.0 st
KiB Mem :  <span class=m>2046932</span> total,   <span class=m>535896</span> free,   <span class=m>307196</span> used,  <span class=m>1203840</span> buff/cache
KiB Swap:  <span class=m>1048572</span> total,  <span class=m>1042292</span> free,     <span class=m>6280</span> used.  <span class=m>1574880</span> avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
    <span class=m>1</span> root      <span class=m>20</span>   <span class=m>0</span>   <span class=m>36480</span>   <span class=m>2940</span>   <span class=m>2584</span> R   <span class=m>0</span>.0  <span class=m>0</span>.1   <span class=m>0</span>:00.03 top
</pre></div> </td></tr></table> <p>Now we got something we can work with. If something would tell this Container to stop, it will tell our only running process so it is sure to reach the correct one!</p> <h3 id=gotchas>Gotchas<a class=headerlink href=#gotchas title="Permanent link">&para;</a></h3> <p>Knowing we can use the exec form for our goal - gracefully shutting down our container - we can move on to the next part of our efforts. For the sake of imparting you with some hard learned lessons, we will explore two gotchas. They're optional, so you can also choose to skip to <em>Make Sure Your Process Listens</em>.</p> <h4 id=docker-exec-form-with-parameters>Docker exec form with parameters<a class=headerlink href=#docker-exec-form-with-parameters title="Permanent link">&para;</a></h4> <p>A caveat with the exec form is that it doesn't interpolate parameters.</p> <p>You can try the following:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>FROM</span><span class=s> ubuntu:18.04</span>
<span class=k>ENV</span> <span class=nv>PARAM</span><span class=o>=</span><span class=s2>&quot;-b&quot;</span>
<span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&quot;top&quot;</span><span class=p>,</span> <span class=s2>&quot;${PARAM}&quot;</span><span class=p>]</span>
</pre></div> </td></tr></table> <p>Then build and run it:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>docker image build --tag exec-param .
docker run --name exec-form --rm exec-param
</pre></div> </td></tr></table> <p>This should yield the following:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>/bin/sh: <span class=m>1</span>: <span class=o>[</span>top: not found
</pre></div> </td></tr></table> <p>This is where Docker created a mix between the two styles. It allows you to create an <em>Entrypoint</em> with a shell command - performing interpolation - but executing it as an exec form. This can be done by prefixing the shell form, with, you guessed it, <em>exec</em>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>FROM</span><span class=s> ubuntu:18.04</span>
<span class=k>ENV</span> <span class=nv>PARAM</span><span class=o>=</span><span class=s2>&quot;-b&quot;</span>
<span class=k>ENTRYPOINT</span> <span class=nb>exec</span> <span class=s2>&quot;top&quot;</span> <span class=s2>&quot;</span><span class=si>${</span><span class=nv>PARAM</span><span class=si>}</span><span class=s2>&quot;</span>
</pre></div> </td></tr></table> <p>Then build and run it:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>docker image build --tag exec-param .
docker run --name exec-form --rm exec-param
</pre></div> </td></tr></table> <p>This will return the exact same as if we would've run <code class=codehilite><span class=n>ENTRYPOINT</span> <span class=p>[</span><span class=ss>&quot;top&quot;</span><span class=p>,</span> <span class=ss>&quot;-b&quot;</span><span class=p>]</span></code>.</p> <p>Now you can also override the param, by using the environment variable flag.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>docker image build --tag exec-param .
docker run --name exec-form --rm -e <span class=nv>PARAM</span><span class=o>=</span><span class=s2>&quot;help&quot;</span> exec-param
</pre></div> </td></tr></table> <p>Resulting in top's help string.</p> <h4 id=the-special-case-of-alpine>The special case of Alpine<a class=headerlink href=#the-special-case-of-alpine title="Permanent link">&para;</a></h4> <p>One of the main <a href=https://docs.docker.com/develop/develop-images/dockerfile_best-practices/ >best practices for Dockerfiles</a>, is to make them as small as possible. The easiest way to do this is to start with a minimal image. This is where <a href=https://hub.docker.com/_/alpine/ >Alpine Linux</a> comes in. We will revisit out shell form example, but replace ubuntu with alpine.</p> <p>Create the following Dockerfile.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>FROM</span><span class=s> alpine:3.8</span>
<span class=k>ENTRYPOINT</span> top -b
</pre></div> </td></tr></table> <p>Then build and run it.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>docker image build --tag exec-param .
docker run --name exec-form --rm -e <span class=nv>PARAM</span><span class=o>=</span><span class=s2>&quot;help&quot;</span> exec-param
</pre></div> </td></tr></table> <p>This yields the following output.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span>Mem: 1509068K used, 537864K free, 640K shrd, 126756K buff, 1012436K cached
CPU:   <span class=m>0</span>% usr   <span class=m>0</span>% sys   <span class=m>0</span>% nic <span class=m>100</span>% idle   <span class=m>0</span>% io   <span class=m>0</span>% irq   <span class=m>0</span>% sirq
Load average: <span class=m>0</span>.00 <span class=m>0</span>.00 <span class=m>0</span>.00 <span class=m>2</span>/404 <span class=m>5</span>
  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND
    <span class=m>1</span>     <span class=m>0</span> root     R     <span class=m>1516</span>   <span class=m>0</span>%   <span class=m>0</span>   <span class=m>0</span>% top -b
</pre></div> </td></tr></table> <p>Aside from <strong>top</strong>'s output looking a bit different, there is only one command.</p> <p>Alpine Linux helps us avoid the problem of shell form altogether!</p> <h2 id=make-sure-your-process-listens>Make Sure Your Process Listens<a class=headerlink href=#make-sure-your-process-listens title="Permanent link">&para;</a></h2> <p>It is excellent if your tenants are all signed up, know their rights and obligations. But you can't contact them when something happens, how will they ever know when to act?</p> <p>Translating that into our process. It starts and can be told to shut down, but does it process listen? Can it interpret the message it gets from Docker or Kubernetes? And if it does, can it relay the message correctly to its Child Processes? In order for your process to gracefully shutdown, it should know when to do so. As such, it should listen not only for itself but also on behalf of its children - yours never do anything wrong though!</p> <p>Some processes do, but many aren't designed to <a href=https://www.fpcomplete.com/blog/2016/10/docker-demons-pid1-orphans-zombies-signals>listen</a> or tell <a href=https://blog.phusion.nl/2015/01/20/docker-and-the-pid-1-zombie-reaping-problem>their Children</a>. They expect someone else to listen for them and tell them and their children - process managers.</p> <p>In order to listen to these <strong>signals</strong>, we can call in the help of others. We will look at two options.</p> <ul> <li>we let Docker manage the process and its children</li> <li>we use a process manager</li> </ul> <h3 id=let-docker-manage-it-for-us>Let Docker manage it for us<a class=headerlink href=#let-docker-manage-it-for-us title="Permanent link">&para;</a></h3> <p>If you're not using Docker to run or manage your containers, you should skip to <em>Depend on a process manager</em>.</p> <p>Docker has a build in feature, that it uses a lightweight process manager to help you.</p> <p>So if you're running your images with Docker itself, either directly or via Compose or Swarm, you're fine. You can use the init flag in your run command or your compose file.</p> <p>Please, note that the below examples require a certain minimum version of Docker.</p> <ul> <li>run - 1.13+</li> <li><a href=https://docs.docker.com/compose/compose-file/compose-file-v2/#image>compose (v 2.2)</a> - 1.13.0+</li> <li><a href=https://docs.docker.com/compose/compose-file/#init>swarm (v 3.7)</a> - 18.06.0+</li> </ul> <h4 id=with-docker-run>With Docker Run<a class=headerlink href=#with-docker-run title="Permanent link">&para;</a></h4> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>docker run --rm -ti --init caladreas/dui
</pre></div> </td></tr></table> <h4 id=with-docker-compose>With Docker Compose<a class=headerlink href=#with-docker-compose title="Permanent link">&para;</a></h4> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>version</span><span class=p>:</span> <span class=s>&#39;2.2&#39;</span>
<span class=nt>services</span><span class=p>:</span>
    <span class=nt>web</span><span class=p>:</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">caladreas/java-docker-signal-demo:no-tini</span>
        <span class=nt>init</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div> </td></tr></table> <h4 id=with-docker-swarm>With Docker Swarm<a class=headerlink href=#with-docker-swarm title="Permanent link">&para;</a></h4> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>version</span><span class=p>:</span> <span class=s>&#39;3.7&#39;</span>
<span class=nt>services</span><span class=p>:</span>
    <span class=nt>web</span><span class=p>:</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">caladreas/java-docker-signal-demo:no-tini</span>
        <span class=nt>init</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div> </td></tr></table> <p>Relying on Docker does create a dependency on how your container runs. It only runs correctly in Docker-related technologies (run, compose, swarm) and only if the proper versions are available.</p> <p>Creating either a different experience for users running your application somewhere else or not able to meet the version requirements. So maybe another solution is to bake a process manager into your image and guarantee its behavior.</p> <h3 id=depend-on-a-process-manager>Depend on a process manager<a class=headerlink href=#depend-on-a-process-manager title="Permanent link">&para;</a></h3> <p>One of our goals for Docker images is to keep them small. We should look for a lightweight process manager. It does not have too many a whole machine worth or processes, just one and perhaps some children.</p> <p>Here we would like to introduce you to <a href=https://github.com/krallin/tini>Tini</a>, a lightweight process manager <a href=https://github.com/krallin/tini/issues/8>designed for this purpose</a>. It is a very successful and widely adopted process manager in the Docker world. So successful, that the before mentioned init flags from Docker are implemented by baking <a href=https://github.com/krallin/tini/issues/81>Tini into Docker</a>.</p> <h4 id=debian-example>Debian example<a class=headerlink href=#debian-example title="Permanent link">&para;</a></h4> <p>For brevity, the build process is excluded, and for image size, we use Debian slim instead of default Debian.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>FROM</span><span class=s> debian:stable-slim</span>
<span class=k>ENV</span> TINI_VERSION v0.18.0
<span class=k>ADD</span> https://github.com/krallin/tini/releases/download/<span class=si>${</span><span class=nv>TINI_VERSION</span><span class=si>}</span>/tini /tini
<span class=k>RUN</span> chmod +x /tini
<span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&quot;/tini&quot;</span><span class=p>,</span> <span class=s2>&quot;-vv&quot;</span><span class=p>,</span><span class=s2>&quot;-g&quot;</span><span class=p>,</span> <span class=s2>&quot;--&quot;</span><span class=p>,</span> <span class=s2>&quot;/usr/bin/dui/bin/dui&quot;</span><span class=p>,</span><span class=s2>&quot;-XX:+UseCGroupMemoryLimitForHeap&quot;</span><span class=p>,</span> <span class=s2>&quot;-XX:+UnlockExperimentalVMOptions&quot;</span><span class=p>]</span>
<span class=k>COPY</span> --from<span class=o>=</span>build /usr/bin/dui-image/ /usr/bin/dui
</pre></div> </td></tr></table> <h4 id=alpine-example>Alpine example<a class=headerlink href=#alpine-example title="Permanent link">&para;</a></h4> <p>Alpine Linux works wonders for Docker images, so to improve our lives, you can very easily install it if you want.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>FROM</span><span class=s> alpine</span>
<span class=k>RUN</span> apk add --no-cache tini
<span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&quot;/sbin/tini&quot;</span><span class=p>,</span> <span class=s2>&quot;-vv&quot;</span><span class=p>,</span><span class=s2>&quot;-g&quot;</span><span class=p>,</span><span class=s2>&quot;-s&quot;</span><span class=p>,</span> <span class=s2>&quot;--&quot;</span><span class=p>]</span>
<span class=k>CMD</span> <span class=p>[</span><span class=s2>&quot;top -b&quot;</span><span class=p>]</span>
</pre></div> </td></tr></table> <h2 id=how-to-be-told-what-you-want-to-hear>How To Be Told What You Want To Hear<a class=headerlink href=#how-to-be-told-what-you-want-to-hear title="Permanent link">&para;</a></h2> <p>You've made it this far; your tenets are reachable so you can inform them if they need to act. However, there's another problem lurking around the corner. Do they speak your language?</p> <p>Our process now starts knowing it can be talked to, it has someone who takes care of listening for it and its children. Now we need to make sure it can understand what it hears, it should be able to handle the incoming signals. We have two main ways of doing this.</p> <ul> <li><strong>Handle signals as they come</strong>: we should make sure our process deal with the signals as they come</li> <li><strong>State the signals we want</strong>: we can also tell up front, which signals we want to hear and put the burden of translation on our callers</li> </ul> <p>For more details on the subject of Signals and Docker, please read this excellent blog from <a href=https://medium.com/@gchudnov/trapping-signals-in-docker-containers-7a57fdda7d86>Grigorii Chudnov</a>.</p> <h3 id=handle-signals-as-they-come>Handle signals as they come<a class=headerlink href=#handle-signals-as-they-come title="Permanent link">&para;</a></h3> <p>Handling process signals depend on your application, programming language or framework.</p> <h3 id=state-the-signals-we-want>State the signals we want<a class=headerlink href=#state-the-signals-we-want title="Permanent link">&para;</a></h3> <p>Sometimes your language or framework of choice, doesn't handle signals all that well. It might be very rigid in what it does with specific signals, removing your ability to do the right thing. Of course, not all languages or frameworks are designed with Docker container or Microservices in mind, are yet to catch up to this more dynamic environment.</p> <p>Luckily Docker and Kubernetes allow you to specify what signal too sent to your process.</p> <h4 id=docker-run>Docker run<a class=headerlink href=#docker-run title="Permanent link">&para;</a></h4> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>docker run --rm -ti --init --stop-signal<span class=o>=</span>SIGINT <span class=se>\</span>
   caladreas/java-docker-signal-demo
</pre></div> </td></tr></table> <h4 id=docker-composeswarm>Docker compose/swarm<a class=headerlink href=#docker-composeswarm title="Permanent link">&para;</a></h4> <p>Docker's compose file format allows you to specify a <a href=https://docs.docker.com/compose/compose-file/compose-file-v2/#stop_signal>stop signal</a>. This is the signal sent when the container is stopped in a normal fashion. Normal in this case, meaning <code class=codehilite><span class=n>docker</span> <span class=n>stop</span></code> or when docker itself determines it should stop the container.</p> <p>If you forcefully remove the container, for example with <code class=codehilite><span class=n>docker</span> <span class=n>rm</span> <span class=o>-</span><span class=n>f</span></code>  it will directly kill the process, so don't do that.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>version</span><span class=p>:</span> <span class=s>&#39;2.2&#39;</span>
<span class=nt>services</span><span class=p>:</span>
    <span class=nt>web</span><span class=p>:</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">caladreas/java-docker-signal-demo</span>
        <span class=nt>stop_signal</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">SIGINT</span>
        <span class=nt>stop_grace_period</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">15s</span>
</pre></div> </td></tr></table> <p>If you run this with <code class=codehilite><span class=n>docker</span><span class=o>-</span><span class=n>compose</span> <span class=n>up</span></code> and then in a second terminal, stop the container, you will see something like this.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class=code><div class=codehilite><pre><span></span>web_1  <span class=p>|</span> HelloWorld!
web_1  <span class=p>|</span> Shutdown hook called!
web_1  <span class=p>|</span> We<span class=s1>&#39;re told to stop early...</span>
<span class=s1>web_1  | java.lang.InterruptedException: sleep interrupted</span>
<span class=s1>web_1  |    at java.base/java.lang.Thread.sleep(Native Method)</span>
<span class=s1>web_1  |    at joostvdg.demo.signal@1.0/com.github.joostvdg.demo.signal.HelloWorld.printHelloWorld(Unknown Source)</span>
<span class=s1>web_1  |    at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)</span>
<span class=s1>web_1  |    at java.base/java.util.concurrent.FutureTask.run(Unknown Source)</span>
<span class=s1>web_1  |    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)</span>
<span class=s1>web_1  |    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)</span>
<span class=s1>web_1  |    at java.base/java.lang.Thread.run(Unknown Source)</span>
<span class=s1>web_1  | [DEBUG tini (1)] Passing signal: &#39;</span>Interrupt<span class=s1>&#39;</span>
<span class=s1>web_1  | [DEBUG tini (1)] Received SIGCHLD</span>
<span class=s1>web_1  | [DEBUG tini (1)] Reaped child with pid: &#39;</span><span class=m>7</span><span class=s1>&#39;</span>
<span class=s1>web_1  | [INFO  tini (1)] Main child exited with signal (with signal &#39;</span>Interrupt<span class=err>&#39;</span><span class=o>)</span>
</pre></div> </td></tr></table> <h4 id=kubernetes>Kubernetes<a class=headerlink href=#kubernetes title="Permanent link">&para;</a></h4> <p>In Kubernetes we can make use of <a href=https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/ >Container Lifecycle Hooks</a> to manage how our container should be stopped. We could, for example, send a SIGINT (interrupt) to tell our application to stop.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class=nt>metadata</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">java-signal-demo</span>
    <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
    <span class=nt>labels</span><span class=p>:</span>
        <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">java-signal-demo</span>
<span class=nt>spec</span><span class=p>:</span>
    <span class=nt>replicas</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class=nt>template</span><span class=p>:</span>
        <span class=nt>metadata</span><span class=p>:</span>
            <span class=nt>labels</span><span class=p>:</span>
                <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">java-signal-demo</span>
        <span class=nt>spec</span><span class=p>:</span>
            <span class=nt>containers</span><span class=p>:</span>
            <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">main</span>
              <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">caladreas/java-docker-signal-demo</span>
              <span class=nt>lifecycle</span><span class=p>:</span>
                  <span class=nt>preStop</span><span class=p>:</span>
                      <span class=nt>exec</span><span class=p>:</span>
                          <span class=nt>command</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;killall&quot;</span><span class="p p-Indicator">,</span> <span class=s>&quot;java&quot;</span> <span class="p p-Indicator">,</span> <span class=s>&quot;-INT&quot;</span><span class="p p-Indicator">]</span>
            <span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>
</pre></div> </td></tr></table> <p>When you create this as deployment.yml, create and delete it - <code class=codehilite><span class=n>kubectl</span> <span class=n>apply</span> <span class=o>-</span><span class=n>f</span> <span class=n>deployment</span><span class=p>.</span><span class=n>yml</span></code> / <code class=codehilite><span class=n>kubectl</span> <span class=k>delete</span> <span class=o>-</span><span class=n>f</span> <span class=n>deployment</span><span class=p>.</span><span class=n>yml</span></code> - you will see the same behavior.</p> <h2 id=how-to-be-told-when-you-want-to-hear-it>How To Be Told When You Want To Hear It<a class=headerlink href=#how-to-be-told-when-you-want-to-hear-it title="Permanent link">&para;</a></h2> <p>Our process now will now start knowing it will hear what it wants to hear. But we now have to make sure we hear it when we need to hear it. An intervention is excellent when you can still be saved, but it is a bit useless if you're already dead.</p> <h3 id=docker>Docker<a class=headerlink href=#docker title="Permanent link">&para;</a></h3> <p>You can either configure your health check in your <a href=https://docs.docker.com/engine/reference/builder/#healthcheck>Dockerfile</a> or configure it in your <a href=https://docs.docker.com/compose/compose-file/#healthcheck>docker-compose.yml</a> for either compose or swarm.</p> <p>Considering only Docker can use the health check in your Dockerfile, it is strongly recommended to have health checks in your application and document how they can be used.</p> <h3 id=kubernetes_1>Kubernetes<a class=headerlink href=#kubernetes_1 title="Permanent link">&para;</a></h3> <p>In Kubernetes we have the concept of <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes>Container Probes</a>. This allows you to configure whether your container is ready (readinessProbe) to be used and if it is still working as expected (livenessProbe).</p> <h2 id=__comments>Comments</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://joostvdg.github.io/blogs/docker-graceful-shutdown/";
      this.page.identifier =
        "/blogs/docker-graceful-shutdown/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//joostvdg-github-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../../other/shell/ title=Shell class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> Shell </span> </div> </a> <a href=../jenkins-pipeline-docker-alternatives/ title="Pipelines with Docker Alternatives" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Pipelines with Docker Alternatives </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2019 Joost van der Griendt </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <a href=https://github.com/joostvdg class="md-footer-social__link fa fa-github"></a> <a href=https://twitter.com/joost_vdg class="md-footer-social__link fa fa-twitter"></a> <a href=https://linkedin.com/in/joostvdg class="md-footer-social__link fa fa-linkedin"></a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.245445c6.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> </body> </html>