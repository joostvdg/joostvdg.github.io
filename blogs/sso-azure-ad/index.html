<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Use Azure AD For Single Sign On For Jenkins / CloudBees Core"><link href=https://joostvdg.github.io/blogs/sso-azure-ad/ rel=canonical><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.2"><title>Azure AD For CloudBees Core</title><link rel=stylesheet href=../../assets/stylesheets/application.30686662.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#fb8c00><script src=../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-145385967-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-primary=orange data-md-color-accent=red> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#azure-ad-cloudbees-core tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-header-nav__button md-logo"> <i class=md-icon>public</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> J's Software Development Pages </span> <span class=md-header-nav__topic> Azure AD For CloudBees Core </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../jenkins-pipeline-support-tool/ class="md-tabs__link md-tabs__link--active"> Blogs </a> </li> <li class=md-tabs__item> <a href=../../cloudbees/sso-azure-ad/ class=md-tabs__link> CICD </a> </li> <li class=md-tabs__item> <a href=../../kubernetes/ class=md-tabs__link> Containers </a> </li> <li class=md-tabs__item> <a href=../../cloud/automation-pulumi/ class=md-tabs__link> Cloud </a> </li> <li class=md-tabs__item> <a href=../../certificates/lets-encrypt-k8s/ class=md-tabs__link> SWE </a> </li> <li class=md-tabs__item> <a href=../../java/ class=md-tabs__link> Java </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-nav__button md-logo"> <i class=md-icon>public</i> </a> J's Software Development Pages </label> <div class=md-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> Home </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-1> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Me class=md-nav__link> Me </a> </li> <li class=md-nav__item> <a href=../../other/mkdocs/ title="MKDocs (This Static Website)" class=md-nav__link> MKDocs (This Static Website) </a> </li> <li class=md-nav__item> <a href=../../other/vim/ title=VIM class=md-nav__link> VIM </a> </li> <li class=md-nav__item> <a href=../../other/shell/ title=Shell class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Blogs </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Blogs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../jenkins-pipeline-support-tool/ title="Jenkins Pipeline Support Tools" class=md-nav__link> Jenkins Pipeline Support Tools </a> </li> <li class=md-nav__item> <a href=../graceful-shutdown/ title="Docker Graceful Shutdown" class=md-nav__link> Docker Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../docker-alternatives/ title="Pipelines with Docker Alternatives" class=md-nav__link> Pipelines with Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../k8s-lets-encrypt/ title="Let's Encrypt for Kubernetes Apps" class=md-nav__link> Let's Encrypt for Kubernetes Apps </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> CloudBees SSO Azure AD </label> <a href=./ title="CloudBees SSO Azure AD" class="md-nav__link md-nav__link--active"> CloudBees SSO Azure AD </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=#configure-azure class=md-nav__link> Configure Azure </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#steps-to-execute class=md-nav__link> Steps to execute </a> </li> <li class=md-nav__item> <a href=#information-to-note-down class=md-nav__link> Information To Note Down </a> </li> <li class=md-nav__item> <a href=#visual-guide class=md-nav__link> Visual Guide </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-new-app-registration class=md-nav__link> Create New App Registration </a> </li> <li class=md-nav__item> <a href=#app-registration-data-to-write-down class=md-nav__link> App Registration Data To Write Down </a> </li> <li class=md-nav__item> <a href=#app-id class=md-nav__link> App ID </a> </li> <li class=md-nav__item> <a href=#api-permissions class=md-nav__link> API Permissions </a> </li> <li class=md-nav__item> <a href=#update-manifest class=md-nav__link> Update Manifest </a> </li> <li class=md-nav__item> <a href=#retrieve-group-object-id class=md-nav__link> Retrieve Group Object ID </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-jenkins class=md-nav__link> Configure Jenkins </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#steps class=md-nav__link> Steps </a> </li> <li class=md-nav__item> <a href=#visual-guide_1 class=md-nav__link> Visual Guide </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configure-security class=md-nav__link> Configure Security </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configure-rbac class=md-nav__link> Configure RBAC </a> </li> <li class=md-nav__item> <a href=#configure-saml class=md-nav__link> Configure SAML </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fields class=md-nav__link> Fields </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-rbac-groups class=md-nav__link> Configure RBAC Groups </a> </li> <li class=md-nav__item> <a href=#xml-config class=md-nav__link> XML Config </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#logout-url class=md-nav__link> Logout URL </a> </li> <li class=md-nav__item> <a href=#for-when-you-mess-up class=md-nav__link> For When You Mess Up </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#on-cloudbees-core-modern-kubernetes class=md-nav__link> On CloudBees Core Modern / Kubernetes </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> References </a> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../kubernetes-sso-keycloak/ title="Kubernetes SSO Keycloak" class=md-nav__link> Kubernetes SSO Keycloak </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-8 type=checkbox id=nav-2-8> <label class=md-nav__link for=nav-2-8> Jenkins Monitoring Kubernetes </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-8> Jenkins Monitoring Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/introduction/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/prepare/ title="Prepare Environment" class=md-nav__link> Prepare Environment </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/install/ title="Install Tools" class=md-nav__link> Install Tools </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/metrics/ title=Metrics class=md-nav__link> Metrics </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/alerts/ title=Alerts class=md-nav__link> Alerts </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/pipeline/ title=Pipeline class=md-nav__link> Pipeline </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/dashboard/ title=Dashboard class=md-nav__link> Dashboard </a> </li> <li class=md-nav__item> <a href=../monitor-jenkins-on-k8s/cloudbees/ title=CloudBees class=md-nav__link> CloudBees </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../k8s-crd/ title="Create your own k8s resource" class=md-nav__link> Create your own k8s resource </a> </li> <li class=md-nav__item> <a href=../dockercon-eu-2018/ title="DockerCon EU 2018" class=md-nav__link> DockerCon EU 2018 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> CICD </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> CICD </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-1 type=checkbox id=nav-3-1> <label class=md-nav__link for=nav-3-1> CloudBees </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-1> CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloudbees/sso-azure-ad/ title="Single Sign On - AzureAD" class=md-nav__link> Single Sign On - AzureAD </a> </li> <li class=md-nav__item> <a href=../../cloudbees/teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-gke-helm/ title="CloudBees Core on GKE" class=md-nav__link> CloudBees Core on GKE </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-eks/ title="CloudBees Core on EKS" class=md-nav__link> CloudBees Core on EKS </a> </li> <li class=md-nav__item> <a href=../../cloudbees/cbc-team-namespace/ title="Team Master Namespace" class=md-nav__link> Team Master Namespace </a> </li> <li class=md-nav__item> <a href=../../cloudbees/multi-cluster/ title=Multi-Cluster class=md-nav__link> Multi-Cluster </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-2 type=checkbox id=nav-3-2> <label class=md-nav__link for=nav-3-2> Jenkins X </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-2> Jenkins X </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/build-packs/ title="Build Packs" class=md-nav__link> Build Packs </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jx-pipelines/ title="Jenkins X Pipelines" class=md-nav__link> Jenkins X Pipelines </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot/ title="JX Boot GKE" class=md-nav__link> JX Boot GKE </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot-aks/ title="JX Boot AKS" class=md-nav__link> JX Boot AKS </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/aks-boot-core/ title="JX Boot & CloudBees Core" class=md-nav__link> JX Boot & CloudBees Core </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hello-world/ title=HelloWorld class=md-nav__link> HelloWorld </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/maven/ title=Maven class=md-nav__link> Maven </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hybrid/ title=Hybrid class=md-nav__link> Hybrid </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/kubernetes-days/ title="Example For Console Reel" class=md-nav__link> Example For Console Reel </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-3 type=checkbox id=nav-3-3> <label class=md-nav__link for=nav-3-3> Jenkins </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-3> Jenkins </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins/ title=Intro class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jobdsl/ title=JobDSL class=md-nav__link> JobDSL </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jenkins-jobs-builder/ title=JenkinsJobsBuilder class=md-nav__link> JenkinsJobsBuilder </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4> <label class=md-nav__link for=nav-3-4> Jenkins Pipelines </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-4> Jenkins Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline/job-types/ title="Job Types" class=md-nav__link> Job Types </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/kaniko-pipelines/ title="Build Docker Image Kaniko" class=md-nav__link> Build Docker Image Kaniko </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/podtemplate-dind/ title="PodTemplate With Docker-In-Docker" class=md-nav__link> PodTemplate With Docker-In-Docker </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/jenkins-parallel-pipeline/ title="Parallel Pipelines" class=md-nav__link> Parallel Pipelines </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/core-concepts/ title="Core Concepts" class=md-nav__link> Core Concepts </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/artifactory-integration/ title="Artifactory Integration" class=md-nav__link> Artifactory Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/declarative-pipeline/ title="Pipeline (declarative)" class=md-nav__link> Pipeline (declarative) </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/groovy-pipeline/ title="Groovy DSL Pipeline" class=md-nav__link> Groovy DSL Pipeline </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/global-shared-library/ title="Pipeline Libraries" class=md-nav__link> Pipeline Libraries </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/ide-integration-pipeline-dsl/ title="DSL IDE Integration" class=md-nav__link> DSL IDE Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/input/ title=Input class=md-nav__link> Input </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-5 type=checkbox id=nav-3-5> <label class=md-nav__link for=nav-3-5> Jenkins Pipeline Examples </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-5> Jenkins Pipeline Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/ title=Index class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-alternatives/ title="Docker Alternatives" class=md-nav__link> Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/maven-declarative/ title="Maven Declarative" class=md-nav__link> Maven Declarative </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-declarative/ title="Docker Declarative" class=md-nav__link> Docker Declarative </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Containers </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Containers </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-1 type=checkbox id=nav-4-1> <label class=md-nav__link for=nav-4-1> Kubernetes (K8S) </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-1> Kubernetes (K8S) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../kubernetes/cka-exam-prep/ title="CKA Exam prep" class=md-nav__link> CKA Exam prep </a> </li> <li class=md-nav__item> <a href=../../kubernetes/tools/ title=Tools class=md-nav__link> Tools </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-2 type=checkbox id=nav-4-2> <label class=md-nav__link for=nav-4-2> K8S Public Services </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-2> K8S Public Services </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/distributions/install-gke/ title=GKE class=md-nav__link> GKE </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/gke-terraform/ title="GKE Terraform" class=md-nav__link> GKE Terraform </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/eks-eksctl/ title="AWS EKS" class=md-nav__link> AWS EKS </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-cli/ title="AKS CLI" class=md-nav__link> AKS CLI </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-terraform/ title="AKS Terraform" class=md-nav__link> AKS Terraform </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> K8S Hard Way - GCE </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-3> K8S Hard Way - GCE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/ title="Installer Preparation" class=md-nav__link> Installer Preparation </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/terraform-compute/ title="Create GCE resources" class=md-nav__link> Create GCE resources </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/certificates/ title="Prepare Certificates" class=md-nav__link> Prepare Certificates </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/kubeconfigs/ title="Prepare Kubeconfigs" class=md-nav__link> Prepare Kubeconfigs </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/encryption/ title="Encryption configuration" class=md-nav__link> Encryption configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/etcd/ title="ETCD configuration" class=md-nav__link> ETCD configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/controller/ title="Controller Config" class=md-nav__link> Controller Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/worker/ title="Worker Config" class=md-nav__link> Worker Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/remote-access/ title="Remote access" class=md-nav__link> Remote access </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/network/ title="Network config" class=md-nav__link> Network config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/debug/ title=Debug class=md-nav__link> Debug </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-4 type=checkbox id=nav-4-4> <label class=md-nav__link for=nav-4-4> Docker </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-4> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docker/graceful-shutdown/ title="Graceful Shutdown" class=md-nav__link> Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../docker/build-kit/ title=BuildKit class=md-nav__link> BuildKit </a> </li> <li class=md-nav__item> <a href=../../docker/multi-stage-builds/ title="Multi-Stage Builds(TBD)" class=md-nav__link> Multi-Stage Builds(TBD) </a> </li> <li class=md-nav__item> <a href=../../docker/swarm/ title="Swarm (mode) (TBD)" class=md-nav__link> Swarm (mode) (TBD) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-5 type=checkbox id=nav-4-5> <label class=md-nav__link for=nav-4-5> Linux </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-5> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../linux/systemd/ title=SystemD class=md-nav__link> SystemD </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Cloud </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloud/automation-pulumi/ title="Automation - Pulumi" class=md-nav__link> Automation - Pulumi </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> SWE </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-6> SWE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../certificates/lets-encrypt-k8s/ title="Let's Encrypt K8S" class=md-nav__link> Let's Encrypt K8S </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6-2 type=checkbox id=nav-6-2> <label class=md-nav__link for=nav-6-2> Software Engineering </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-6-2> Software Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../swe/important-concepts/ title="Important Concepts" class=md-nav__link> Important Concepts </a> </li> <li class=md-nav__item> <a href=../../swe/naming/ title=Naming class=md-nav__link> Naming </a> </li> <li class=md-nav__item> <a href=../../swe/distributed/ title="Distributed Computing" class=md-nav__link> Distributed Computing </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6-3 type=checkbox id=nav-6-3> <label class=md-nav__link for=nav-6-3> Productivity </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-6-3> Productivity </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../productivity/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../productivity/incidents/ title=Incidents class=md-nav__link> Incidents </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class=md-nav__link for=nav-7> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-7> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../java/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../keep-watching/ title="Spring Boot App" class=md-nav__link> Spring Boot App </a> </li> <li class=md-nav__item> <a href=../../java/networking/ title="Java Networking" class=md-nav__link> Java Networking </a> </li> <li class=md-nav__item> <a href=../../java/concurrency/ title="Java Concurrency" class=md-nav__link> Java Concurrency </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=#configure-azure class=md-nav__link> Configure Azure </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#steps-to-execute class=md-nav__link> Steps to execute </a> </li> <li class=md-nav__item> <a href=#information-to-note-down class=md-nav__link> Information To Note Down </a> </li> <li class=md-nav__item> <a href=#visual-guide class=md-nav__link> Visual Guide </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-new-app-registration class=md-nav__link> Create New App Registration </a> </li> <li class=md-nav__item> <a href=#app-registration-data-to-write-down class=md-nav__link> App Registration Data To Write Down </a> </li> <li class=md-nav__item> <a href=#app-id class=md-nav__link> App ID </a> </li> <li class=md-nav__item> <a href=#api-permissions class=md-nav__link> API Permissions </a> </li> <li class=md-nav__item> <a href=#update-manifest class=md-nav__link> Update Manifest </a> </li> <li class=md-nav__item> <a href=#retrieve-group-object-id class=md-nav__link> Retrieve Group Object ID </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-jenkins class=md-nav__link> Configure Jenkins </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#steps class=md-nav__link> Steps </a> </li> <li class=md-nav__item> <a href=#visual-guide_1 class=md-nav__link> Visual Guide </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configure-security class=md-nav__link> Configure Security </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configure-rbac class=md-nav__link> Configure RBAC </a> </li> <li class=md-nav__item> <a href=#configure-saml class=md-nav__link> Configure SAML </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fields class=md-nav__link> Fields </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-rbac-groups class=md-nav__link> Configure RBAC Groups </a> </li> <li class=md-nav__item> <a href=#xml-config class=md-nav__link> XML Config </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#logout-url class=md-nav__link> Logout URL </a> </li> <li class=md-nav__item> <a href=#for-when-you-mess-up class=md-nav__link> For When You Mess Up </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#on-cloudbees-core-modern-kubernetes class=md-nav__link> On CloudBees Core Modern / Kubernetes </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> References </a> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/joostvdg/joostvdg.github.io/edit/master/docs/blogs/sso-azure-ad.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1 id=azure-ad-cloudbees-core>Azure AD &amp; CloudBees Core<a class=headerlink href=#azure-ad-cloudbees-core title="Permanent link">&para;</a></h1> <p>In this article we're going to configure Azure AD as Single-Sign-Solution for CloudBees Core. The configuration rests on three points; 1) Azure AD, 2) Jenkins' SAML plugin, and 3) CloudBees Core's Role Base Access Control or RBAC for short.</p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>Currently there's a discrepency between the TimeToLive (TTL) of the RefreshToken in Azure AD and the default configuration in the SAML plugin.</p> <p>This creates the problem that you can be logged in, in Azure, but when going to Jenkins you get the Logged Out page. The only way to log back in, is to logout in Azure and back in.</p> <p>The reason is as follows:</p> <blockquote> <p>The max lifetime of the Access Token in Azure AD seems to be 24 hours where the refresh token can live for a maximum of 14 days (if the access token expires the refresh token is used to try to obtain a new access token). The Jenkins setting in Configure Global Security &gt; SAML Identity Provider Settings &gt; Maximum Authentication Lifetime is 24 hours (86400 in seconds) upping this to 1209600 (which is 14 days in seconds/the max lifetime of the Refresh Token).</p> </blockquote> <p>The recommended resolution is to set <code class=codehilite><span class=n>Maximum</span> <span class=n>Authentication</span> <span class=n>Lifetime</span></code> to the same value of your RefreshToken TTL. If you haven't changed this in Azure AD, it is <code class=codehilite><span class=mi>1209600</span></code>.</p> <p><code class=codehilite><span class=n>Manage</span> <span class=n>Jenkins</span></code> -&gt; <code class=codehilite><span class=n>Configure</span> <span class=k>Global</span> <span class=k>Security</span></code> &gt; <code class=codehilite><span class=n>SAML</span> <span class=k>Identity</span> <span class=n>Provider</span> <span class=n>Settings</span></code> &gt; <code class=codehilite><span class=n>Maximum</span> <span class=n>Authentication</span> <span class=n>Lifetime</span></code> = <code class=codehilite><span class=mi>1209600</span></code></p> </div> <h2 id=prerequisites>Prerequisites<a class=headerlink href=#prerequisites title="Permanent link">&para;</a></h2> <p>Before we start, there are some requirements.</p> <ul> <li>a running CloudBees Core Operations Center instance</li> <li>this instance is accessible via <code class=codehilite><span class=n>https</span><span class=p>.</span></code><ul> <li>if you do not have a valid certificate and you're running on Kubernetes <a href=/certificates/lets-encrypt-k8s/ >take a look at my cert-manager guide</a></li> <li>Let's Encrypt can now also work with <a href=nip.io>nip.io</a> addresses</li> </ul> </li> <li>active Azure subscription</li> <li>have an Azure subscription Administrator on hand</li> </ul> <h2 id=configure-azure>Configure Azure<a class=headerlink href=#configure-azure title="Permanent link">&para;</a></h2> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>We use <code class=codehilite><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>cloudbees</span><span class=o>-</span><span class=n>core</span><span class=p>.</span><span class=n>example</span><span class=p>.</span><span class=n>com</span></code> as the example URL for CloudBees Core. Please replace the domain to your actual domain in all the examples!</p> </div> <h3 id=steps-to-execute>Steps to execute<a class=headerlink href=#steps-to-execute title="Permanent link">&para;</a></h3> <p>We do the following steps on the Azure side.</p> <ul> <li>create the Azure Active Directory</li> <li>create users and groups</li> <li>create App Registration<ul> <li>URL: <code class=codehilite><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>cloudbees</span><span class=o>-</span><span class=n>core</span><span class=p>.</span><span class=n>example</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>cjoc</span><span class=o>/</span><span class=n>securityRealm</span><span class=o>/</span><span class=n>finishLogin</span></code></li> <li>replace <code class=codehilite><span class=n>example</span><span class=p>.</span><span class=n>com</span></code> with your domain, https is required! </li> </ul> </li> <li>update manifest (for groups) <ul> <li>change: <code class=codehilite><span class=ss>&quot;groupMembershipClaims&quot;</span><span class=p>:</span> <span class=k>null</span><span class=p>,</span></code> (usually line 11)</li> <li>to: <code class=codehilite><span class=ss>&quot;groupMembershipClaims&quot;</span><span class=p>:</span> <span class=ss>&quot;SecurityGroup&quot;</span><span class=p>,</span></code></li> </ul> </li> <li>create SP ID / App ID URI</li> <li>grant admin consent</li> </ul> <div class="admonition info"> <p class=admonition-title>Info</p> <p>If you use the Azure AD plugin, you also create a client secret.</p> </div> <h3 id=information-to-note-down>Information To Note Down<a class=headerlink href=#information-to-note-down title="Permanent link">&para;</a></h3> <p>The following information is unique to your installation, so you need to record them as you go along.</p> <ul> <li><code class=codehilite><span class=n>App</span> <span class=n>ID</span> <span class=n>URI</span></code></li> <li><code class=codehilite><span class=k>Object</span> <span class=n>ID</span></code>'s of Users and Groups you want to give rights</li> <li><code class=codehilite><span class=n>Federation</span> <span class=n>Metadata</span> <span class=n>Document</span></code> Endpoint<ul> <li>Azure AD -&gt; App Registrations -&gt; <your app registration> -&gt; Endpoints (circular icon on top)</li> <li>you can use either the URL or the document contents</li> <li>make sure the URL contains the Tenant ID of your Azure Active Directory</li> <li>URL example: <code class=codehilite>https://login.microsoftonline.com/<span class=cp>${</span><span class=n>TENANT_ID</span><span class=cp>}</span>/federationmetadata/2007-06/federationmetadata.xml</code></li> <li>You can find your Tenant ID in <code class=codehilite><span class=n>Azure</span> <span class=n>Active</span> <span class=n>Directory</span></code> -&gt; <code class=codehilite><span class=n>Properties</span></code> -&gt; <code class=codehilite><span class=n>Directory</span> <span class=n>ID</span></code> (different name, same ID)</li> </ul> </li> </ul> <h3 id=visual-guide>Visual Guide<a class=headerlink href=#visual-guide title="Permanent link">&para;</a></h3> <p>Below is a visual guide with screenshots.</p> <p>Pay attention to these hints in the screenshots.</p> <ul> <li><strong>red</strong>: this is the main thing</li> <li><strong>orange</strong>: this is how we got to the current page/view</li> <li><strong>blue</strong>: while you're in this screen, there might be other things you could do</li> </ul> <h4 id=create-new-app-registration>Create New App Registration<a class=headerlink href=#create-new-app-registration title="Permanent link">&para;</a></h4> <p>If you have an Azure account, you have an Azure Active Directory (Azure AD) pre-created.</p> <p>This guide assumes you have an Azure AD ready to use.</p> <p>That means the next step is to create an Application Registration.</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-new-app-reg.png></p> <p>Give the registration a useful name, select who can authenticate and the <code class=codehilite><span class=n>redirect</span> <span class=n>URL</span></code>.</p> <p>This URL needs to be configured and MUST be the actual URL of your CloudBees Core installation.</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-new-app-reg2.png></p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>To have Client Masters as a fallback for login, incase Operations Center is down, you have to add another redirect URL for each Master.</p> <p>Azure AD -&gt; App Registrations -&gt; <app> -&gt; Authentication -&gt; Web -&gt; <code class=codehilite><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>example</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>teams</span><span class=o>-</span><span class=n>cat</span><span class=o>/</span><span class=n>securityRealm</span><span class=o>/</span><span class=n>finishLogin</span></code></p> </div> <h4 id=app-registration-data-to-write-down>App Registration Data To Write Down<a class=headerlink href=#app-registration-data-to-write-down title="Permanent link">&para;</a></h4> <p>Depending on the plugin you're going to use (SAML or Azure AD) you need information from your Azure AD / App Registration.</p> <ul> <li><strong>Tentant ID</strong></li> <li><strong>Object ID</strong></li> <li><strong>Client ID</strong></li> <li><strong>Federation Metadata Document</strong> <ul> <li>you can use the document XML content or the URL</li> </ul> </li> </ul> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-data2.png></p> <p>Click on the <code class=codehilite><span class=n>Endpoints</span></code> button to open the side-bar with the links.</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-data1.png></p> <h4 id=app-id>App ID<a class=headerlink href=#app-id title="Permanent link">&para;</a></h4> <p>We need the <code class=codehilite><span class=n>App</span> <span class=n>ID</span></code> - even if the SAML plugin doesn't mention it.</p> <p>Azure generates an <code class=codehilite><span class=n>APP</span> <span class=n>ID</span></code> URI for you. You can also use CloudBees Core's URL as the URI. The URI is shown when there is an error, so it recommended to use a value you can recognize.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p><code class=codehilite><span class=n>App</span> <span class=n>ID</span></code> must match in both Azure AD (set as <code class=codehilite><span class=n>App</span> <span class=n>ID</span> <span class=n>URI</span></code>) and the SAML plugin (set as <code class=codehilite><span class=n>Entity</span> <span class=n>ID</span></code>) configuration in Jenkins. So write it down.</p> </div> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-app-id1.png></p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-app-id2.png></p> <h4 id=api-permissions>API Permissions<a class=headerlink href=#api-permissions title="Permanent link">&para;</a></h4> <p>Of course, things wouldn't be proper IAM/LDAP/AD without giving some permissions.</p> <p>If we want to retrieve group information and other fields, we need to be able to read the Directory information.</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-api-perm1.png></p> <p>You find the Directory information via the <code class=codehilite><span class=n>Microsoft</span> <span class=n>Graph</span></code> api button.</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-api-perm2.png></p> <p>We select <code class=codehilite><span class=n>Application</span> <span class=n>Permissions</span></code> and then check <code class=codehilite><span class=n>Directory</span><span class=p>.</span><span class=k>Read</span><span class=p>.</span><span class=k>All</span></code>. We don't need to write.</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-api-perm3.png></p> <p>The Permissions have changed, so we require an Administrator account to consent with the new permissions.</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-api-perm4.png></p> <h4 id=update-manifest>Update Manifest<a class=headerlink href=#update-manifest title="Permanent link">&para;</a></h4> <p>As with the permissions, the default <code class=codehilite><span class=n>Manifest</span></code> doesn't give us all the information we want.</p> <p>We want the groups so we can configure RBAC, and thus we have to set the <code class=codehilite><span class=n>groupMembershipsClaims</span></code> claim attribute.</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-manifest1.png></p> <p>We change the <code class=codehilite><span class=k>null</span></code> to <code class=codehilite><span class=ss>&quot;SecurityGroup&quot;</span></code>. Please consult the Microsoft docs (see reference below) for other options.</p> <p>We can download, edit, and upload the manifest file. Alternatively, we can edit inline and hit save on top.</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-manifest2.png></p> <h4 id=retrieve-group-object-id>Retrieve Group Object ID<a class=headerlink href=#retrieve-group-object-id title="Permanent link">&para;</a></h4> <p>If we want to assign Azure AD groups to groups or roles in Jenkins' RBAC, we need to use the <code class=codehilite><span class=k>Object</span> <span class=n>ID</span></code>'s.</p> <p>Each Group and User has an <code class=codehilite><span class=k>Object</span> <span class=n>ID</span></code>, which have a handy <code class=codehilite><span class=k>Copy</span> <span class=n>this</span></code> button on the end of the value box!</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-azure-group-info.png></p> <h2 id=configure-jenkins>Configure Jenkins<a class=headerlink href=#configure-jenkins title="Permanent link">&para;</a></h2> <p>We now get to the point where we configure Jenkins. The SAML plugin is opensource, and thus it's configuration can also be used for <a href=jenkins.io>Jenkins</a> or <a href=https://www.cloudbees.com/products/cloudbees-jenkins-distribution>CloudBees Jenkins Distribution</a>.</p> <h3 id=steps>Steps<a class=headerlink href=#steps title="Permanent link">&para;</a></h3> <p>Here are the steps we perform to configure Azure AD as the Single-Sign-On solution. </p> <ul> <li><a href=https://plugins.jenkins.io/saml>install the SAML plugin</a><ul> <li>I assume you know how to install plugins, so we skip this</li> <li>if you don't know <a href=https://go.cloudbees.com/docs/cloudbees-documentation/admin-instance/managing-plugins/ >Read the Managing Plugins Guide</a></li> </ul> </li> <li>configure saml 2.0 in Jenkins</li> <li>setup groups (RBAC)<ul> <li>administrators -&gt; admin group</li> <li>browsers -&gt; all other groups</li> </ul> </li> </ul> <h3 id=visual-guide_1>Visual Guide<a class=headerlink href=#visual-guide_1 title="Permanent link">&para;</a></h3> <p>Below is a visual guide with screenshots. Please pay attention to the hints in the screenshots.</p> <ul> <li><strong>Red</strong>: this is the main thing</li> <li><strong>Orange</strong>: this is how we got to the current page/view</li> <li><strong>Blue</strong>: while you're in this screen, there might be other things you could do</li> </ul> <h4 id=configure-security>Configure Security<a class=headerlink href=#configure-security title="Permanent link">&para;</a></h4> <p>To go to Jenkins' security configuration, follow this route:</p> <ul> <li>login with an Admin user</li> <li>go to the <code class=codehilite><span class=n>Operations</span> <span class=n>Center</span></code></li> <li><code class=codehilite><span class=n>Manage</span> <span class=n>Jenkins</span></code> -&gt; <code class=codehilite><span class=k>Global</span> <span class=k>Security</span> <span class=n>Configuration</span></code></li> </ul> <h5 id=configure-rbac>Configure RBAC<a class=headerlink href=#configure-rbac title="Permanent link">&para;</a></h5> <p>The SAML plugin configuration pollutes the screen with fields.</p> <p>My advice is to enable RBAC first.</p> <p>If you haven't got any groups/roles yet, I recommend using the <code class=codehilite><span class=n>Typical</span> <span class=n>Initial</span> <span class=n>Setup</span></code> from the dropdown. The logged-in user is automatically registered as administrator. So if your Azure AD configuration doesn't work, this user can still manage Jenkins.</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-jenkins-sec1-config.png></p> <div class="admonition important"> <p class=admonition-title>Important</p> <p>Make sure you know the credentials of the current admin user.</p> <p>It will automatically be added to the <code class=codehilite><span class=n>Administrators</span></code> group, and it will be your go-to account when you mess up the SAML configuration and you have to reset security. </p> <p>For how to reset the security configuration, see the <code class=codehilite><span class=k>For</span> <span class=nv>When</span> <span class=nv>You</span> <span class=nv>Mess</span> <span class=nv>Up</span></code> paragraph.</p> </div> <h5 id=configure-saml>Configure SAML<a class=headerlink href=#configure-saml title="Permanent link">&para;</a></h5> <p>Select <code class=codehilite><span class=n>SAML</span> <span class=mi>2</span><span class=p>.</span><span class=mi>0</span></code> from the <code class=codehilite><span class=k>Security</span> <span class=n>Realm</span></code> options.</p> <p>Here we first supply our <code class=codehilite><span class=n>Federation</span> <span class=n>Metadata</span> <span class=n>Document</span></code> content or it's URL.</p> <p>Each option - document content or URL - has its own <code class=codehilite><span class=n>Validate</span> <span class=p>...</span></code> button, hit it and confirm it says <code class=codehilite><span class=n>Success</span></code>.</p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-jenkins-sec2-config.png></p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-jenkins-sec5-config.png></p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>You can leave <code class=codehilite><span class=n>Displayname</span></code> empty, which gives you the default naming scheme from Azure AD. I think this is ugly, as it amounts to something like <code class=codehilite><span class=cp>${</span><span class=n>EMAIL_ADDRESS</span><span class=cp>}</span>_<span class=cp>${</span><span class=n>AD_DOMAIN</span><span class=cp>}</span>_<span class=cp>${</span><span class=n>AZURE_CORP_DOMAIN</span><span class=cp>}</span></code>. There are other options, I've settled for <code class=codehilite><span class=n>givenname</span></code>, as there isn't a <code class=codehilite><span class=n>fullname</span></code> by default, and well, I prefer <code class=codehilite><span class=n>Joost</span></code> to a long hard to recognize string.</p> </div> <h6 id=fields>Fields<a class=headerlink href=#fields title="Permanent link">&para;</a></h6> <ul> <li><strong>Displayname</strong>: <code class=codehilite><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>schemas</span><span class=p>.</span><span class=n>xmlsoap</span><span class=p>.</span><span class=n>org</span><span class=o>/</span><span class=n>ws</span><span class=o>/</span><span class=mi>2005</span><span class=o>/</span><span class=mi>05</span><span class=o>/</span><span class=k>identity</span><span class=o>/</span><span class=n>claims</span><span class=o>/</span><span class=n>givenname</span></code></li> <li><strong>Group</strong>: <code class=codehilite><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>schemas</span><span class=p>.</span><span class=n>microsoft</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>ws</span><span class=o>/</span><span class=mi>2008</span><span class=o>/</span><span class=mi>06</span><span class=o>/</span><span class=k>identity</span><span class=o>/</span><span class=n>claims</span><span class=o>/</span><span class=n>groups</span></code></li> <li><strong>Username</strong>: <code class=codehilite><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>schemas</span><span class=p>.</span><span class=n>xmlsoap</span><span class=p>.</span><span class=n>org</span><span class=o>/</span><span class=n>ws</span><span class=o>/</span><span class=mi>2005</span><span class=o>/</span><span class=mi>05</span><span class=o>/</span><span class=k>identity</span><span class=o>/</span><span class=n>claims</span><span class=o>/</span><span class=n>name</span></code></li> <li><strong>Email</strong>: <code class=codehilite><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>schemas</span><span class=p>.</span><span class=n>xmlsoap</span><span class=p>.</span><span class=n>org</span><span class=o>/</span><span class=n>ws</span><span class=o>/</span><span class=mi>2005</span><span class=o>/</span><span class=mi>05</span><span class=o>/</span><span class=k>identity</span><span class=o>/</span><span class=n>claims</span><span class=o>/</span><span class=n>emailaddress</span></code></li> <li><strong>SP Entity ID</strong>: the <code class=codehilite><span class=n>App</span> <span class=n>ID</span></code> URI you configured in Azure AD (hidden behind <code class=codehilite><span class=n>Advanced</span> <span class=n>Configuration</span></code>)</li> </ul> <h4 id=configure-rbac-groups>Configure RBAC Groups<a class=headerlink href=#configure-rbac-groups title="Permanent link">&para;</a></h4> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Once Azure AD is configured, and it works, you can configure groups for RBAC just as you're used to.</p> <p>Both for classic RBAC and Team Masters.</p> <p>Just make sure you use the Azure AD <code class=codehilite><span class=k>Object</span> <span class=n>ID</span></code>'s of the groups to map them.</p> <p>Bonus tip, add every Azure AD group to <code class=codehilite><span class=n>Browsers</span></code>, so you can directly map their groups to Team Master roles without problems. </p> </div> <p><img alt="gitops model" src=../../images/azuread/azure-ad-jenkins-group-config1.png></p> <p><img alt="gitops model" src=../../images/azuread/azure-ad-jenkins-group-config2.png></p> <h4 id=xml-config>XML Config<a class=headerlink href=#xml-config title="Permanent link">&para;</a></h4> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class=code><div class=codehilite><pre><span></span>  <span class=nt>&lt;useSecurity&gt;</span>true<span class=nt>&lt;/useSecurity&gt;</span>
  <span class=nt>&lt;authorizationStrategy</span> <span class=na>class=</span><span class=s>&quot;nectar.plugins.rbac.strategy.RoleMatrixAuthorizationStrategyImpl&quot;</span><span class=nt>/&gt;</span>
 <span class=nt>&lt;securityRealm</span> <span class=na>class=</span><span class=s>&quot;org.jenkinsci.plugins.saml.SamlSecurityRealm&quot;</span> <span class=na>plugin=</span><span class=s>&quot;saml@1.1.2&quot;</span><span class=nt>&gt;</span>
    <span class=nt>&lt;displayNameAttributeName&gt;</span>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname<span class=nt>&lt;/displayNameAttributeName&gt;</span>
    <span class=nt>&lt;groupsAttributeName&gt;</span>http://schemas.microsoft.com/ws/2008/06/identity/claims/groups<span class=nt>&lt;/groupsAttributeName&gt;</span>
    <span class=nt>&lt;maximumAuthenticationLifetime&gt;</span>86400<span class=nt>&lt;/maximumAuthenticationLifetime&gt;</span>
    <span class=nt>&lt;emailAttributeName&gt;</span>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress<span class=nt>&lt;/emailAttributeName&gt;</span>
    <span class=nt>&lt;usernameCaseConversion&gt;</span>none<span class=nt>&lt;/usernameCaseConversion&gt;</span>
    <span class=nt>&lt;usernameAttributeName&gt;</span>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name<span class=nt>&lt;/usernameAttributeName&gt;</span>
    <span class=nt>&lt;binding&gt;</span>urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect<span class=nt>&lt;/binding&gt;</span>
    <span class=nt>&lt;advancedConfiguration&gt;</span>
      <span class=nt>&lt;forceAuthn&gt;</span>false<span class=nt>&lt;/forceAuthn&gt;</span>
      <span class=nt>&lt;spEntityId&gt;</span>https://cloudbees-core.kearos.net<span class=nt>&lt;/spEntityId&gt;</span>
    <span class=nt>&lt;/advancedConfiguration&gt;</span>
    <span class=nt>&lt;idpMetadataConfiguration&gt;</span>
      <span class=nt>&lt;xml&gt;&lt;/xml&gt;</span>
      <span class=nt>&lt;url&gt;</span>https://login.microsoftonline.com/95b46e09-0307-488b-a6fc-1d2717ba9c49/federationmetadata/2007-06/federationmetadata.xml<span class=nt>&lt;/url&gt;</span>
      <span class=nt>&lt;period&gt;</span>5<span class=nt>&lt;/period&gt;</span>
    <span class=nt>&lt;/idpMetadataConfiguration&gt;</span>
  <span class=nt>&lt;/securityRealm&gt;</span>
  <span class=nt>&lt;disableRememberMe&gt;</span>false<span class=nt>&lt;/disableRememberMe&gt;</span>
</pre></div> </td></tr></table> <h3 id=logout-url>Logout URL<a class=headerlink href=#logout-url title="Permanent link">&para;</a></h3> <p>Depending on the requirements, you may want to specify a logout url in the SAML configuration to log you completely out of SAML, not just Core.</p> <p>An example <code class=codehilite><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>login</span><span class=p>.</span><span class=n>windows</span><span class=p>.</span><span class=n>net</span><span class=o>/&lt;</span><span class=n>tenant_id_of_your_app</span><span class=o>&gt;/</span><span class=n>oauth2</span><span class=o>/</span><span class=n>logout</span><span class=o>?</span><span class=n>post_logout_redirect_uri</span><span class=o>=&lt;</span><span class=n>logout_URL_of_your_app</span><span class=o>&gt;/</span><span class=n>logout</span></code></p> <h3 id=for-when-you-mess-up>For When You Mess Up<a class=headerlink href=#for-when-you-mess-up title="Permanent link">&para;</a></h3> <p>This is the default config for security in CloudBees Core.</p> <p>This file is in <code class=codehilite><span class=cp>${</span><span class=n>JENKINS_HOME</span><span class=cp>}</span>/config.xml</code>, the XML tags we want to look at are quite near the top.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span> <span class=nt>&lt;useSecurity&gt;</span>true<span class=nt>&lt;/useSecurity&gt;</span>
  <span class=nt>&lt;authorizationStrategy</span> <span class=na>class=</span><span class=s>&quot;hudson.security.FullControlOnceLoggedInAuthorizationStrategy&quot;</span><span class=nt>&gt;</span>
    <span class=nt>&lt;denyAnonymousReadAccess&gt;</span>true<span class=nt>&lt;/denyAnonymousReadAccess&gt;</span>
  <span class=nt>&lt;/authorizationStrategy&gt;</span>
  <span class=nt>&lt;securityRealm</span> <span class=na>class=</span><span class=s>&quot;hudson.security.HudsonPrivateSecurityRealm&quot;</span><span class=nt>&gt;</span>
    <span class=nt>&lt;disableSignup&gt;</span>true<span class=nt>&lt;/disableSignup&gt;</span>
    <span class=nt>&lt;enableCaptcha&gt;</span>false<span class=nt>&lt;/enableCaptcha&gt;</span>
  <span class=nt>&lt;/securityRealm&gt;</span>
  <span class=nt>&lt;disableRememberMe&gt;</span>false<span class=nt>&lt;/disableRememberMe&gt;</span>
</pre></div> </td></tr></table> <h4 id=on-cloudbees-core-modern-kubernetes>On CloudBees Core Modern / Kubernetes<a class=headerlink href=#on-cloudbees-core-modern-kubernetes title="Permanent link">&para;</a></h4> <p>To rectify a failed configuration, execute the following steps:</p> <ol> <li>exec into the <code class=codehilite><span class=n>cjoc</span><span class=o>-</span><span class=mi>0</span></code> container: <code class=codehilite><span class=nv>kubectl</span> <span class=k>exec</span> <span class=o>-</span><span class=nv>ti</span> <span class=nv>cjoc</span><span class=o>-</span><span class=mi>0</span> <span class=o>--</span> <span class=nv>bash</span></code></li> <li>open <code class=codehilite><span class=n>config</span><span class=p>.</span><span class=n>xml</span></code>: <code class=codehilite><span class=n>vi</span> <span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=n>jenkins_home</span><span class=o>/</span><span class=n>config</span><span class=p>.</span><span class=n>xml</span></code></li> <li>replace conflicting lines with the above snippet</li> <li>save the changes</li> <li>exit the container: <code class=codehilite><span class=k>exit</span></code></li> <li>kill the pod: <code class=codehilite><span class=n>kubectl</span> <span class=k>delete</span> <span class=n>po</span> <span class=n>cjoc</span><span class=o>-</span><span class=mi>0</span></code></li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>For removing a whole line, stay in "normal" mode, and press <code class=codehilite><span class=n>d</span> <span class=n>d</span></code> (two times the <code class=codehilite><span class=n>d</span></code> key). To add the new lines, go into insert mode by pressing the <code class=codehilite><span class=n>i</span></code> key. Go back to "normal" mode by pressing the <code class=codehilite><span class=n>esc</span></code> key. Then, save and quit, by writing: <code class=codehilite><span class=p>:</span><span class=n>wq</span></code> followed by <code class=codehilite><span class=n>enter</span></code>.</p> </div> <h2 id=references>References<a class=headerlink href=#references title="Permanent link">&para;</a></h2> <ul> <li><a href=https://www.cloudbees.com/blog/securing-jenkins-role-based-access-control-and-azure-active-directory>CloudBees Guide on Azure AD for Core SSO</a>(outdated)</li> <li><a href=https://github.com/jenkinsci/saml-plugin/blob/master/doc/CONFIGURE_AZURE.md>SAML Plugin Docs for Azure AD</a> (outdated)</li> <li><a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/reference-saml-tokens>Microsoft Doc for Azure AD Tokens</a></li> <li><a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-optional-claims>Microsoft Doc for Azure AD Optional Tokens</a></li> <li><a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-saml-claims-customization>Microsoft Doc for Azure AD Custom Tokens</a></li> <li><a href=https://github.com/jenkinsci/azure-ad-plugin>Alternative Azure AD Plugin</a> (very new)</li> </ul> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Currently, there is a limitation which requires you to use the <code class=codehilite><span class=k>Object</span> <span class=n>ID</span></code>'s which make searching groups and people less than ideal. When the Alternative Azure AD Plugin is approved this may provide a more satisfactory solution.</p> </div> <h2 id=__comments>Comments</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://joostvdg.github.io/blogs/sso-azure-ad/";
      this.page.identifier =
        "/blogs/sso-azure-ad/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//joostvdg-github-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../k8s-lets-encrypt/ title="Let's Encrypt for Kubernetes Apps" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> Let's Encrypt for Kubernetes Apps </span> </div> </a> <a href=../teams-automation/ title="CloudBees Automate Teams" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> CloudBees Automate Teams </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2019 Joost van der Griendt </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <a href=https://github.com/joostvdg class="md-footer-social__link fa fa-github"></a> <a href=https://twitter.com/joost_vdg class="md-footer-social__link fa fa-twitter"></a> <a href=https://linkedin.com/in/joostvdg class="md-footer-social__link fa fa-linkedin"></a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.c648116f.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> </body> </html>