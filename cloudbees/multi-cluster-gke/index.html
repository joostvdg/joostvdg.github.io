<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Multi Cluster setup with CloudBees CI on GKE"><link href=https://joostvdg.github.io/cloudbees/multi-cluster-gke/ rel=canonical><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-5.2.2"><title>CloudBees CI - Multi Cluster GKE</title><link rel=stylesheet href=../../assets/stylesheets/main.a2408e81.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.a46bcfb3.min.css><meta name=theme-color content=#ffa726><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lato:300,400,400i,700%7CCutive+Mono&display=fallback"><style>body,input{font-family:"Lato",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Cutive Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel="preconnect dns-prefetch" href=https://www.google-analytics.com><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-145385967-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=orange data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#cloudbees-ci-multi-cluster-gke class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-header-nav__button md-logo" aria-label="J's Software Development Pages"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> J's Software Development Pages </span> <span class="md-header-nav__topic md-ellipsis"> CloudBees CI - Multi Cluster GKE </span> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class="md-tabs md-tabs--active" aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../blogs/jenkins-pipeline-support-tool/ class=md-tabs__link> Blogs </a> </li> <li class=md-tabs__item> <a href=../sso-azure-ad/ class="md-tabs__link md-tabs__link--active"> Jenkins & CloudBees </a> </li> <li class=md-tabs__item> <a href=../../jenkinsx/build-packs/ class=md-tabs__link> Jenkins X </a> </li> <li class=md-tabs__item> <a href=../../openshift/rhos311-gcp-minimal/ class=md-tabs__link> Containers </a> </li> <li class=md-tabs__item> <a href=../../cloud/automation-pulumi/ class=md-tabs__link> Software Eng. </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-nav__button md-logo" aria-label="J's Software Development Pages"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> J's Software Development Pages </label> <div class=md-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> Home <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Home data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Me class=md-nav__link> Me </a> </li> <li class=md-nav__item> <a href=../../other/mkdocs/ title="MKDocs (This Static Website)" class=md-nav__link> MKDocs (This Static Website) </a> </li> <li class=md-nav__item> <a href=../../other/vim/ title=VIM class=md-nav__link> VIM </a> </li> <li class=md-nav__item> <a href=../../other/shell/ title=Shell class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Blogs <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Blogs data-md-level=1> <label class=md-nav__title for=nav-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Blogs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../blogs/jenkins-pipeline-support-tool/ title="Jenkins Pipeline Support Tools" class=md-nav__link> Jenkins Pipeline Support Tools </a> </li> <li class=md-nav__item> <a href=../../blogs/graceful-shutdown/ title="Docker Graceful Shutdown" class=md-nav__link> Docker Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../blogs/docker-alternatives/ title="Pipelines with Docker Alternatives" class=md-nav__link> Pipelines with Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../blogs/k8s-lets-encrypt/ title="Let's Encrypt for Kubernetes Apps" class=md-nav__link> Let's Encrypt for Kubernetes Apps </a> </li> <li class=md-nav__item> <a href=../../blogs/sso-azure-ad/ title="CloudBees SSO Azure AD" class=md-nav__link> CloudBees SSO Azure AD </a> </li> <li class=md-nav__item> <a href=../../blogs/teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../../blogs/kubernetes-sso-keycloak/ title="Kubernetes SSO Keycloak" class=md-nav__link> Kubernetes SSO Keycloak </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-8 type=checkbox id=nav-2-8> <label class=md-nav__link for=nav-2-8> Jenkins X Java Native Image Prod <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Jenkins X Java Native Image Prod" data-md-level=2> <label class=md-nav__title for=nav-2-8> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Jenkins X Java Native Image Prod </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/01-intro/ title=Intro class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/02-cloud-sql/ title="Cloud SQL" class=md-nav__link> Cloud SQL </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/03-quarkus/ title=Quarkus class=md-nav__link> Quarkus </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/04-jx-import/ title="Import Into Jenkins X" class=md-nav__link> Import Into Jenkins X </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/05-jx-secrets/ title="Database Connection And Secrets" class=md-nav__link> Database Connection And Secrets </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/06-native-image/ title="Native Image" class=md-nav__link> Native Image </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/07-pipeline-improvements/ title="Pipeline Improvements" class=md-nav__link> Pipeline Improvements </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/08-preview-int-test/ title="Previews & Integration Tests" class=md-nav__link> Previews & Integration Tests </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/09-production-improvements/ title="Production Improvements" class=md-nav__link> Production Improvements </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/10-promote-prod/ title="Promote To Production" class=md-nav__link> Promote To Production </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-9 type=checkbox id=nav-2-9> <label class=md-nav__link for=nav-2-9> Jenkins Monitoring Kubernetes <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Jenkins Monitoring Kubernetes" data-md-level=2> <label class=md-nav__title for=nav-2-9> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Jenkins Monitoring Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/introduction/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/prepare/ title="Prepare Environment" class=md-nav__link> Prepare Environment </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/install/ title="Install Tools" class=md-nav__link> Install Tools </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/metrics/ title=Metrics class=md-nav__link> Metrics </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/alerts/ title=Alerts class=md-nav__link> Alerts </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/pipeline/ title=Pipeline class=md-nav__link> Pipeline </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/dashboard/ title=Dashboard class=md-nav__link> Dashboard </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/cloudbees/ title=CloudBees class=md-nav__link> CloudBees </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../blogs/k8s-crd/ title="Create your own k8s resource" class=md-nav__link> Create your own k8s resource </a> </li> <li class=md-nav__item> <a href=../../blogs/dockercon-eu-2018/ title="DockerCon EU 2018" class=md-nav__link> DockerCon EU 2018 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3 type=checkbox id=nav-3 checked> <label class=md-nav__link for=nav-3> Jenkins & CloudBees <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Jenkins & CloudBees" data-md-level=1> <label class=md-nav__title for=nav-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Jenkins & CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-1 type=checkbox id=nav-3-1 checked> <label class=md-nav__link for=nav-3-1> CloudBees <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=CloudBees data-md-level=2> <label class=md-nav__title for=nav-3-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../sso-azure-ad/ title="Single Sign On - AzureAD" class=md-nav__link> Single Sign On - AzureAD </a> </li> <li class=md-nav__item> <a href=../teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../cbc-gke-helm/ title="CloudBees Core on GKE" class=md-nav__link> CloudBees Core on GKE </a> </li> <li class=md-nav__item> <a href=../cbc-eks/ title="CloudBees Core on EKS" class=md-nav__link> CloudBees Core on EKS </a> </li> <li class=md-nav__item> <a href=../cbc-team-namespace/ title="Team Master Namespace" class=md-nav__link> Team Master Namespace </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Multi-Cluster GKE <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg> </span> </label> <a href=./ title="Multi-Cluster GKE" class="md-nav__link md-nav__link--active"> Multi-Cluster GKE </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=#steps-to-do class=md-nav__link> Steps to do </a> </li> <li class=md-nav__item> <a href=#create-and-configure-cluster-one class=md-nav__link> Create and Configure Cluster One </a> <nav class=md-nav aria-label="Create and Configure Cluster One"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-create-cluster-with-terraform class=md-nav__link> 1. Create Cluster With Terraform </a> <nav class=md-nav aria-label="1. Create Cluster With Terraform"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#main class=md-nav__link> Main </a> </li> <li class=md-nav__item> <a href=#variables class=md-nav__link> Variables </a> </li> <li class=md-nav__item> <a href=#cluster class=md-nav__link> Cluster </a> </li> <li class=md-nav__item> <a href=#nodepools class=md-nav__link> Nodepools </a> </li> <li class=md-nav__item> <a href=#execute-terraform-steps class=md-nav__link> Execute Terraform Steps </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-create-cloud-dns-zone class=md-nav__link> 2. Create Cloud DNS Zone </a> <nav class=md-nav aria-label="2. Create Cloud DNS Zone"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#gcloud class=md-nav__link> Gcloud </a> </li> <li class=md-nav__item> <a href=#terraform class=md-nav__link> Terraform </a> </li> <li class=md-nav__item> <a href=#create-gcp-service-account-for-accessing-cloud-dns class=md-nav__link> Create GCP Service Account for accessing Cloud DNS </a> <nav class=md-nav aria-label="Create GCP Service Account for accessing Cloud DNS"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ui class=md-nav__link> UI </a> </li> <li class=md-nav__item> <a href=#gcloud_1 class=md-nav__link> Gcloud </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-credentials-in-cluster class=md-nav__link> Configure Credentials In Cluster </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-install-bootstrapping class=md-nav__link> 3. Install Bootstrapping </a> <nav class=md-nav aria-label="3. Install Bootstrapping"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#nginx-ingress class=md-nav__link> Nginx Ingress </a> </li> <li class=md-nav__item> <a href=#certmanager class=md-nav__link> Certmanager </a> </li> <li class=md-nav__item> <a href=#external-dns-controller class=md-nav__link> External DNS Controller </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-install-cloudbees-ci class=md-nav__link> 4. Install CloudBees CI </a> </li> <li class=md-nav__item> <a href=#5-configure-external-access class=md-nav__link> 5. Configure External Access </a> <nav class=md-nav aria-label="5. Configure External Access"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tcp-services-configmap class=md-nav__link> TCP Services ConfigMap </a> </li> <li class=md-nav__item> <a href=#update-nginx-deployment class=md-nav__link> Update Nginx Deployment </a> </li> <li class=md-nav__item> <a href=#update-nginx-service class=md-nav__link> Update Nginx Service </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-and-configure-clustertwo class=md-nav__link> Create and Configure ClusterTwo </a> <nav class=md-nav aria-label="Create and Configure ClusterTwo"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#4-create-gcp-service-account-for-accessing-gke class=md-nav__link> 4. Create GCP service account for accessing GKE </a> <nav class=md-nav aria-label="4. Create GCP service account for accessing GKE"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ui_1 class=md-nav__link> UI </a> </li> <li class=md-nav__item> <a href=#gcloud_2 class=md-nav__link> Gcloud </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5-configure-receiving-namespace class=md-nav__link> 5. Configure Receiving Namespace </a> <nav class=md-nav aria-label="5. Configure Receiving Namespace"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prepare-namespace class=md-nav__link> Prepare Namespace </a> </li> <li class=md-nav__item> <a href=#give-user-admin-rights class=md-nav__link> Give User Admin Rights </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-managed-master-in-both-clusters class=md-nav__link> Create Managed Master in both clusters </a> <nav class=md-nav aria-label="Create Managed Master in both clusters"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-cloudbees-ci-credential-with-gcp-service-account class=md-nav__link> Create CloudBees CI Credential with GCP Service Account </a> </li> <li class=md-nav__item> <a href=#create-second-kubernetes-endpoint-configuration class=md-nav__link> Create second Kubernetes endpoint configuration </a> </li> <li class=md-nav__item> <a href=#create-managed-masters class=md-nav__link> Create Managed Masters </a> <nav class=md-nav aria-label="Create Managed Masters"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#update-master-provisioning class=md-nav__link> Update Master Provisioning </a> </li> <li class=md-nav__item> <a href=#creating-master class=md-nav__link> Creating Master </a> </li> <li class=md-nav__item> <a href=#give-user-permissions-in-cluster-two class=md-nav__link> Give User Permissions In Cluster Two </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../multi-cluster/ title="Multi-Cluster (OLD)" class=md-nav__link> Multi-Cluster (OLD) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-2 type=checkbox id=nav-3-2> <label class=md-nav__link for=nav-3-2> Jenkins <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Jenkins data-md-level=2> <label class=md-nav__title for=nav-3-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Jenkins </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins/ title=Intro class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jobdsl/ title=JobDSL class=md-nav__link> JobDSL </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jenkins-jobs-builder/ title=JenkinsJobsBuilder class=md-nav__link> JenkinsJobsBuilder </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-3 type=checkbox id=nav-3-3> <label class=md-nav__link for=nav-3-3> Jenkins Pipelines <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Jenkins Pipelines" data-md-level=2> <label class=md-nav__title for=nav-3-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Jenkins Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline/job-types/ title="Job Types" class=md-nav__link> Job Types </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/kaniko-pipelines/ title="Build Docker Image Kaniko" class=md-nav__link> Build Docker Image Kaniko </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/podtemplate-dind/ title="PodTemplate With Docker-In-Docker" class=md-nav__link> PodTemplate With Docker-In-Docker </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/jenkins-parallel-pipeline/ title="Parallel Pipelines" class=md-nav__link> Parallel Pipelines </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/core-concepts/ title="Core Concepts" class=md-nav__link> Core Concepts </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/artifactory-integration/ title="Artifactory Integration" class=md-nav__link> Artifactory Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/declarative-pipeline/ title="Pipeline (declarative)" class=md-nav__link> Pipeline (declarative) </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/groovy-pipeline/ title="Groovy DSL Pipeline" class=md-nav__link> Groovy DSL Pipeline </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/global-shared-library/ title="Pipeline Libraries" class=md-nav__link> Pipeline Libraries </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/ide-integration-pipeline-dsl/ title="DSL IDE Integration" class=md-nav__link> DSL IDE Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/input/ title=Input class=md-nav__link> Input </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4> <label class=md-nav__link for=nav-3-4> Jenkins Pipeline Examples <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Jenkins Pipeline Examples" data-md-level=2> <label class=md-nav__title for=nav-3-4> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Jenkins Pipeline Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/ title=Index class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-alternatives/ title="Docker Alternatives" class=md-nav__link> Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/maven-declarative/ title="Maven Declarative" class=md-nav__link> Maven Declarative </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-declarative/ title="Docker Declarative" class=md-nav__link> Docker Declarative </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Jenkins X <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Jenkins X" data-md-level=1> <label class=md-nav__title for=nav-4> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Jenkins X </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/build-packs/ title="Build Packs" class=md-nav__link> Build Packs </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jx-pipelines/ title="Jenkins X Pipelines" class=md-nav__link> Jenkins X Pipelines </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> Java Native Image Prod <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Java Native Image Prod" data-md-level=2> <label class=md-nav__title for=nav-4-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Java Native Image Prod </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/01-intro/ title=Intro class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/02-cloud-sql/ title="Cloud SQL" class=md-nav__link> Cloud SQL </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/03-quarkus/ title=Quarkus class=md-nav__link> Quarkus </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/04-jx-import/ title="Import Into Jenkins X" class=md-nav__link> Import Into Jenkins X </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/05-jx-secrets/ title="Database Connection And Secrets" class=md-nav__link> Database Connection And Secrets </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/06-native-image/ title="Native Image" class=md-nav__link> Native Image </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/07-pipeline-improvements/ title="Pipeline Improvements" class=md-nav__link> Pipeline Improvements </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/08-preview-int-test/ title="Previews & Integration Tests" class=md-nav__link> Previews & Integration Tests </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/09-production-improvements/ title="Production Improvements" class=md-nav__link> Production Improvements </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/10-promote-prod/ title="Promote To Production" class=md-nav__link> Promote To Production </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../jenkinsx/builder-image/ title="Create Builder Image" class=md-nav__link> Create Builder Image </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot/ title="JX Boot GKE" class=md-nav__link> JX Boot GKE </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot-aks/ title="JX Boot AKS" class=md-nav__link> JX Boot AKS </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/aks-boot-core/ title="JX Boot & CloudBees Core" class=md-nav__link> JX Boot & CloudBees Core </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/rhos-311-minimal/ title="OpenShift 3.11" class=md-nav__link> OpenShift 3.11 </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/rhos-311-restricted/ title="OpenShift 3.11 - Restricted" class=md-nav__link> OpenShift 3.11 - Restricted </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/lighthouse-bitbucket/ title="Lighthouse & Bitbucket" class=md-nav__link> Lighthouse & Bitbucket </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hello-world/ title=HelloWorld class=md-nav__link> HelloWorld </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/maven/ title=Maven class=md-nav__link> Maven </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hybrid/ title=Hybrid class=md-nav__link> Hybrid </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/kubernetes-days/ title="Example For Console Reel" class=md-nav__link> Example For Console Reel </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Containers <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Containers data-md-level=1> <label class=md-nav__title for=nav-5> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Containers </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> OpenShift <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=OpenShift data-md-level=2> <label class=md-nav__title for=nav-5-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> OpenShift </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../openshift/rhos311-gcp-minimal/ title="OpenShift 3.11 GCP(minimal)" class=md-nav__link> OpenShift 3.11 GCP(minimal) </a> </li> <li class=md-nav__item> <a href=../../openshift/rhos311-gcp-medium/ title="OpenShift 3.11 GCP(medium)" class=md-nav__link> OpenShift 3.11 GCP(medium) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Kubernetes (K8S) <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Kubernetes (K8S)" data-md-level=2> <label class=md-nav__title for=nav-5-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Kubernetes (K8S) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../kubernetes/cka-exam-prep/ title="CKA Exam prep" class=md-nav__link> CKA Exam prep </a> </li> <li class=md-nav__item> <a href=../../kubernetes/tools/ title=Tools class=md-nav__link> Tools </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> Managed Kubernetes (cloud) <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Managed Kubernetes (cloud)" data-md-level=2> <label class=md-nav__title for=nav-5-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Managed Kubernetes (cloud) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/distributions/install-gke/ title=GKE class=md-nav__link> GKE </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/gke-terraform/ title="GKE Terraform" class=md-nav__link> GKE Terraform </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/eks-eksctl/ title="AWS EKS" class=md-nav__link> AWS EKS </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-cli/ title="AKS CLI" class=md-nav__link> AKS CLI </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-terraform/ title="AKS Terraform" class=md-nav__link> AKS Terraform </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> K8S Hard Way - GCE <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="K8S Hard Way - GCE" data-md-level=2> <label class=md-nav__title for=nav-5-4> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> K8S Hard Way - GCE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/ title="Installer Preparation" class=md-nav__link> Installer Preparation </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/terraform-compute/ title="Create GCE resources" class=md-nav__link> Create GCE resources </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/certificates/ title="Prepare Certificates" class=md-nav__link> Prepare Certificates </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/kubeconfigs/ title="Prepare Kubeconfigs" class=md-nav__link> Prepare Kubeconfigs </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/encryption/ title="Encryption configuration" class=md-nav__link> Encryption configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/etcd/ title="ETCD configuration" class=md-nav__link> ETCD configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/controller/ title="Controller Config" class=md-nav__link> Controller Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/worker/ title="Worker Config" class=md-nav__link> Worker Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/remote-access/ title="Remote access" class=md-nav__link> Remote access </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/network/ title="Network config" class=md-nav__link> Network config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/debug/ title=Debug class=md-nav__link> Debug </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Docker <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Docker data-md-level=2> <label class=md-nav__title for=nav-5-5> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docker/graceful-shutdown/ title="Graceful Shutdown" class=md-nav__link> Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../docker/build-kit/ title=BuildKit class=md-nav__link> BuildKit </a> </li> <li class=md-nav__item> <a href=../../docker/multi-stage-builds/ title="Multi-Stage Builds(TBD)" class=md-nav__link> Multi-Stage Builds(TBD) </a> </li> <li class=md-nav__item> <a href=../../docker/swarm/ title="Swarm (mode) (TBD)" class=md-nav__link> Swarm (mode) (TBD) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-6 type=checkbox id=nav-5-6> <label class=md-nav__link for=nav-5-6> Linux <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Linux data-md-level=2> <label class=md-nav__title for=nav-5-6> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../linux/systemd/ title=SystemD class=md-nav__link> SystemD </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> Software Eng. <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Software Eng." data-md-level=1> <label class=md-nav__title for=nav-6> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Software Eng. </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-1 type=checkbox id=nav-6-1> <label class=md-nav__link for=nav-6-1> Automation <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Automation data-md-level=2> <label class=md-nav__title for=nav-6-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Automation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloud/automation-pulumi/ title=Pulumi class=md-nav__link> Pulumi </a> </li> <li class=md-nav__item> <a href=../../certificates/lets-encrypt-k8s/ title="Let's Encrypt K8S" class=md-nav__link> Let's Encrypt K8S </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-2 type=checkbox id=nav-6-2> <label class=md-nav__link for=nav-6-2> Software Engineering <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Software Engineering" data-md-level=2> <label class=md-nav__title for=nav-6-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Software Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../swe/important-concepts/ title="Important Concepts" class=md-nav__link> Important Concepts </a> </li> <li class=md-nav__item> <a href=../../swe/naming/ title=Naming class=md-nav__link> Naming </a> </li> <li class=md-nav__item> <a href=../../swe/distributed/ title="Distributed Computing" class=md-nav__link> Distributed Computing </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-3 type=checkbox id=nav-6-3> <label class=md-nav__link for=nav-6-3> Productivity <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Productivity data-md-level=2> <label class=md-nav__title for=nav-6-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Productivity </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../productivity/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../productivity/incidents/ title=Incidents class=md-nav__link> Incidents </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-4 type=checkbox id=nav-6-4> <label class=md-nav__link for=nav-6-4> Java <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Java data-md-level=2> <label class=md-nav__title for=nav-6-4> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../java/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../keep-watching/ title="Spring Boot App" class=md-nav__link> Spring Boot App </a> </li> <li class=md-nav__item> <a href=../../java/networking/ title="Java Networking" class=md-nav__link> Java Networking </a> </li> <li class=md-nav__item> <a href=../../java/concurrency/ title="Java Concurrency" class=md-nav__link> Java Concurrency </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=#steps-to-do class=md-nav__link> Steps to do </a> </li> <li class=md-nav__item> <a href=#create-and-configure-cluster-one class=md-nav__link> Create and Configure Cluster One </a> <nav class=md-nav aria-label="Create and Configure Cluster One"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-create-cluster-with-terraform class=md-nav__link> 1. Create Cluster With Terraform </a> <nav class=md-nav aria-label="1. Create Cluster With Terraform"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#main class=md-nav__link> Main </a> </li> <li class=md-nav__item> <a href=#variables class=md-nav__link> Variables </a> </li> <li class=md-nav__item> <a href=#cluster class=md-nav__link> Cluster </a> </li> <li class=md-nav__item> <a href=#nodepools class=md-nav__link> Nodepools </a> </li> <li class=md-nav__item> <a href=#execute-terraform-steps class=md-nav__link> Execute Terraform Steps </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-create-cloud-dns-zone class=md-nav__link> 2. Create Cloud DNS Zone </a> <nav class=md-nav aria-label="2. Create Cloud DNS Zone"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#gcloud class=md-nav__link> Gcloud </a> </li> <li class=md-nav__item> <a href=#terraform class=md-nav__link> Terraform </a> </li> <li class=md-nav__item> <a href=#create-gcp-service-account-for-accessing-cloud-dns class=md-nav__link> Create GCP Service Account for accessing Cloud DNS </a> <nav class=md-nav aria-label="Create GCP Service Account for accessing Cloud DNS"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ui class=md-nav__link> UI </a> </li> <li class=md-nav__item> <a href=#gcloud_1 class=md-nav__link> Gcloud </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-credentials-in-cluster class=md-nav__link> Configure Credentials In Cluster </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-install-bootstrapping class=md-nav__link> 3. Install Bootstrapping </a> <nav class=md-nav aria-label="3. Install Bootstrapping"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#nginx-ingress class=md-nav__link> Nginx Ingress </a> </li> <li class=md-nav__item> <a href=#certmanager class=md-nav__link> Certmanager </a> </li> <li class=md-nav__item> <a href=#external-dns-controller class=md-nav__link> External DNS Controller </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-install-cloudbees-ci class=md-nav__link> 4. Install CloudBees CI </a> </li> <li class=md-nav__item> <a href=#5-configure-external-access class=md-nav__link> 5. Configure External Access </a> <nav class=md-nav aria-label="5. Configure External Access"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tcp-services-configmap class=md-nav__link> TCP Services ConfigMap </a> </li> <li class=md-nav__item> <a href=#update-nginx-deployment class=md-nav__link> Update Nginx Deployment </a> </li> <li class=md-nav__item> <a href=#update-nginx-service class=md-nav__link> Update Nginx Service </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-and-configure-clustertwo class=md-nav__link> Create and Configure ClusterTwo </a> <nav class=md-nav aria-label="Create and Configure ClusterTwo"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#4-create-gcp-service-account-for-accessing-gke class=md-nav__link> 4. Create GCP service account for accessing GKE </a> <nav class=md-nav aria-label="4. Create GCP service account for accessing GKE"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ui_1 class=md-nav__link> UI </a> </li> <li class=md-nav__item> <a href=#gcloud_2 class=md-nav__link> Gcloud </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5-configure-receiving-namespace class=md-nav__link> 5. Configure Receiving Namespace </a> <nav class=md-nav aria-label="5. Configure Receiving Namespace"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prepare-namespace class=md-nav__link> Prepare Namespace </a> </li> <li class=md-nav__item> <a href=#give-user-admin-rights class=md-nav__link> Give User Admin Rights </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-managed-master-in-both-clusters class=md-nav__link> Create Managed Master in both clusters </a> <nav class=md-nav aria-label="Create Managed Master in both clusters"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-cloudbees-ci-credential-with-gcp-service-account class=md-nav__link> Create CloudBees CI Credential with GCP Service Account </a> </li> <li class=md-nav__item> <a href=#create-second-kubernetes-endpoint-configuration class=md-nav__link> Create second Kubernetes endpoint configuration </a> </li> <li class=md-nav__item> <a href=#create-managed-masters class=md-nav__link> Create Managed Masters </a> <nav class=md-nav aria-label="Create Managed Masters"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#update-master-provisioning class=md-nav__link> Update Master Provisioning </a> </li> <li class=md-nav__item> <a href=#creating-master class=md-nav__link> Creating Master </a> </li> <li class=md-nav__item> <a href=#give-user-permissions-in-cluster-two class=md-nav__link> Give User Permissions In Cluster Two </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/joostvdg/joostvdg.github.io/edit/master/docs/cloudbees/multi-cluster-gke.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1 id=cloudbees-ci-multi-cluster-gke>CloudBees CI - Multi Cluster GKE<a class=headerlink href=#cloudbees-ci-multi-cluster-gke title="Permanent link">&para;</a></h1> <p>Imagine you have a whole range of departments and development teams. Preferably you want to serve them with a standardized SDA(Software Delivery Automation) platform, but at the same time, make sure they pay for their usage.</p> <p>I don't think this is too far fetched or something terrible. I think it makes sense. In this light, CloudBees Core now <a href=https://docs.cloudbees.com/docs/cloudbees-core/latest/cloud-admin-guide/multiple-clusters>supports running on multiple Kubernetes clusters</a>.</p> <p>In this guide, we're going to explore how to run CloudBees Core on two GKE cluster at the same time. And how to deal with the details of getting the namespace configured, certificates, Kubernetes API tokens and so on and so forth.</p> <h2 id=prerequisites>Prerequisites<a class=headerlink href=#prerequisites title="Permanent link">&para;</a></h2> <ul> <li>The ability to create two GKE clusters</li> <li>CloudDNS enabled</li> <li>valid domain name</li> </ul> <h2 id=steps-to-do>Steps to do<a class=headerlink href=#steps-to-do title="Permanent link">&para;</a></h2> <p>High over, we have to do the following steps:</p> <ul> <li>create and configure GKE cluster One<ul> <li>create GCP service account for accessing CloudDNS<ul> <li>this is per GCP Project, if cluster two is in another project, repeat this</li> </ul> </li> <li>install Operations Center</li> </ul> </li> <li>create and configure GKE cluster Two<ul> <li>create GCP service account for accessing GKE</li> </ul> </li> <li>create a Managed Master in both clusters<ul> <li>configure Operations Center</li> <li>create managed masters</li> </ul> </li> </ul> <h2 id=create-and-configure-cluster-one>Create and Configure Cluster One<a class=headerlink href=#create-and-configure-cluster-one title="Permanent link">&para;</a></h2> <p>The easiest way to create <em>and</em> manage a cluster is with Terraform.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>I will use <code>GCP_PROJECT_ONE</code> and <code>one.domain.com</code> as placeholders for the Google Project ID and domain name respectively. You will need to change these to reflect your configuration.</p> <p>The assumption in this guide is that the clusters are in two different projects. This doesn't have to be so be, so feel free to use the same project id and domain name for both clusters.</p> </div> <p>To create and configure cluster one, we execute the following steps:</p> <ol> <li>Create Cluster With Terraform</li> <li>Create Cloud DNS Zone</li> <li>Install Bootstrapping services (certmanager, ingress controller, external dns)</li> <li>Install CloudBees CI</li> <li>Configure External Access</li> </ol> <h3 id=1-create-cluster-with-terraform>1. Create Cluster With Terraform<a class=headerlink href=#1-create-cluster-with-terraform title="Permanent link">&para;</a></h3> <p>We create four files:</p> <ul> <li><code>main.tf</code> containing the provider information</li> <li><code>variables.tf</code> containg the variables (and their defaults)</li> <li><code>cluster.tf</code> cluster definition</li> <li><code>nodepool.tf</code>houses our node pool definition, currently one, but should be easy to add more if desired</li> </ul> <h4 id=main>Main<a class=headerlink href=#main title="Permanent link">&para;</a></h4> <div class="admonition example"> <p class=admonition-title>main.tf</p> <div class=highlight><pre><span></span><code><span class=kd>terraform</span> <span class=" -Punctuation">{</span>
<span class=na>  required_version</span> <span class=o>=</span> <span class=s2>&quot;~&gt; 0.12&quot;</span>
<span class=" -Punctuation">}</span><span class=c1></span>

<span class=c1># https://www.terraform.io/docs/providers/google/index.html</span>
<span class=kr>provider</span> <span class=s>&quot;google&quot;</span> <span class=" -Punctuation">{</span>
<span class=na>  version</span>   <span class=o>=</span> <span class=s2>&quot;~&gt; 2.18.1&quot;</span>
<span class=na>  project</span>   <span class=o>=</span> <span class=err>var</span><span class=p>.</span><span class=err>project</span>
<span class=na>  region</span>    <span class=o>=</span> <span class=err>var</span><span class=p>.</span><span class=err>location</span>
<span class=" -Punctuation">}</span>
</code></pre></div> </div> <h4 id=variables>Variables<a class=headerlink href=#variables title="Permanent link">&para;</a></h4> <div class="admonition example"> <p class=admonition-title>variables.tf</p> <div class=highlight><pre><span></span><code><span class=kr>variable</span> <span class=s>&quot;project&quot;</span> <span class=" -Punctuation">{</span><span class=err> </span><span class=" -Punctuation">}</span>

<span class=kr>variable</span> <span class=s>&quot;name&quot;</span> <span class=" -Punctuation">{</span>
<span class=na>  description</span> <span class=o>=</span> <span class=s2>&quot;The name of the cluster (required)&quot;</span>
<span class=na>  default</span>     <span class=o>=</span> <span class=s2>&quot;jvandergriendt_cluster_one&quot;</span>
<span class=" -Punctuation">}</span>

<span class=kr>variable</span> <span class=s>&quot;description&quot;</span> <span class=" -Punctuation">{</span>
<span class=na>  description</span> <span class=o>=</span> <span class=s2>&quot;The description of the cluster&quot;</span>
<span class=na>  default</span>     <span class=o>=</span> <span class=s2>&quot;CloudBees CI environment for jvandergriendt&quot;</span>
<span class=" -Punctuation">}</span>

<span class=kr>variable</span> <span class=s>&quot;location&quot;</span> <span class=" -Punctuation">{</span>
<span class=na>  description</span> <span class=o>=</span> <span class=s2>&quot;The location to host the cluster&quot;</span>
<span class=na>  default</span>     <span class=o>=</span> <span class=s2>&quot;europe-west4&quot;</span>
<span class=" -Punctuation">}</span>

<span class=kr>variable</span> <span class=s>&quot;cluster_master_version&quot;</span> <span class=" -Punctuation">{</span>
<span class=na>  description</span> <span class=o>=</span> <span class=s2>&quot;The minimum kubernetes version for the master nodes&quot;</span>
<span class=na>  default</span>     <span class=o>=</span> <span class=s2>&quot;1.15.9-gke.8&quot;</span>
<span class=" -Punctuation">}</span>

<span class=kr>variable</span> <span class=s>&quot;np1count&quot;</span> <span class=" -Punctuation">{</span>
<span class=na>  description</span> <span class=o>=</span> <span class=s2>&quot;The initial Node Count for NodePool 2&quot;</span>
<span class=na>  default</span>     <span class=o>=</span> <span class=m>1</span>
<span class=" -Punctuation">}</span>

<span class=kr>variable</span> <span class=s>&quot;np1machinetype&quot;</span> <span class=" -Punctuation">{</span>
<span class=na>  description</span> <span class=o>=</span> <span class=s2>&quot;GCP Machine Type for Nodepool 1&quot;</span>
<span class=na>  default</span>     <span class=o>=</span> <span class=s2>&quot;e2-standard-2&quot;</span>
<span class=" -Punctuation">}</span>
</code></pre></div> </div> <h4 id=cluster>Cluster<a class=headerlink href=#cluster title="Permanent link">&para;</a></h4> <div class="admonition example"> <p class=admonition-title>cluster.tf</p> <div class=highlight><pre><span></span><code><span class=kr>resource</span> <span class=s>&quot;google_container_cluster&quot; &quot;primary&quot;</span> <span class=" -Punctuation">{</span>
<span class=na>  name</span>        <span class=o>=</span> <span class=err>var</span><span class=p>.</span><span class=err>name</span>
<span class=na>  location</span>    <span class=o>=</span> <span class=err>var</span><span class=p>.</span><span class=err>location</span><span class=c1></span>

<span class=c1>  # We can&#39;t create a cluster with no node pool defined, but we want to only use</span>
<span class=c1>  # separately managed node pools. So we create the smallest possible default</span>
<span class=c1>  # node pool and immediately delete it.</span>
<span class=na>  remove_default_node_pool</span>  <span class=o>=</span> <span class=kt>true</span>
<span class=na>  initial_node_count</span>        <span class=o>=</span> <span class=m>1</span>
<span class=na>  resource_labels</span>           <span class=o>=</span> <span class=" -Punctuation">{</span>
<span class=na>    environment</span> <span class=o>=</span> <span class=s2>&quot;development&quot;</span>
<span class=na>    created-by</span>  <span class=o>=</span> <span class=s2>&quot;terraform&quot;</span>
<span class=na>    cb-owner</span>    <span class=o>=</span> <span class=s2>&quot;professional-services&quot;</span>
  <span class=" -Punctuation">}</span><span class=c1></span>

<span class=c1>  # Configuration options for the NetworkPolicy feature.</span>
  <span class=err>network_policy</span> <span class=" -Punctuation">{</span><span class=c1></span>
<span class=c1>    # Whether network policy is enabled on the cluster. Defaults to false.</span>
<span class=c1>    # In GKE this also enables the ip masquerade agent</span>
<span class=c1>    # https://cloud.google.com/kubernetes-engine/docs/how-to/ip-masquerade-agent</span>
<span class=na>    enabled</span> <span class=o>=</span> <span class=kt>true</span><span class=c1></span>

<span class=c1>    # The selected network policy provider. Defaults to PROVIDER_UNSPECIFIED.</span>
<span class=na>    provider</span> <span class=o>=</span> <span class=s2>&quot;CALICO&quot;</span>
  <span class=" -Punctuation">}</span>
<span class=" -Punctuation">}</span>
</code></pre></div> </div> <h4 id=nodepools>Nodepools<a class=headerlink href=#nodepools title="Permanent link">&para;</a></h4> <div class="admonition example"> <p class=admonition-title>nodepool.tf</p> <div class=highlight><pre><span></span><code><span class=kr>resource</span> <span class=s>&quot;google_container_node_pool&quot; &quot;nodepool1&quot;</span> <span class=" -Punctuation">{</span>
<span class=na>  name</span>       <span class=o>=</span> <span class=s2>&quot;pool1&quot;</span>
<span class=na>  location</span>   <span class=o>=</span> <span class=err>var</span><span class=p>.</span><span class=err>location</span>
<span class=na>  cluster</span>    <span class=o>=</span> <span class=err>google_container_cluster</span><span class=p>.</span><span class=err>primary</span><span class=p>.</span><span class=err>name</span>
<span class=na>  node_count</span> <span class=o>=</span> <span class=err>var</span><span class=p>.</span><span class=err>np</span><span class=m>1</span><span class=err>count</span>

  <span class=err>management</span> <span class=" -Punctuation">{</span>
<span class=na>    auto_repair</span>  <span class=o>=</span> <span class=kt>true</span>
<span class=na>    auto_upgrade</span> <span class=o>=</span> <span class=kt>true</span>
  <span class=" -Punctuation">}</span>

  <span class=err>autoscaling</span> <span class=" -Punctuation">{</span>
<span class=na>    min_node_count</span> <span class=o>=</span> <span class=m>2</span>
<span class=na>    max_node_count</span> <span class=o>=</span> <span class=m>5</span>
  <span class=" -Punctuation">}</span>

  <span class=err>node_config</span> <span class=" -Punctuation">{</span>
<span class=na>    machine_type</span> <span class=o>=</span> <span class=err>var</span><span class=p>.</span><span class=err>np</span><span class=m>1</span><span class=err>machinetype</span>
<span class=na>    oauth_scopes</span> <span class=o>=</span> <span class=p>[</span>
      <span class=s2>&quot;https://www.googleapis.com/auth/compute&quot;</span><span class=p>,</span>
      <span class=s2>&quot;https://www.googleapis.com/auth/devstorage.read_only&quot;</span><span class=p>,</span>
      <span class=s2>&quot;https://www.googleapis.com/auth/logging.write&quot;</span><span class=p>,</span>
      <span class=s2>&quot;https://www.googleapis.com/auth/monitoring&quot;</span><span class=p>,</span>
      <span class=s2>&quot;https://www.googleapis.com/auth/ndev.clouddns.readwrite&quot;</span><span class=p>,</span>
      <span class=s2>&quot;https://www.googleapis.com/auth/cloud-platform&quot;</span>
    <span class=p>]</span>
  <span class=" -Punctuation">}</span>
<span class=" -Punctuation">}</span>
</code></pre></div> </div> <h4 id=execute-terraform-steps>Execute Terraform Steps<a class=headerlink href=#execute-terraform-steps title="Permanent link">&para;</a></h4> <div class=tabbed-set data-tabs=1:3><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><label for=__tabbed_1_1>Terraform init</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>terraform init
</code></pre></div> </div> <input id=__tabbed_1_2 name=__tabbed_1 type=radio><label for=__tabbed_1_2>Terraform plan</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>terraform plan -out plan.out
</code></pre></div> </div> <input id=__tabbed_1_3 name=__tabbed_1 type=radio><label for=__tabbed_1_3>Terraform apply</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>terraform apply <span class=s2>&quot;plan.out&quot;</span>
</code></pre></div> </div> </div> <h3 id=2-create-cloud-dns-zone>2. Create Cloud DNS Zone<a class=headerlink href=#2-create-cloud-dns-zone title="Permanent link">&para;</a></h3> <h4 id=gcloud>Gcloud<a class=headerlink href=#gcloud title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code>gcloud dns managed-zones create one-domain-com --dns-name one.domain.com. <span class=se>\</span>
      --description <span class=s2>&quot;Example DNS zone&quot;</span>
</code></pre></div> <h4 id=terraform>Terraform<a class=headerlink href=#terraform title="Permanent link">&para;</a></h4> <div class="admonition example"> <p class=admonition-title>main.tf</p> <div class=highlight><pre><span></span><code><span class=kr>resource</span> <span class=s>&quot;google_dns_managed_zone&quot; &quot;one-domain-com&quot;</span> <span class=" -Punctuation">{</span>
<span class=na>  name</span>        <span class=o>=</span> <span class=s2>&quot;one-domain-com&quot;</span>
<span class=na>  dns_name</span>    <span class=o>=</span> <span class=s2>&quot;one.domain.com.&quot;</span>
<span class=na>  description</span> <span class=o>=</span> <span class=s2>&quot;Example DNS zone&quot;</span>
<span class=na>  labels</span> <span class=o>=</span> <span class=" -Punctuation">{</span>
<span class=na>    foo</span> <span class=o>=</span> <span class=s2>&quot;bar&quot;</span>
  <span class=" -Punctuation">}</span>
<span class=" -Punctuation">}</span>
</code></pre></div> </div> <h4 id=create-gcp-service-account-for-accessing-cloud-dns>Create GCP Service Account for accessing Cloud DNS<a class=headerlink href=#create-gcp-service-account-for-accessing-cloud-dns title="Permanent link">&para;</a></h4> <h5 id=ui>UI<a class=headerlink href=#ui title="Permanent link">&para;</a></h5> <p>In GCP's IAM/service Account screen, create a new Service Account.</p> <p>Give the service account two roles:</p> <ul> <li>Project Viewer</li> <li>DNS Admin</li> </ul> <p>Once done, create a JSON key and download this. Rename the file to <code>credentials.json</code>.</p> <h5 id=gcloud_1>Gcloud<a class=headerlink href=#gcloud_1 title="Permanent link">&para;</a></h5> <div class=tabbed-set data-tabs=2:4><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><label for=__tabbed_2_1>Create SA</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>gcloud iam service-accounts create sa-name <span class=se>\</span>
    --description<span class=o>=</span><span class=s2>&quot;sa-description&quot;</span> <span class=se>\</span>
    --display-name<span class=o>=</span><span class=s2>&quot;sa-display-name&quot;</span>
</code></pre></div> </div> <input id=__tabbed_2_2 name=__tabbed_2 type=radio><label for=__tabbed_2_2>Give SA Project Permission</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>gcloud projects add-iam-policy-binding my-project-123 <span class=se>\</span>
    --member serviceAccount:my-sa-123@my-project-123.iam.gserviceaccount.com <span class=se>\</span>
    --role roles/viewer
</code></pre></div> </div> <input id=__tabbed_2_3 name=__tabbed_2 type=radio><label for=__tabbed_2_3>Give CloudDNS Permission</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>gcloud projects add-iam-policy-binding my-project-123 <span class=se>\</span>
    --member serviceAccount:my-sa-123@my-project-123.iam.gserviceaccount.com <span class=se>\</span>
    --role roles/dns.admin
</code></pre></div> </div> <input id=__tabbed_2_4 name=__tabbed_2 type=radio><label for=__tabbed_2_4>Generate JSON Key</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>gcloud iam service-accounts keys create ~key.json <span class=se>\</span>
  --iam-account &lt;YOUR-SA-NAME&gt;&gt;@project-id.iam.gserviceaccount.com
</code></pre></div> </div> </div> <h4 id=configure-credentials-in-cluster>Configure Credentials In Cluster<a class=headerlink href=#configure-credentials-in-cluster title="Permanent link">&para;</a></h4> <p>Create the Kubernetes namespace <code>bootstrap</code> and add the credentials to the namespace.</p> <div class=highlight><pre><span></span><code>kubectl create namespace bootstrap
</code></pre></div> <div class=highlight><pre><span></span><code>kubectl create secret generic external-dns-gcp-sa --from-file<span class=o>=</span>credentials.json -n bootstrap
</code></pre></div> <h3 id=3-install-bootstrapping>3. Install Bootstrapping<a class=headerlink href=#3-install-bootstrapping title="Permanent link">&para;</a></h3> <h4 id=nginx-ingress>Nginx Ingress<a class=headerlink href=#nginx-ingress title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code>helm install nginx-ingress stable/nginx-ingress <span class=se>\</span>
  -f nginx-values.yaml <span class=se>\</span>
  -n bootstrap
</code></pre></div> <div class="admonition example"> <p class=admonition-title>nginx-values.yaml</p> <div class=highlight><pre><span></span><code><span class=nt>service</span><span class=p>:</span>
  <span class=nt>omitClusterIP</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=nt>controller</span><span class=p>:</span>
  <span class=nt>autoscaling</span><span class=p>:</span>
    <span class=nt>enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class=nt>minReplicas</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
    <span class=nt>maxReplicas</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">7</span>
  <span class=nt>publishService</span><span class=p>:</span>
    <span class=nt>enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class=nt>metrics</span><span class=p>:</span>
    <span class=nt>enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div> </div> <h4 id=certmanager>Certmanager<a class=headerlink href=#certmanager title="Permanent link">&para;</a></h4> <div class=tabbed-set data-tabs=3:3><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><label for=__tabbed_3_1>Install Repository</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>helm repo add jetstack https://charts.jetstack.io
</code></pre></div> </div> <input id=__tabbed_3_2 name=__tabbed_3 type=radio><label for=__tabbed_3_2>Update Helm Repositories</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>helm repo update
</code></pre></div> </div> <input id=__tabbed_3_3 name=__tabbed_3 type=radio><label for=__tabbed_3_3>Install Certmanager chart</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>helm install certmanager jetstack/cert-manager <span class=se>\</span>
  -f certmanager-values.yaml <span class=se>\</span>
  -n bootstrap <span class=se>\</span>
   --version v0.15.1 <span class=se>\</span>
   --set <span class=nv>installCRDs</span><span class=o>=</span><span class=nb>true</span>
</code></pre></div> </div> </div> <div class="admonition example"> <p class=admonition-title>certmanager-values.yaml</p> <div class=highlight><pre><span></span><code><span class=nt>prometheus</span><span class=p>:</span>
  <span class=nt>enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=nt>ingressShim</span><span class=p>:</span>
  <span class=nt>defaultIssuerName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
  <span class=nt>defaultIssuerKind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
</code></pre></div> </div> <div class="admonition example"> <p class=admonition-title>cluster-issuer.yaml</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1alpha2</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>acme</span><span class=p>:</span>
    <span class=nt>email</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">joostvdg@gmail.com</span>
    <span class=nt>privateKeySecretRef</span><span class=p>:</span>
      <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
    <span class=nt>server</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https://acme-v02.api.letsencrypt.org/directory</span>
    <span class=nt>solvers</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>dns01</span><span class=p>:</span>
        <span class=nt>clouddns</span><span class=p>:</span>
          <span class=nt>project</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">GCP_PROJECT_ONE</span>
          <span class=nt>serviceAccountSecretRef</span><span class=p>:</span>
            <span class=nt>key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">credentials.json</span>
            <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">external-dns-gcp-sa</span>
</code></pre></div> </div> <div class=highlight><pre><span></span><code>kubectl apply -f cluster-issuer.yaml
</code></pre></div> <h4 id=external-dns-controller>External DNS Controller<a class=headerlink href=#external-dns-controller title="Permanent link">&para;</a></h4> <div class="admonition example"> <p class=admonition-title>extdns-values.yaml</p> <div class=highlight><pre><span></span><code><span class=nt>provider</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">google</span>
<span class=nt>domainFilters</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=s>&quot;one.domain.com&quot;</span>
<span class=nt>metrics</span><span class=p>:</span>
  <span class=nt>enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=nt>google</span><span class=p>:</span>
  <span class=nt>project</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">GCP_PROJECT_ONE</span>
  <span class=nt>serviceAccountSecret</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">external-dns-gcp-sa</span>
</code></pre></div> </div> <h3 id=4-install-cloudbees-ci>4. Install CloudBees CI<a class=headerlink href=#4-install-cloudbees-ci title="Permanent link">&para;</a></h3> <div class="admonition example"> <p class=admonition-title>cloudbees-ci-values.yaml</p> <div class=highlight><pre><span></span><code><span class=nt>OperationsCenter</span><span class=p>:</span>
  <span class=nt>HostName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ci.one.domain.com</span>
  <span class=nt>Ingress</span><span class=p>:</span>
    <span class=nt>tls</span><span class=p>:</span>
      <span class=nt>Enable</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class=nt>Host</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ci.dev.jxgke.kearos.net</span>
      <span class=nt>SecretName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">tls-dev-jxgke-kearos-net-p</span>
  <span class=nt>ServiceType</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
</code></pre></div> </div> <div class=tabbed-set data-tabs=4:4><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><label for=__tabbed_4_1>Add Helm Repo</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>helm repo add cloudbees https://charts.cloudbees.com/public/cloudbees
</code></pre></div> </div> <input id=__tabbed_4_2 name=__tabbed_4 type=radio><label for=__tabbed_4_2>Update Helm Repos</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>helm repo update
</code></pre></div> </div> <input id=__tabbed_4_3 name=__tabbed_4 type=radio><label for=__tabbed_4_3>Create Namespace</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>kubectl create namespace cloudbees-ci
</code></pre></div> </div> <input id=__tabbed_4_4 name=__tabbed_4 type=radio><label for=__tabbed_4_4>Helm Install</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>helm install cloudbees-ci cloudbees/cloudbees-core <span class=se>\</span>
  -f cloudbees-ci-values.yaml <span class=se>\</span>
  --namespace cloudbees-ci <span class=se>\</span>
  --version <span class=m>3</span>.14.0+ebfb4625ad50
</code></pre></div> </div> </div> <h3 id=5-configure-external-access>5. Configure External Access<a class=headerlink href=#5-configure-external-access title="Permanent link">&para;</a></h3> <p>To allow Master to connect back to Operations Center from another cluster, two ports must be open, <code>443</code> (or <code>80</code> if no TLS) and <code>50000</code> (if you've kept the default).</p> <p>For this we enable <code>tcp-services</code> and configure the <code>50000</code> port on the <em>deployment</em> and <em>service</em> (Kubernetes resources) of our Nginx Ingress.</p> <p>How to change the Nginx Ingress configuration depends on how you've installed it. For sake of brevity, I will simply edit the resources via a <code>kubectl edit</code> (hint: don't do this in production).</p> <h4 id=tcp-services-configmap>TCP Services ConfigMap<a class=headerlink href=#tcp-services-configmap title="Permanent link">&para;</a></h4> <p>To enable the TCP services, we need to take three steps:</p> <ul> <li>create a config map with the configuration</li> <li>enable tcp services in the deployment and point to the configmap</li> <li>update the service to listen to port <code>50000</code></li> </ul> <div class="admonition example"> <p class=admonition-title>nginx-config-map.yaml</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">tcp-services</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class=nt>data</span><span class=p>:</span>
  <span class=nt>50000</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cloudbees-ci/cjoc:50000&quot;</span>
</code></pre></div> </div> <div class="admonition info"> <p class=admonition-title>Info</p> <p><code>cloudbees-ci</code> is the namespace my CJOC runs in.</p> <p>Change this if your CJOC runs elsewhere.</p> </div> <div class=highlight><pre><span></span><code>kubectl apply -f nginx-config-map.yaml
</code></pre></div> <h4 id=update-nginx-deployment>Update Nginx Deployment<a class=headerlink href=#update-nginx-deployment title="Permanent link">&para;</a></h4> <p>Once this is done, we can edit the controller's deployment.</p> <p>We have to make two changes:</p> <ul> <li>add the tcp-services coniguration</li> <li>add the port <code>50000</code> configuration</li> </ul> <div class=highlight><pre><span></span><code>kubectl -n <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span> edit deployment nginx-ingress-controller
</code></pre></div> <p>Among the container args, we add <code>--tcp-services-configmap</code>.</p> <div class=highlight><pre><span></span><code>    <span class=nt>spec</span><span class=p>:</span>
      <span class=nt>containers</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=nt>args</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/nginx-ingress-controller</span>
        <span class="l l-Scalar l-Scalar-Plain">...</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--tcp-services-configmap=kube-system/tcp-services</span>
</code></pre></div> <p>Next, we edit the same deployment, and add the tcp port.</p> <p>We will add the 50000 to the container ports.</p> <div class=highlight><pre><span></span><code>        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">50000</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
          <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
</code></pre></div> <p>It will then look something like this.</p> <div class=highlight><pre><span></span><code>        <span class=nt>ports</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">443</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https</span>
          <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">50000</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
          <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
</code></pre></div> <h4 id=update-nginx-service>Update Nginx Service<a class=headerlink href=#update-nginx-service title="Permanent link">&para;</a></h4> <p>Last but not least, we also have to update the Nginx Ingress <em>service</em> resource.</p> <div class=highlight><pre><span></span><code>kubectl -n <span class=nv>$NAMESPACE</span> edit svc nginx-ingress-controller
</code></pre></div> <p>We add a similar port definition.</p> <div class=highlight><pre><span></span><code>  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
    <span class=nt>nodePort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">31559</span>
    <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">50000</span>
    <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
</code></pre></div> <p>Which will then look something like this (clusterIp and nodePort's will be different).</p> <div class=highlight><pre><span></span><code><span class=nt>spec</span><span class=p>:</span>
  <span class=nt>clusterIP</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">.....</span>
  <span class=nt>externalTrafficPolicy</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Cluster</span>
  <span class=nt>ports</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
    <span class=nt>nodePort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">31406</span>
    <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https</span>
    <span class=nt>nodePort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">30391</span>
    <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">443</span>
    <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
    <span class=nt>nodePort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">31559</span>
    <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">50000</span>
    <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
</code></pre></div> <h2 id=create-and-configure-clustertwo>Create and Configure ClusterTwo<a class=headerlink href=#create-and-configure-clustertwo title="Permanent link">&para;</a></h2> <p>Creating Cluster Two is similar to the creation of Cluster One. We re-use some steps of the Creation Cluster One segment, and below are the new steps. Do ensure to replace the placeholders for the cluster name, project id, and domain with the appropriate values for Cluster Two.</p> <p>To create and configure Cluster Two, we execute the following steps:</p> <ol> <li>Create Cluster With Terraform <a href=#1-create-cluster-with-terraform>see step 1</a></li> <li>Create Cloud DNS Zone <a href=#2-create-cloud-dns-zone>see step 2</a></li> <li>Install Bootstrapping services <a href=#3-install-bootstrapping>see step 3</a></li> <li>Create GCP service account for accessing GKE</li> <li>Configure Receiving Namespace</li> </ol> <h3 id=4-create-gcp-service-account-for-accessing-gke>4. Create GCP service account for accessing GKE<a class=headerlink href=#4-create-gcp-service-account-for-accessing-gke title="Permanent link">&para;</a></h3> <h4 id=ui_1>UI<a class=headerlink href=#ui_1 title="Permanent link">&para;</a></h4> <p>Open the <em>Hamburger Menu</em> on the top left, and select <code>IAM &amp; Admin</code> &rarr; <code>Service Accounts</code> -&gt; <code>CREATE SERVICE ACCOUNT</code> (top middle).</p> <p>Give it a descriptive name and two roles:</p> <ul> <li><code>Project / Viewer</code></li> <li><code>Kubernetes Engine Cluster Admin</code> (or, <code>Kubernetes Engine Developer</code>)</li> </ul> <p><img alt="Configure GCP SA" src=../../images/cloudbees-multicluster-gke-sa.png></p> <p>Then hit the <code>+ CREATE KEY</code> button, and select (and download) the JSON key.</p> <p><img alt="Configure Second Kubernetes Endpoint" src=../../images/cloudbees-multicluster-gke-sa-key.png></p> <h4 id=gcloud_2>Gcloud<a class=headerlink href=#gcloud_2 title="Permanent link">&para;</a></h4> <p>If you prefer to create the SA via <a href=https://cloud.google.com/sdk/ >Gcloud</a> CLI:</p> <div class=tabbed-set data-tabs=5:4><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><label for=__tabbed_5_1>Create SA</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>gcloud iam service-accounts create sa-name <span class=se>\</span>
    --description<span class=o>=</span><span class=s2>&quot;sa-description&quot;</span> <span class=se>\</span>
    --display-name<span class=o>=</span><span class=s2>&quot;sa-display-name&quot;</span>
</code></pre></div> </div> <input id=__tabbed_5_2 name=__tabbed_5 type=radio><label for=__tabbed_5_2>Give SA Project Permission</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>gcloud projects add-iam-policy-binding my-project-123 <span class=se>\</span>
    --member serviceAccount:my-sa-123@my-project-123.iam.gserviceaccount.com <span class=se>\</span>
    --role roles/viewer
</code></pre></div> </div> <input id=__tabbed_5_3 name=__tabbed_5 type=radio><label for=__tabbed_5_3>Give GKE Permission</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>gcloud projects add-iam-policy-binding my-project-123 <span class=se>\</span>
    --member serviceAccount:my-sa-123@my-project-123.iam.gserviceaccount.com <span class=se>\</span>
    --role roles/container.clusterAdmin <span class=c1># or roles/container.developer</span>
</code></pre></div> </div> <input id=__tabbed_5_4 name=__tabbed_5 type=radio><label for=__tabbed_5_4>Generate JSON Key</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>gcloud iam service-accounts keys create ~key.json <span class=se>\</span>
  --iam-account &lt;YOUR-SA-NAME&gt;&gt;@project-id.iam.gserviceaccount.com
</code></pre></div> </div> </div> <p>Read <a href=https://cloud.google.com/iam/docs/understanding-roles#predefined_roles>Google Cloud's</a> documentation on Roles for further information.</p> <h3 id=5-configure-receiving-namespace>5. Configure Receiving Namespace<a class=headerlink href=#5-configure-receiving-namespace title="Permanent link">&para;</a></h3> <h4 id=prepare-namespace>Prepare Namespace<a class=headerlink href=#prepare-namespace title="Permanent link">&para;</a></h4> <div class=tabbed-set data-tabs=6:4><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><label for=__tabbed_6_1>Create Namespace</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>kubectl create namespace masters
</code></pre></div> </div> <input id=__tabbed_6_2 name=__tabbed_6 type=radio><label for=__tabbed_6_2>Fetch Helm Chart</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>helm fetch cloudbees/cloudbees-core --untar
</code></pre></div> </div> <input id=__tabbed_6_3 name=__tabbed_6 type=radio><label for=__tabbed_6_3>Generate Namespace Manifests</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>helm template cloudbees-core-masters-masters cloudbees-core <span class=se>\</span>
   --namespace masters <span class=se>\</span>
   -f namespace-masters-values.yaml <span class=se>\</span>
   &gt; namespace-masters.yaml
</code></pre></div> </div> <input id=__tabbed_6_4 name=__tabbed_6 type=radio><label for=__tabbed_6_4>Apply Namespace Manifests</label><div class=tabbed-content> <div class=highlight><pre><span></span><code>kubectl apply -f namespace-masters.yaml <span class=se>\</span>
  --namespace masters
</code></pre></div> </div> </div> <div class="admonition caution"> <p class=admonition-title>Caution</p> <p>Make sure you are executing the steps on Cluster Two!</p> </div> <div class="admonition example"> <p class=admonition-title>namespace-masters-values.yaml</p> <div class=highlight><pre><span></span><code><span class=nt>OperationsCenter</span><span class=p>:</span>
    <span class=nt>Enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class=nt>Master</span><span class=p>:</span>
    <span class=nt>Enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class=nt>OperationsCenterNamespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">masters</span>
<span class=nt>Agents</span><span class=p>:</span>
    <span class=nt>Enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div> </div> <h4 id=give-user-admin-rights>Give User Admin Rights<a class=headerlink href=#give-user-admin-rights title="Permanent link">&para;</a></h4> <p>I'm not sure if you can figure out the user id upfront. When you create a Master in this cluster, you'll likely see an error that <code>user 98389745879 has no permission</code> to create certain resources, such as the StatefulSet.</p> <p>Run the command below to give this user permission to create these Kubernetes resources.</p> <div class=highlight><pre><span></span><code>kubectl create clusterrolebinding clusterrolebinding-name <span class=se>\</span>
--clusterrole cluster-admin <span class=se>\</span>
--user <span class=nv>$USER_ID</span>
</code></pre></div> <p>If you don't know the user id of your GCP Service Account, go ahead with the next chapter. We refer back to this paragraph.</p> <h2 id=create-managed-master-in-both-clusters>Create Managed Master in both clusters<a class=headerlink href=#create-managed-master-in-both-clusters title="Permanent link">&para;</a></h2> <ol> <li>Create CloudBees CI Credential with GCP Service Account</li> <li>Create second Kubernetes endpoint configuration</li> <li>Create Managed Master in Cluster One</li> <li>Create Managed Master in Cluster Two</li> </ol> <h3 id=create-cloudbees-ci-credential-with-gcp-service-account>Create CloudBees CI Credential with GCP Service Account<a class=headerlink href=#create-cloudbees-ci-credential-with-gcp-service-account title="Permanent link">&para;</a></h3> <p>This requires that you've created the GCP Service Account with access to GKE and generated the JSON Key.</p> <p>You can then upload this JSON Key as a credential to CloudBees CI via the Credentials kind <code>Google Service Account from private key</code>.</p> <p><img alt="Configure Second Kubernetes Endpoint" src=../../images/cloudbees-multicluster-gke-cred.png></p> <h3 id=create-second-kubernetes-endpoint-configuration>Create second Kubernetes endpoint configuration<a class=headerlink href=#create-second-kubernetes-endpoint-configuration title="Permanent link">&para;</a></h3> <p>Now we create a second Kubernetes Endpoint in the cluster.</p> <p>The fields to fill in:</p> <ol> <li><strong>API endpoint URL</strong>: the cluster endpoint of Cluster Two</li> <li><strong>Display Name</strong>: display name so you know which cluster you create a Master in</li> <li><strong>Credentials</strong>: the credentials we create in <a href="#Create CloudBees CI Credential with GCP Service Account">#Create CloudBees CI Credential with GCP Service Account</a></li> <li><strong>Server Certificate</strong>: the server certificate of Cluster Two</li> <li><strong>Namespace</strong>: the namespace you have prepared, in our case <code>masters</code></li> <li><strong>Master URL Pattern</strong>: the DNS pattern for Cluster Two, in our case <code>https://*.two.domain.com</code></li> <li><strong>Ingress Class</strong>: unless you used a different Ingress than in this guide, set to <code>nginx</code></li> <li><strong>Jenkins URL</strong>: the external URL of the Operations Center</li> </ol> <div class="admonition info"> <p class=admonition-title>Info</p> <p>If you don't know the API Endpoint or the Server Certificate, you can retrieve this from your <code>~/.kube/config</code> file. Assuming you have access to Cluster Two, you will the details of the cluster there.</p> <p>For the Server Certificate, you have to Base64 decode this. You can do so on mac/linux by echo + pipe into <code>base64</code>.</p> <p>For example, on a mac:</p> <div class=highlight><pre><span></span><code><span class=nb>echo</span> <span class=s2>&quot;kjhKJSDH13123&quot;</span> <span class=p>|</span> base64 -D
</code></pre></div> </div> <p><img alt="Configure Second Kubernetes Endpoint" src=../../images/cloudbees-multicluster-gke.png></p> <h3 id=create-managed-masters>Create Managed Masters<a class=headerlink href=#create-managed-masters title="Permanent link">&para;</a></h3> <p>To enable automatic TLS for the Masters in the clusters, you can either edit the Ingress when creating the Mater, or update the Kubernetes Master Provisioning before hand.</p> <h4 id=update-master-provisioning>Update Master Provisioning<a class=headerlink href=#update-master-provisioning title="Permanent link">&para;</a></h4> <ul> <li><code>Manage Jenkins</code> -&gt; <code>Configure System</code> -&gt; <code>Kubernetes Master Provisioning</code> -&gt; <code>Advanced</code> -&gt; <code>YAML</code></li> </ul> <div class="admonition example"> <p class=admonition-title>YAML field</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span> <span class=s>&quot;extensions/v1beta1&quot;</span>
<span class=nt>kind</span><span class=p>:</span> <span class=s>&quot;Ingress&quot;</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>annotations</span><span class=p>:</span>
    <span class=nt>cert-manager.io/cluster-issuer</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>tls</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">${host}</span>
    <span class=nt>secretName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">${secretName}</span>
</code></pre></div> </div> <h4 id=creating-master>Creating Master<a class=headerlink href=#creating-master title="Permanent link">&para;</a></h4> <p>In the top right corner, there's a button "New Master", push it and give your master a name.</p> <p>In the field <code>Cluster Endpoint</code>, select the one for Cluster Two. Confirm the URL has the correct domain and hit save.</p> <p><img alt="Create New Master" src=../../images/cloudbees-multicluster-gke-newmm.png></p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>The process for creating a Master in Cluster One and Cluster Two are the same. The only difference is the Kubenernetes endpoint used.</p> </div> <h4 id=give-user-permissions-in-cluster-two>Give User Permissions In Cluster Two<a class=headerlink href=#give-user-permissions-in-cluster-two title="Permanent link">&para;</a></h4> <p>As discussed in the Create Cluster Two chapter, the paragraph <a href=/cloudbees/multi-cluster-gke/#give-user-admin-rights>#Give User Admin Rights</a> explains how to do so.</p> <hr> <div class=md-source-date> <small> Last update: 2020-06-02 16:26:32 </small> </div> <h2 id=__comments>Comments</h2> <div id=disqus_thread></div> <script>var disqus_config=function(){this.page.url="https://joostvdg.github.io/cloudbees/multi-cluster-gke/",this.page.identifier="/cloudbees/multi-cluster-gke/"};!function(){var e=document,i=e.createElement("script");i.src="//joostvdg-github-io.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)}()</script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label=Footer> <a href=../cbc-team-namespace/ title="Team Master Namespace" class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Previous </span> Team Master Namespace </div> </div> </a> <a href=../multi-cluster/ title="Multi-Cluster (OLD)" class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Next </span> Multi-Cluster (OLD) </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2020 Joost van der Griendt </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/joostvdg target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> <a href=https://twitter.com/joost_vdg target=_blank rel=noopener title=twitter.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://linkedin.com/in/joostvdg target=_blank rel=noopener title=linkedin.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/vendor.d710d30a.min.js></script> <script src=../../assets/javascripts/bundle.5f27aba8.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script> <script>
        app = initialize({
          base: "../..",
          features: ["tabs", "instant"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.27c6a5e6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>