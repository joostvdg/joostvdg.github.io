<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link href=https://joostvdg.github.io/cloudbees/multi-cluster/ rel=canonical><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.4.2"><title>Multi-Cluster - J's Software Development Pages</title><link rel=stylesheet href=../../assets/stylesheets/application.30686662.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#fb8c00><script src=../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-145385967-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-primary=orange data-md-color-accent=red> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#prerequisites tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-header-nav__button md-logo"> <i class=md-icon>public</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> J's Software Development Pages </span> <span class=md-header-nav__topic> Multi-Cluster </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../blogs/jenkins-pipeline-support-tool/ class=md-tabs__link> Blogs </a> </li> <li class=md-tabs__item> <a href=../sso-azure-ad/ class="md-tabs__link md-tabs__link--active"> CICD </a> </li> <li class=md-tabs__item> <a href=../../kubernetes/ class=md-tabs__link> Containers </a> </li> <li class=md-tabs__item> <a href=../../cloud/automation-pulumi/ class=md-tabs__link> Cloud </a> </li> <li class=md-tabs__item> <a href=../../certificates/lets-encrypt-k8s/ class=md-tabs__link> SWE </a> </li> <li class=md-tabs__item> <a href=../../java/ class=md-tabs__link> Java </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://joostvdg.github.io title="J's Software Development Pages" class="md-nav__button md-logo"> <i class=md-icon>public</i> </a> J's Software Development Pages </label> <div class=md-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> Home </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-1> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Me class=md-nav__link> Me </a> </li> <li class=md-nav__item> <a href=../../other/mkdocs/ title="MKDocs (This Static Website)" class=md-nav__link> MKDocs (This Static Website) </a> </li> <li class=md-nav__item> <a href=../../other/vim/ title=VIM class=md-nav__link> VIM </a> </li> <li class=md-nav__item> <a href=../../other/shell/ title=Shell class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Blogs </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Blogs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../blogs/jenkins-pipeline-support-tool/ title="Jenkins Pipeline Support Tools" class=md-nav__link> Jenkins Pipeline Support Tools </a> </li> <li class=md-nav__item> <a href=../../blogs/graceful-shutdown/ title="Docker Graceful Shutdown" class=md-nav__link> Docker Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../blogs/docker-alternatives/ title="Pipelines with Docker Alternatives" class=md-nav__link> Pipelines with Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../blogs/k8s-lets-encrypt/ title="Let's Encrypt for Kubernetes Apps" class=md-nav__link> Let's Encrypt for Kubernetes Apps </a> </li> <li class=md-nav__item> <a href=../../blogs/sso-azure-ad/ title="CloudBees SSO Azure AD" class=md-nav__link> CloudBees SSO Azure AD </a> </li> <li class=md-nav__item> <a href=../../blogs/teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../../blogs/kubernetes-sso-keycloak/ title="Kubernetes SSO Keycloak" class=md-nav__link> Kubernetes SSO Keycloak </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-8 type=checkbox id=nav-2-8> <label class=md-nav__link for=nav-2-8> Jenkins Monitoring Kubernetes </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-8> Jenkins Monitoring Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/introduction/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/prepare/ title="Prepare Environment" class=md-nav__link> Prepare Environment </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/install/ title="Install Tools" class=md-nav__link> Install Tools </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/metrics/ title=Metrics class=md-nav__link> Metrics </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/alerts/ title=Alerts class=md-nav__link> Alerts </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/pipeline/ title=Pipeline class=md-nav__link> Pipeline </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/dashboard/ title=Dashboard class=md-nav__link> Dashboard </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/cloudbees/ title=CloudBees class=md-nav__link> CloudBees </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../blogs/k8s-crd/ title="Create your own k8s resource" class=md-nav__link> Create your own k8s resource </a> </li> <li class=md-nav__item> <a href=../../blogs/dockercon-eu-2018/ title="DockerCon EU 2018" class=md-nav__link> DockerCon EU 2018 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3 checked> <label class=md-nav__link for=nav-3> CICD </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> CICD </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-1 type=checkbox id=nav-3-1 checked> <label class=md-nav__link for=nav-3-1> CloudBees </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-1> CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../sso-azure-ad/ title="Single Sign On - AzureAD" class=md-nav__link> Single Sign On - AzureAD </a> </li> <li class=md-nav__item> <a href=../teams-automation/ title="CloudBees Automate Teams" class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../cbc-gke-helm/ title="CloudBees Core on GKE" class=md-nav__link> CloudBees Core on GKE </a> </li> <li class=md-nav__item> <a href=../cbc-eks/ title="CloudBees Core on EKS" class=md-nav__link> CloudBees Core on EKS </a> </li> <li class=md-nav__item> <a href=../cbc-team-namespace/ title="Team Master Namespace" class=md-nav__link> Team Master Namespace </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Multi-Cluster </label> <a href=./ title=Multi-Cluster class="md-nav__link md-nav__link--active"> Multi-Cluster </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=#steps-to-do class=md-nav__link> Steps to do </a> </li> <li class=md-nav__item> <a href=#tweak-gke-cluster class=md-nav__link> Tweak GKE Cluster </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tcp-services class=md-nav__link> TCP Services </a> </li> <li class=md-nav__item> <a href=#set-default-tls-certificate class=md-nav__link> Set Default TLS Certificate </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-aks-cluster class=md-nav__link> Configure AKS Cluster </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#gather-kubernetes-credential-certificate class=md-nav__link> Gather Kubernetes Credential &amp; Certificate </a> </li> <li class=md-nav__item> <a href=#install-an-ingress-controller class=md-nav__link> Install an Ingress controller </a> </li> <li class=md-nav__item> <a href=#create-configure-namespace class=md-nav__link> Create &amp; Configure Namespace </a> </li> <li class=md-nav__item> <a href=#configure-cloudbees-sidecar-injector class=md-nav__link> Configure CloudBees Sidecar Injector </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-operations-center class=md-nav__link> Configure Operations Center </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configure-endpoint class=md-nav__link> Configure Endpoint </a> </li> <li class=md-nav__item> <a href=#master-template class=md-nav__link> Master Template </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-a-managed-master class=md-nav__link> Create a Managed Master </a> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-2 type=checkbox id=nav-3-2> <label class=md-nav__link for=nav-3-2> Jenkins X </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-2> Jenkins X </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/build-packs/ title="Build Packs" class=md-nav__link> Build Packs </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jx-pipelines/ title="Jenkins X Pipelines" class=md-nav__link> Jenkins X Pipelines </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot/ title="JX Boot GKE" class=md-nav__link> JX Boot GKE </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot-aks/ title="JX Boot AKS" class=md-nav__link> JX Boot AKS </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/aks-boot-core/ title="JX Boot & CloudBees Core" class=md-nav__link> JX Boot & CloudBees Core </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hello-world/ title=HelloWorld class=md-nav__link> HelloWorld </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/maven/ title=Maven class=md-nav__link> Maven </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hybrid/ title=Hybrid class=md-nav__link> Hybrid </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/kubernetes-days/ title="Example For Console Reel" class=md-nav__link> Example For Console Reel </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-3 type=checkbox id=nav-3-3> <label class=md-nav__link for=nav-3-3> Jenkins </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-3> Jenkins </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins/ title=Intro class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jobdsl/ title=JobDSL class=md-nav__link> JobDSL </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jenkins-jobs-builder/ title=JenkinsJobsBuilder class=md-nav__link> JenkinsJobsBuilder </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4> <label class=md-nav__link for=nav-3-4> Jenkins Pipelines </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-4> Jenkins Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline/job-types/ title="Job Types" class=md-nav__link> Job Types </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/kaniko-pipelines/ title="Build Docker Image Kaniko" class=md-nav__link> Build Docker Image Kaniko </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/podtemplate-dind/ title="PodTemplate With Docker-In-Docker" class=md-nav__link> PodTemplate With Docker-In-Docker </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/jenkins-parallel-pipeline/ title="Parallel Pipelines" class=md-nav__link> Parallel Pipelines </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/core-concepts/ title="Core Concepts" class=md-nav__link> Core Concepts </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/artifactory-integration/ title="Artifactory Integration" class=md-nav__link> Artifactory Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/declarative-pipeline/ title="Pipeline (declarative)" class=md-nav__link> Pipeline (declarative) </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/groovy-pipeline/ title="Groovy DSL Pipeline" class=md-nav__link> Groovy DSL Pipeline </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/global-shared-library/ title="Pipeline Libraries" class=md-nav__link> Pipeline Libraries </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/ide-integration-pipeline-dsl/ title="DSL IDE Integration" class=md-nav__link> DSL IDE Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/input/ title=Input class=md-nav__link> Input </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-5 type=checkbox id=nav-3-5> <label class=md-nav__link for=nav-3-5> Jenkins Pipeline Examples </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-5> Jenkins Pipeline Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/ title=Index class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-alternatives/ title="Docker Alternatives" class=md-nav__link> Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/maven-declarative/ title="Maven Declarative" class=md-nav__link> Maven Declarative </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-declarative/ title="Docker Declarative" class=md-nav__link> Docker Declarative </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Containers </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Containers </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-1 type=checkbox id=nav-4-1> <label class=md-nav__link for=nav-4-1> Kubernetes (K8S) </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-1> Kubernetes (K8S) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../kubernetes/cka-exam-prep/ title="CKA Exam prep" class=md-nav__link> CKA Exam prep </a> </li> <li class=md-nav__item> <a href=../../kubernetes/tools/ title=Tools class=md-nav__link> Tools </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-2 type=checkbox id=nav-4-2> <label class=md-nav__link for=nav-4-2> K8S Public Services </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-2> K8S Public Services </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/distributions/install-gke/ title=GKE class=md-nav__link> GKE </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/gke-terraform/ title="GKE Terraform" class=md-nav__link> GKE Terraform </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/eks-eksctl/ title="AWS EKS" class=md-nav__link> AWS EKS </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-cli/ title="AKS CLI" class=md-nav__link> AKS CLI </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-terraform/ title="AKS Terraform" class=md-nav__link> AKS Terraform </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> K8S Hard Way - GCE </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-3> K8S Hard Way - GCE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/ title="Installer Preparation" class=md-nav__link> Installer Preparation </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/terraform-compute/ title="Create GCE resources" class=md-nav__link> Create GCE resources </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/certificates/ title="Prepare Certificates" class=md-nav__link> Prepare Certificates </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/kubeconfigs/ title="Prepare Kubeconfigs" class=md-nav__link> Prepare Kubeconfigs </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/encryption/ title="Encryption configuration" class=md-nav__link> Encryption configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/etcd/ title="ETCD configuration" class=md-nav__link> ETCD configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/controller/ title="Controller Config" class=md-nav__link> Controller Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/worker/ title="Worker Config" class=md-nav__link> Worker Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/remote-access/ title="Remote access" class=md-nav__link> Remote access </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/network/ title="Network config" class=md-nav__link> Network config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/debug/ title=Debug class=md-nav__link> Debug </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-4 type=checkbox id=nav-4-4> <label class=md-nav__link for=nav-4-4> Docker </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-4> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docker/graceful-shutdown/ title="Graceful Shutdown" class=md-nav__link> Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../docker/build-kit/ title=BuildKit class=md-nav__link> BuildKit </a> </li> <li class=md-nav__item> <a href=../../docker/multi-stage-builds/ title="Multi-Stage Builds(TBD)" class=md-nav__link> Multi-Stage Builds(TBD) </a> </li> <li class=md-nav__item> <a href=../../docker/swarm/ title="Swarm (mode) (TBD)" class=md-nav__link> Swarm (mode) (TBD) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-5 type=checkbox id=nav-4-5> <label class=md-nav__link for=nav-4-5> Linux </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-5> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../linux/systemd/ title=SystemD class=md-nav__link> SystemD </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Cloud </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloud/automation-pulumi/ title="Automation - Pulumi" class=md-nav__link> Automation - Pulumi </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> SWE </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-6> SWE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../certificates/lets-encrypt-k8s/ title="Let's Encrypt K8S" class=md-nav__link> Let's Encrypt K8S </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6-2 type=checkbox id=nav-6-2> <label class=md-nav__link for=nav-6-2> Software Engineering </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-6-2> Software Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../swe/important-concepts/ title="Important Concepts" class=md-nav__link> Important Concepts </a> </li> <li class=md-nav__item> <a href=../../swe/naming/ title=Naming class=md-nav__link> Naming </a> </li> <li class=md-nav__item> <a href=../../swe/distributed/ title="Distributed Computing" class=md-nav__link> Distributed Computing </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6-3 type=checkbox id=nav-6-3> <label class=md-nav__link for=nav-6-3> Productivity </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-6-3> Productivity </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../productivity/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../productivity/incidents/ title=Incidents class=md-nav__link> Incidents </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class=md-nav__link for=nav-7> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-7> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../java/ title=General class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../keep-watching/ title="Spring Boot App" class=md-nav__link> Spring Boot App </a> </li> <li class=md-nav__item> <a href=../../java/networking/ title="Java Networking" class=md-nav__link> Java Networking </a> </li> <li class=md-nav__item> <a href=../../java/concurrency/ title="Java Concurrency" class=md-nav__link> Java Concurrency </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=#steps-to-do class=md-nav__link> Steps to do </a> </li> <li class=md-nav__item> <a href=#tweak-gke-cluster class=md-nav__link> Tweak GKE Cluster </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tcp-services class=md-nav__link> TCP Services </a> </li> <li class=md-nav__item> <a href=#set-default-tls-certificate class=md-nav__link> Set Default TLS Certificate </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-aks-cluster class=md-nav__link> Configure AKS Cluster </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#gather-kubernetes-credential-certificate class=md-nav__link> Gather Kubernetes Credential &amp; Certificate </a> </li> <li class=md-nav__item> <a href=#install-an-ingress-controller class=md-nav__link> Install an Ingress controller </a> </li> <li class=md-nav__item> <a href=#create-configure-namespace class=md-nav__link> Create &amp; Configure Namespace </a> </li> <li class=md-nav__item> <a href=#configure-cloudbees-sidecar-injector class=md-nav__link> Configure CloudBees Sidecar Injector </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-operations-center class=md-nav__link> Configure Operations Center </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configure-endpoint class=md-nav__link> Configure Endpoint </a> </li> <li class=md-nav__item> <a href=#master-template class=md-nav__link> Master Template </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-a-managed-master class=md-nav__link> Create a Managed Master </a> </li> <li class=md-nav__item> <a href=#__comments title=Comments class="md-nav__link md-nav__link--active"> Comments </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/joostvdg/joostvdg.github.io/edit/master/docs/cloudbees/multi-cluster.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1>Multi-Cluster</h1> <p>Imagine you have a whole range of departments and development teams. Preferably you want to serve them with a standardized SDA(Software Delivery Automation) platform, but at the same time, make sure they pay for their usage.</p> <p>I don't think this is too far fetched or something terrible. I think it makes sense. In this light, CloudBees Core now <a href=https://docs.cloudbees.com/docs/cloudbees-core/latest/cloud-admin-guide/multiple-clusters>supports running on multiple Kubernetes clusters</a>. </p> <p>In this guide, we're going to explore how to run CloudBees Core on a GKE and AKS cluster at the same time. And how to deal with the details of getting the namespace configured, certificates, Kubernetes API tokens and so on and so forth.</p> <h2 id=prerequisites>Prerequisites<a class=headerlink href=#prerequisites title="Permanent link">&para;</a></h2> <p>First off, we need a [GKE cluster] (/kubernetes/distributions/gke-terraform/) and a <a href=/kubernetes/distributions/aks-terraform/ >AKS cluster</a>.</p> <p>Next, we make the GKE cluster the default one. Here we will install CloudBees Core. You can either install <a href=/cloudbees/cbc-gke-helm/ >CloudBees Core directly</a> or via <a href=/jenkinsx/aks-boot-core/#install-cloudbees-core>Jenkins X</a>.</p> <p>You're also welcome to follow the <a href=https://docs.cloudbees.com/docs/cloudbees-core/latest/gke-install-guide/installing-gke-using-helm>CloudBees documentation</a>.</p> <p>The expected state is that you access Operations Center via a proper DNS name with TLS enabled, served via Nginx Ingress. And the AKS cluster is ready to be used - but empty.</p> <p>Some further assumptions: you have admin rights on both clusters the TLS certificate is from Let's Encrypt via Certmanager the AKS cluster is empty You can break these assumptions, but that means you have to change the examples to reflect your situation.</p> <h2 id=steps-to-do>Steps to do<a class=headerlink href=#steps-to-do title="Permanent link">&para;</a></h2> <p>High over, we have to do the following steps:</p> <ul> <li>tweak the GKE cluster</li> <li>configure the AKS cluster</li> <li>configure Operations Center</li> <li>create a Managed Master</li> </ul> <h2 id=tweak-gke-cluster>Tweak GKE Cluster<a class=headerlink href=#tweak-gke-cluster title="Permanent link">&para;</a></h2> <p>At this time of writing, Jenkins is suffering from an <a href=https://support.cloudbees.com/hc/en-us/articles/360019630132-Issue-connecting-External-Client-Master-with-TLS-setup-at-Ingress>outdated OpenSSL library</a>. This version doesn't support <a href=https://en.wikipedia.org/wiki/Server_Name_Indication>SNI</a>, which is what the <a href=https://github.com/kubernetes/ingress-nginx/issues/4674#issuecomment-569493421>Nginx Ingress Controller</a> relies on.</p> <p>When a Client Master (Managed or not) connects to the Operations Center via the Nginx Controller without SNI, the controller will not route you to the correct path. Because of this, when TLS is enabled, you will get the default controller's TLS certificate. As this certificate, by default, is an invalid one, you get TLS handshake errors.</p> <p>We have to rectify this. There are many ways to do this. For example, you make the TLS certificate for Operations Center the default TLS certificate. While this might not be nice for other applications, it will suit our case.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>If there are many other applications in the same cluster, consider having more than one Nginx Ingress Controller.</p> <p>Via the configuration parameters <code class=codehilite><span class=n>controller</span><span class=p>.</span><span class=k>scope</span><span class=p>.</span><span class=n>enabled</span></code> and <code class=codehilite><span class=n>controller</span><span class=p>.</span><span class=k>scope</span><span class=p>.</span><span class=n>namespace</span></code> , you can limit the controller to a single namespace. This way, you can configure the default TLS certificate only for the Ingress Controller that manages the Operations Center's namespace â€” limiting the effect of the workaround.</p> </div> <p>In addition to the change for the default certificate, we also need to make sure external Masters can connect to the Operations Center. They require two ports to be open, <code class=codehilite><span class=mi>443</span></code> (or <code class=codehilite><span class=mi>80</span></code> if no TLS) and <code class=codehilite><span class=mi>50000</span></code> (if you've kept the default). </p> <p>For this we enable <code class=codehilite><span class=n>tcp</span><span class=o>-</span><span class=n>services</span></code> and configure the <code class=codehilite><span class=mi>50000</span></code> port on the <em>deployment</em> and <em>service</em> (Kubernetes resources).</p> <p>How to change the Nginx Ingress configuration depends on how you've installed it. For sake of brevity, I will simply edit the resources via a <code class=codehilite><span class=n>kubectl</span> <span class=n>edit</span></code> (hint: don't do this in production).</p> <h3 id=tcp-services>TCP Services<a class=headerlink href=#tcp-services title="Permanent link">&para;</a></h3> <p>To enable the TCP services, we need to do two things: * create a config map with the configuration * enable tcp services in the deployment and point to the configmap</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1># nginx-config-map.yaml</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
 <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">tcp-services</span>
 <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class=nt>data</span><span class=p>:</span>
 <span class=nt>50000</span><span class=p>:</span> <span class=s>&quot;&lt;CJOC_NAMESPACE&gt;/cjoc:50000&quot;</span>
</pre></div> </td></tr></table> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Do replace <code class=codehilite><span class=n>CJOC_NAMESPACE</span></code> with the actual namespace!</p> </div> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl apply -f nginx-config-map.yaml
</pre></div> </td></tr></table> <p>Once this is done, we can edit the controller's deployment.</p> <p>We have to make two changes: * add the tcp-services coniguration * add the port <code class=codehilite><span class=mi>50000</span></code> configuration</p> <p><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl -n <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span> edit deployment nginx-ingress-controller
</pre></div> </td></tr></table> Among the container args, we add <code class=codehilite><span class=c1>--tcp-services-configmap</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=nt>spec</span><span class=p>:</span>
      <span class=nt>containers</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=nt>args</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/nginx-ingress-controller</span>
        <span class="l l-Scalar l-Scalar-Plain">...</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--tcp-services-configmap=kube-system/tcp-services</span>
</pre></div> </td></tr></table> <p>Next, we edit the same deployment, and add the tcp port.</p> <p>We will add the 50000 to the container ports.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">50000</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
          <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
</pre></div> </td></tr></table> <p>It will then look something like this.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class=nt>ports</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">443</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https</span>
          <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">50000</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
          <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
</pre></div> </td></tr></table> <p>Last but not least, we also have to update the Nginx Ingress <em>service</em> resource.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl -n <span class=nv>$NAMESPACE</span> edit svc nginx-ingress-controller
</pre></div> </td></tr></table> <p>We add a similar port definition.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span>  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
    <span class=nt>nodePort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">31559</span>
    <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">50000</span>
    <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
</pre></div> </td></tr></table> <p>Which will then look something like this (clusterIp and nodePort's will be different).</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>spec</span><span class=p>:</span>
  <span class=nt>clusterIP</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">.....</span>
  <span class=nt>externalTrafficPolicy</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Cluster</span>
  <span class=nt>ports</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
    <span class=nt>nodePort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">31406</span>
    <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https</span>
    <span class=nt>nodePort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">30391</span>
    <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">443</span>
    <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
    <span class=nt>nodePort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">31559</span>
    <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">50000</span>
    <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jnlp</span>
</pre></div> </td></tr></table> <h3 id=set-default-tls-certificate>Set Default TLS Certificate<a class=headerlink href=#set-default-tls-certificate title="Permanent link">&para;</a></h3> <p>The first thing you'll have to do is to find out the name of the secret container the certificate. If you've created it yourself, great, else this is a way.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl get certificate -A
</pre></div> </td></tr></table> <p>The output should look like this:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span>NAMESPACE    NAME                           READY   SECRET                         AGE
jx-staging   tls-staging-gke-kearos-net-p   True    tls-staging-gke-kearos-net-p   4d
jx           tls-dev-gke-kearos-net-p       True    tls-dev-gke-kearos-net-p       15d
</pre></div> </td></tr></table> <p>It should tell you which secret belongs to which certificate and in which namespace it resides. Note down both the secret name and the namespace.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Hint, the <code class=codehilite><span class=o>-</span><span class=n>A</span></code> flag means <code class=codehilite><span class=c1>--all-namespaces</span></code> but then with less typing.</p> </div> <p><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl -n <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span> edit deployment nginx-ingress-controller
</pre></div> </td></tr></table> Among the container args, <code class=codehilite><span class=o>-</span> <span class=c1>--default-ssl-certificate=&lt;namespace&gt;/&lt;secretName&gt;</span></code>.</p> <p>And it should then look something like this:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=nt>spec</span><span class=p>:</span>
      <span class=nt>containers</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=nt>args</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/nginx-ingress-controller</span>
    <span class="l l-Scalar l-Scalar-Plain">...</span>
        <span class="l l-Scalar l-Scalar-Plain">- --default-ssl-certificate=default/tls-fake-kearos-net</span>
</pre></div> </td></tr></table> <h2 id=configure-aks-cluster>Configure AKS Cluster<a class=headerlink href=#configure-aks-cluster title="Permanent link">&para;</a></h2> <p>We need to do the following steps:</p> <ul> <li>retrieve the Kubernetes API endpoint</li> <li>retrieve the Kubernetes API endpoint's certificate</li> <li>retrieve the service account token</li> <li>install an Ingress controller</li> <li>create &amp; configure namespace for Managed Master(s)</li> <li>configure CloudBees Sidecar Injector</li> </ul> <h3 id=gather-kubernetes-credential-certificate>Gather Kubernetes Credential &amp; Certificate<a class=headerlink href=#gather-kubernetes-credential-certificate title="Permanent link">&para;</a></h3> <p>If you haven't already retrieved the Kubernetes credentials for your AKS cluster, you can do so via the <code class=codehilite><span class=n>az</span></code> or <em>AzureCLI</em>.</p> <p><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>az aks get-credentials --resource-group <span class=si>${</span><span class=nv>AKS_RESOURCE_GROUP</span><span class=si>}</span> --name <span class=si>${</span><span class=nv>AKS_CLUSTER_NAME</span><span class=si>}</span>
</pre></div> </td></tr></table> All three parts that we need, the <em>Kubernetes API endpoint</em>, <em>Kubernetes API endpoint's certificate</em>, <em>Service Account Token</em> will be added to our <code class=codehilite><span class=na>.kubeconfig</span></code>. In my case, it is located at <code class=codehilite><span class=o>~/</span><span class=p>.</span><span class=n>kube</span><span class=o>/</span><span class=n>config</span></code>.</p> <ul> <li>Kubernetes API endpoint: <code class=codehilite><span class=k>cluster</span><span class=p>.</span><span class=n>server</span></code></li> <li>Kubernetes API endpoint's certificate: <code class=codehilite><span class=k>cluster</span><span class=p>.</span><span class=n>certificate</span><span class=o>-</span><span class=n>authority</span><span class=o>-</span><span class=k>data</span></code></li> <li>Service Account Token: <code class=codehilite><span class=n>users</span><span class=p>.</span><span class=k>user</span><span class=p>.</span><span class=n>token</span></code></li> </ul> <p>Mind you, the certificate is Base64 encoded. To decode, you can usually use a command line tool. </p> <div class=superfences-tabs> <input name=__tabs_1 type=radio id=__tab_1_0 checked=checked> <label for=__tab_1_0>macOs</label> <div class=superfences-content><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nb>echo</span> <span class=s2>&quot;LS0tLS1C....LS0tCg==&quot;</span> <span class=p>|</span> base64 -D
</pre></div> </td></tr></table></div> </div> <p>The decoded thing should look like this:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span>-----BEGIN CERTIFICATE-----
MIIEyTCCArGgAwIBAgIQK0sOS0aRjfZPYLM1TaRQMjANBgkqhkiG9w0BAQsFADAN
..........
<span class=nv>kKrPcnzV0gRdWNGNoJtRh9EGtKDP1VZUBiwdH44</span><span class=o>=</span>
-----END CERTIFICATE-----
</pre></div> </td></tr></table> <p>Save this into a <code class=codehilite><span class=na>.pem</span></code> file, we're going to need it. Let's call it <code class=codehilite><span class=n>aks</span><span class=o>-</span><span class=n>kubernetes</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=n>server</span><span class=p>.</span><span class=n>pem</span></code>.</p> <h3 id=install-an-ingress-controller>Install an Ingress controller<a class=headerlink href=#install-an-ingress-controller title="Permanent link">&para;</a></h3> <p>We're going to use Helm to install the Nginx Ingres Controller.</p> <p>Let's start by creating a namespace for your ingress resources</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl create namespace ingress-nginx
</pre></div> </td></tr></table> <p>Add the official stable repository, just to be sure.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>helm repo add stable https://kubernetes-charts.storage.googleapis.com/
</pre></div> </td></tr></table> <p>And update the helm repos.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>helm repo update
</pre></div> </td></tr></table> <p>Create a values file, <code class=codehilite><span class=n>ingress</span><span class=o>-</span><span class=k>values</span><span class=p>.</span><span class=n>yaml</span></code>, we will need to change some values.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>rbac</span><span class=p>:</span>
 <span class=nt>create</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=nt>defaultBackend</span><span class=p>:</span>
 <span class=nt>enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class=nt>controller</span><span class=p>:</span>
 <span class=nt>ingressClass</span><span class=p>:</span> <span class=s>&quot;nginx&quot;</span>
 <span class=nt>metrics</span><span class=p>:</span>
   <span class=nt>enabled</span><span class=p>:</span> <span class=s>&quot;true&quot;</span>
 <span class=nt>replicaCount</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
 <span class=nt>nodeSelector</span><span class=p>:</span> 
   <span class=nt>beta\.kubernetes.io/os</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">linux</span> 
 <span class=nt>scope</span><span class=p>:</span>
   <span class=nt>enabled</span><span class=p>:</span> <span class=s>&quot;true&quot;</span>
   <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cbmasters</span>
 <span class=nt>service</span><span class=p>:</span>
   <span class=nt>externalTrafficPolicy</span><span class=p>:</span> <span class=s>&quot;Cluster&quot;</span>
</pre></div> </td></tr></table> <div class=superfences-tabs> <input name=__tabs_2 type=radio id=__tab_2_0 checked=checked> <label for=__tab_2_0>Helm V3</label> <div class=superfences-content><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span>helm install nginx-ingress stable/nginx-ingress <span class=se>\</span>
 --namespace ingress-nginx <span class=se>\</span>
 --values ingress-values.yaml <span class=se>\</span>
 --version <span class=m>1</span>.29.6
</pre></div> </td></tr></table></div> <input name=__tabs_2 type=radio id=__tab_2_1> <label for=__tab_2_1>Helm V2</label> <div class=superfences-content><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span>helm install <span class=se>\</span>
 --name nginx-ingress stable/nginx-ingress <span class=se>\</span>
 --namespace ingress-nginx <span class=se>\</span>
 --values ingress-values.yaml <span class=se>\</span>
 --version <span class=m>1</span>.29.6
</pre></div> </td></tr></table></div> </div> <h3 id=create-configure-namespace>Create &amp; Configure Namespace<a class=headerlink href=#create-configure-namespace title="Permanent link">&para;</a></h3> <p>We're going to use a feature from the official CloudBees Core helm chart. We start by creating the namespace that will house our Managed Master(s).</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nv>NAMESPACE</span><span class=o>=</span>
</pre></div> </td></tr></table> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl create namespace <span class=nv>$NAMESPACE</span>
</pre></div> </td></tr></table> <p>Create a configuration for CloudBees Core Helm chart, called <code class=codehilite><span class=n>cloudbees</span><span class=o>-</span><span class=k>values</span><span class=p>.</span><span class=n>yaml</span></code>. The namespace of the Operations Center doesn't really matter, it is in a different cluster anyway.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>OperationsCenter</span><span class=p>:</span>
 <span class=nt>Enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class=nt>Master</span><span class=p>:</span>
 <span class=nt>Enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
 <span class=nt>OperationsCenterNamespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cloudbees-core</span>
<span class=nt>Agents</span><span class=p>:</span>
 <span class=nt>Enabled</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div> </td></tr></table> <p>To be able to generate the Kubernetes resources files, we first have to use <code class=codehilite><span class=n>helm</span> <span class=k>fetch</span></code> to retrieve the chart.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span>helm fetch <span class=se>\</span>
 --repo https://charts.cloudbees.com/public/cloudbees <span class=se>\</span>
 --version <span class=m>3</span>.8.0+a0d07461ae1c <span class=se>\</span>
 cloudbees-core
</pre></div> </td></tr></table> <p>Now we can generate the Kubernetes resource definitions and store them as a single yaml file.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span>helm template cloudbees-core-namespace <span class=se>\</span>
 cloudbees-core-3.8.0+a0d07461ae1c.tgz <span class=se>\</span>
 -f cloudbees-values.yaml <span class=se>\</span>
 --namespace <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span> <span class=se>\</span>
 &gt; cloudbees-core-namespace.yml
</pre></div> </td></tr></table> <p>Which we then apply.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl apply -f cloudbees-core-namespace.yml --namespace <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span>
</pre></div> </td></tr></table> <h3 id=configure-cloudbees-sidecar-injector>Configure CloudBees Sidecar Injector<a class=headerlink href=#configure-cloudbees-sidecar-injector title="Permanent link">&para;</a></h3> <p>Unfortunately, the Let's Encrypt Root CA certificates are not yet in the trust stores of our images. So we have to ensure they end up in the Masters we run in this (AKS) cluster, so they do not run into SSL errors. You can find the certificates on the <a href=https://letsencrypt.org/certificates/ >certificates</a> page of letsencrypt.org.</p> <p>Make sure to download and save the PEM of <code class=codehilite><span class=n>ISRGRoot</span> <span class=n>X1</span> <span class=p>(</span><span class=k>self</span><span class=o>-</span><span class=n>signed</span><span class=p>)</span></code>, <code class=codehilite><span class=n>Let</span><span class=err>&#39;</span><span class=n>s</span> <span class=n>Encrypt</span> <span class=n>Authority</span> <span class=n>X3</span> <span class=p>(</span><span class=n>IdenTrust</span> <span class=k>Cross</span><span class=o>-</span><span class=n>signed</span><span class=p>)</span></code>, and <code class=codehilite><span class=n>Let</span><span class=err>&#39;</span><span class=n>s</span> <span class=n>Encrypt</span> <span class=n>Authority</span> <span class=n>X3</span> <span class=p>(</span><span class=n>Signed</span> <span class=k>By</span> <span class=n>ISRG</span> <span class=n>Root</span> <span class=n>X1</span><span class=p>)</span></code>.</p> <p>Next, we have to add them to a bundle and a truststore, we can then put into a ConfigMap.</p> <p>We first have retrieve the current bundle and truststore. We can get them from Operations Center via a <code class=codehilite><span class=n>kubectl</span> <span class=n>cp</span></code>. The process is described in the <a href=https://docs.cloudbees.com/docs/cloudbees-core/latest/cloud-admin-guide/kubernetes-self-signed-certificates#_create_a_certificate_bundle>CloudBees Cloud Admin Guide</a>. Unfortunately, it seems as of CloudBees Core 2.204.+ the location has changed. The new locations are below. </p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl cp cjoc-0:etc/pki/ca-trust/extracted/java/cacerts ca-bundle/cacerts
kubectl cp cjoc-0:etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem ca-bundle/ca-certificates.crt
</pre></div> </td></tr></table> <p>Now that we have the files to start with, we can add our Let's Encrypt Root and Intermediary certificates.</p> <p>This assumes we're in the folder <code class=codehilite><span class=n>ca</span><span class=o>-</span><span class=n>bundle</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>cat valid-isrgrootx1-letsencrypt-org.pem &gt;&gt; ca-certificates.crt
keytool -import -noprompt -keystore cacerts -file valid-isrgrootx1-letsencrypt-org.pem -storepass changeit -alias letsencrypt<span class=p>;</span>
</pre></div> </td></tr></table> <p>We also have to add the <code class=codehilite><span class=n>aks</span><span class=o>-</span><span class=n>kubernetes</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=n>server</span><span class=p>.</span><span class=n>pem</span></code> to ensure we can talk to the Kubernetes API Endpoint.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>cat aks-kubernetes-api-server.pem &gt;&gt; ca-certificates.crt
keytool -import -noprompt -keystore cacerts -file aks-kubernetes-api-server.pem -storepass changeit -alias kubeapi<span class=p>;</span>
</pre></div> </td></tr></table> <div class="admonition info"> <p class=admonition-title>Info</p> <p>If you use custom or self-signed certificates, the process is the same. Simply substitute the Let's Encrypt certificates mentioned by your own / your provider's.</p> </div> <p>This assumes we're in the folder <code class=codehilite><span class=n>ca</span><span class=o>-</span><span class=n>bundle</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl create configmap --from-file<span class=o>=</span>ca-certificates.crt,cacerts ca-bundles
</pre></div> </td></tr></table> <p>Now we can focus on installing the <a href=https://docs.cloudbees.com/docs/cloudbees-core/latest/cloud-admin-guide/kubernetes-self-signed-certificates#_set_up_injector>CloudBees Sidecar Injector</a>. It is a tool that creates a <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/#how-pods-manage-multiple-containers>Sidecar</a> to inject the certificate bundle and truststore from the Configmap into containers.</p> <p>As before, we first fetch chart. Unfortunately, the value we need to change is not parameterized, so we have to un tar the config. We can let the Helm fetch do that via the <code class=codehilite><span class=c1>--untar</span></code> flag, followed by the <code class=codehilite><span class=c1>--untardir &lt;folderName&gt;</span></code> flag.</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>If you haven't done so already, configure the CloudBees Helm repo by the following commands.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>helm repo add cloudbees https://charts.cloudbees.com/public/cloudbees
helm repo update
</pre></div> </td></tr></table> </div> <p>Update the configmap, in the file<code class=codehilite><span class=n>templates</span><span class=o>/</span><span class=n>configmap</span><span class=p>.</span><span class=n>yaml</span></code>, set <code class=codehilite><span class=n>requiresExplicitInjection</span></code> to true.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span> requiresExplicitInjection: <span class=nb>true</span>
</pre></div> </td></tr></table> <p>Generate the end result via <code class=codehilite><span class=n>helm</span> <span class=k>template</span></code>.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span>helm template cloudbees-sidecar-injector <span class=se>\</span>
 cloudbees-sidecar-injector <span class=se>\</span>
 --namespace cloudbees-sidecar-injector<span class=se>\</span>
 &gt; cloudbees-sidecar-injector.yml
</pre></div> </td></tr></table> <p>And apply the file.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>kubectl apply -f cloudbees-sidecar-injector.yml
</pre></div> </td></tr></table> <h2 id=configure-operations-center>Configure Operations Center<a class=headerlink href=#configure-operations-center title="Permanent link">&para;</a></h2> <p>We have to configure two things in Operations Center. First, we create the AKS endpoint, and then we configure the Master template by adding a YAML snippet.</p> <p>We go to <code class=codehilite><span class=n>Operations</span> <span class=n>Center</span></code> -&gt; <code class=codehilite><span class=n>Manage</span> <span class=n>Jenkins</span></code> -&gt; <code class=codehilite><span class=n>Configure</span> <span class=k>System</span></code> -&gt; <code class=codehilite><span class=n>Kubernetes</span> <span class=n>Master</span> <span class=n>Provisioning</span></code>.</p> <h3 id=configure-endpoint>Configure Endpoint<a class=headerlink href=#configure-endpoint title="Permanent link">&para;</a></h3> <p><img alt="configure endpoint" src=../../images/multi-cluster-cjoc.png></p> <p>Every field is essential here.</p> <ul> <li><strong>API endpoint URL</strong>: the Kubernetes API server url, you should have this saved somewhere (e.g. <code class=codehilite><span class=o>~/</span><span class=p>.</span><span class=n>kube</span><span class=o>/</span><span class=n>config</span></code>)</li> <li><strong>Display Name</strong>: the name by which you can refer to this endpoint</li> <li><strong>Credentials</strong>: credentials of the Service Account that can access the Kubernetes API, you should have this saved somewhere (e.g. <code class=codehilite><span class=o>~/</span><span class=p>.</span><span class=n>kube</span><span class=o>/</span><span class=n>config</span></code>, <code class=codehilite><span class=n>users</span><span class=p>.</span><span class=k>user</span><span class=p>.</span><span class=n>token</span></code>)</li> <li><strong>Server Certificate</strong>: the certificate of the Kubernetes API Server of the target cluster, copy paste the contents of <code class=codehilite><span class=n>aks</span><span class=o>-</span><span class=n>kubernetes</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=n>server</span><span class=p>.</span><span class=n>pem</span></code></li> <li><strong>Namespace</strong>: the namespace we created on the AKS cluster which is configured to be used by Operations Center</li> <li><strong>Master URL Pattern</strong>: assuming that your domain name for the other cluster is different, make sure you have a pattern in here <code class=codehilite><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>ake</span><span class=p>.</span><span class=n>mydomain</span><span class=p>.</span><span class=n>com</span><span class=cm>/*/</span></code> ensure all Master will have that host name and the Master name will replace the <code class=codehilite><span class=o>*</span></code></li> <li><strong>Jenkins URL</strong>: the URL of this Operations Center, you can leave this blank</li> </ul> <h3 id=master-template>Master Template<a class=headerlink href=#master-template title="Permanent link">&para;</a></h3> <p>We can open up the Master template configuration by hitting the <code class=codehilite><span class=n>Advanced</span></code> button in the Kubernetes Master Provisioning block.</p> <p><img alt=multi-cluster-cjoc-template src=../../images/multi-cluster-cjoc-template-1.png></p> <p>We have to add the annotation <code class=codehilite><span class=n>com</span><span class=p>.</span><span class=n>cloudbees</span><span class=p>.</span><span class=n>sidecar</span><span class=o>-</span><span class=n>injector</span><span class=o>/</span><span class=n>inject</span><span class=p>:</span> <span class=n>yes</span></code> to ensure the Masters will receive the certificates from the CloudBees Sidecar Injector - so they can talk to Operations Center.</p> <p>The full snippet becomes this:</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=nt>apiVersion</span><span class=p>:</span> <span class=s>&quot;apps/v1&quot;</span>
<span class=nt>kind</span><span class=p>:</span> <span class=s>&quot;StatefulSet&quot;</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>template</span><span class=p>:</span>
    <span class=nt>metadata</span><span class=p>:</span>
      <span class=nt>annotations</span><span class=p>:</span>
        <span class=nt>com.cloudbees.sidecar-injector/inject</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</pre></div> </td></tr></table> <p><img alt=multi-cluster-cjoc-template src=../../images/multi-cluster-cjoc-template-2.png></p> <p>And then hit the <code class=codehilite><span class=n>Save</span></code> button at the bottom to persist our changes.</p> <h2 id=create-a-managed-master>Create a Managed Master<a class=headerlink href=#create-a-managed-master title="Permanent link">&para;</a></h2> <p>To create a Managed Master, we go to the home page of the Operations Center. If you're unsure, go to <code class=codehilite><span class=o>&lt;</span><span class=n>cjocHost</span><span class=o>&gt;/</span><span class=n>cjoc</span><span class=o>/</span></code> or click on the top left breadcrumb <code class=codehilite><span class=n>Jenkins</span></code>.</p> <p>On the top right, hit the button <code class=codehilite><span class=k>New</span> <span class=n>Master</span></code>.</p> <p><img alt=new-managed-master-step-1 src=../../images/multi-cluster-cjoc-create-mm1.png></p> <p>Give the Master an appropriate name and hit <code class=codehilite><span class=k>Go</span><span class=w></span></code>.</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Sometimes the button is not clickable. Click next to the button with your mouse to make the text field lose focus. It should now be clickable.</p> </div> <p><img alt=new-managed-master-step-2 src=../../images/multi-cluster-cjoc-create-mm2.png></p> <p>The first thing we have to change, is the <code class=codehilite><span class=k>Cluster</span> <span class=n>endpoint</span></code>. This should now be a dropdown with <code class=codehilite><span class=n>kubernetes</span></code> and <code class=codehilite><span class=n>Azure</span></code> (or whatever you've named your endpoint). Select the one that points to your other cluster, in my case, <code class=codehilite><span class=n>Azure</span></code>.</p> <p><img alt=new-managed-master-step-3 src=../../images/multi-cluster-cjoc-create-mm3.png></p> <p>We have one more change to make. We have to tell the JVM where our truststore is with the additional certificates. To ensure we can contact the Operations Center and the Kubernetes API.</p> <p>We do this by supplying the <code class=codehilite><span class=n>javax</span><span class=p>.</span><span class=n>net</span><span class=p>.</span><span class=n>ssl</span><span class=p>.</span><span class=n>trustStore</span></code> and <code class=codehilite><span class=n>javax</span><span class=p>.</span><span class=n>net</span><span class=p>.</span><span class=n>ssl</span><span class=p>.</span><span class=n>trustStorePassword</span></code> properties in the <code class=codehilite><span class=k>System</span> <span class=n>Properties</span></code> field. Each should be on its own line. If you're wondering what the location is, this is where the CloudBees Sidecar Injector will place the truststore.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>javax.net.ssl.trustStore<span class=o>=</span>/etc/ssl/certs/java/cacerts
javax.net.ssl.trustStorePassword<span class=o>=</span>changeit
</pre></div> </td></tr></table> <p>If you run into SSL or truststore issues -not trust issues, I cannot help you with those - you can enable debug logging by adding the following property.</p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>javax.net.debug<span class=o>=</span>SSL,trustmanager
</pre></div> </td></tr></table> <p><img alt=new-managed-master-step-4 src=../../images/multi-cluster-cjoc-create-mm4.png></p> <p>Hit the <code class=codehilite><span class=n>Save</span></code> button at the bottom, and you should be good to go!</p> <h2 id=__comments>Comments</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://joostvdg.github.io/cloudbees/multi-cluster/";
      this.page.identifier =
        "/cloudbees/multi-cluster/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//joostvdg-github-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../cbc-team-namespace/ title="Team Master Namespace" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> Team Master Namespace </span> </div> </a> <a href=../../jenkinsx/build-packs/ title="Build Packs" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Build Packs </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2019 Joost van der Griendt </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <a href=https://github.com/joostvdg class="md-footer-social__link fa fa-github"></a> <a href=https://twitter.com/joost_vdg class="md-footer-social__link fa fa-twitter"></a> <a href=https://linkedin.com/in/joostvdg class="md-footer-social__link fa fa-linkedin"></a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.c648116f.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> </body> </html>