<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Use Configuration as Code to automate the configuration of CloudBees CI"><link href=https://joostvdg.github.io/cloudbees/cbci-casc/ rel=canonical><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-8.5.9"><title>CloudBees CI - Configuration As Code - J's Software Development Pages</title><link rel=stylesheet href=../../assets/stylesheets/main.20d9efc8.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.08040f6c.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"JetBrains Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=orange data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#configuration-as-code class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="J's Software Development Pages" class="md-header__button md-logo" aria-label="J's Software Development Pages" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.35 10.03A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.03A6.004 6.004 0 0 0 0 14a6 6 0 0 0 6 6h13a5 5 0 0 0 5-5c0-2.64-2.05-4.78-4.65-4.97Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> J's Software Development Pages </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> CloudBees CI - Configuration As Code </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=orange data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=deep-orange data-md-color-accent=teal aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/joostvdg/joostvdg.github.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../blogs/jenkins-pipeline-support-tool/ class=md-tabs__link> Blogs </a> </li> <li class=md-tabs__item> <a href=../../jenkins/jenkins-on-kubernetes/ class="md-tabs__link md-tabs__link--active"> Jenkins & CloudBees </a> </li> <li class=md-tabs__item> <a href=../../openshift/rhos311-gcp-minimal/ class=md-tabs__link> Kubernetes & Docker </a> </li> <li class=md-tabs__item> <a href=../../tanzu/ class=md-tabs__link> VMware Tanzu </a> </li> <li class=md-tabs__item> <a href=../../jenkinsx/build-packs/ class=md-tabs__link> Jenkins X </a> </li> <li class=md-tabs__item> <a href=../../cloud/automation-pulumi/ class=md-tabs__link> Software Eng. </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="J's Software Development Pages" class="md-nav__button md-logo" aria-label="J's Software Development Pages" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.35 10.03A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.03A6.004 6.004 0 0 0 0 14a6 6 0 0 0 6 6h13a5 5 0 0 0 5-5c0-2.64-2.05-4.78-4.65-4.97Z"/></svg> </a> J's Software Development Pages </label> <div class=md-nav__source> <a href=https://github.com/joostvdg/joostvdg.github.io title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> joostvdg/joostvdg.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> Home <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Home data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Me </a> </li> <li class=md-nav__item> <a href=../../other/mkdocs/ class=md-nav__link> MKDocs (This Static Website) </a> </li> <li class=md-nav__item> <a href=../../other/vim/ class=md-nav__link> VIM </a> </li> <li class=md-nav__item> <a href=../../other/shell/ class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Blogs <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Blogs data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Blogs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../blogs/jenkins-pipeline-support-tool/ class=md-nav__link> Jenkins Pipeline Support Tools </a> </li> <li class=md-nav__item> <a href=../../blogs/graceful-shutdown/ class=md-nav__link> Docker Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../blogs/docker-alternatives/ class=md-nav__link> Pipelines with Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../blogs/k8s-lets-encrypt/ class=md-nav__link> Let's Encrypt for Kubernetes Apps </a> </li> <li class=md-nav__item> <a href=../../blogs/sso-azure-ad/ class=md-nav__link> CloudBees SSO Azure AD </a> </li> <li class=md-nav__item> <a href=../../blogs/teams-automation/ class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../../blogs/kubernetes-sso-keycloak/ class=md-nav__link> Kubernetes SSO Keycloak </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_8 type=checkbox id=__nav_2_8> <label class=md-nav__link for=__nav_2_8> Jenkins X Java Native Image Prod <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Jenkins X Java Native Image Prod" data-md-level=2> <label class=md-nav__title for=__nav_2_8> <span class="md-nav__icon md-icon"></span> Jenkins X Java Native Image Prod </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/01-intro/ class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/02-cloud-sql/ class=md-nav__link> Cloud SQL </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/03-quarkus/ class=md-nav__link> Quarkus </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/04-jx-import/ class=md-nav__link> Import Into Jenkins X </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/05-jx-secrets/ class=md-nav__link> Database Connection And Secrets </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/06-native-image/ class=md-nav__link> Native Image </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/07-pipeline-improvements/ class=md-nav__link> Pipeline Improvements </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/08-preview-int-test/ class=md-nav__link> Previews & Integration Tests </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/09-production-improvements/ class=md-nav__link> Production Improvements </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/10-promote-prod/ class=md-nav__link> Promote To Production </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_9 type=checkbox id=__nav_2_9> <label class=md-nav__link for=__nav_2_9> Jenkins Monitoring Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Jenkins Monitoring Kubernetes" data-md-level=2> <label class=md-nav__title for=__nav_2_9> <span class="md-nav__icon md-icon"></span> Jenkins Monitoring Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/introduction/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/prepare/ class=md-nav__link> Prepare Environment </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/install/ class=md-nav__link> Install Tools </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/metrics/ class=md-nav__link> Metrics </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/alerts/ class=md-nav__link> Alerts </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/pipeline/ class=md-nav__link> Pipeline </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/dashboard/ class=md-nav__link> Dashboard </a> </li> <li class=md-nav__item> <a href=../../blogs/monitor-jenkins-on-k8s/cloudbees/ class=md-nav__link> CloudBees </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../blogs/k8s-crd/ class=md-nav__link> Create your own k8s resource </a> </li> <li class=md-nav__item> <a href=../../blogs/dockercon-eu-2018/ class=md-nav__link> DockerCon EU 2018 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Jenkins & CloudBees <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Jenkins & CloudBees" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Jenkins & CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins/jenkins-on-kubernetes/ class=md-nav__link> Jenkins On Kubernetes </a> </li> <li class=md-nav__item> <a href=../../tanzu/jenkins-tap/ class=md-nav__link> TAP & Jenkins </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3 checked> <label class=md-nav__link for=__nav_3_3> CloudBees <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=CloudBees data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> CloudBees </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> CloudBees CasC <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> CloudBees CasC </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#solution class=md-nav__link> Solution </a> <nav class=md-nav aria-label=Solution> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=#steps-to-take class=md-nav__link> Steps to take </a> </li> <li class=md-nav__item> <a href=#tools-included class=md-nav__link> Tools Included </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#bootstrap-kubernetes-cluster class=md-nav__link> Bootstrap Kubernetes Cluster </a> <nav class=md-nav aria-label="Bootstrap Kubernetes Cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-namespaces class=md-nav__link> Create Namespaces </a> </li> <li class=md-nav__item> <a href=#configure-cert-manager-namespace class=md-nav__link> Configure cert-manager namespace </a> </li> <li class=md-nav__item> <a href=#external-dns-config class=md-nav__link> External DNS Config </a> </li> <li class=md-nav__item> <a href=#configure-cbci-namespace class=md-nav__link> Configure CBCI namespace </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#helmfile-configuration class=md-nav__link> Helm(file) Configuration </a> <nav class=md-nav aria-label="Helm(file) Configuration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#helmfile-layout class=md-nav__link> Helmfile Layout </a> </li> <li class=md-nav__item> <a href=#helmfileyaml class=md-nav__link> Helmfile.yaml </a> </li> <li class=md-nav__item> <a href=#helmfile-valuesyaml class=md-nav__link> Helmfile-values.yaml </a> </li> <li class=md-nav__item> <a href=#values-files class=md-nav__link> Values Files </a> </li> <li class=md-nav__item> <a href=#install-via-helmfile class=md-nav__link> Install Via Helmfile </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#casc-for-oc class=md-nav__link> CasC for OC </a> <nav class=md-nav aria-label="CasC for OC"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#make-oc-use-casc class=md-nav__link> Make OC use CasC </a> </li> <li class=md-nav__item> <a href=#bundle-structure class=md-nav__link> Bundle Structure </a> </li> <li class=md-nav__item> <a href=#configure-oc-via-casc class=md-nav__link> Configure OC via CasC </a> </li> <li class=md-nav__item> <a href=#managing-items class=md-nav__link> Managing Items </a> </li> <li class=md-nav__item> <a href=#keep-bundle-up-to-date-with-git-sync class=md-nav__link> Keep Bundle up-to-date with Git Sync </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#casc-for-controllers class=md-nav__link> CasC for Controllers </a> <nav class=md-nav aria-label="CasC for Controllers"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#synchronize-controller-bundles-to-oc class=md-nav__link> Synchronize Controller Bundles to OC </a> </li> <li class=md-nav__item> <a href=#bundle-inheritance class=md-nav__link> Bundle Inheritance </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../sso-azure-ad/ class=md-nav__link> Single Sign On - AzureAD </a> </li> <li class=md-nav__item> <a href=../teams-automation/ class=md-nav__link> CloudBees Automate Teams </a> </li> <li class=md-nav__item> <a href=../cbc-gke-helm/ class=md-nav__link> CloudBees CI on GKE </a> </li> <li class=md-nav__item> <a href=../cbc-eks/ class=md-nav__link> CloudBees CI on EKS </a> </li> <li class=md-nav__item> <a href=../cbc-team-namespace/ class=md-nav__link> Team Master Namespace </a> </li> <li class=md-nav__item> <a href=../multi-cluster-gke/ class=md-nav__link> Multi-Cluster GKE </a> </li> <li class=md-nav__item> <a href=../multi-cluster-eks/ class=md-nav__link> Multi-Cluster EKS </a> </li> <li class=md-nav__item> <a href=../multi-cluster/ class=md-nav__link> Multi-Cluster (OLD/AKS) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4> Jenkins <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Jenkins data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Jenkins </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins/ class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jobdsl/ class=md-nav__link> JobDSL </a> </li> <li class=md-nav__item> <a href=../../jenkins-jobs/jenkins-jobs-builder/ class=md-nav__link> JenkinsJobsBuilder </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_5 type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5> Jenkins Pipelines <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Jenkins Pipelines" data-md-level=2> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> Jenkins Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline/job-types/ class=md-nav__link> Job Types </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/kaniko-pipelines/ class=md-nav__link> Build Docker Image Kaniko </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/podtemplate-dind/ class=md-nav__link> PodTemplate With Docker-In-Docker </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/jenkins-parallel-pipeline/ class=md-nav__link> Parallel Pipelines </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/core-concepts/ class=md-nav__link> Core Concepts </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/artifactory-integration/ class=md-nav__link> Artifactory Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/declarative-pipeline/ class=md-nav__link> Pipeline (declarative) </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/groovy-pipeline/ class=md-nav__link> Groovy DSL Pipeline </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/global-shared-library/ class=md-nav__link> Pipeline Libraries </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/ide-integration-pipeline-dsl/ class=md-nav__link> DSL IDE Integration </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline/input/ class=md-nav__link> Input </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_6 type=checkbox id=__nav_3_6> <label class=md-nav__link for=__nav_3_6> Jenkins Pipeline Examples <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Jenkins Pipeline Examples" data-md-level=2> <label class=md-nav__title for=__nav_3_6> <span class="md-nav__icon md-icon"></span> Jenkins Pipeline Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-alternatives/ class=md-nav__link> Docker Alternatives </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/maven-declarative/ class=md-nav__link> Maven Declarative </a> </li> <li class=md-nav__item> <a href=../../jenkins-pipeline-examples/docker-declarative/ class=md-nav__link> Docker Declarative </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Kubernetes & Docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Kubernetes & Docker" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Kubernetes & Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1 type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1> OpenShift <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=OpenShift data-md-level=2> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> OpenShift </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../openshift/rhos311-gcp-minimal/ class=md-nav__link> OpenShift 3.11 GCP(minimal) </a> </li> <li class=md-nav__item> <a href=../../openshift/rhos311-gcp-medium/ class=md-nav__link> OpenShift 3.11 GCP(medium) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Kubernetes (K8S) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Kubernetes (K8S)" data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Kubernetes (K8S) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../kubernetes/cka-exam-prep/ class=md-nav__link> CKA Exam prep </a> </li> <li class=md-nav__item> <a href=../../kubernetes/tools/ class=md-nav__link> Tools </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> Managed Kubernetes (cloud) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Managed Kubernetes (cloud)" data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Managed Kubernetes (cloud) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/distributions/install-gke/ class=md-nav__link> GKE </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/gke-terraform/ class=md-nav__link> GKE Terraform </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/eks-eksctl/ class=md-nav__link> AWS EKS </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-cli/ class=md-nav__link> AKS CLI </a> </li> <li class=md-nav__item> <a href=../../kubernetes/distributions/aks-terraform/ class=md-nav__link> AKS Terraform </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> K8S Hard Way - GCE <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="K8S Hard Way - GCE" data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> K8S Hard Way - GCE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/ class=md-nav__link> Installer Preparation </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/terraform-compute/ class=md-nav__link> Create GCE resources </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/certificates/ class=md-nav__link> Prepare Certificates </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/kubeconfigs/ class=md-nav__link> Prepare Kubeconfigs </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/encryption/ class=md-nav__link> Encryption configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/etcd/ class=md-nav__link> ETCD configuration </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/controller/ class=md-nav__link> Controller Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/worker/ class=md-nav__link> Worker Config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/remote-access/ class=md-nav__link> Remote access </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/network/ class=md-nav__link> Network config </a> </li> <li class=md-nav__item> <a href=../../kubernetes/khw-gce/debug/ class=md-nav__link> Debug </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_5 type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5> Docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Docker data-md-level=2> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../docker/graceful-shutdown/ class=md-nav__link> Graceful Shutdown </a> </li> <li class=md-nav__item> <a href=../../docker/build-kit/ class=md-nav__link> BuildKit </a> </li> <li class=md-nav__item> <a href=../../docker/multi-stage-builds/ class=md-nav__link> Multi-Stage Builds(TBD) </a> </li> <li class=md-nav__item> <a href=../../docker/swarm/ class=md-nav__link> Swarm (mode) (TBD) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_6 type=checkbox id=__nav_4_6> <label class=md-nav__link for=__nav_4_6> Linux <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Linux data-md-level=2> <label class=md-nav__title for=__nav_4_6> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../linux/systemd/ class=md-nav__link> SystemD </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> VMware Tanzu <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="VMware Tanzu" data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> VMware Tanzu </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tanzu/ class=md-nav__link> Tanzu </a> </li> <li class=md-nav__item> <a href=../../tanzu/tap-on-tkgs/ class=md-nav__link> TAP on TKGs </a> </li> <li class=md-nav__item> <a href=../../tanzu/harbor-ca/ class=md-nav__link> Harbor with custom CA </a> </li> <li class=md-nav__item> <a href=../../tanzu/jenkins-tap/ class=md-nav__link> TAP Jenkins </a> </li> <li class=md-nav__item> <a href=../../tanzu/tkg-grafana/ class=md-nav__link> TKG Grafana with LDAP </a> </li> <li class=md-nav__item> <a href=../../tanzu/dependencies/ class=md-nav__link> Dependencies </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Jenkins X <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Jenkins X" data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Jenkins X </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/build-packs/ class=md-nav__link> Build Packs </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jx-pipelines/ class=md-nav__link> Jenkins X Pipelines </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6_3 type=checkbox id=__nav_6_3> <label class=md-nav__link for=__nav_6_3> Java Native Image Prod <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Java Native Image Prod" data-md-level=2> <label class=md-nav__title for=__nav_6_3> <span class="md-nav__icon md-icon"></span> Java Native Image Prod </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/01-intro/ class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/02-cloud-sql/ class=md-nav__link> Cloud SQL </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/03-quarkus/ class=md-nav__link> Quarkus </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/04-jx-import/ class=md-nav__link> Import Into Jenkins X </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/05-jx-secrets/ class=md-nav__link> Database Connection And Secrets </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/06-native-image/ class=md-nav__link> Native Image </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/07-pipeline-improvements/ class=md-nav__link> Pipeline Improvements </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/08-preview-int-test/ class=md-nav__link> Previews & Integration Tests </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/09-production-improvements/ class=md-nav__link> Production Improvements </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/java-native-prod/10-promote-prod/ class=md-nav__link> Promote To Production </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../jenkinsx/builder-image/ class=md-nav__link> Create Builder Image </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot/ class=md-nav__link> JX Boot GKE </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/jxboot-aks/ class=md-nav__link> JX Boot AKS </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/aks-boot-core/ class=md-nav__link> JX Boot & CloudBees Core </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/rhos-311-minimal/ class=md-nav__link> OpenShift 3.11 </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/rhos-311-restricted/ class=md-nav__link> OpenShift 3.11 - Restricted </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/lighthouse-bitbucket/ class=md-nav__link> Lighthouse & Bitbucket </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hello-world/ class=md-nav__link> HelloWorld </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/maven/ class=md-nav__link> Maven </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/hybrid/ class=md-nav__link> Hybrid </a> </li> <li class=md-nav__item> <a href=../../jenkinsx/kubernetes-days/ class=md-nav__link> Example For Console Reel </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> Software Eng. <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Software Eng." data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Software Eng. </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7_1 type=checkbox id=__nav_7_1> <label class=md-nav__link for=__nav_7_1> Automation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Automation data-md-level=2> <label class=md-nav__title for=__nav_7_1> <span class="md-nav__icon md-icon"></span> Automation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cloud/automation-pulumi/ class=md-nav__link> Pulumi </a> </li> <li class=md-nav__item> <a href=../../certificates/lets-encrypt-k8s/ class=md-nav__link> Let's Encrypt K8S </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7_2 type=checkbox id=__nav_7_2> <label class=md-nav__link for=__nav_7_2> Software Engineering <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Software Engineering" data-md-level=2> <label class=md-nav__title for=__nav_7_2> <span class="md-nav__icon md-icon"></span> Software Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../swe/important-concepts/ class=md-nav__link> Important Concepts </a> </li> <li class=md-nav__item> <a href=../../swe/naming/ class=md-nav__link> Naming </a> </li> <li class=md-nav__item> <a href=../../swe/distributed/ class=md-nav__link> Distributed Computing </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7_3 type=checkbox id=__nav_7_3> <label class=md-nav__link for=__nav_7_3> Productivity <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Productivity data-md-level=2> <label class=md-nav__title for=__nav_7_3> <span class="md-nav__icon md-icon"></span> Productivity </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../productivity/ class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../productivity/incidents/ class=md-nav__link> Incidents </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7_4 type=checkbox id=__nav_7_4> <label class=md-nav__link for=__nav_7_4> Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Java data-md-level=2> <label class=md-nav__title for=__nav_7_4> <span class="md-nav__icon md-icon"></span> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../java/ class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=../../keep-watching/ class=md-nav__link> Spring Boot App </a> </li> <li class=md-nav__item> <a href=../../java/networking/ class=md-nav__link> Java Networking </a> </li> <li class=md-nav__item> <a href=../../java/concurrency/ class=md-nav__link> Java Concurrency </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#solution class=md-nav__link> Solution </a> <nav class=md-nav aria-label=Solution> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prerequisites class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=#steps-to-take class=md-nav__link> Steps to take </a> </li> <li class=md-nav__item> <a href=#tools-included class=md-nav__link> Tools Included </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#bootstrap-kubernetes-cluster class=md-nav__link> Bootstrap Kubernetes Cluster </a> <nav class=md-nav aria-label="Bootstrap Kubernetes Cluster"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-namespaces class=md-nav__link> Create Namespaces </a> </li> <li class=md-nav__item> <a href=#configure-cert-manager-namespace class=md-nav__link> Configure cert-manager namespace </a> </li> <li class=md-nav__item> <a href=#external-dns-config class=md-nav__link> External DNS Config </a> </li> <li class=md-nav__item> <a href=#configure-cbci-namespace class=md-nav__link> Configure CBCI namespace </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#helmfile-configuration class=md-nav__link> Helm(file) Configuration </a> <nav class=md-nav aria-label="Helm(file) Configuration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#helmfile-layout class=md-nav__link> Helmfile Layout </a> </li> <li class=md-nav__item> <a href=#helmfileyaml class=md-nav__link> Helmfile.yaml </a> </li> <li class=md-nav__item> <a href=#helmfile-valuesyaml class=md-nav__link> Helmfile-values.yaml </a> </li> <li class=md-nav__item> <a href=#values-files class=md-nav__link> Values Files </a> </li> <li class=md-nav__item> <a href=#install-via-helmfile class=md-nav__link> Install Via Helmfile </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#casc-for-oc class=md-nav__link> CasC for OC </a> <nav class=md-nav aria-label="CasC for OC"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#make-oc-use-casc class=md-nav__link> Make OC use CasC </a> </li> <li class=md-nav__item> <a href=#bundle-structure class=md-nav__link> Bundle Structure </a> </li> <li class=md-nav__item> <a href=#configure-oc-via-casc class=md-nav__link> Configure OC via CasC </a> </li> <li class=md-nav__item> <a href=#managing-items class=md-nav__link> Managing Items </a> </li> <li class=md-nav__item> <a href=#keep-bundle-up-to-date-with-git-sync class=md-nav__link> Keep Bundle up-to-date with Git Sync </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#casc-for-controllers class=md-nav__link> CasC for Controllers </a> <nav class=md-nav aria-label="CasC for Controllers"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#synchronize-controller-bundles-to-oc class=md-nav__link> Synchronize Controller Bundles to OC </a> </li> <li class=md-nav__item> <a href=#bundle-inheritance class=md-nav__link> Bundle Inheritance </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/joostvdg/joostvdg.github.io/edit/master/docs/cloudbees/cbci-casc.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=configuration-as-code>Configuration As Code<a class=headerlink href=#configuration-as-code title="Permanent link">&para;</a></h1> <p>What we will do is leverage CloudBees CI's(CBCI) Configuration as Code (<abbr title="CloudBees Configuration As Code">CasC</abbr>) to automate as much of the CBCI installation as possible.</p> <h2 id=solution>Solution<a class=headerlink href=#solution title="Permanent link">&para;</a></h2> <div class="admonition attention"> <p class=admonition-title>CBCI Modern only!</p> <p>This solution is for CloudBees CI Modern, on a recent Kubernetes cluster.</p> </div> <h3 id=prerequisites>Prerequisites<a class=headerlink href=#prerequisites title="Permanent link">&para;</a></h3> <ul> <li>A running Kubernetes cluster</li> <li><a href=https://helm.sh/ >Helm</a></li> <li><a href=https://github.com/roboll/helmfile>Helmfile</a></li> <li><a href=https://github.com/databus23/helm-diff>Helm diff plugin</a></li> <li><a href=https://kubernetes.io/docs/tasks/tools/ >Kubectl</a> with access to the Kubernetes cluster</li> <li>CloudBees CI license</li> </ul> <h4 id=install-helm-diff>Install Helm diff<a class=headerlink href=#install-helm-diff title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code>helm plugin install https://github.com/databus23/helm-diff
</code></pre></div> <h3 id=steps-to-take>Steps to take<a class=headerlink href=#steps-to-take title="Permanent link">&para;</a></h3> <ul> <li>Bootstrap the Kubernetes cluster</li> <li>Setup Helm configuration (we'll use Helmfile)</li> <li>Setup Configuration as Code for the Operations Center</li> <li>Setup Configuration as Code for Controllers</li> </ul> <h3 id=tools-included>Tools Included<a class=headerlink href=#tools-included title="Permanent link">&para;</a></h3> <ul> <li><a href=https://kubernetes.github.io/ingress-nginx/deploy/ >nginx-ingress</a>: our Ingress Controller for accessing web applications in the cluster</li> <li><a href=https://github.com/kubernetes-sigs/external-dns>external-dns</a>: manages the DNS entries in our Google CloudDNS Zone, so each Ingress resource gets its own unique DNS entry, this also enables us to generate specfic certificates via cert-manager</li> <li><a href=https://cert-manager.io/ >cert-manager</a>: manages certificate requests, so all our web applications can use TLS</li> <li><a href=https://www.openldap.org/ >openldap</a>: an LDAP server, for having an actual representative authentication realm for CBCI</li> <li>We use <a href=https://geek-cookbook.funkypenguin.co.nz/recipes/openldap/ >Geek-Cookbook</a>'s version.</li> <li><a href=https://prometheus.io/docs/introduction/overview/ >prometheus</a>: we use Prometheus to collect metrics from the resources in the cluster</li> <li><a href=https://grafana.com/grafana/ >grafana</a>: we use Grafana to turn the metrics from Prometheus into viewable dashboards<ul> <li>the dashboard that is installed comes from <a href=https://joostvdg.github.io/blogs/monitor-jenkins-on-k8s/dashboard/ >here</a></li> </ul> </li> </ul> <h2 id=bootstrap-kubernetes-cluster>Bootstrap Kubernetes Cluster<a class=headerlink href=#bootstrap-kubernetes-cluster title="Permanent link">&para;</a></h2> <h3 id=create-namespaces>Create Namespaces<a class=headerlink href=#create-namespaces title="Permanent link">&para;</a></h3> <p>We need a namespace for nginx-ingress, cert-manager, and CloudBees CI.</p> <div class=highlight><pre><span></span><code>kubectl create namespace cbci
kubectl create namespace cert-manager
kubectl create namespace nginx-ingress
</code></pre></div> <h3 id=configure-cert-manager-namespace>Configure cert-manager namespace<a class=headerlink href=#configure-cert-manager-namespace title="Permanent link">&para;</a></h3> <p>Cert Manager will perform some validations on Ingress resources. It cannot do that on <em>its own</em> Ingress resource, so we label the <code>cert-manager</code> namespace so Cert Manager ignores itself.</p> <div class=highlight><pre><span></span><code>kubectl label namespace cert-manager certmanager.k8s.io/disable-validation<span class=o>=</span><span class=nb>true</span>
</code></pre></div> <h3 id=external-dns-config>External DNS Config<a class=headerlink href=#external-dns-config title="Permanent link">&para;</a></h3> <p>In my case, I am using the <a href=https://github.com/kubernetes-sigs/external-dns>External DNS Controller</a> with Google Cloud and a Cloud DNS Zone.</p> <p>For this I have created a <abbr title="Google Cloud Platform">GCP</abbr> Service Account with a credentials file (the JSON file). If you want both <code>cert-manager</code> and <code>nginx-ingress</code> to directly use the Cloud DNS configuration to bypass the more lenghty alternatives (such as http verification) you need to supply them with the <abbr title="Google Cloud Platform">GCP</abbr> Service Account.</p> <p><a href=https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/nginx-ingress.md>Read here</a> for more on using the External DNS Controller with <abbr title="Google Cloud Platform">GCP</abbr>.</p> <p>For other options, please refer to the <a href=https://github.com/kubernetes-sigs/external-dns#deploying-to-a-cluster>External DNS Controller docs</a>, which has guides for all the supported environments.</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>Cert Manager</label><label for=__tabbed_1_2>Nginx Ingress Controller</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code>kubectl -n cert-manager create secret generic external-dns-gcp-sa --from-file<span class=o>=</span>credentials.json
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code>kubectl -n nginx-ingress create secret generic external-dns-gcp-sa --from-file<span class=o>=</span>credentials.json 
</code></pre></div> </div> </div> </div> <h3 id=configure-cbci-namespace>Configure CBCI namespace<a class=headerlink href=#configure-cbci-namespace title="Permanent link">&para;</a></h3> <p>We need to configure the LDAP password secret, so our <abbr title="CloudBees Configuration As Code">CasC</abbr> for <abbr title="CloudBees Operations Center">OC</abbr> bundle can configure LDAP while <abbr title="Jenkins Configuration As Code (OSS plugin)">JCasC</abbr> translates the placeholder to the actual password.</p> <p>This should be the same value as the <code>ldapGlobalPassword</code> in the <code>helmfile-values.yaml</code>.</p> <div class=highlight><pre><span></span><code>kubectl create secret generic ldap-manager-pass --from-literal<span class=o>=</span><span class=nv>pass</span><span class=o>=</span><span class=si>${</span><span class=nv>LDAP_GLOBAL_PASSWORD</span><span class=si>}</span> --namespace cbci
</code></pre></div> <h2 id=helmfile-configuration>Helm(file) Configuration<a class=headerlink href=#helmfile-configuration title="Permanent link">&para;</a></h2> <h3 id=helmfile-layout>Helmfile Layout<a class=headerlink href=#helmfile-layout title="Permanent link">&para;</a></h3> <p>The files that matter to Helmfile are the following.</p> <div class=highlight><span class=filename>helmfile directory structure</span><pre><span></span><code>.
├── helmfile-values.yaml
├── helmfile.yaml
└── values
    └── *.yaml.gotmpl
</code></pre></div> <h3 id=helmfileyaml>Helmfile.yaml<a class=headerlink href=#helmfileyaml title="Permanent link">&para;</a></h3> <p>The <code>helmfile.yaml</code> file has several sections.</p> <p>Let's look at each section separately, before I share the whole file.</p> <p>We start with the environments. In this case, I have just one environments, <code>default</code>, but you can choose to have more, opting to have seperate value files for Staging and Production for example.</p> <div class=highlight><span class=filename>helmfile.yaml (enviroments)</span><pre><span></span><code><span class=nt>environments</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=c1># (1)</span><span class=w></span>
<span class=w>    </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">helmfile-values.yaml</span><span class=w> </span>
</code></pre></div> <ol> <li>the default environment is chosen if you do not choose an environment</li> </ol> <p>As Helmfile will interact with Helm for us, we can properly manage our Helm repositories. If we give Helmfile a list of Helm repositories, it will make to update them prior to any installation, so you don't have to worry about that.</p> <div class=highlight><span class=filename>helmfile.yaml (repositories)</span><pre><span></span><code><span class=nt>repositories</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">stable</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.helm.sh/stable</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cloudbees</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.cloudbees.com/public/cloudbees</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jetstack</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.jetstack.io</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bitnami</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.bitnami.com/bitnami</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">geek-cookbook</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://geek-cookbook.github.io/charts/</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">grafana</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://grafana.github.io/helm-charts</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">prometheus-community</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://prometheus-community.github.io/helm-charts</span><span class=w></span>
</code></pre></div> <p>Another thing we cannot steer if Helmfile does the interaction with Helm for us, are Helms flags. Some of these flags might be important for you, I've chosen to set these.</p> <div class=highlight><span class=filename>helmfile.yaml (defaults)</span><pre><span></span><code><span class=nt>helmDefaults</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>wait</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w> </span><span class=c1># (1)</span><span class=w></span>
<span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">600</span><span class=w> </span><span class=c1># (2)</span><span class=w></span>
<span class=w>  </span><span class=nt>historyMax</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">25</span><span class=w> </span><span class=c1># (3)</span><span class=w></span>
<span class=w>  </span><span class=nt>createNamespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w> </span><span class=c1># (4)</span><span class=w></span>
</code></pre></div> <ol> <li>We will wait on the resources becoming ready before creating the next. This ensures our dependencies are honored.</li> <li>I personally always set an explicit timeout, so it is easy to spot if we hit a timeout. The timeout refers to how long we wait for the resources to be ready.</li> <li>How many update versions Hel tracks. I like to be able to rollback and have a bit of history.</li> <li>Some namespaces we created in the bootstrap, the rest should get created when required. This setting will make sure that any Helm installation in a new namespace, will have it created.</li> </ol> <p>Next up are the releases. These are the Helm chart releases. For the latest versions and the configurable properties, I recommend using <a href=https://artifacthub.io/ >ArtifactHub.io</a>.</p> <p>Releases need a name, chart, version, and values. The chart, is a combination of the source repository (how you named it) and the chart name <em>in</em> that repository. In our case, this would be <code>cloudbees</code>, because I called the CloudBees Helm repository that, and then <code>/cloudbees-core</code>. While the product has been renamed, the Helm chart has kept the CloudBees Core name.</p> <p>Another thing you can see, is the <code>needs</code> list. This tells Helmfile to install those releases (by name) before installing this one.</p> <div class=highlight><span class=filename>helmfile.yaml (releases)</span><pre><span></span><code><span class=nt>releases</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cbci</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cbci</span><span class=w></span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cloudbees/cloudbees-core</span><span class=w> </span><span class=c1># (1)</span><span class=w></span>
<span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&#39;3.37.2+7390bf58e3ab&#39;</span><span class=w> </span>
<span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values/cbci.yaml.gotmpl</span><span class=w>  </span><span class=c1># (2)</span><span class=w></span>
<span class=w>  </span><span class=nt>needs</span><span class=p>:</span><span class=w> </span><span class=c1># (3)</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">external-dns</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ldap</span><span class=w></span>

<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cm-cluster-issuer</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span><span class=w></span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">incubator/raw</span><span class=w> </span><span class=c1># (4)</span><span class=w></span>
<span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values/cluster-issuer.yaml.gotmpl</span><span class=w></span>
<span class=w>  </span><span class=nt>needs</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cbci</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span><span class=w></span>
</code></pre></div> <ol> <li>The name of a Chart, <code>&lt;Repository Name&gt;/&lt;Chart Name&gt;</code></li> <li>The values to use for this Helm installation. In this case we're specifying a <a href=https://blog.gopheracademy.com/advent-2017/using-go-templates/ >Go template</a>, signified by the <code>yaml.gotmpl</code> extension.</li> <li>Informs Helmfile there is a dependency relationship between this Release and others, making sure it install them in the proper order.</li> <li><code>incubator/raw</code> lets you include templated files directly, without having a Helm release</li> </ol> <p>Helmfile supports various ways of supplying the Helm values. In this example I'm using a <a href=https://blog.gopheracademy.com/advent-2017/using-go-templates/ >Go template</a> which lets us template the Helm chart installations. By using a template values file, we can re-use values accross Helm charts to ensure that if two or more Charts reference the same value, we can guarantee it is the same.</p> <p>The second release, <code>cm-cluster-issuer</code> is a file that is in the same repository as the Helmfile configuration. This is why the chart is listed as <code>incubator/raw</code>, it lets you include templated Kubernetes manifests directly, without creating a Helm release.</p> <details class=example> <summary>Full Helmfile</summary> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>helmfile.yaml</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span>
<span class=normal>71</span>
<span class=normal>72</span>
<span class=normal>73</span>
<span class=normal>74</span>
<span class=normal>75</span>
<span class=normal>76</span>
<span class=normal>77</span>
<span class=normal>78</span>
<span class=normal>79</span>
<span class=normal>80</span>
<span class=normal>81</span>
<span class=normal>82</span>
<span class=normal>83</span>
<span class=normal>84</span>
<span class=normal>85</span>
<span class=normal>86</span>
<span class=normal>87</span>
<span class=normal>88</span>
<span class=normal>89</span>
<span class=normal>90</span>
<span class=normal>91</span>
<span class=normal>92</span>
<span class=normal>93</span>
<span class=normal>94</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nt>environments</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">helmfile-values.yaml</span><span class=w></span>

<span class=nt>repositories</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">stable</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.helm.sh/stable</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cloudbees</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.cloudbees.com/public/cloudbees</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jetstack</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.jetstack.io</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bitnami</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://charts.bitnami.com/bitnami</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">geek-cookbook</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://geek-cookbook.github.io/charts/</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">grafana</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://grafana.github.io/helm-charts</span><span class=w>  </span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">prometheus-community</span><span class=w></span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://prometheus-community.github.io/helm-charts</span><span class=w></span>

<span class=nt>helmDefaults</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>wait</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">600</span><span class=w></span>
<span class=w>  </span><span class=nt>historyMax</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">25</span><span class=w></span>
<span class=w>  </span><span class=nt>createNamespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w>  </span>

<span class=nt>releases</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cbci</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cbci</span><span class=w></span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cloudbees/cloudbees-core</span><span class=w> </span>
<span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3.37.2+7390bf58e3ab</span><span class=w> </span>
<span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values/cbci.yaml.gotmpl</span><span class=w></span>
<span class=w>  </span><span class=nt>needs</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">external-dns</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ldap</span><span class=w></span>

<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span><span class=w></span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bitnami/nginx-ingress-controller</span><span class=w></span>
<span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">7.6.21</span><span class=w></span>
<span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values/nginx-ingress.yaml.gotmpl</span><span class=w></span>

<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">external-dns</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span><span class=w></span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bitnami/external-dns</span><span class=w></span>
<span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5.4.8</span><span class=w></span>
<span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values/external-dns.yaml.gotmpl</span><span class=w></span>

<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span><span class=w></span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jetstack/cert-manager</span><span class=w></span>
<span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1.5.3</span><span class=w></span>
<span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values/cert-manager.yaml.gotmpl</span><span class=w></span>
<span class=w>  </span><span class=nt>needs</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span><span class=w></span>

<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cm-cluster-issuer</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span><span class=w></span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">incubator/raw</span><span class=w></span>
<span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values/cluster-issuer.yaml.gotmpl</span><span class=w></span>
<span class=w>  </span><span class=nt>needs</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cbci</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager</span><span class=w></span>

<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ldap</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cbci</span><span class=w></span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">geek-cookbook/openldap</span><span class=w></span>
<span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1.2.4</span><span class=w></span>
<span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values/ldap.yaml.gotmpl</span><span class=w></span>

<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">prometheus</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mon</span><span class=w></span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">prometheus-community/prometheus</span><span class=w></span>
<span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">14.8.1</span><span class=w></span>
<span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values/prom.yaml.gotmpl</span><span class=w></span>

<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">grafana</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mon</span><span class=w></span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">grafana/grafana</span><span class=w></span>
<span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">6.16.11</span><span class=w></span>
<span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values/grafana.yaml.gotmpl</span><span class=w></span>
<span class=w>  </span><span class=nt>needs</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">prometheus</span><span class=w></span>
</code></pre></div></td></tr></table></div> </details> <h3 id=helmfile-valuesyaml>Helmfile-values.yaml<a class=headerlink href=#helmfile-valuesyaml title="Permanent link">&para;</a></h3> <p>As stated in the previous section, I have opted for using templated Helm values files. This lets me add placeholder values, which I can replace with values via Helmfile.</p> <p>In the <code>environments</code> section, I referenced the file <code>helmfile-values.yaml</code> for the default, and only, environment. So let's take a look at this file.</p> <p>There are mostly passwords in there, for Grafana and LDAP. There are also two values related to the External DNS Controller configuration, <code>googleProject</code> and <code>googleASSecret</code>.</p> <p>Feel free to remove these, if you're not using <abbr title="Google Cloud Platform">GCP</abbr> or you're not using the External DNS Controller.</p> <div class=highlight><span class=filename>helmfile-values.yaml</span><pre><span></span><code><span class=nt>adminEmail</span><span class=p>:</span><span class=w> </span><span class=c1># (1)</span><span class=w></span>
<span class=nt>googleProject</span><span class=p>:</span><span class=w> </span><span class=c1># (2)</span><span class=w></span>
<span class=nt>googleASSecret</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">external-dns-gcp-sa</span><span class=w> </span><span class=c1># (3)</span><span class=w></span>
<span class=nt>ldapGlobalPassword</span><span class=p>:</span><span class=w> </span>
<span class=nt>ldapUser1Password</span><span class=p>:</span><span class=w> </span>
<span class=nt>ldapUser2Password</span><span class=p>:</span><span class=w> </span>
<span class=nt>ldapUser3Password</span><span class=p>:</span><span class=w> </span>
<span class=nt>grafanaUser</span><span class=p>:</span><span class=w> </span>
<span class=nt>grafanaPass</span><span class=p>:</span><span class=w> </span>
</code></pre></div> <ol> <li>the admin email address used for the Cluster Issuer, and will receive notifications from Cert Manager for certificate expirations</li> <li>the Google Project <em>id</em> where the Cloud DNS Zone resides</li> <li>the name of the Kubernetes secret containing the <abbr title="Google Cloud Platform">GCP</abbr> Service Account JSON file</li> </ol> <h3 id=values-files>Values Files<a class=headerlink href=#values-files title="Permanent link">&para;</a></h3> <p>I won't list each of them here, they are all available in my <a href=https://github.com/joostvdg/cloudbees-ci-casc/ >CloudBees CI <abbr title="CloudBees Configuration As Code">CasC</abbr></a> repo on GitHub.</p> <p>The Cluster Issuer is an optional resource. I personally always prefer having an automated DNS setup and HTTPS with matching Certificates (e.g., no wildcard certificates).</p> <div class="admonition tip"> <p class=admonition-title>Optional</p> <p>Only use this if you are using <abbr title="Google Cloud Platform">GCP</abbr>, the External DNS Controller, and Cert Manager.</p> </div> <div class=highlight><span class=filename>values/cluster-issuer.yaml.gotmpl</span><pre><span></span><code><span class=nt>resources</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span><span class=w></span>
<span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span><span class=w></span>
<span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span><span class=w></span>
<span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>acme</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=nt>email</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{{</span><span class=w> </span><span class=nv>.Values.adminEmail</span><span class=w> </span><span class="p p-Indicator">}}</span><span class=w></span>
<span class=w>        </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://acme-v02.api.letsencrypt.org/directory</span><span class=w></span>
<span class=w>        </span><span class=nt>privateKeySecretRef</span><span class=p>:</span><span class=w></span>
<span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span><span class=w></span>
<span class=w>        </span><span class=nt>solvers</span><span class=p>:</span><span class=w> </span><span class=c1># (1)</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span><span class=w> </span>
<span class=w>          </span><span class=nt>dns01</span><span class=p>:</span><span class=w></span>
<span class=w>            </span><span class=nt>cloudDNS</span><span class=p>:</span><span class=w></span>
<span class=w>              </span><span class=nt>project</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{{</span><span class=w> </span><span class=nv>.Values.googleProject</span><span class=w> </span><span class="p p-Indicator">}}</span><span class=w></span>
<span class=w>              </span><span class=nt>serviceAccountSecretRef</span><span class=p>:</span><span class=w></span>
<span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{{</span><span class=w> </span><span class=nv>.Values.googleASSecret</span><span class=w> </span><span class="p p-Indicator">}}</span><span class=w></span>
<span class=w>                </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">credentials.json</span><span class=w></span>
</code></pre></div> <ol> <li>An empty 'selector' means that this solver matches all domains</li> </ol> <p>The most important one of couse, is the Helm values for the CloudBees CI installation. It already contains some secret sauce that will help us with synchronizing the <abbr title="CloudBees Configuration As Code">CasC</abbr> for <abbr title="CloudBees Operations Center">OC</abbr> Bundle.</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>values/cbci.yaml.gotmpl</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nt>OperationsCenter</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>HostName</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{{</span><span class=w> </span><span class=nv>.Values.cbciHostname</span><span class=w> </span><span class="p p-Indicator">}}</span><span class=w></span>
<span class=w>  </span><span class=nt>CSRF</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>ProxyCompatibility</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<span class=w>  </span><span class=nt>Annotations</span><span class=p>:</span><span class=w> </span><span class=c1># (1)</span><span class=w></span>
<span class=w>    </span><span class=nt>prometheus.io/path</span><span class=p>:</span><span class=w> </span><span class=s>&quot;/prometheus&quot;</span><span class=w></span>
<span class=w>    </span><span class=nt>prometheus.io/port</span><span class=p>:</span><span class=w> </span><span class=s>&quot;8080&quot;</span><span class=w></span>
<span class=w>    </span><span class=nt>prometheus.io/scrape</span><span class=p>:</span><span class=w> </span><span class=s>&quot;true&quot;</span><span class=w></span>
<span class=w>  </span><span class=nt>Ingress</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>Annotations</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>cert-manager.io/cluster-issuer</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span><span class=w> </span><span class=c1># (2)</span><span class=w></span>
<span class=w>      </span><span class=nt>kubernetes.io/tls-acme</span><span class=p>:</span><span class=w> </span><span class=s>&#39;true&#39;</span><span class=w></span>
<span class=w>      </span><span class=nt>kubernetes.io/ingress.class</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class=w></span>
<span class=w>    </span><span class=nt>tls</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>Enable</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<span class=w>      </span><span class=nt>Host</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{{</span><span class=w> </span><span class=nv>.Values.cbciHostname</span><span class=w> </span><span class="p p-Indicator">}}</span><span class=w></span>
<span class=w>      </span><span class=nt>SecretName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-cbci-tls-secret</span><span class=w></span>
<span class=w>  </span><span class=nt>JavaOpts</span><span class=p>:</span><span class=w> </span><span class=c1># (3)</span><span class=w></span>
<span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">-Djenkins.install.runSetupWizard=false</span><span class=w></span>
<span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">-Dcore.casc.config.bundle=/var/jenkins_config/oc-casc-bundle-from-git/cloudbees-ci-casc/casc-for-oc/bundle</span><span class=w></span>
<span class=w>  </span><span class=nt>ContainerEnv</span><span class=p>:</span><span class=w> </span><span class=c1># (4)</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LDAP_MANAGER_PASSWORD</span><span class=w></span>
<span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w></span>
<span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ldap-manager-pass</span><span class=w></span>
<span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pass</span><span class=w></span>
<span class=w>  </span><span class=nt>ExtraContainers</span><span class=p>:</span><span class=w> </span><span class=c1># (5)</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">git-sync</span><span class=w></span>
<span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcr.io/k8s-staging-git-sync/git-sync@sha256:866599ca98bcde1404b56152d8601888a5d3dae7fc21665155577d607652aa09</span><span class=w></span>
<span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--repo=https://github.com/joostvdg/cloudbees-ci-casc</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--branch=main</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--depth=1</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--wait=20</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--root=/git</span><span class=w></span>
<span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">content-from-git</span><span class=w></span>
<span class=w>        </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/git</span><span class=w></span>

<span class=w>  </span><span class=nt>ExtraVolumes</span><span class=p>:</span><span class=w> </span><span class=c1># (6)</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">content-from-git</span><span class=w></span>
<span class=w>    </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span><span class=w></span>
<span class=w>  </span><span class=nt>ExtraVolumeMounts</span><span class=p>:</span><span class=w> </span><span class=c1># (7)</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">content-from-git</span><span class=w></span>
<span class=w>    </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/jenkins_config/oc-casc-bundle-from-git</span><span class=w></span>
<span class=w>    </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>

<span class=nt>Agents</span><span class=p>:</span><span class=w> </span><span class=c1># (8)</span><span class=w></span>
<span class=w>  </span><span class=nt>Enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<span class=w>  </span><span class=nt>SeparateNamespace</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>Enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<span class=w>    </span><span class=nt>Name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ci-agents</span><span class=w></span>
<span class=w>    </span><span class=nt>Create</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>

<span class=nt>Hibernation</span><span class=p>:</span><span class=w> </span><span class=c1># (9)</span><span class=w></span>
<span class=w>  </span><span class=nt>Enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
</code></pre></div></td></tr></table></div> <ol> <li><abbr title="CloudBees Operations Center">OC</abbr> Pod Annotations for Prometheus, so our Prometheus installation can scrape the Metrics from the <abbr title="CloudBees Operations Center">OC</abbr></li> <li>Annotations for the Ingress resource, so we get a valid certificate from Cert Manager via our referenced Certificate Issuer</li> <li>Disable the Installation Wizard, and tell the <abbr title="CloudBees Operations Center">OC</abbr> where it can find its <abbr title="CloudBees Configuration As Code">CasC</abbr> Bundle</li> <li>Map the LDAP password secret as an environment variable, so <abbr title="Jenkins Configuration As Code (OSS plugin)">JCasC</abbr> can interpolate it</li> <li>Define a sidecar container with the <a href=https://github.com/kubernetes/git-sync>Git Sync</a></li> <li>Define additional Pod volumes</li> <li>Define additional <abbr title="CloudBees Operations Center">OC</abbr> Container Volume Mounts</li> <li>Let CloudBees CI run Kubernetes agent in a separate namespace</li> <li>Enable the CloudBees CI <a href=https://docs.cloudbees.com/docs/cloudbees-ci/latest/cloud-admin-guide/managing-masters#_hibernation_in_managed_masters>Hibernation feature</a></li> </ol> <p>Some of the things we're doing in this Helm file configuration:</p> <ul> <li><abbr title="CloudBees Operations Center">OC</abbr> Pod Annotations for Prometheus, so our Prometheus installation can scrape the Metrics from the <abbr title="CloudBees Operations Center">OC</abbr></li> <li>Annotations for the Ingress resource, so we get a valid certificate from Cert Manager via our referenced Certificate Issuer</li> <li>Tell the <abbr title="CloudBees Operations Center">OC</abbr> where it can find its <abbr title="CloudBees Configuration As Code">CasC</abbr> Bundle</li> <li>Define a sidecar container with the <a href=https://github.com/kubernetes/git-sync>Git Sync</a> with additional volume mounts (more at <a href=/cloudbees/cbci-casc/#git-sync-for-casc-oc-bundle>git-sync-for-casc-oc-bundle</a>) </li> <li>Let CloudBees CI run Kubernetes agent in a separate namespace</li> <li>Enable the CloudBees CI <a href=https://docs.cloudbees.com/docs/cloudbees-ci/latest/cloud-admin-guide/managing-masters#_hibernation_in_managed_masters>Hibernation feature</a></li> </ul> <h3 id=install-via-helmfile>Install Via Helmfile<a class=headerlink href=#install-via-helmfile title="Permanent link">&para;</a></h3> <p>To verify the Helm and Helmfile configuration is correct, you can run the validate command.</p> <div class=highlight><pre><span></span><code>helmfile lint
</code></pre></div> <p>The output will be something like this:</p> <div class="admonition success"> <p class=admonition-title>Success</p> <div class=highlight><pre><span></span><code>Adding repo cloudbees https://charts.cloudbees.com/public/cloudbees
<span class=s2>&quot;cloudbees&quot;</span> has been added to your repositories

Fetching cloudbees/cloudbees-core

Linting <span class=nv>release</span><span class=o>=</span>cbci, <span class=nv>chart</span><span class=o>=</span>/var/folders/f_/mpwdv8s16r7_zt43r3r7k20w0000gn/T/helmfile2581490205/cbci/cbci/cloudbees/cloudbees-core/3.37.2+7390bf58e3ab/cloudbees-core
<span class=o>==</span>&gt; Linting /var/folders/f_/mpwdv8s16r7_zt43r3r7k20w0000gn/T/helmfile2581490205/cbci/cbci/cloudbees/cloudbees-core/3.37.2+7390bf58e3ab/cloudbees-core
<span class=o>[</span>WARNING<span class=o>]</span> templates/cjoc-ingress.yaml: extensions/v1beta1 Ingress is deprecated <span class=k>in</span> v1.14+, unavailable <span class=k>in</span> v1.22+<span class=p>;</span> use networking.k8s.io/v1 Ingress
<span class=o>[</span>WARNING<span class=o>]</span> templates/managed-master-hibernation-monitor-ingress.yaml: extensions/v1beta1 Ingress is deprecated <span class=k>in</span> v1.14+, unavailable <span class=k>in</span> v1.22+<span class=p>;</span> use networking.k8s.io/v1 Ingress

<span class=m>1</span> chart<span class=o>(</span>s<span class=o>)</span> linted, <span class=m>0</span> chart<span class=o>(</span>s<span class=o>)</span> failed
</code></pre></div> </div> <p>Assuming all your configuration is valid, you can now safely apply it to the cluster.</p> <div class=highlight><pre><span></span><code>helmfile apply
</code></pre></div> <p>The output of that depends on your charts and their versions, and you will see the post-install messages of each chart. If, like me, you've configured the option <code>helmDefaults.wait</code>, then there will be pauses in the process, as Helmfile waits for the Helm install to finish before moving to the next.</p> <h2 id=casc-for-oc><abbr title="CloudBees Configuration As Code">CasC</abbr> for <abbr title="CloudBees Operations Center">OC</abbr><a class=headerlink href=#casc-for-oc title="Permanent link">&para;</a></h2> <p>At the time of writing this (November 2021), <a href=https://docs.cloudbees.com/docs/cloudbees-ci/latest/casc-oc/ >Configuration as Code (<abbr title="CloudBees Configuration As Code">CasC</abbr>) for the Operations Center</a> (<abbr title="CloudBees Operations Center">OC</abbr>) is still a <a href=https://docs.beescloud.com/docs/lexicon/latest/preview>Preview</a> feature.</p> <p>But aside from a few wrinkles that are about to be ironed out, <abbr title="CloudBees Configuration As Code">CasC</abbr> for <abbr title="CloudBees Operations Center">OC</abbr> is ready for prime time. Where applicable, I will mention the wrinkle and the workaround if required.</p> <p>We will look at the following things:</p> <ul> <li>How to make <abbr title="CloudBees Operations Center">OC</abbr> use <abbr title="CloudBees Configuration As Code">CasC</abbr></li> <li>How to structure the <abbr title="CloudBees Configuration As Code">CasC</abbr> Bundle</li> <li>How to configure some common items</li> <li>How to keep the Bundle up to date</li> <li>How to manage Items (such as Jobs, Folders, Controllers)</li> </ul> <p>For all the details, my full working <a href=https://github.com/joostvdg/cloudbees-ci-casc/tree/main/casc-for-oc/bundle><abbr title="CloudBees Configuration As Code">CasC</abbr> for <abbr title="CloudBees Operations Center">OC</abbr> example</a> is on GitHub.</p> <div class="admonition info"> <p class=admonition-title>What is a Bundle</p> <p>CloudBees CI extends <a href=https://www.jenkins.io/projects/jcasc/ >Jenkins Configuration as Code</a> (<abbr title="Jenkins Configuration As Code (OSS plugin)">JCasC</abbr>) with additional configuration files, for a full Configuration as Code experience. This collection of files, is called a Bundle. A Bundle has a fixed structure.</p> <p>For more information, please read <a href=https://docs.cloudbees.com/docs/cloudbees-ci/latest/casc-oc/create-bundle>creating a <abbr title="CloudBees Operations Center">OC</abbr> Bundle</a> in the official documentation.</p> </div> <h3 id=make-oc-use-casc>Make <abbr title="CloudBees Operations Center">OC</abbr> use <abbr title="CloudBees Configuration As Code">CasC</abbr><a class=headerlink href=#make-oc-use-casc title="Permanent link">&para;</a></h3> <div class="admonition warning inline end"> <p class=admonition-title>Warning</p> <p>There is a chicken and egg problem; unless you have a wildcard license, you need to start <abbr title="CloudBees Operations Center">OC</abbr> with the wizard, and either retrieve a valid license based on its <code>Instance ID</code>, or request a trial license. </p> <p>From then on, you can use <abbr title="CloudBees Configuration As Code">CasC</abbr> to configure the <abbr title="CloudBees Operations Center">OC</abbr>, including the License (if you want).</p> </div> <p>To make <abbr title="CloudBees Operations Center">OC</abbr> use a <abbr title="CloudBees Configuration As Code">CasC</abbr> we need three things:</p> <ol> <li>have a valid <abbr title="CloudBees Configuration As Code">CasC</abbr> Bundle</li> <li>have an <abbr title="CloudBees Operations Center">OC</abbr> with the <abbr title="CloudBees Configuration As Code">CasC</abbr> plugins installed</li> <li>tell <abbr title="CloudBees Operations Center">OC</abbr> where its Bundle is</li> </ol> <p>We will explore the first point in the next section. For the second point, we can use <abbr title="CloudBees Configuration As Code">CasC</abbr> to install those plugins and that ability is there by default. So luckily, we can ignore the chicken and egg problem there.</p> <p>To tell <abbr title="CloudBees Operations Center">OC</abbr> to use a Bundle, we set a Java property with the directory where it can find the Bundle. We can set Java properties in the Helm chart, via the <code>OperationsCenter.JavaOpts</code> property. The property to set, is <code>-Dcore.casc.config.bundle=</code>, as you can see in the example below.</p> <div class=highlight><span class=filename>values/cbci.yaml.gotmpl</span><pre><span></span><code><span class=nt>OperationsCenter</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=c1># other config ignored for example</span><span class=w></span>
<span class=w>  </span><span class=nt>JavaOpts</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">-Djenkins.install.runSetupWizard=false</span><span class=w></span>
<span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">-Dcore.casc.config.bundle=/var/jenkins_config/oc-casc-bundle-from-git/cloudbees-ci-casc/casc-for-oc/bundle</span><span class=w></span>

<span class=w>  </span><span class=c1># other config ignored for example</span><span class=w></span>
<span class=w>  </span><span class=nt>ExtraVolumes</span><span class=p>:</span><span class=w> </span><span class=c1># (6)</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">casc-oc-volume</span><span class=w></span>
<span class=w>    </span><span class=nt>configMap</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">casc-oc</span><span class=w></span>
<span class=w>  </span><span class=nt>ExtraVolumeMounts</span><span class=p>:</span><span class=w> </span><span class=c1># (7)</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">casc-oc-volume</span><span class=w></span>
<span class=w>    </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/jenkins_config/oc-casc-bundle</span><span class=w></span>
<span class=w>    </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
</code></pre></div> <div class="admonition help"> <p class=admonition-title>Help</p> <p>If you're wondering how we configure that sidecar container and why, we'll dive into this, in the section: <a href=/cloudbees/cbci-casc/#keep-bundle-up-to-date-with-git-sync>Keep Bundle up-to-date with Git Sync</a>.</p> </div> <p>In this example, we use a sidecar container to synchronize the <abbr title="CloudBees Operations Center">OC</abbr> Bundle to a directory. Due to the structure of that repository, the Bundle is accessible at <code>/var/jenkins_config/oc-casc-bundle-from-git/cloudbees-ci-casc/casc-for-oc/bundle</code>. </p> <h3 id=bundle-structure>Bundle Structure<a class=headerlink href=#bundle-structure title="Permanent link">&para;</a></h3> <p>Below is a snippet of my <abbr title="CloudBees Configuration As Code">CasC</abbr> for <abbr title="CloudBees Operations Center">OC</abbr> Bundle.</p> <div class=highlight><pre><span></span><code>.
├── bundle.yaml
├── items
│   ├── controllers
│   │   ├── blue.yaml
│   │   └── yellow.yaml
│   ├── items.yaml
│   └── <span class=nb>jobs</span>
├── jenkins.yaml
├── plugins.yaml
└── rbac.yaml
</code></pre></div> <p>The main items here are as follows:</p> <ul> <li><code>bundle.yaml</code>: the Bundle descriptor, informs <abbr title="CloudBees Configuration As Code">CasC</abbr> about the contents of this Bundle</li> <li><code>items/</code>: folder with with subfolders and items in their separate files</li> <li><code>jenkins.yaml</code>: the main configuration, essentially leveraging <abbr title="Jenkins Configuration As Code (OSS plugin)">JCasC</abbr></li> <li><code>plugins.yaml</code>: list of plugins to install, limited to <abbr title="CloudBees Assurance Program">CAP</abbr> plugins</li> <li><code>rbac.yaml</code>: where we configure Role Based Access Control, global roles and global groups</li> </ul> <div class="admonition hint"> <p class=admonition-title><abbr title="Role Based Access Control">RBAC</abbr> Configuration</p> <p>The <code>rbac.yaml</code> contains the <em>global</em> configuration. Configuration for folders or Controllers is defined in their respective item manifest files. We'll explore these later.</p> </div> <p>Let's take a look at some of these files.</p> <div class=highlight><span class=filename>bundle.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1&quot;</span><span class=w></span>
<span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s>&quot;jenkins&quot;</span><span class=w></span>
<span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;OC</span><span class=nv> </span><span class=s>Bundle&quot;</span><span class=w></span>
<span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1.12&quot;</span><span class=w> </span><span class=c1># (1)</span><span class=w></span>
<span class=nt>plugins</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;plugins.yaml&quot;</span><span class=w></span>
<span class=nt>jcasc</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;jenkins.yaml&quot;</span><span class=w></span>
<span class=nt>rbac</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;rbac.yaml&quot;</span><span class=w></span>
<span class=nt>items</span><span class=p>:</span><span class=w> </span><span class=c1># (2)</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;items/&quot;</span><span class=w></span>
</code></pre></div> <ol> <li>updating the version speeds up the detection of a bundle change</li> <li>we can read configuration from a directory and its subdirectories</li> </ol> <p>The only mandatory files are this <code>bundle.yaml</code> and the <code>jcasc</code> section with one or more files. You can either use a named file, like I've done, or use point it to a folder. <abbr title="CloudBees Configuration As Code">CasC</abbr> will read all the files in the directory and its sub-directories.</p> <p>We leverage that with our <code>items</code> section. We'll explore this in more depth in the <a href=/cloudbees/cbci-casc/#managing-items>Managing Items</a> section.</p> <h3 id=configure-oc-via-casc>Configure <abbr title="CloudBees Operations Center">OC</abbr> via <abbr title="CloudBees Configuration As Code">CasC</abbr><a class=headerlink href=#configure-oc-via-casc title="Permanent link">&para;</a></h3> <p>To configure <abbr title="CloudBees Operations Center">OC</abbr> via a Bundle, let's explore some of the files by which you can do so. Due to the more detailed nature, we'll explore Items and the LDAP configuration separately.</p> <p>Let's start with the plugins.</p> <div class=highlight><span class=filename>plugin.yaml</span><pre><span></span><code><span class=nt>plugins</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">{</span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=nv>notification-api</span><span class="p p-Indicator">}</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">{</span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=nv>operations-center-notification</span><span class="p p-Indicator">}</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="p p-Indicator">{</span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=nv>cloudbees-prometheus</span><span class="p p-Indicator">}</span><span class=w></span>
<span class=c1># skipping some items to reduce example size</span><span class=w></span>
</code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>At the time of writing, the <abbr title="CloudBees Configuration As Code">CasC</abbr> plugins are restructured. So while the example at some point in time used the following two plugins; <code>cloudbees-casc-api</code> and <code>cloudbees-casc-server</code>.</p> <p>They are likely different by the time you're reading this. Please look at the <a href=https://docs.cloudbees.com/docs/cloudbees-ci/latest/casc-oc/items#_supported_items_using_casc>official docs</a> for the appropriate plugins for your release. </p> </div> <p>If you look at the <a href=https://github.com/joostvdg/cloudbees-ci-casc/blob/main/casc-for-oc/bundle/plugins.yaml>file</a> in my example repository, you'll fine it has ~108 plugins. For the sake of the example, I won't list all of them here.</p> <p>For plugins in the <abbr title="CloudBees Assurance Program">CAP</abbr> we do not have to list the versions, as <abbr title="CloudBees Assurance Program">CAP</abbr> manages those for us. So we only list the plugin <em>id</em> of the plugins we want. If for some reason the plugin cannot be installed, there will be an explicit warning in the logs.</p> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>When adding plugins, the instance must always be restarted for the change to take effect.</p> </div> <p>Up next is the <abbr title="Role Based Access Control">RBAC</abbr> configuration, if you're not using CloudBees' <abbr title="Role Based Access Control">RBAC</abbr> with CloudBees CI yet, I strongly urge you to reconsider!</p> <div class=highlight><span class=filename>rbac.yaml</span><pre><span></span><code><span class=nt>removeStrategy</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>rbac</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">SYNC</span><span class=w></span>

<span class=nt>roles</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">authenticated</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>permissions</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hudson.model.Hudson.Administer</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">administer</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">anonymous</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>filterable</span><span class=p>:</span><span class=w> </span><span class=s>&#39;true&#39;</span><span class=w></span>
<span class=w>  </span><span class=nt>permissions</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hudson.model.Item.Read</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hudson.model.Item.Discover</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hudson.model.Hudson.Read</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hudson.model.View.Read</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">browse</span><span class=w></span>
<span class=nt>groups</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>members</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>external_groups</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Administrators</span><span class=w></span>
<span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">admin</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jvandergriendt</span><span class=w></span>
<span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">administer</span><span class=w></span>
<span class=w>    </span><span class=nt>grantedAt</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">current</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Administrators</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>roles</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">develop</span><span class=w></span>
<span class=w>    </span><span class=nt>grantedAt</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">current</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Developers</span><span class=w></span>
<span class=w>  </span><span class=nt>members</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>external_groups</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">BlueAdmins</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">GreenAdmins</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>roles</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">browse</span><span class=w></span>
<span class=w>    </span><span class=nt>grantedAt</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">current</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Browsers</span><span class=w></span>
<span class=w>  </span><span class=nt>members</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>external_groups</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Blue</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Green</span><span class=w></span>
</code></pre></div> <p>There are three main sections in my exmaple.</p> <ul> <li><code>removeStrategy</code>: determines how differences between the <abbr title="CloudBees Configuration As Code">CasC</abbr> configuration and current state is handled</li> <li><code>roles</code>: defines the global roles, these are applied to the <abbr title="CloudBees Operations Center">OC</abbr> and all Controllers (except those that opt out of global <abbr title="Role Based Access Control">RBAC</abbr>)</li> <li><code>groups</code>: these are the global groups, active from the root from <abbr title="CloudBees Operations Center">OC</abbr> all the way down. Which is why we give some external groups the <code>browse</code>role, so they can see the items in <abbr title="CloudBees Operations Center">OC</abbr> they might be administrator of (such as a Controller)</li> </ul> <p>For the sake of brevity, I have excluded some of the roles. These are the roles that are generated when you first initialize <abbr title="Role Based Access Control">RBAC</abbr> and choose <code>typical initial setup</code>.</p> <p>If you're not sure how the define these, I recommend exploring the options via the UI first, and then exporting the configuration.</p> <div class="admonition warning inline end"> <p class=admonition-title>Warning</p> <p>The <code>removeStrategy</code> is required, please read the <a href=https://docs.cloudbees.com/docs/cloudbees-ci/latest/casc-oc/rbac>official docs</a> for the available options.</p> </div> <h4 id=jenkinsyaml>Jenkins.yaml<a class=headerlink href=#jenkinsyaml title="Permanent link">&para;</a></h4> <p>In the <code>jcasc</code> section of the Bundle manifest (<code>bundle.yaml</code>), we define the configuration of the <abbr title="CloudBees Operations Center">OC</abbr>. Essentially, anything you can configure via one of the pages of the <code>Manage Jenkins</code> screen, can be defined via <abbr title="CloudBees Configuration As Code">CasC</abbr>.</p> <p>Again, for the sake of brevity, I'll exclude some details that aren't important to discuss.</p> <div class=highlight><span class=filename>jenkins.yaml</span><pre><span></span><code><span class=nt>jenkins</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>authorizationStrategy</span><span class=p>:</span><span class=w> </span><span class=s>&quot;cloudBeesRoleBasedAccessControl&quot;</span><span class=w></span>
<span class=w>  </span><span class=nt>crumbIssuer</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>standard</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>excludeClientIPFromCrumb</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<span class=w>  </span><span class=nt>primaryView</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>masters</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>columns</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;jobName&quot;</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;status&quot;</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;weather&quot;</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;masterConfigurationStaleViewColumn&quot;</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;jenkinsVersionViewColumn&quot;</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;cascViewColumn&quot;</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;manageMaster&quot;</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;totalJobsViewColumn&quot;</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;queueSizeViewColumn&quot;</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;listSelectionColumn&quot;</span><span class=w></span>
<span class=w>      </span><span class=nt>jobFilters</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;connectedMasterViewFilter&quot;</span><span class=w></span>
<span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Controllers&quot;</span><span class=w></span>
<span class=w>      </span><span class=nt>recurse</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<span class=w>  </span><span class=nt>securityRealm</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>ldap</span><span class=p>:</span><span class=w> </span><span class=c1>#  we&#39;ll dive into this below</span><span class=w></span>
<span class=nt>cloudBeesCasCServer</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>defaultBundle</span><span class=p>:</span><span class=w> </span><span class=s>&quot;mc1&quot;</span><span class=w></span>
<span class=w>  </span><span class=nt>visibility</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<span class=nt>beekeeper</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>

<span class=nt>masterprovisioning</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>clusterEndpoints</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=c1># details are explored below</span><span class=w></span>
</code></pre></div> <div class="admonition danger inline end"> <p class=admonition-title>Danger</p> <p>If you want to manage the <abbr title="Role Based Access Control">RBAC</abbr> configuration via <abbr title="CloudBees Configuration As Code">CasC</abbr>, the <code>authorizationStrategy</code> <em>must</em> be set to <code>"cloudBeesRoleBasedAccessControl"</code>.</p> </div> <p>You can see that this file can quickly become quite large and unwieldy. So you can break it up into different files, and then in the <code>bundle.yaml</code> point to a folder with all the file instead.</p> <p>In case you've used either <abbr title="CloudBees Configuration As Code">CasC</abbr> or <abbr title="Jenkins Configuration As Code (OSS plugin)">JCasC</abbr> before, this is exactly the same, with the only difference that the <abbr title="CloudBees Operations Center">OC</abbr> might not support some plugins and has some plugins which do not exist for Controllers.</p> <p>When in doubt, configure it via the UI first and then <a href=https://docs.cloudbees.com/docs/cloudbees-ci/latest/casc-oc/create-bundle#_exporting_a_casc_configuration>export the <abbr title="CloudBees Configuration As Code">CasC</abbr> configuration</a>.</p> <h4 id=ldap-configuration>LDAP Configuration<a class=headerlink href=#ldap-configuration title="Permanent link">&para;</a></h4> <p>Let's take a look at the LDAP configuration snippet. The configuration as based on the LDAP we've configured via the Helmfile configuration earlier in this guide.</p> <div class=highlight><span class=filename>jenkins.yaml (jenkins.securityRealm)</span><pre><span></span><code><span class=nt>jenkins</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>securityRealm</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>ldap</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>configurations</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>displayNameAttributeName</span><span class=p>:</span><span class=w> </span><span class=s>&quot;cn&quot;</span><span class=w></span>
<span class=w>        </span><span class=nt>groupMembershipStrategy</span><span class=p>:</span><span class=w></span>
<span class=w>          </span><span class=nt>fromGroupSearch</span><span class=p>:</span><span class=w></span>
<span class=w>            </span><span class=nt>filter</span><span class=p>:</span><span class=w> </span><span class=s>&quot;member={0}&quot;</span><span class=w></span>
<span class=w>        </span><span class=nt>groupSearchBase</span><span class=p>:</span><span class=w> </span><span class=s>&quot;ou=Groups&quot;</span><span class=w></span>
<span class=w>        </span><span class=nt>inhibitInferRootDN</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class=w></span>
<span class=w>        </span><span class=nt>managerDN</span><span class=p>:</span><span class=w> </span><span class=s>&quot;cn=admin,dc=example,dc=org&quot;</span><span class=w></span>
<span class=w>        </span><span class=nt>managerPasswordSecret</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${LDAP_MANAGER_PASSWORD}</span><span class=w></span>
<span class=w>        </span><span class=nt>rootDN</span><span class=p>:</span><span class=w> </span><span class=s>&quot;dc=example,dc=org&quot;</span><span class=w></span>
<span class=w>        </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=s>&quot;ldap://ldap-openldap:389&quot;</span><span class=w></span>
<span class=w>        </span><span class=nt>userSearchBase</span><span class=p>:</span><span class=w> </span><span class=s>&quot;ou=People&quot;</span><span class=w></span>
<span class=w>      </span><span class=nt>disableMailAddressResolver</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class=w></span>
<span class=w>      </span><span class=nt>groupIdStrategy</span><span class=p>:</span><span class=w> </span><span class=s>&quot;caseInsensitive&quot;</span><span class=w></span>
<span class=w>      </span><span class=nt>userIdStrategy</span><span class=p>:</span><span class=w> </span><span class=s>&quot;caseInsensitive&quot;</span><span class=w>  </span>
</code></pre></div> <p>The password has been set to <code>${LDAP_MANAGER_PASSWORD}</code>, which will be automatically interpreted by <abbr title="Jenkins Configuration As Code (OSS plugin)">JCasC</abbr>, <a href=https://github.com/jenkinsci/configuration-as-code-plugin/blob/master/docs/features/secrets.adoc>read here how and what options there are</a>.</p> <p>I've opted for leveraging an environment variable. This environment variable comes from a Kubernetes secret by the name <code>ldap-manager-pass</code>, we created in the <a href=/cloudbees/cbci-casc/#configure-cbci-namespace>Configure CBCI namespace</a> section.</p> <div class=highlight><span class=filename>values/cbci.yaml.gotmpl</span><pre><span></span><code><span class=nt>OperationsCenter</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=c1># other config excluded for brevity</span><span class=w></span>
<span class=w>  </span><span class=nt>ContainerEnv</span><span class=p>:</span><span class=w> </span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LDAP_MANAGER_PASSWORD</span><span class=w></span>
<span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w></span>
<span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ldap-manager-pass</span><span class=w></span>
<span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pass</span><span class=w></span>
</code></pre></div> <h4 id=controller-provisioning>Controller Provisioning<a class=headerlink href=#controller-provisioning title="Permanent link">&para;</a></h4> <div class="admonition bug inline end"> <p class=admonition-title>Bug</p> <p>While CloudBees CI stands for inclusive naming and works hard to remove any outdated terminology, sometimes they missed. Expect <code>masterprovisioning</code> to be renamed to <code>controllerprovisioning</code>.</p> </div> <p>One of the great things about CloudBees CI Modern is its ability of creating and managing Controllers on Kubernetes. To control the properties of the Kubernetes resources, there is the <code>masterprovisioning</code>.</p> <p>I've configured just the default settings, where the only notable thing is the <code>-Dorg.csanchez...defaultImage=cloudbees/cloudbees-core-agent:2.303.3.3</code> property. Which will have to be updated if you upgrade CloudBees CI.</p> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>As we're using YAML in YAML and have multiple layers of interpretation, we have to exclude the <code>${name}</code> variables, so the annotations get the correct Controller name. To escape values, such as the <code>$</code> in this case, we use the <code>^</code>, so <code>${name}</code> becomes <code>^${name}</code>.</p> </div> <p>Remember the configuration for Prometheus? Well, if we want our Controller's metrics to be scrapable by Prometheus, we need to ensure they have the proper annotations as well. So I've included the annotations in the <code>yaml</code> section, so any new Controller automatically has them.</p> <div class=highlight><span class=filename>jenkins.yaml (masterprovisioning)</span><pre><span></span><code><span class=nt>masterprovisioning</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>clusterEndpoints</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s>&quot;default&quot;</span><span class=w></span>
<span class=w>      </span><span class=nt>ingressClass</span><span class=p>:</span><span class=w> </span><span class=s>&quot;nginx&quot;</span><span class=w></span>
<span class=w>      </span><span class=nt>jenkinsUrl</span><span class=p>:</span><span class=w> </span><span class=s>&quot;http://cjoc.cbci.svc.cluster.local/cjoc/&quot;</span><span class=w></span>
<span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&quot;kubernetes&quot;</span><span class=w></span>
<span class=w>    </span><span class=nt>cpus</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1.0&quot;</span><span class=w></span>
<span class=w>    </span><span class=nt>disk</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">50</span><span class=w></span>
<span class=w>    </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1000&quot;</span><span class=w></span>
<span class=w>    </span><span class=nt>globalJavaOptions</span><span class=p>:</span><span class=w> </span><span class=s>&quot;-Djenkins.model.Jenkins.crumbIssuerProxyCompatibility=true\</span>
<span class=w>      </span><span class=s>\ -Dorg.csanchez.jenkins.plugins.kubernetes.pipeline.PodTemplateStepExecution.defaultImage=cloudbees/cloudbees-core-agent:2.303.3.3\</span>
<span class=w>      </span><span class=s>\ -Dcom.cloudbees.jenkins.plugins.kube.ServiceAccountFilter.defaultServiceAccount=jenkins-agents\</span>
<span class=w>      </span><span class=s>\ -Dcom.cloudbees.networking.useSubdomain=false</span><span class=nv> </span><span class=s>-Dcom.cloudbees.networking.protocol=\&quot;\</span>
<span class=w>      </span><span class=s>https\&quot;</span><span class=nv> </span><span class=s>-Dcom.cloudbees.networking.hostname=\&quot;ci.cbci-pm.beescloud.com\&quot;</span><span class=nv> </span><span class=s>-Dcom.cloudbees.networking.port=443\</span>
<span class=w>      </span><span class=s>\ -Dcom.cloudbees.networking.operationsCenterName=\&quot;cjoc\&quot;&quot;</span><span class=w></span>
<span class=w>    </span><span class=nt>javaOptions</span><span class=p>:</span><span class=w> </span><span class=s>&quot;-XshowSettings:vm</span><span class=nv> </span><span class=s>-XX:+AlwaysPreTouch</span><span class=nv> </span><span class=s>-XX:+UseG1GC</span><span class=nv> </span><span class=s>-XX:+DisableExplicitGC\</span>
<span class=w>      </span><span class=s>\ -XX:+ParallelRefProcEnabled</span><span class=nv> </span><span class=s>-XX:+UseStringDeduplication</span><span class=nv> </span><span class=s>-Dhudson.slaves.NodeProvisioner.initialDelay=0&quot;</span><span class=w></span>
<span class=w>    </span><span class=nt>livenessInitialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class=w></span>
<span class=w>    </span><span class=nt>livenessPeriodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">12</span><span class=w></span>
<span class=w>    </span><span class=nt>livenessTimeoutSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">12</span><span class=w></span>
<span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3072</span><span class=w></span>
<span class=w>    </span><span class=nt>readinessFailureThreshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class=w></span>
<span class=w>    </span><span class=nt>readinessInitialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class=w></span>
<span class=w>    </span><span class=nt>readinessTimeoutSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span><span class=w></span>
<span class=w>    </span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1200</span><span class=w></span>
<span class=w>    </span><span class=nt>yaml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|-</span><span class=w></span>
<span class=w>      </span><span class=no>apiVersion: &quot;apps/v1&quot;</span><span class=w></span>
<span class=w>      </span><span class=no>kind: &quot;StatefulSet&quot;</span><span class=w></span>
<span class=w>      </span><span class=no>spec:</span><span class=w></span>
<span class=w>        </span><span class=no>template:</span><span class=w></span>
<span class=w>          </span><span class=no>metadata:</span><span class=w></span>
<span class=w>            </span><span class=no>annotations:</span><span class=w></span>
<span class=w>              </span><span class=no>prometheus.io/path: &quot;/^${name}/prometheus&quot;</span><span class=w></span>
<span class=w>              </span><span class=no>prometheus.io/port: &quot;8080&quot;</span><span class=w></span>
<span class=w>              </span><span class=no>prometheus.io/scrape: &quot;true&quot;</span><span class=w></span>
<span class=w>            </span><span class=no>labels:</span><span class=w></span>
<span class=w>              </span><span class=no>app.kubernetes.io/component: Managed-Controller</span><span class=w></span>
<span class=w>              </span><span class=no>app.kubernetes.io/instance: &quot;^${name}&quot;</span><span class=w></span>
<span class=w>              </span><span class=no>app.kubernetes.io/managed-by: CloudBees-CI-Cloud-Operations-Center</span><span class=w></span>
<span class=w>              </span><span class=no>app.kubernetes.io/name: &quot;^${name}&quot;</span><span class=w></span>
</code></pre></div> <h3 id=managing-items>Managing Items<a class=headerlink href=#managing-items title="Permanent link">&para;</a></h3> <p>As you've seen, we've configured the Bundle to collect Item manifests from the <code>items</code> folder.</p> <p><abbr title="CloudBees Configuration As Code">CasC</abbr> will automatically read all the files in the specified folder and its subfolders.</p> <p>In my example Bundle, the items folder looks like this:</p> <div class=highlight><pre><span></span><code>.
├── controllers
│   ├── blue.yaml
│   ├── cyan.yaml
│   ├── green.yaml
│   ├── purple.yaml
│   └── yellow.yaml
├── items.yaml
└── <span class=nb>jobs</span>
    └── controller-casc-sync.yaml
</code></pre></div> <p>In the <code>items.yaml</code> you can define any item you need, such as Folders. I've separated Controllers and Jobs from the main file.</p> <p>This way, if someone wants to add a new Controller or a new Job, all they have to do is add a new file into the folder and synchronise the Bundle to <abbr title="CloudBees Operations Center">OC</abbr>.</p> <div class="admonition info"> <p class=admonition-title>Mandatory Boilerplate</p> <p>In the current iteration of <abbr title="CloudBees Configuration As Code">CasC</abbr>, each file in the Items directory hierarchy, needs some boilerplate configuration, else it throws an error.</p> <div class=highlight><pre><span></span><code><span class=nt>removeStrategy</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>rbac</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">SYNC</span><span class=w></span>
<span class=w>  </span><span class=nt>items</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">NONE</span><span class=w></span>
<span class=nt>items</span><span class=p>:</span><span class=w></span>
</code></pre></div> </div> <h4 id=managed-controller>Managed Controller<a class=headerlink href=#managed-controller title="Permanent link">&para;</a></h4> <p>You might have picked it up already, but yes, you can create and managed Managed Controllers via <abbr title="CloudBees Operations Center">OC</abbr>'s <abbr title="CloudBees Configuration As Code">CasC</abbr> Bundle!</p> <p>Below is about as minimal an example as it can get. It configures some basic properties such as the name and description, and some more specific items. Such as the <abbr title="Role Based Access Control">RBAC</abbr> configuration (via <code>groups:</code>), which <abbr title="CloudBees Configuration As Code">CasC</abbr> Bundle it should use, and its Kubernetes configuration (overriding or extending <code>masterprovisioning</code> from the <abbr title="CloudBees Operations Center">OC</abbr>).</p> <div class="admonition bug"> <p class=admonition-title>Created but not provisioned</p> <p>In the CloudBees CI releases prior to December 2021, Managed Controllers get created, but do not get provisioned. This means their respective Kubernetes resources do not get created automatically.</p> <p>You can create a Cluster Operations Job, use the UI, or the CLI to save and restart the Controllers to create their Kubernetes resources.</p> </div> <div class=highlight><span class=filename>items/controllers/cyan.yaml</span><pre><span></span><code><span class=nt>removeStrategy</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>rbac</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">SYNC</span><span class=w></span>
<span class=w>  </span><span class=nt>items</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">NONE</span><span class=w></span>

<span class=nt>items</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">managedController</span><span class=w></span>
<span class=w>  </span><span class=nt>displayName</span><span class=p>:</span><span class=w> </span><span class=s>&#39;Cyan&#39;</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mc-cyan</span><span class=w></span>
<span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&#39;Cyan</span><span class=nv> </span><span class=s>Controller</span><span class=nv> </span><span class=s>(Managed</span><span class=nv> </span><span class=s>by</span><span class=nv> </span><span class=s>CasC)&#39;</span><span class=w></span>
<span class=w>  </span><span class=nt>groups</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>members</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>users</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bluedev</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">blueadmin</span><span class=w></span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Blues</span><span class=w></span>
<span class=w>  </span><span class=nt>properties</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>configurationAsCode</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>bundle</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">purple</span><span class=w></span>
<span class=w>  </span><span class=nt>configuration</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>domain</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cyan</span><span class=w></span>
</code></pre></div> <h3 id=keep-bundle-up-to-date-with-git-sync>Keep Bundle up-to-date with Git Sync<a class=headerlink href=#keep-bundle-up-to-date-with-git-sync title="Permanent link">&para;</a></h3> <p>There are various ways you can get a <abbr title="CloudBees Configuration As Code">CasC</abbr> Bundle to the <abbr title="CloudBees Operations Center">OC</abbr>.</p> <p>For example, you can store the YAML files in a Kubernetes ConfigMap, and then mount that ConfigMap into the <abbr title="CloudBees Operations Center">OC</abbr>'s volume.</p> <p>If you have a flat Bundle file hierarchy, or you have a transformation pipeline that creates a customizable output a ConfigMap is an option.</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>If you do want to use a ConfigMap, this is how you configure the Helm values, assuming you <abbr title="CloudBees Configuration As Code">CasC</abbr> Bundle's ConfigMap is called <code>casc-oc</code>.</p> <div class=highlight><pre><span></span><code><span class=nt>ExtraVolumes</span><span class=p>:</span><span class=w> </span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">casc-oc-volume</span><span class=w></span>
<span class=w>  </span><span class=nt>configMap</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">casc-oc</span><span class=w></span>
<span class=nt>ExtraVolumeMounts</span><span class=p>:</span><span class=w> </span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">casc-oc-volume</span><span class=w></span>
<span class=w>  </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/jenkins_config/oc-casc-bundle</span><span class=w></span>
<span class=w>  </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
</code></pre></div> </div> <p>I've opted to go another route, synchronizing my <abbr title="CloudBees Configuration As Code">CasC</abbr> Bundle directly from Git into a (Kubernetes) Volume. To do so, I've used <a href=https://github.com/kubernetes/git-sync>Git Sync</a>, a tool from the Kubernetes maintainers for exactly this purpose.</p> <p>So what we want to achieve, is that when I make a change in my Bundle in Git, it is automatically updated in the <abbr title="CloudBees Operations Center">OC</abbr>. To do so, we will add a sidecar container to the <abbr title="CloudBees Operations Center">OC</abbr> via the Helm values and some volume mounts, and thats all we need.</p> <p>I've based my solution based on the <a href=https://github.com/kubernetes/git-sync/blob/master/docs/kubernetes.md>Git Sync documentation example</a> for raw Kubernetes.</p> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>The example uses a Container repository that is either not accessible, or does not contain the Git Sync images.</p> <p>After some digging around, I found the <code>3.x</code> version images in a GCR; <code>gcr.io/k8s-staging-git-sync/git-sync:v3.3.4__linux_amd64</code>. </p> <p>For those who want to use the hash id instead of the tag, that tag is the following <code>git-sync@sha256:866599ca98bcde1404b56152d8601888a5d3dae7fc21665155577d607652aa09</code>.</p> </div> <p>While not documented, there is an option in the CBCI Helm chart to add a side car container. You do so via <code>OperationsCenter.ExtraContainers</code> which is a list item.</p> <p>This container needs a name and an image. For the sake of Git Sync, we need to supply it with arguments which tell it which repository to synchronize, how, and where to store it.</p> <p>My repository is public, so it does not need credentials, if yours does, all the common solutions <a href=https://github.com/kubernetes/git-sync/#parameters>are supported, as per the docs</a>. Do verify the actual options the version you use supports, as it seems some flags were renamed between the version <code>4.x</code> that is the current <code>main</code> branch and the <code>3.4</code> version I'm using.</p> <p>We add a Volume Mount to this sidecar container, so it can store the Git checkout on a Volume that is also usable by <abbr title="CloudBees Operations Center">OC</abbr>. We can add volumes via the <code>OperationsCenter.ExtraVolumes</code> property, which is also a list item.</p> <p>Then to make sure the <abbr title="CloudBees Operations Center">OC</abbr> can <em>read</em> from this Volume, we also mount that same Volume via the <code>OperationsCenter.ExtraVolumeMounts</code> property. The <code>mountPath</code> is what is the basis of the <code>-Dcore.casc.config.bundle</code> flag we set, to tell <abbr title="CloudBees Operations Center">OC</abbr> where it can find its Bundle.</p> <div class=highlight><span class=filename>values/cbci.yaml.gotmpl</span><pre><span></span><code><span class=w>  </span><span class=nt>ExtraContainers</span><span class=p>:</span><span class=w> </span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">git-sync</span><span class=w></span>
<span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gcr.io/k8s-staging-git-sync/git-sync@sha256:866599ca98bcde1404b56152d8601888a5d3dae7fc21665155577d607652aa09</span><span class=w></span>
<span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--repo=https://github.com/joostvdg/cloudbees-ci-casc</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--branch=main</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--depth=1</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--wait=20</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--root=/git</span><span class=w></span>
<span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">content-from-git</span><span class=w></span>
<span class=w>        </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/git</span><span class=w></span>

<span class=w>  </span><span class=nt>ExtraVolumes</span><span class=p>:</span><span class=w> </span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">content-from-git</span><span class=w></span>
<span class=w>    </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span><span class=w></span>
<span class=w>  </span><span class=nt>ExtraVolumeMounts</span><span class=p>:</span><span class=w> </span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">content-from-git</span><span class=w></span>
<span class=w>    </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/jenkins_config/oc-casc-bundle-from-git</span><span class=w></span>
<span class=w>    </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
</code></pre></div> <p>Speaking of the flag <code>-Dcore.casc.config.bundle</code>, to save you some of the trouble I had, lets take a good look at the path I've specified. Essentially, the Git Sync checks out the repository into a folder with the same name.</p> <p>The path starts from the <code>mountPath</code>, which is <code>/var/jenkins_config/oc-casc-bundle-from-git</code>. My Bundle's repository is called <code>cloudbees-ci-casc</code>, which we'll add next, and then the path to my Bundle within that repository.</p> <div class=highlight><span class=filename>values/cbci.yaml.gotmpl</span><pre><span></span><code><span class=w>  </span><span class=nt>JavaOpts</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">-Djenkins.install.runSetupWizard=false</span><span class=w></span>
<span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">-Dcore.casc.config.bundle=/var/jenkins_config/oc-casc-bundle-from-git/cloudbees-ci-casc/casc-for-oc/bundle</span><span class=w></span>
</code></pre></div> <h2 id=casc-for-controllers><abbr title="CloudBees Configuration As Code">CasC</abbr> for Controllers<a class=headerlink href=#casc-for-controllers title="Permanent link">&para;</a></h2> <div class="admonition note"> <p class=admonition-title>What is a Bundle</p> <p>CloudBees CI extends <a href=https://www.jenkins.io/projects/jcasc/ >Jenkins Configuration as Code</a> (<abbr title="Jenkins Configuration As Code (OSS plugin)">JCasC</abbr>) with additional configuration files, for a full Configuration as Code experience. This collection of files, is called a Bundle. A Bundle has a fixed structure.</p> <p>For more information, please read <a href=https://docs.cloudbees.com/docs/cloudbees-ci/latest/casc-controller/create-bundle>creating a Controller Bundle</a> in the official documentation.</p> </div> <p>As a Controller Bundle is essentially the same as the one for the <abbr title="CloudBees Operations Center">OC</abbr>, I'll limit myself to two things. One, how you can get those Bundles into the <abbr title="CloudBees Operations Center">OC</abbr> and usable by Controllers, and two, how to leverage the inheritance.</p> <h3 id=synchronize-controller-bundles-to-oc>Synchronize Controller Bundles to <abbr title="CloudBees Operations Center">OC</abbr><a class=headerlink href=#synchronize-controller-bundles-to-oc title="Permanent link">&para;</a></h3> <h4 id=steps-to-synchronize-bundles>Steps to Synchronize Bundles<a class=headerlink href=#steps-to-synchronize-bundles title="Permanent link">&para;</a></h4> <ul> <li>install a git client on Operations Center</li> <li>for example: <code>github-branch-source</code></li> <li>create a Freestyle job</li> <li>check out from your repository with the casc Bundles</li> <li>use the <code>Synchronize bundles from workspace with internal storage</code> build step</li> <li>create a Controller and select an available Bundle</li> </ul> <h4 id=update-bundle-configuration>Update Bundle Configuration<a class=headerlink href=#update-bundle-configuration title="Permanent link">&para;</a></h4> <p>If you're not sure what you'd want to configure in the bundle, or which plugins you really need.</p> <p>You can first create a Managed Controller how you want it to be. Then export its <abbr title="CloudBees Configuration As Code">CasC</abbr> configuration by the built-in <code>casc-exporter</code>.</p> <p>You do this, by going to the following URL <code>&lt;controllerUrl&gt;/core-casc-export</code>.</p> <h4 id=freestyle-job-on-oc>Freestyle Job - On <abbr title="CloudBees Operations Center">OC</abbr><a class=headerlink href=#freestyle-job-on-oc title="Permanent link">&para;</a></h4> <p>URL to checkout: <code>https://github.com/joostvdg/cloudbees-ci-casc.git</code> Use the <code>Synchronize bundles from workspace with internal storage</code> build step.</p> <p>Note: this only works if the Bundles are at the top level</p> <p><img alt="CasC Sync Step" src=../../images/casc-sync-step-example.png></p> <details class=example> <summary><abbr title="CloudBees Configuration As Code">CasC</abbr> Sync Job as <abbr title="CloudBees Configuration As Code">CasC</abbr> Item</summary> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>casc-sync-job-item.yaml</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span></pre></div></td><td class=code><div><pre><span></span><code><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">freeStyle</span><span class=w></span>
<span class=w>  </span><span class=nt>displayName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">casc-sync-new</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">casc-sync-new</span><span class=w></span>
<span class=w>  </span><span class=nt>disabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class=w></span>
<span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&#39;My</span><span class=nv> </span><span class=s>CasC</span><span class=nv> </span><span class=s>Bundle</span><span class=nv> </span><span class=s>Synchronization</span><span class=nv> </span><span class=s>job&#39;</span><span class=w></span>
<span class=w>  </span><span class=nt>concurrentBuild</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class=w></span>
<span class=w>  </span><span class=nt>builders</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>casCBundlesSyncBuildStep</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span><span class=w></span>
<span class=w>  </span><span class=nt>blockBuildWhenUpstreamBuilding</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class=w></span>
<span class=w>  </span><span class=nt>blockBuildWhenDownstreamBuilding</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class=w></span>
<span class=w>  </span><span class=nt>scm</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>gitSCM</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>userRemoteConfigs</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>userRemoteConfig</span><span class=p>:</span><span class=w></span>
<span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/joostvdg/cloudbees-ci-casc.git</span><span class=w></span>
<span class=w>      </span><span class=nt>branches</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>branchSpec</span><span class=p>:</span><span class=w></span>
<span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>&#39;*/main&#39;</span><span class=w></span>
<span class=w>  </span><span class=nt>scmCheckoutStrategy</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>standard</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span><span class=w></span>
</code></pre></div></td></tr></table></div> </details> <h3 id=bundle-inheritance>Bundle Inheritance<a class=headerlink href=#bundle-inheritance title="Permanent link">&para;</a></h3> <p>You can have Bundles inherit from each other. You do so by using the parent property in a Bundle descriptor (<code>bundle.yaml</code>).</p> <p>For example, let's take a look at my <a href=https://github.com/joostvdg/cloudbees-ci-casc/tree/main/community2>community2</a> Bundle.</p> <div class=highlight><span class=filename>bundle.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1&quot;</span><span class=w></span>
<span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&quot;1.0&quot;</span><span class=w></span>
<span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s>&quot;community2&quot;</span><span class=w></span>
<span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;Shared</span><span class=nv> </span><span class=s>Bundle&quot;</span><span class=w></span>
<span class=hll><span class=nt>parent</span><span class=p>:</span><span class=w> </span><span class=s>&quot;community1&quot;</span><span class=w></span>
</span><span class=nt>jcasc</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;jenkins.yaml&quot;</span><span class=w></span>
<span class=nt>plugins</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;plugins.yaml&quot;</span><span class=w></span>
</code></pre></div> <p>This means the Bundle now extends the <code>community1</code> Bundle. When you use <code>community2</code>, you essentially get all the files of both <code>community1</code> and <code>community2</code>.</p> <div class="admonition attention"> <p class=admonition-title>Inheritance Limitation</p> <p>At this time of writing, Bundles cannot override configuration they inherit and the configuration <em>must</em> be complimentary. Meaning, once you specify the <code>jenkins.systemMessage</code>, the entire inheritance chain has to use the same message.</p> <p>What does work, which may not be obvious, is list items. Such as SharedLibraries, PodTemplates, and Tool definitions. Meaning, if you define two SharedLibraries in Bundle A, one SharedLibrary in Bundle B, the Controller using Bundle B, will have <em>three</em> SharedLibraries defined.</p> </div> <p>Another caveeat to take note of, is that the last found Plugin Catalog is used. As a Plugin Catalog essentially just lists plugins that <em>can</em> be installed, I suggest you define <em>one</em> Plugin Catalog at the root of your hierarchy, and any plugins you need after, you add them to that same <em>one</em> Plugin Catalog.</p> <p>This is what I've done with the <code>community</code> chain of Bundles. The Bundle <code>community1</code> contains a Plugin Catalog, with all the Tier 3 plugins <em>all</em> downstream Bundles need.</p> <ul> <li>Bundle <code>community1</code> sets up a basic configuration, including a Plugin Catalog listing common Tier 3 (Community) plugins</li> <li>Bundle <code>community2</code> installs a chunk of these plugins, and sets a system message</li> <li>Bubdle <code>purple</code> install an additional community plugin (also defined in the Plugin Catalog) and has Controllers specific items (jobs)</li> </ul> <div class=highlight><pre><span></span><code>.
├── community1
│   ├── bundle.yaml
│   ├── jenkins
│   │   ├── jenkins.yaml
│   │   ├── podtemplate-golang.yaml
│   │   ├── podtemplate-maven-jdk17.yaml
│   │   └── shared-libraries.yaml
│   ├── plugin-catalog.yaml
│   └── plugins.yaml
├── community2 <span class=o>(</span>inherits community <span class=m>1</span><span class=o>)</span>
│   ├── bundle.yaml
│   ├── jenkins.yaml
│   └── plugins.yaml
└── purple <span class=o>(</span>inherits community <span class=m>2</span><span class=o>)</span>
    ├── bundle.yaml
    ├── items
    │   └── pipeline-example.yaml
    └── plugins.yaml
</code></pre></div> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime">2021-12-13 20:47:52</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../tanzu/jenkins-tap/ class="md-footer__link md-footer__link--prev" aria-label="Previous: TAP & Jenkins" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> TAP & Jenkins </div> </div> </a> <a href=../sso-azure-ad/ class="md-footer__link md-footer__link--next" aria-label="Next: Single Sign On - AzureAD" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Single Sign On - AzureAD </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2022 Joost van der Griendt </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/joostvdg target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> <a href=https://twitter.com/joost_vdg target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://linkedin.com/in/joostvdg target=_blank rel=noopener title=linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "navigation.instant", "navigation.tabs.sticky", "content.code.annotate", "toc.follow"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../assets/javascripts/bundle.d6c3db9e.min.js></script> </body> </html>